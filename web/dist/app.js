(()=>{(()=>{let b=window.HMApp||(window.HMApp={}),s=b.api||={};b.dom={locateBtn:document.getElementById("locateBtn"),voiceLocateBtn:document.getElementById("voiceLocateBtn"),voiceLocateBtnLabel:document.getElementById("voiceLocateBtnLabel"),modeRailBtn:document.getElementById("modeRailBtn"),modeTramBtn:document.getElementById("modeTramBtn"),modeMetroBtn:document.getElementById("modeMetroBtn"),modeBusBtn:document.getElementById("modeBusBtn"),helsinkiOnlyBtn:document.getElementById("helsinkiOnlyBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),resolvedLocationEl:document.getElementById("resolvedLocation"),voiceLocationChoicesEl:document.getElementById("voiceLocationChoices"),voiceLocationChoicesTitleEl:document.getElementById("voiceLocationChoicesTitle"),voiceLocationChoicesOptionsEl:document.getElementById("voiceLocationChoicesOptions"),voiceLocationChoicesCancelEl:document.getElementById("voiceLocationChoicesCancel"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),permissionCardEl:document.getElementById("permissionCard"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},b.constants={MODE_RAIL:"rail",MODE_TRAM:"tram",MODE_METRO:"metro",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_HELSINKI_ONLY_KEY:"prefs:helsinkiOnly",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_TRAM_KEY:"prefs:resultsLimitTram",STORAGE_RESULTS_LIMIT_METRO_KEY:"prefs:resultsLimitMetro",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_TRAM:8,DEFAULT_RESULTS_LIMIT_METRO:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],VOICE_RECOGNITION_TIMEOUT_MS:8e3,VOICE_SILENCE_STOP_MS:1200,VOICE_QUERY_MIN_LENGTH:3,FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5,METRIC_REPORT_LIMIT:10,METRIC_SAMPLE_RATE:1};let{MODE_RAIL:r,MODE_TRAM:n,MODE_METRO:y,MODE_BUS:I}=b.constants;b.state={isLoading:!1,isVoiceListening:!1,currentCoords:null,latestResponse:null,mode:r,helsinkiOnly:!1,busStopId:null,busLineFilters:[],busDestinationFilters:[],deferInitialStopContext:!1,deferredBusStopId:null,deferredBusLineFilters:[],deferredBusDestinationFilters:[],resultsLimitByMode:{[r]:b.constants.DEFAULT_RESULTS_LIMIT_RAIL,[n]:b.constants.DEFAULT_RESULTS_LIMIT_TRAM,[y]:b.constants.DEFAULT_RESULTS_LIMIT_METRO,[I]:b.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},resolvedLocationHint:null,suppressBusStopChange:!1,hasCompletedInitialStopModeLoad:!1,errorReportCount:0,metricReportCount:0,isMetricSessionSampled:Math.random()<b.constants.METRIC_SAMPLE_RATE,sessionStartedAtMs:Date.now(),hasReportedFirstSuccessfulRenderMetric:!1,hasReportedFirstManualInteractionMetric:!1,hasReportedFirstManualStopContextMetric:!1,hasReportedInitialNearestStopResolvedMetric:!1,latestLoadToken:0};let{dom:g,state:l,constants:p}=b;function L(){let e=l.isLoading||l.isVoiceListening,i=l.isLoading;g.locateBtn&&(g.locateBtn.disabled=e),g.voiceLocateBtn&&(g.voiceLocateBtn.disabled=i,g.voiceLocateBtn.classList.toggle("is-listening",l.isVoiceListening),g.voiceLocateBtn.setAttribute("aria-pressed",String(l.isVoiceListening))),g.voiceLocateBtnLabel&&(g.voiceLocateBtnLabel.textContent=l.isVoiceListening?"Listening...":"Describe Location")}function m(e){l.isLoading=e,L()}function C(e){l.isVoiceListening=!!e,L()}function M(e){g.statusEl&&(g.statusEl.textContent=e)}function N(e){let i=Number(e);return Number.isFinite(i)?i.toFixed(5):null}function f(e){let i=e&&typeof e=="object";if(l.resolvedLocationHint=i?{query:T(e.query,120).trim(),label:T(e.label,180).trim(),lat:Number(e.lat),lon:Number(e.lon)}:null,!g.resolvedLocationEl)return;if(!l.resolvedLocationHint){g.resolvedLocationEl.classList.add("hidden"),g.resolvedLocationEl.textContent="";return}let d=l.resolvedLocationHint.label||"Unknown place",E=l.resolvedLocationHint.query,_=N(l.resolvedLocationHint.lat),S=N(l.resolvedLocationHint.lon),A=E?` (from "${E}")`:"",w=_&&S?` - ${_}, ${S}`:"";g.resolvedLocationEl.textContent=`Resolved location: ${d}${A}${w}`,g.resolvedLocationEl.classList.remove("hidden")}function $(e){g.permissionCardEl&&g.permissionCardEl.classList.toggle("hidden",!e)}function U(e){!g.lastUpdatedEl||!(e instanceof Date)||(g.lastUpdatedEl.textContent=`Last updated: ${e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function h(e){try{return window.localStorage.getItem(e)}catch{return null}}function R(e,i){try{window.localStorage.setItem(e,i)}catch{}}function T(e,i){let d=String(e||"");return d.length<=i?d:d.slice(0,i)}function z(e){if(e instanceof Error)return e;try{let i=typeof e=="string"?e:JSON.stringify(e);return new Error(i||"Unknown error")}catch{return new Error(String(e||"Unknown error"))}}function P(e){let i=JSON.stringify(e);if(navigator.sendBeacon){let d=new Blob([i],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",d);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:i,keepalive:!0}).catch(()=>{})}function V(e,i,d=null){if(l.errorReportCount>=p.ERROR_REPORT_LIMIT)return;l.errorReportCount+=1;let E=z(i),_={type:T(e,40),message:T(E.message,400),stack:T(E.stack||"",1200),url:T(window.location.href,500),userAgent:T(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:d&&typeof d=="object"?d:null};P(_)}function G(){return Math.max(0,Date.now()-l.sessionStartedAtMs)}function k(e,i=null){if(!l.isMetricSessionSampled||l.metricReportCount>=p.METRIC_REPORT_LIMIT)return!1;l.metricReportCount+=1;let d={type:"metric",message:T(e,400),stack:"",url:T(window.location.href,500),userAgent:T(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:{metricName:T(e,80),sessionElapsedMs:G(),mode:l.mode,...i&&typeof i=="object"?i:{}}};return P(d),!0}function Y(e,i){if(l.hasReportedFirstSuccessfulRenderMetric)return;l.hasReportedFirstSuccessfulRenderMetric=!0;let d=Array.isArray(e?.station?.departures)?e.station.departures:[];k("first_successful_render",{requestMode:String(i||"").trim(),hasStation:!!e?.station,departureCount:d.length})}function X(e,i=null){l.hasReportedFirstManualInteractionMetric||(l.hasReportedFirstManualInteractionMetric=!0,k("first_manual_interaction",{interactionType:T(e,80),...i&&typeof i=="object"?i:{}}))}function K(e,i=null){l.hasReportedFirstManualStopContextMetric||(l.hasReportedFirstManualStopContextMetric=!0,k("first_manual_stop_context_change",{changeType:T(e,80),lineFilterCount:l.busLineFilters.length,destinationFilterCount:l.busDestinationFilters.length,...i&&typeof i=="object"?i:{}}))}function Z(e,i){if(l.hasReportedInitialNearestStopResolvedMetric)return;let d=String(e?.selectedStopId||"").trim();if(!d)return;l.hasReportedInitialNearestStopResolvedMetric=!0;let _=(Array.isArray(e?.stops)?e.stops:[]).find(A=>A?.id===d)||null,S=Array.isArray(e?.station?.departures)?e.station.departures:[];k("initial_nearest_stop_resolved",{requestMode:String(i||"").trim(),selectedStopId:d,distanceMeters:Number(_?.distanceMeters)||null,departureCount:S.length})}function x(e){if(!e)return null;let i=String(e).trim().toLowerCase();return i===r||i===n||i===y||i===I?i:null}function q(e){if(e==null)return null;let i=String(e).trim().toLowerCase();return["1","true","yes","on"].includes(i)?!0:["0","false","no","off"].includes(i)?!1:null}function j(e){return Array.isArray(e)?[...new Set(e.map(i=>String(i||"").trim()).filter(Boolean))]:[]}function v(e){if(e==null||e==="")return null;let i=Number(e);return!Number.isInteger(i)||!p.RESULT_LIMIT_OPTIONS.includes(i)?null:i}function Q(e=l.mode){return e===I?p.DEFAULT_RESULTS_LIMIT_BUS:e===y?p.DEFAULT_RESULTS_LIMIT_METRO:e===n?p.DEFAULT_RESULTS_LIMIT_TRAM:p.DEFAULT_RESULTS_LIMIT_RAIL}function D(e=l.mode){let i=v(l.resultsLimitByMode?.[e]);return i??Q(e)}function J(e){let i=h(e);if(!i)return[];try{let d=JSON.parse(i);return j(d)}catch{return[]}}function c(){let e=new URLSearchParams(window.location.search);return{mode:x(e.get("mode")),helsinkiOnly:q(e.get("helsinkiOnly")),stopProvided:e.has("stop"),busStopId:e.get("stop")?e.get("stop").trim():null,linesProvided:e.has("line"),busLines:j(e.getAll("line")),destinationsProvided:e.has("dest"),busDestinations:j(e.getAll("dest")),resultsProvided:e.has("results"),resultsLimit:v(e.get("results"))}}function t(){let e=c(),i=x(h(p.STORAGE_MODE_KEY)),d=q(h(p.STORAGE_HELSINKI_ONLY_KEY));l.mode=e.mode||i||r,l.helsinkiOnly=e.helsinkiOnly??d??!1,l.mode!==r&&(l.helsinkiOnly=!1);let E=String(h(p.STORAGE_BUS_STOP_KEY)||"").trim()||null,_=e.stopProvided?e.busStopId:E,S=J(p.STORAGE_BUS_LINES_KEY),A=J(p.STORAGE_BUS_DESTINATIONS_KEY),w=e.linesProvided?e.busLines:S,H=e.destinationsProvided?e.busDestinations:A,O=!!_||w.length>0||H.length>0;l.deferInitialStopContext=O,O?(l.deferredBusStopId=_,l.deferredBusLineFilters=[...w],l.deferredBusDestinationFilters=[...H],l.busStopId=null,l.busLineFilters=[],l.busDestinationFilters=[]):(l.deferredBusStopId=null,l.deferredBusLineFilters=[],l.deferredBusDestinationFilters=[],l.busStopId=_,l.busLineFilters=w,l.busDestinationFilters=H);let W=v(h(p.STORAGE_RESULTS_LIMIT_RAIL_KEY)),B=v(h(p.STORAGE_RESULTS_LIMIT_TRAM_KEY)),F=v(h(p.STORAGE_RESULTS_LIMIT_METRO_KEY)),ee=v(h(p.STORAGE_RESULTS_LIMIT_BUS_KEY));l.resultsLimitByMode[r]=W??p.DEFAULT_RESULTS_LIMIT_RAIL,l.resultsLimitByMode[n]=B??p.DEFAULT_RESULTS_LIMIT_TRAM,l.resultsLimitByMode[y]=F??p.DEFAULT_RESULTS_LIMIT_METRO,l.resultsLimitByMode[I]=ee??p.DEFAULT_RESULTS_LIMIT_BUS,e.resultsProvided&&e.resultsLimit!=null&&(l.resultsLimitByMode[l.mode]=e.resultsLimit)}function o(){R(p.STORAGE_MODE_KEY,l.mode),R(p.STORAGE_HELSINKI_ONLY_KEY,l.helsinkiOnly?"1":"0"),R(p.STORAGE_BUS_STOP_KEY,l.busStopId||""),R(p.STORAGE_BUS_LINES_KEY,JSON.stringify(l.busLineFilters)),R(p.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(l.busDestinationFilters)),R(p.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(D(r))),R(p.STORAGE_RESULTS_LIMIT_TRAM_KEY,String(D(n))),R(p.STORAGE_RESULTS_LIMIT_METRO_KEY,String(D(y))),R(p.STORAGE_RESULTS_LIMIT_BUS_KEY,String(D(I)))}function a(){let e=new URLSearchParams(window.location.search);l.mode===r?e.delete("mode"):e.set("mode",l.mode),l.mode===r&&l.helsinkiOnly?e.set("helsinkiOnly","1"):e.delete("helsinkiOnly");let i=D(),d=Q();if(i===d?e.delete("results"):e.set("results",String(i)),e.delete("stop"),e.delete("line"),e.delete("dest"),l.mode===I||l.mode===n||l.mode===y){l.busStopId&&e.set("stop",l.busStopId);for(let S of l.busLineFilters)e.append("line",S);for(let S of l.busDestinationFilters)e.append("dest",S)}let E=e.toString(),_=`${window.location.pathname}${E?`?${E}`:""}${window.location.hash}`;window.history.replaceState(null,"",_)}function u(){o(),a()}L(),Object.assign(s,{updateLocationActionButtons:L,setLoading:m,setVoiceListening:C,setStatus:M,setResolvedLocationHint:f,setPermissionRequired:$,setLastUpdated:U,getStorageItem:h,setStorageItem:R,safeString:T,toError:z,sendClientReport:P,reportClientError:V,reportClientMetric:k,getSessionElapsedMs:G,trackFirstSuccessfulRender:Y,trackFirstManualInteraction:X,trackFirstManualStopContextChange:K,trackInitialNearestStopResolved:Z,normalizeMode:x,parseBoolean:q,uniqueNonEmptyStrings:j,parseResultLimit:v,getDefaultResultsLimit:Q,getActiveResultsLimit:D,parseStoredArray:J,readStateFromUrl:c,hydrateInitialState:t,syncStateToStorage:o,syncStateToUrl:a,persistUiState:u})})();(()=>{let b=window.HMApp,{api:s,dom:r,state:n,constants:y}=b,{MODE_RAIL:I,MODE_TRAM:g,MODE_METRO:l,MODE_BUS:p}=y;function L(t=n.mode){return t===p||t===g||t===l}function m(t=n.mode){return t===g?{singular:"tram",plural:"trams",title:"Tram"}:t===l?{singular:"metro",plural:"metros",title:"Metro"}:{singular:"bus",plural:"buses",title:"Bus"}}function C(t){let o=M(t);return o<=0?"Now":`${o}m`}function M(t){let o=new Date(t);return Math.floor((o.getTime()-Date.now())/6e4)}function N(t){let o=M(t);return o<=0||o<5?"departure-now":o<=15?"departure-soon":"departure-later"}function f(t){let o=t?.destination||"";return/\bhelsinki\b/i.test(o)}function $(){let t=new Set((n.busFilterOptions.lines||[]).map(a=>a.value)),o=new Set((n.busFilterOptions.destinations||[]).map(a=>a.value));n.busLineFilters=n.busLineFilters.filter(a=>t.has(a)),n.busDestinationFilters=n.busDestinationFilters.filter(a=>o.has(a))}function U(t){if(!Array.isArray(t))return[];if(n.mode===I)return n.helsinkiOnly?t.filter(f):t;if(!L())return t;let o=new Set(n.busLineFilters),a=new Set(n.busDestinationFilters);return t.filter(u=>{if(o.size===0)return!0;let e=String(u?.line||"").trim();return o.has(e)}).filter(u=>{if(a.size===0)return!0;let e=String(u?.destination||"").trim();return a.has(e)})}function h(){if(r.modeRailBtn){let t=n.mode===I;r.modeRailBtn.setAttribute("aria-pressed",String(t)),r.modeRailBtn.classList.toggle("is-active",t)}if(r.modeTramBtn){let t=n.mode===g;r.modeTramBtn.setAttribute("aria-pressed",String(t)),r.modeTramBtn.classList.toggle("is-active",t)}if(r.modeMetroBtn){let t=n.mode===l;r.modeMetroBtn.setAttribute("aria-pressed",String(t)),r.modeMetroBtn.classList.toggle("is-active",t)}if(r.modeBusBtn){let t=n.mode===p;r.modeBusBtn.setAttribute("aria-pressed",String(t)),r.modeBusBtn.classList.toggle("is-active",t)}}function R(){let t=L()?m().title:"Rail",o=L()?`Next ${m().title}`:"Next Train";r.modeEyebrowEl&&(r.modeEyebrowEl.textContent=`Helsinki Moves \u2022 ${t}`),r.nextLabelEl&&(r.nextLabelEl.textContent=o)}function T(){if(!r.resultsLimitSelectEl)return;let t=Array.isArray(y.RESULT_LIMIT_OPTIONS)?y.RESULT_LIMIT_OPTIONS:[],o=s.getActiveResultsLimit();r.resultsLimitSelectEl.innerHTML="";for(let a of t){let u=document.createElement("option");u.value=String(a),u.textContent=`${a}`,r.resultsLimitSelectEl.appendChild(u)}r.resultsLimitSelectEl.value=String(o)}function z(){if(r.helsinkiOnlyBtn){if(n.mode!==I){r.helsinkiOnlyBtn.setAttribute("aria-pressed","false"),r.helsinkiOnlyBtn.classList.remove("is-active"),r.helsinkiOnlyBtn.disabled=!0,r.helsinkiOnlyBtn.textContent="Helsinki Only (Rail)";return}r.helsinkiOnlyBtn.disabled=!1,r.helsinkiOnlyBtn.setAttribute("aria-pressed",String(n.helsinkiOnly)),r.helsinkiOnlyBtn.classList.toggle("is-active",n.helsinkiOnly),r.helsinkiOnlyBtn.textContent=n.helsinkiOnly?"Helsinki Only: On":"Helsinki Only: Off"}}function P(t){r.busControlsEl&&r.busControlsEl.classList.toggle("hidden",!t)}function V(t){return n.busStops.find(o=>o.id===t)||null}function G(t){let o=s.uniqueNonEmptyStrings([...Array.isArray(t?.stopCodes)?t.stopCodes:[],t?.code]);return o.length===0&&t?.id&&o.push(String(t.id)),o}function k(t,o=null){let a=V(n.busStopId),u=String(o?.stopName||t?.stopName||a?.name||"").trim(),i=s.uniqueNonEmptyStrings([o?.stopCode,...Array.isArray(t?.stopCodes)?t.stopCodes:[],t?.stopCode,...G(a)])[0]||"";return u&&i?`${u} ${i}`:u||i||"\u2014"}function Y(t,o=null){if(L())return k(t,o);let a=String(o?.stopName||t?.stopName||"").trim(),u=String(o?.stopCode||t?.stopCode||"").trim();return a&&u?`${a} ${u}`:a||u||"\u2014"}function X(t){if(!r.dataScopeEl)return;if(!L()){r.dataScopeEl.classList.add("hidden"),r.dataScopeEl.textContent="";return}let o=String(t?.station?.stopName||V(n.busStopId)?.name||"").trim(),u=s.uniqueNonEmptyStrings([...Array.isArray(t?.station?.stopCodes)?t.station.stopCodes:[],t?.station?.stopCode,...G(V(n.busStopId))]).join(", "),e=n.busLineFilters.length===0?"all lines":`${n.busLineFilters.length} line${n.busLineFilters.length===1?"":"s"} selected`,i=n.busDestinationFilters.length===0?"all destinations":`${n.busDestinationFilters.length} destination${n.busDestinationFilters.length===1?"":"s"} selected`,d=`${s.getActiveResultsLimit()} results`;o?r.dataScopeEl.textContent=`Selected stop ${o} (${u||"\u2014"}) - ${e}, ${i}, ${d}`:r.dataScopeEl.textContent=`Selecting stop... (${e}, ${i}, ${d})`,r.dataScopeEl.classList.remove("hidden")}function K(t,o,a,u){if(!t)return;if(t.innerHTML="",!Array.isArray(o)||o.length===0){let i=document.createElement("span");i.className="chip-empty",i.textContent="No options",t.appendChild(i);return}let e=new Set(a);for(let i of o){let d=document.createElement("button");d.type="button",d.className="chip-toggle",e.has(i.value)?(d.classList.add("is-active"),d.setAttribute("aria-pressed","true")):d.setAttribute("aria-pressed","false"),d.textContent=`${i.value} (${i.count})`,d.addEventListener("click",()=>u(i.value)),t.appendChild(d)}}function Z(){let t=L();if(P(t),!!t){if(r.busStopSelectEl){if(n.suppressBusStopChange=!0,r.busStopSelectEl.innerHTML="",n.busStops.length===0){let o=document.createElement("option");o.value="",o.textContent=`No nearby ${m().singular} stops`,r.busStopSelectEl.appendChild(o),r.busStopSelectEl.disabled=!0}else{r.busStopSelectEl.disabled=!1;for(let o of n.busStops){let a=document.createElement("option");a.value=o.id,a.textContent=`${o.name} (${o.distanceMeters}m)`,r.busStopSelectEl.appendChild(a)}n.busStopId&&n.busStops.some(o=>o.id===n.busStopId)?r.busStopSelectEl.value=n.busStopId:r.busStopSelectEl.value=n.busStops[0].id}n.suppressBusStopChange=!1}K(r.busLineFiltersEl,n.busFilterOptions.lines,n.busLineFilters,o=>{n.busLineFilters.includes(o)?n.busLineFilters=n.busLineFilters.filter(a=>a!==o):n.busLineFilters=[...n.busLineFilters,o],s.trackFirstManualInteraction("line_filter_toggle",{currentMode:n.mode}),s.trackFirstManualStopContextChange("line_filter_toggle"),s.persistUiState(),n.latestResponse&&(s.render(n.latestResponse),s.setStatus(s.buildStatusFromResponse(n.latestResponse)))}),K(r.busDestinationFiltersEl,n.busFilterOptions.destinations,n.busDestinationFilters,o=>{n.busDestinationFilters.includes(o)?n.busDestinationFilters=n.busDestinationFilters.filter(a=>a!==o):n.busDestinationFilters=[...n.busDestinationFilters,o],s.trackFirstManualInteraction("destination_filter_toggle",{currentMode:n.mode}),s.trackFirstManualStopContextChange("destination_filter_toggle"),s.persistUiState(),n.latestResponse&&(s.render(n.latestResponse),s.setStatus(s.buildStatusFromResponse(n.latestResponse)))})}}function x(t,o=null){if(!r.nextSummaryEl||!r.nextMinsEl||!r.nextLineEl||!r.nextTrackEl||!r.nextDestinationEl)return;if(!t){r.nextSummaryEl.classList.add("hidden"),r.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later");return}let a=M(t.departureIso);r.nextMinsEl.textContent=C(t.departureIso),r.nextLineEl.textContent=t.line||"\u2014",r.nextLineEl.classList.toggle("next-letter-now",a<5),r.nextTrackEl.textContent=L()?`Stop ${Y(o,t)}`:t.track?`Track ${t.track}`:"Track \u2014",r.nextDestinationEl.textContent=t.destination||"\u2014",r.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),a<5?r.nextSummaryEl.classList.add("next-summary-now"):a<=15?r.nextSummaryEl.classList.add("next-summary-soon"):r.nextSummaryEl.classList.add("next-summary-later"),r.nextSummaryEl.classList.remove("hidden")}function q(t){if(!t||!t.station)return L()?t?.message||`No nearby ${m().singular} stops found.`:t?.message||"No nearby train stations found.";let a=U(t.station.departures)[0];if(!a)return L()?n.busLineFilters.length>0||n.busDestinationFilters.length>0?`No upcoming ${m().plural} match selected filters.`:"No upcoming departures from this stop.":n.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.";let u=a.destination?` \u2022 ${a.destination}`:"",e=n.mode===I?a.track?` \u2022 Track ${a.track}`:"":t.station.stopName||t.station.stopCode?` \u2022 ${Y(t.station,a)}`:"",i=L()?m().singular:"train";return`Next ${a.line||i} in ${C(a.departureIso)}${u}${e}`}function j(t){if(!(t instanceof Error))return"Could not refresh departures. Please try again.";if(t.name==="AbortError")return"Request timed out. Please try again.";let o=(t.message||"").trim();return o==="Temporary server error. Please try again."?o:o==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":o==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function v(t){return t?.code===1?"Location permission denied.":t?.code===2?"Location unavailable. Please try again.":t?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function Q(t){let o=String(t?.code||"").trim();return o==="voice_unsupported"?"Voice location is not supported in this browser.":o==="voice_permission_denied"?"Microphone permission denied.":o==="voice_no_microphone"?"No microphone was found for voice location.":o==="voice_no_speech"?"No speech detected. Please try again.":o==="voice_recognition_timeout"?"Voice listening timed out. Please try again.":o==="voice_language_not_supported"?"Voice language was not supported on this device.":o==="voice_query_too_short"?"Please describe your location with a few words.":o==="voice_location_not_found"?"Could not match that place. Try a nearby landmark or street.":o==="voice_location_selection_cancelled"?"Location selection was cancelled.":o==="voice_location_selection_invalid"?"Please choose one of the suggested locations.":o==="voice_recognition_network"?"Voice recognition failed due to a network error. On iPhone, try enabling Siri & Dictation.":"Could not use voice location. Please try again."}function D(){let t=[...document.querySelectorAll(".departure-row .train-top")];if(t.length===0)return;let o=t.map(i=>i.querySelector(".destination")).filter(Boolean);for(let i of o)i.style.width="auto";let a=0;for(let i of o)a=Math.max(a,Math.ceil(i.scrollWidth));let u=Number.POSITIVE_INFINITY;for(let i of t){let d=i.querySelector(".time");if(!d)continue;let E=getComputedStyle(i),_=parseFloat(E.columnGap||E.gap||"0")||0,S=i.clientWidth-d.offsetWidth-_;S>0&&(u=Math.min(u,S))}let e=Math.max(0,Math.min(a,u));for(let i of o)i.style.width=`${e}px`}function J(t){if(Z(),X(t),!t||!t.station){r.resultEl.classList.add("hidden"),x(null);return}let o=t.station;r.resultEl.classList.remove("hidden"),r.stationTitleEl.textContent=o.stopName,r.stationMetaEl.textContent=`${o.distanceMeters}m away`,r.departuresEl.innerHTML="";let a=U(o.departures);if(a.length===0){x(null);let e=document.createElement("li");e.className="empty-row",L()?e.textContent=n.busLineFilters.length>0||n.busDestinationFilters.length>0?`No upcoming ${m().plural} match selected filters.`:"No upcoming departures from this stop.":e.textContent=n.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.",r.departuresEl.appendChild(e);return}x(a[0],o);let u=a.slice(1);if(u.length===0){let e=document.createElement("li");e.className="empty-row",e.textContent=L()?`No additional upcoming ${m().plural} right now.`:"No additional upcoming commuter trains right now.",r.departuresEl.appendChild(e);return}for(let e=0;e<u.length;e++){let i=u[e],d=document.createElement("li");d.className=`departure-row ${N(i.departureIso)}`,d.style.setProperty("--i",e);let E=document.createElement("div");E.className="letter-badge",E.textContent=i.line||"?";let _=document.createElement("div");_.className="train";let S=document.createElement("div");S.className="train-top";let A=document.createElement("div");A.className="destination",A.textContent=i.destination||"\u2014",S.appendChild(A);let w=document.createElement("div");w.className="time";let H=document.createElement("span");H.className="remaining",H.textContent=C(i.departureIso);let O=document.createElement("span");O.className="clock-time",O.textContent=new Date(i.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),w.appendChild(H),w.appendChild(O),S.appendChild(w),_.appendChild(S);let W=document.createElement("span");W.className="track",L()?W.textContent=`Stop ${Y(o,i)}`:W.textContent=i.track?`Track ${i.track}`:"Track \u2014",_.appendChild(W),d.appendChild(E),d.appendChild(_),r.departuresEl.appendChild(d)}requestAnimationFrame(D)}function c(){r.nowClockEl&&(r.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(s,{formatMinutes:C,minutesUntil:M,departureRowClass:N,isHelsinkiBound:f,sanitizeStopSelections:$,getVisibleDepartures:U,updateModeButtons:h,updateModeLabels:R,renderResultsLimitControl:T,updateHelsinkiFilterButton:z,setStopControlsVisibility:P,getStopMeta:V,getStopCodes:G,buildStopDisplay:k,buildModeStopDisplay:Y,updateDataScope:X,renderFilterButtons:K,renderStopControls:Z,updateNextSummary:x,buildStatusFromResponse:q,getLoadErrorStatus:j,getGeolocationErrorStatus:v,getVoiceLocationErrorStatus:Q,alignDepartureColumns:D,render:J,updateClock:c})})();(()=>{let b=window.HMApp,{api:s,dom:r,state:n,constants:y}=b,{MODE_TRAM:I,MODE_METRO:g,MODE_BUS:l}=y;function p(c){return c===l||c===I||c===g}function L(c){return new Promise(t=>setTimeout(t,c))}async function m(c,t={},o=y.FETCH_TIMEOUT_MS){let a=new AbortController,u=setTimeout(()=>a.abort(),o);try{return await fetch(c,{...t,signal:a.signal})}finally{clearTimeout(u)}}async function C(c,t={}){let o;try{o=await m(c,t)}catch{return await L(350),m(c,t)}return o.status>=500?(await L(350),m(c,t)):o}function M(c){let t=new Map,o=new Map;for(let u of c||[]){let e=String(u?.line||"").trim();e&&t.set(e,(t.get(e)||0)+1);let i=String(u?.destination||"").trim();i&&o.set(i,(o.get(i)||0)+1)}let a=u=>[...u.entries()].sort((e,i)=>i[1]-e[1]||e[0].localeCompare(i[0])).map(([e,i])=>({value:e,count:i}));return{lines:a(t),destinations:a(o)}}function N(c){let t=Array.isArray(c?.stops)?c.stops.filter(e=>e&&e.id&&e.name).map(e=>({id:e.id,name:e.name,code:String(e.code||"").trim()||null,stopCodes:s.uniqueNonEmptyStrings([...Array.isArray(e.stopCodes)?e.stopCodes:[],e.code]),distanceMeters:Number(e.distanceMeters)||0})):[];n.busStops=t;let o=String(c?.selectedStopId||"").trim()||null,a=e=>t.some(i=>i.id===e);o&&a(o)?n.busStopId=o:(!n.busStopId||!a(n.busStopId))&&(n.busStopId=t[0]?.id||null),n.deferInitialStopContext&&(n.deferInitialStopContext=!1,n.deferredBusStopId=null,n.deferredBusLineFilters=[],n.deferredBusDestinationFilters=[],n.busLineFilters=[],n.busDestinationFilters=[]),n.hasCompletedInitialStopModeLoad=!0;let u=Array.isArray(c?.station?.departures)?c.station.departures:[];n.busFilterOptions=M(u),s.sanitizeStopSelections()}function f(c,t){let o=new Error(t);return o.code=c,o}function $(c){return String(c?.code||"").trim().toLowerCase()}function U(){return s.uniqueNonEmptyStrings(["fi-FI","en-US",...Array.isArray(navigator.languages)?navigator.languages:[],navigator.language])}function h(){return typeof window.SpeechRecognition=="function"?window.SpeechRecognition:typeof window.webkitSpeechRecognition=="function"?window.webkitSpeechRecognition:null}function R(){return!!h()}function T(c){return c==="not-allowed"||c==="service-not-allowed"?f("voice_permission_denied","Microphone permission denied."):c==="audio-capture"?f("voice_no_microphone","No microphone available."):c==="language-not-supported"?f("voice_language_not_supported","Speech language is not supported."):c==="network"?f("voice_recognition_network","Voice recognition network error."):c==="no-speech"?f("voice_no_speech","No speech detected."):f("voice_not_understood","Voice recognition failed.")}function z(c){let t=h();return t?new Promise((o,a)=>{let u=new t,e=String(c||navigator.language||"fi-FI").trim();u.lang=e||"fi-FI",u.continuous=!1,u.interimResults=!0,u.maxAlternatives=1;let i=!1,d="",E=null,_=!1,S=()=>{clearTimeout(E),E=null},A=()=>{if(!(_||i)){_=!0;try{u.stop()}catch{}}},w=()=>{S(),E=setTimeout(A,y.VOICE_SILENCE_STOP_MS)},H=()=>{clearTimeout(W),S(),u.onresult=null,u.onerror=null,u.onend=null,u.onspeechend=null,u.onsoundend=null,u.onaudioend=null,u.onnomatch=null},O=(B,F)=>{i||(i=!0,H(),B(F))},W=setTimeout(()=>{try{u.abort()}catch{}O(a,f("voice_recognition_timeout","Voice recognition timed out."))},y.VOICE_RECOGNITION_TIMEOUT_MS);u.onresult=B=>{for(let F=B?.resultIndex||0;F<(B?.results?.length||0);F+=1){let ee=B.results[F],te=String(ee?.[0]?.transcript||"").trim();if(te&&(d=te,w(),ee?.isFinal)){A();return}}},u.onerror=B=>{let F=String(B?.error||"").trim().toLowerCase();O(a,T(F))},u.onend=()=>{if(i)return;let B=String(d||"").trim();if(!B){O(a,f("voice_no_speech","No speech detected."));return}O(o,B)},u.onspeechend=()=>{A()},u.onsoundend=()=>{w()},u.onaudioend=()=>{w()},u.onnomatch=()=>{O(a,f("voice_not_understood","Could not understand speech."))};try{u.start()}catch(B){let F=String(B?.name||"").trim().toLowerCase();if(F==="notallowederror"||F==="securityerror"){O(a,f("voice_permission_denied","Microphone permission denied."));return}O(a,f("voice_not_understood","Unable to start voice recognition."))}}):Promise.reject(f("voice_unsupported","Voice recognition not supported."))}function P(c){return c==="voice_no_speech"||c==="voice_not_understood"||c==="voice_recognition_timeout"||c==="voice_language_not_supported"}async function V(){let c=U(),t=null;for(let o of c)try{return await z(o)}catch(a){if(t=a,!P($(a)))break}throw t||f("voice_not_understood","Voice recognition failed.")}function G(c){return Array.isArray(c)?c.map(t=>{let o=Number(t?.lat),a=Number(t?.lon);return!Number.isFinite(o)||!Number.isFinite(a)?null:{lat:o,lon:a,label:String(t?.label||"").trim()}}).filter(Boolean):[]}function k(){r.voiceLocationChoicesEl&&r.voiceLocationChoicesEl.classList.add("hidden"),r.voiceLocationChoicesTitleEl&&(r.voiceLocationChoicesTitleEl.textContent=""),r.voiceLocationChoicesOptionsEl&&(r.voiceLocationChoicesOptionsEl.innerHTML=""),r.voiceLocationChoicesCancelEl&&(r.voiceLocationChoicesCancelEl.onclick=null)}function Y(c,t){if(typeof window.prompt!="function")throw f("voice_location_selection_cancelled","Location selection was cancelled.");let o=t.map((e,i)=>`${i+1}. ${e.label||`${e.lat}, ${e.lon}`}`).join(`
`),a=window.prompt(`Multiple matches found for "${s.safeString(c,80)}". Select number:
${o}`,"1");if(a==null)throw f("voice_location_selection_cancelled","Location selection was cancelled.");let u=Number.parseInt(String(a).trim(),10);if(!Number.isInteger(u)||u<1||u>t.length)throw f("voice_location_selection_invalid","Invalid location selection.");return t[u-1]}async function X(c,t){if(!Array.isArray(t)||t.length===0)throw f("voice_location_not_found","No matching location found.");return!r.voiceLocationChoicesEl||!r.voiceLocationChoicesTitleEl||!r.voiceLocationChoicesOptionsEl||!r.voiceLocationChoicesCancelEl?Y(c,t):new Promise((o,a)=>{let u=!1,e=(i,d)=>{u||(u=!0,k(),i(d))};r.voiceLocationChoicesTitleEl.textContent=`Multiple matches for "${s.safeString(c,80)}". Choose one:`,s.setStatus("Multiple matches found. Choose one below."),r.voiceLocationChoicesOptionsEl.innerHTML="";for(let i of t){let d=document.createElement("button");d.type="button",d.className="voice-location-choice-option",d.textContent=i.label||`${i.lat.toFixed(5)}, ${i.lon.toFixed(5)}`,d.addEventListener("click",()=>e(o,i),{once:!0}),r.voiceLocationChoicesOptionsEl.appendChild(d)}r.voiceLocationChoicesCancelEl.onclick=()=>e(a,f("voice_location_selection_cancelled","Location selection was cancelled.")),r.voiceLocationChoicesEl.classList.remove("hidden")})}async function K(c){let t=String(c||"").trim();if(t.length<y.VOICE_QUERY_MIN_LENGTH)throw f("voice_query_too_short","Voice query too short.");let o=new URLSearchParams({text:t});n.currentCoords&&(o.set("lat",String(n.currentCoords.lat)),o.set("lon",String(n.currentCoords.lon)));let a=Array.isArray(navigator.languages)&&navigator.languages[0]||navigator.language||"";a&&o.set("lang",String(a));let u;try{u=await C(`/api/v1/geocode?${o.toString()}`)}catch{throw f("voice_geocode_failed","Location lookup failed.")}if(!(u.headers.get("content-type")||"").includes("application/json"))throw f("voice_geocode_failed","Unexpected location lookup response.");let i=await u.json();if(!u.ok)throw f("voice_geocode_failed",String(i?.error||"Location lookup failed.").trim());let d=G(i?.choices);if(i?.ambiguous&&d.length>1){let S=await X(t,d);return{lat:S.lat,lon:S.lon,label:S.label,query:t}}let E=Number(i?.location?.lat),_=Number(i?.location?.lon);if(!Number.isFinite(E)||!Number.isFinite(_))throw f("voice_location_not_found","No matching location found.");return{lat:E,lon:_,label:String(i?.location?.label||"").trim(),query:t}}function Z(c){return c==="voice_unsupported"||c==="voice_no_speech"||c==="voice_recognition_timeout"||c==="voice_recognition_network"||c==="voice_not_understood"}function x(c){if(!Z(c)||typeof window.prompt!="function")return null;let t=c==="voice_unsupported"?"Voice input is limited in this browser. Type your location instead:":"Could not capture your voice on this device. Type your location:",o=window.prompt(`${t}
Example: Kamppi Helsinki`,"");return String(o||"").trim()||null}async function q(c){let t=String(c||"").trim();k(),s.setStatus(`Looking up "${s.safeString(t,80)}"...`);let o=await K(t);return s.setResolvedLocationHint({query:t,label:o.label,lat:o.lat,lon:o.lon}),n.currentCoords={lat:o.lat,lon:o.lon},s.setPermissionRequired(!1),await v(o.lat,o.lon),!0}async function j(){if(n.isLoading||n.isVoiceListening)return!1;k(),s.setVoiceListening(!0),s.setStatus("Listening... speak now, then pause.");try{if(!R()){let t=f("voice_unsupported","Voice recognition not supported."),o=x($(t));return o?q(o):(s.setStatus(s.getVoiceLocationErrorStatus(t)),!1)}let c=await V();return q(c)}catch(c){let t=$(c),o=x(t);if(o)try{return await q(o)}catch(a){return console.error("voice fallback location error:",a),s.reportClientError("voice-location-fallback",a,{mode:n.mode,sourceCode:t||"unknown"}),s.setStatus(s.getVoiceLocationErrorStatus(a)),!1}return(!t||t==="unknown")&&console.error("voice location error:",c),s.reportClientError("voice-location",c,{mode:n.mode,code:t||"unknown"}),s.setStatus(s.getVoiceLocationErrorStatus(c)),!1}finally{s.setVoiceListening(!1)}}async function v(c,t){let o=++n.latestLoadToken,a=n.mode,u=n.busStopId,e=p(a)&&!n.hasCompletedInitialStopModeLoad;s.setLoading(!0),s.setStatus("Loading departures...");try{let i=new URLSearchParams({lat:String(c),lon:String(t),mode:a.toUpperCase(),results:String(s.getActiveResultsLimit(a))}),d=p(a)&&(n.deferInitialStopContext||!n.hasCompletedInitialStopModeLoad);p(a)&&u&&!d&&i.set("stopId",u);let E=await C(`/api/v1/departures?${i.toString()}`);if(!(E.headers.get("content-type")||"").includes("application/json"))throw E.ok?new Error("Unexpected server response."):new Error("Request failed");let S=await E.json();if(!E.ok)throw new Error(S.error||"Request failed");if(o!==n.latestLoadToken)return;p(a)&&(N(S),s.persistUiState(),e&&s.trackInitialNearestStopResolved(S,a)),n.latestResponse=S,s.render(S),s.setPermissionRequired(!1),s.setLastUpdated(new Date),s.setStatus(s.buildStatusFromResponse(S)),s.trackFirstSuccessfulRender(S,a)}catch(i){if(o!==n.latestLoadToken)return;n.latestResponse=null,console.error("load departures error:",i),s.reportClientError("load",i,{mode:a}),s.setStatus(s.getLoadErrorStatus(i)),r.resultEl.classList.add("hidden"),s.updateNextSummary(null)}finally{o===n.latestLoadToken&&s.setLoading(!1)}}function Q(){return k(),s.setResolvedLocationHint(null),navigator.geolocation?n.isLoading||n.isVoiceListening?!1:(s.setStatus("Getting your location..."),s.setLoading(!0),navigator.geolocation.getCurrentPosition(c=>{n.currentCoords={lat:c.coords.latitude,lon:c.coords.longitude},s.setPermissionRequired(!1),s.setLoading(!1),v(n.currentCoords.lat,n.currentCoords.lon)},c=>{if(s.setLoading(!1),c.code===1){s.setPermissionRequired(!0),s.setStatus(s.getGeolocationErrorStatus(c)),n.latestResponse=null,r.resultEl.classList.add("hidden"),s.updateNextSummary(null);return}s.setPermissionRequired(!1),s.setStatus(s.getGeolocationErrorStatus(c)),n.latestResponse=null,r.resultEl.classList.add("hidden"),s.updateNextSummary(null)},{enableHighAccuracy:!1,timeout:1e4,maximumAge:0}),!0):(s.setStatus("Geolocation not supported in this browser."),s.setPermissionRequired(!0),!1)}function D(){if(!n.isVoiceListening){if(n.currentCoords){v(n.currentCoords.lat,n.currentCoords.lon);return}Q()}}function J(){s.updateModeButtons(),s.updateModeLabels(),s.renderResultsLimitControl(),s.updateHelsinkiFilterButton(),s.renderStopControls(),s.updateDataScope(n.latestResponse)}Object.assign(s,{delay:L,fetchWithTimeout:m,fetchWithRetryOnce:C,updateStopModeStateFromResponse:N,buildFilterOptionsFromDepartures:M,load:v,requestLocationAndLoad:Q,requestVoiceLocationAndLoad:j,supportsVoiceLocation:R,captureVoiceQuery:z,captureVoiceQueryWithRetry:V,getVoiceRecognitionLanguages:U,shouldRetryVoiceRecognition:P,resolveVoiceLocationQuery:K,refreshDeparturesOnly:D,applyModeUiState:J})})();(()=>{let b=window.HMApp,{api:s,dom:r,state:n,constants:y}=b,{MODE_RAIL:I,MODE_TRAM:g,MODE_METRO:l,MODE_BUS:p}=y;function L(){if(n.currentCoords){s.load(n.currentCoords.lat,n.currentCoords.lon);return}s.requestLocationAndLoad()}r.locateBtn?.addEventListener("click",()=>{s.trackFirstManualInteraction("refresh_location_click"),s.requestLocationAndLoad()}),r.voiceLocateBtn?.addEventListener("click",()=>{s.trackFirstManualInteraction("voice_location_click"),s.requestVoiceLocationAndLoad()}),r.modeRailBtn?.addEventListener("click",()=>{n.mode!==I&&(s.trackFirstManualInteraction("mode_change",{toMode:I}),n.mode=I,s.applyModeUiState(),s.persistUiState(),L())}),r.modeTramBtn?.addEventListener("click",()=>{n.mode!==g&&(s.trackFirstManualInteraction("mode_change",{toMode:g}),n.mode=g,n.helsinkiOnly=!1,s.applyModeUiState(),s.persistUiState(),L())}),r.modeMetroBtn?.addEventListener("click",()=>{n.mode!==l&&(s.trackFirstManualInteraction("mode_change",{toMode:l}),n.mode=l,n.helsinkiOnly=!1,s.applyModeUiState(),s.persistUiState(),L())}),r.modeBusBtn?.addEventListener("click",()=>{n.mode!==p&&(s.trackFirstManualInteraction("mode_change",{toMode:p}),n.mode=p,n.helsinkiOnly=!1,s.applyModeUiState(),s.persistUiState(),L())}),r.resultsLimitSelectEl?.addEventListener("change",()=>{let m=s.parseResultLimit(r.resultsLimitSelectEl.value);if(m==null){s.renderResultsLimitControl();return}s.getActiveResultsLimit()!==m&&(s.trackFirstManualInteraction("results_limit_change",{nextLimit:m,currentMode:n.mode}),n.resultsLimitByMode[n.mode]=m,s.persistUiState(),L())}),r.busStopSelectEl?.addEventListener("change",()=>{if(n.suppressBusStopChange||n.mode!==p&&n.mode!==g&&n.mode!==l)return;let m=String(r.busStopSelectEl.value||"").trim();!m||m===n.busStopId||(s.trackFirstManualInteraction("stop_select",{currentMode:n.mode}),s.trackFirstManualStopContextChange("stop_select",{selectedStopId:m}),n.busStopId=m,s.persistUiState(),n.currentCoords&&s.load(n.currentCoords.lat,n.currentCoords.lon))}),r.helsinkiOnlyBtn?.addEventListener("click",()=>{n.mode===I&&(s.trackFirstManualInteraction("helsinki_only_toggle"),n.helsinkiOnly=!n.helsinkiOnly,s.persistUiState(),s.updateHelsinkiFilterButton(),n.latestResponse&&(s.render(n.latestResponse),s.setStatus(s.buildStatusFromResponse(n.latestResponse))))}),s.hydrateInitialState(),s.applyModeUiState(),s.updateClock(),setInterval(s.updateClock,1e3),s.requestLocationAndLoad(),setInterval(s.refreshDeparturesOnly,3e4),window.addEventListener("resize",()=>{requestAnimationFrame(s.alignDepartureColumns)}),window.addEventListener("error",m=>{s.reportClientError("error",m.error||m.message||"Unknown error",{source:m.filename||"",line:m.lineno||null,column:m.colno||null})}),window.addEventListener("unhandledrejection",m=>{s.reportClientError("unhandledrejection",m.reason||"Unhandled promise rejection")}),(()=>{let m=document.getElementById("themeToggle");if(!m)return;let C=document.documentElement,M=window.matchMedia("(prefers-color-scheme: dark)"),N=()=>{let h=s.getStorageItem("theme");return h==="dark"||h==="light"?h:null},f=h=>{C.setAttribute("data-theme",h==="light"?"light":"dark")},$=()=>{let h=N();if(h){f(h);return}f(M.matches?"dark":"light")},U=h=>{N()||f(h.matches?"dark":"light")};$(),typeof M.addEventListener=="function"?M.addEventListener("change",U):typeof M.addListener=="function"&&M.addListener(U),m.addEventListener("click",()=>{let h=C.getAttribute("data-theme")==="dark"?"light":"dark";f(h),s.setStorageItem("theme",h)})})()})();})();
