(()=>{(()=>{let C=window.HMApp||(window.HMApp={}),s=C.api||={};C.dom={locateBtn:document.getElementById("locateBtn"),modeRailBtn:document.getElementById("modeRailBtn"),modeTramBtn:document.getElementById("modeTramBtn"),modeMetroBtn:document.getElementById("modeMetroBtn"),modeBusBtn:document.getElementById("modeBusBtn"),helsinkiOnlyBtn:document.getElementById("helsinkiOnlyBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),permissionCardEl:document.getElementById("permissionCard"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},C.constants={MODE_RAIL:"rail",MODE_TRAM:"tram",MODE_METRO:"metro",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_HELSINKI_ONLY_KEY:"prefs:helsinkiOnly",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_TRAM_KEY:"prefs:resultsLimitTram",STORAGE_RESULTS_LIMIT_METRO_KEY:"prefs:resultsLimitMetro",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_TRAM:8,DEFAULT_RESULTS_LIMIT_METRO:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5};let{MODE_RAIL:n,MODE_TRAM:t,MODE_METRO:A,MODE_BUS:O}=C.constants;C.state={isLoading:!1,currentCoords:null,latestResponse:null,mode:n,helsinkiOnly:!1,busStopId:null,busLineFilters:[],busDestinationFilters:[],resultsLimitByMode:{[n]:C.constants.DEFAULT_RESULTS_LIMIT_RAIL,[t]:C.constants.DEFAULT_RESULTS_LIMIT_TRAM,[A]:C.constants.DEFAULT_RESULTS_LIMIT_METRO,[O]:C.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},suppressBusStopChange:!1,errorReportCount:0,latestLoadToken:0};let{dom:R,state:l,constants:d}=C;function f(i){l.isLoading=i,R.locateBtn&&(R.locateBtn.disabled=i)}function m(i){R.statusEl&&(R.statusEl.textContent=i)}function w(i){R.permissionCardEl&&R.permissionCardEl.classList.toggle("hidden",!i)}function B(i){!R.lastUpdatedEl||!(i instanceof Date)||(R.lastUpdatedEl.textContent=`Last updated: ${i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function M(i){try{return window.localStorage.getItem(i)}catch{return null}}function h(i,c){try{window.localStorage.setItem(i,c)}catch{}}function k(i,c){let U=String(i||"");return U.length<=c?U:U.slice(0,c)}function F(i){if(i instanceof Error)return i;try{let c=typeof i=="string"?i:JSON.stringify(i);return new Error(c||"Unknown error")}catch{return new Error(String(i||"Unknown error"))}}function _(i,c,U=null){if(l.errorReportCount>=d.ERROR_REPORT_LIMIT)return;l.errorReportCount+=1;let D=F(c),$={type:k(i,40),message:k(D.message,400),stack:k(D.stack||"",1200),url:k(window.location.href,500),userAgent:k(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:U&&typeof U=="object"?U:null},v=JSON.stringify($);if(navigator.sendBeacon){let e=new Blob([v],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",e);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:v,keepalive:!0}).catch(()=>{})}function p(i){if(!i)return null;let c=String(i).trim().toLowerCase();return c===n||c===t||c===A||c===O?c:null}function T(i){if(i==null)return null;let c=String(i).trim().toLowerCase();return["1","true","yes","on"].includes(c)?!0:["0","false","no","off"].includes(c)?!1:null}function g(i){return Array.isArray(i)?[...new Set(i.map(c=>String(c||"").trim()).filter(Boolean))]:[]}function L(i){if(i==null||i==="")return null;let c=Number(i);return!Number.isInteger(c)||!d.RESULT_LIMIT_OPTIONS.includes(c)?null:c}function b(i=l.mode){return i===O?d.DEFAULT_RESULTS_LIMIT_BUS:i===A?d.DEFAULT_RESULTS_LIMIT_METRO:i===t?d.DEFAULT_RESULTS_LIMIT_TRAM:d.DEFAULT_RESULTS_LIMIT_RAIL}function u(i=l.mode){let c=L(l.resultsLimitByMode?.[i]);return c??b(i)}function I(i){let c=M(i);if(!c)return[];try{let U=JSON.parse(c);return g(U)}catch{return[]}}function N(){let i=new URLSearchParams(window.location.search);return{mode:p(i.get("mode")),helsinkiOnly:T(i.get("helsinkiOnly")),stopProvided:i.has("stop"),busStopId:i.get("stop")?i.get("stop").trim():null,linesProvided:i.has("line"),busLines:g(i.getAll("line")),destinationsProvided:i.has("dest"),busDestinations:g(i.getAll("dest")),resultsProvided:i.has("results"),resultsLimit:L(i.get("results"))}}function x(){let i=N(),c=p(M(d.STORAGE_MODE_KEY)),U=T(M(d.STORAGE_HELSINKI_ONLY_KEY));l.mode=i.mode||c||n,l.helsinkiOnly=i.helsinkiOnly??U??!1,l.mode!==n&&(l.helsinkiOnly=!1);let D=String(M(d.STORAGE_BUS_STOP_KEY)||"").trim()||null;l.busStopId=i.stopProvided?i.busStopId:D;let $=I(d.STORAGE_BUS_LINES_KEY),v=I(d.STORAGE_BUS_DESTINATIONS_KEY);l.busLineFilters=i.linesProvided?i.busLines:$,l.busDestinationFilters=i.destinationsProvided?i.busDestinations:v;let e=L(M(d.STORAGE_RESULTS_LIMIT_RAIL_KEY)),o=L(M(d.STORAGE_RESULTS_LIMIT_TRAM_KEY)),r=L(M(d.STORAGE_RESULTS_LIMIT_METRO_KEY)),S=L(M(d.STORAGE_RESULTS_LIMIT_BUS_KEY));l.resultsLimitByMode[n]=e??d.DEFAULT_RESULTS_LIMIT_RAIL,l.resultsLimitByMode[t]=o??d.DEFAULT_RESULTS_LIMIT_TRAM,l.resultsLimitByMode[A]=r??d.DEFAULT_RESULTS_LIMIT_METRO,l.resultsLimitByMode[O]=S??d.DEFAULT_RESULTS_LIMIT_BUS,i.resultsProvided&&i.resultsLimit!=null&&(l.resultsLimitByMode[l.mode]=i.resultsLimit)}function G(){h(d.STORAGE_MODE_KEY,l.mode),h(d.STORAGE_HELSINKI_ONLY_KEY,l.helsinkiOnly?"1":"0"),h(d.STORAGE_BUS_STOP_KEY,l.busStopId||""),h(d.STORAGE_BUS_LINES_KEY,JSON.stringify(l.busLineFilters)),h(d.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(l.busDestinationFilters)),h(d.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(u(n))),h(d.STORAGE_RESULTS_LIMIT_TRAM_KEY,String(u(t))),h(d.STORAGE_RESULTS_LIMIT_METRO_KEY,String(u(A))),h(d.STORAGE_RESULTS_LIMIT_BUS_KEY,String(u(O)))}function H(){let i=new URLSearchParams(window.location.search);l.mode===n?i.delete("mode"):i.set("mode",l.mode),l.mode===n&&l.helsinkiOnly?i.set("helsinkiOnly","1"):i.delete("helsinkiOnly");let c=u(),U=b();if(c===U?i.delete("results"):i.set("results",String(c)),i.delete("stop"),i.delete("line"),i.delete("dest"),l.mode===O||l.mode===t||l.mode===A){l.busStopId&&i.set("stop",l.busStopId);for(let v of l.busLineFilters)i.append("line",v);for(let v of l.busDestinationFilters)i.append("dest",v)}let D=i.toString(),$=`${window.location.pathname}${D?`?${D}`:""}${window.location.hash}`;window.history.replaceState(null,"",$)}function Y(){G(),H()}Object.assign(s,{setLoading:f,setStatus:m,setPermissionRequired:w,setLastUpdated:B,getStorageItem:M,setStorageItem:h,safeString:k,toError:F,reportClientError:_,normalizeMode:p,parseBoolean:T,uniqueNonEmptyStrings:g,parseResultLimit:L,getDefaultResultsLimit:b,getActiveResultsLimit:u,parseStoredArray:I,readStateFromUrl:N,hydrateInitialState:x,syncStateToStorage:G,syncStateToUrl:H,persistUiState:Y})})();(()=>{let C=window.HMApp,{api:s,dom:n,state:t,constants:A}=C,{MODE_RAIL:O,MODE_TRAM:R,MODE_METRO:l,MODE_BUS:d}=A;function f(e=t.mode){return e===d||e===R||e===l}function m(e=t.mode){return e===R?{singular:"tram",plural:"trams",title:"Tram"}:e===l?{singular:"metro",plural:"metros",title:"Metro"}:{singular:"bus",plural:"buses",title:"Bus"}}function w(e){let o=B(e);return o<=0?"Now":`${o}m`}function B(e){let o=new Date(e);return Math.floor((o.getTime()-Date.now())/6e4)}function M(e){let o=B(e);return o<=0||o<5?"departure-now":o<=15?"departure-soon":"departure-later"}function h(e){let o=e?.destination||"";return/\bhelsinki\b/i.test(o)}function k(){let e=new Set((t.busFilterOptions.lines||[]).map(r=>r.value)),o=new Set((t.busFilterOptions.destinations||[]).map(r=>r.value));t.busLineFilters=t.busLineFilters.filter(r=>e.has(r)),t.busDestinationFilters=t.busDestinationFilters.filter(r=>o.has(r))}function F(e){if(!Array.isArray(e))return[];if(t.mode===O)return t.helsinkiOnly?e.filter(h):e;if(!f())return e;let o=new Set(t.busLineFilters),r=new Set(t.busDestinationFilters);return e.filter(S=>{if(o.size===0)return!0;let E=String(S?.line||"").trim();return o.has(E)}).filter(S=>{if(r.size===0)return!0;let E=String(S?.destination||"").trim();return r.has(E)})}function _(){if(n.modeRailBtn){let e=t.mode===O;n.modeRailBtn.setAttribute("aria-pressed",String(e)),n.modeRailBtn.classList.toggle("is-active",e)}if(n.modeTramBtn){let e=t.mode===R;n.modeTramBtn.setAttribute("aria-pressed",String(e)),n.modeTramBtn.classList.toggle("is-active",e)}if(n.modeMetroBtn){let e=t.mode===l;n.modeMetroBtn.setAttribute("aria-pressed",String(e)),n.modeMetroBtn.classList.toggle("is-active",e)}if(n.modeBusBtn){let e=t.mode===d;n.modeBusBtn.setAttribute("aria-pressed",String(e)),n.modeBusBtn.classList.toggle("is-active",e)}}function p(){let e=f()?m().title:"Rail",o=f()?`Next ${m().title}`:"Next Train";n.modeEyebrowEl&&(n.modeEyebrowEl.textContent=`Helsinki Moves \u2022 ${e}`),n.nextLabelEl&&(n.nextLabelEl.textContent=o)}function T(){if(!n.resultsLimitSelectEl)return;let e=Array.isArray(A.RESULT_LIMIT_OPTIONS)?A.RESULT_LIMIT_OPTIONS:[],o=s.getActiveResultsLimit();n.resultsLimitSelectEl.innerHTML="";for(let r of e){let S=document.createElement("option");S.value=String(r),S.textContent=`${r}`,n.resultsLimitSelectEl.appendChild(S)}n.resultsLimitSelectEl.value=String(o)}function g(){if(n.helsinkiOnlyBtn){if(t.mode!==O){n.helsinkiOnlyBtn.setAttribute("aria-pressed","false"),n.helsinkiOnlyBtn.classList.remove("is-active"),n.helsinkiOnlyBtn.disabled=!0,n.helsinkiOnlyBtn.textContent="Helsinki Only (Rail)";return}n.helsinkiOnlyBtn.disabled=!1,n.helsinkiOnlyBtn.setAttribute("aria-pressed",String(t.helsinkiOnly)),n.helsinkiOnlyBtn.classList.toggle("is-active",t.helsinkiOnly),n.helsinkiOnlyBtn.textContent=t.helsinkiOnly?"Helsinki Only: On":"Helsinki Only: Off"}}function L(e){n.busControlsEl&&n.busControlsEl.classList.toggle("hidden",!e)}function b(e){return t.busStops.find(o=>o.id===e)||null}function u(e){let o=s.uniqueNonEmptyStrings([...Array.isArray(e?.stopCodes)?e.stopCodes:[],e?.code]);return o.length===0&&e?.id&&o.push(String(e.id)),o}function I(e,o=null){let r=b(t.busStopId),S=String(o?.stopName||e?.stopName||r?.name||"").trim(),a=s.uniqueNonEmptyStrings([o?.stopCode,...Array.isArray(e?.stopCodes)?e.stopCodes:[],e?.stopCode,...u(r)])[0]||"";return S&&a?`${S} ${a}`:S||a||"\u2014"}function N(e,o=null){if(f())return I(e,o);let r=String(o?.stopName||e?.stopName||"").trim(),S=String(o?.stopCode||e?.stopCode||"").trim();return r&&S?`${r} ${S}`:r||S||"\u2014"}function x(e){if(!n.dataScopeEl)return;if(!f()){n.dataScopeEl.classList.add("hidden"),n.dataScopeEl.textContent="";return}let o=String(e?.station?.stopName||b(t.busStopId)?.name||"").trim(),S=s.uniqueNonEmptyStrings([...Array.isArray(e?.station?.stopCodes)?e.station.stopCodes:[],e?.station?.stopCode,...u(b(t.busStopId))]).join(", "),E=t.busLineFilters.length===0?"all lines":`${t.busLineFilters.length} line${t.busLineFilters.length===1?"":"s"} selected`,a=t.busDestinationFilters.length===0?"all destinations":`${t.busDestinationFilters.length} destination${t.busDestinationFilters.length===1?"":"s"} selected`,y=`${s.getActiveResultsLimit()} results`;o?n.dataScopeEl.textContent=`Selected stop ${o} (${S||"\u2014"}) - ${E}, ${a}, ${y}`:n.dataScopeEl.textContent=`Selecting stop... (${E}, ${a}, ${y})`,n.dataScopeEl.classList.remove("hidden")}function G(e,o,r,S){if(!e)return;if(e.innerHTML="",!Array.isArray(o)||o.length===0){let a=document.createElement("span");a.className="chip-empty",a.textContent="No options",e.appendChild(a);return}let E=new Set(r);for(let a of o){let y=document.createElement("button");y.type="button",y.className="chip-toggle",E.has(a.value)?(y.classList.add("is-active"),y.setAttribute("aria-pressed","true")):y.setAttribute("aria-pressed","false"),y.textContent=`${a.value} (${a.count})`,y.addEventListener("click",()=>S(a.value)),e.appendChild(y)}}function H(){let e=f();if(L(e),!!e){if(n.busStopSelectEl){if(t.suppressBusStopChange=!0,n.busStopSelectEl.innerHTML="",t.busStops.length===0){let o=document.createElement("option");o.value="",o.textContent=`No nearby ${m().singular} stops`,n.busStopSelectEl.appendChild(o),n.busStopSelectEl.disabled=!0}else{n.busStopSelectEl.disabled=!1;for(let o of t.busStops){let r=document.createElement("option");r.value=o.id,r.textContent=`${o.name} (${o.distanceMeters}m)`,n.busStopSelectEl.appendChild(r)}t.busStopId&&t.busStops.some(o=>o.id===t.busStopId)?n.busStopSelectEl.value=t.busStopId:n.busStopSelectEl.value=t.busStops[0].id}t.suppressBusStopChange=!1}G(n.busLineFiltersEl,t.busFilterOptions.lines,t.busLineFilters,o=>{t.busLineFilters.includes(o)?t.busLineFilters=t.busLineFilters.filter(r=>r!==o):t.busLineFilters=[...t.busLineFilters,o],s.persistUiState(),t.latestResponse&&(s.render(t.latestResponse),s.setStatus(s.buildStatusFromResponse(t.latestResponse)))}),G(n.busDestinationFiltersEl,t.busFilterOptions.destinations,t.busDestinationFilters,o=>{t.busDestinationFilters.includes(o)?t.busDestinationFilters=t.busDestinationFilters.filter(r=>r!==o):t.busDestinationFilters=[...t.busDestinationFilters,o],s.persistUiState(),t.latestResponse&&(s.render(t.latestResponse),s.setStatus(s.buildStatusFromResponse(t.latestResponse)))})}}function Y(e,o=null){if(!n.nextSummaryEl||!n.nextMinsEl||!n.nextLineEl||!n.nextTrackEl||!n.nextDestinationEl)return;if(!e){n.nextSummaryEl.classList.add("hidden"),n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later");return}let r=B(e.departureIso);n.nextMinsEl.textContent=w(e.departureIso),n.nextLineEl.textContent=e.line||"\u2014",n.nextLineEl.classList.toggle("next-letter-now",r<5),n.nextTrackEl.textContent=f()?`Stop ${N(o,e)}`:e.track?`Track ${e.track}`:"Track \u2014",n.nextDestinationEl.textContent=e.destination||"\u2014",n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),r<5?n.nextSummaryEl.classList.add("next-summary-now"):r<=15?n.nextSummaryEl.classList.add("next-summary-soon"):n.nextSummaryEl.classList.add("next-summary-later"),n.nextSummaryEl.classList.remove("hidden")}function i(e){if(!e||!e.station)return f()?e?.message||`No nearby ${m().singular} stops found.`:e?.message||"No nearby train stations found.";let r=F(e.station.departures)[0];if(!r){if(f()){let y=m().plural;return t.busLineFilters.length>0||t.busDestinationFilters.length>0?`No upcoming ${y} match selected filters.`:`No upcoming ${y} right now.`}return t.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now."}let S=r.destination?` \u2022 ${r.destination}`:"",E=t.mode===O?r.track?` \u2022 Track ${r.track}`:"":e.station.stopName||e.station.stopCode?` \u2022 ${N(e.station,r)}`:"",a=f()?m().singular:"train";return`Next ${r.line||a} in ${w(r.departureIso)}${S}${E}`}function c(e){if(!(e instanceof Error))return"Could not refresh departures. Please try again.";if(e.name==="AbortError")return"Request timed out. Please try again.";let o=(e.message||"").trim();return o==="Temporary server error. Please try again."?o:o==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":o==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function U(e){return e?.code===1?"Location permission denied.":e?.code===2?"Location unavailable. Please try again.":e?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function D(){let e=[...document.querySelectorAll(".departure-row .train-top")];if(e.length===0)return;let o=e.map(a=>a.querySelector(".destination")).filter(Boolean);for(let a of o)a.style.width="auto";let r=0;for(let a of o)r=Math.max(r,Math.ceil(a.scrollWidth));let S=Number.POSITIVE_INFINITY;for(let a of e){let y=a.querySelector(".time");if(!y)continue;let K=getComputedStyle(a),q=parseFloat(K.columnGap||K.gap||"0")||0,P=a.clientWidth-y.offsetWidth-q;P>0&&(S=Math.min(S,P))}let E=Math.max(0,Math.min(r,S));for(let a of o)a.style.width=`${E}px`}function $(e){if(H(),x(e),!e||!e.station){n.resultEl.classList.add("hidden"),Y(null);return}let o=e.station;n.resultEl.classList.remove("hidden"),n.stationTitleEl.textContent=o.stopName,n.stationMetaEl.textContent=`${o.distanceMeters}m away`,n.departuresEl.innerHTML="";let r=F(o.departures);if(r.length===0){Y(null);let E=document.createElement("li");if(E.className="empty-row",f()){let a=m().plural;E.textContent=t.busLineFilters.length>0||t.busDestinationFilters.length>0?`No upcoming ${a} match selected filters.`:`No upcoming ${a} right now.`}else E.textContent=t.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.";n.departuresEl.appendChild(E);return}Y(r[0],o);let S=r.slice(1);if(S.length===0){let E=document.createElement("li");E.className="empty-row",E.textContent=f()?`No additional upcoming ${m().plural} right now.`:"No additional upcoming commuter trains right now.",n.departuresEl.appendChild(E);return}for(let E=0;E<S.length;E++){let a=S[E],y=document.createElement("li");y.className=`departure-row ${M(a.departureIso)}`,y.style.setProperty("--i",E);let K=document.createElement("div");K.className="letter-badge",K.textContent=a.line||"?";let q=document.createElement("div");q.className="train";let P=document.createElement("div");P.className="train-top";let W=document.createElement("div");W.className="destination",W.textContent=a.destination||"\u2014",P.appendChild(W);let j=document.createElement("div");j.className="time";let J=document.createElement("span");J.className="remaining",J.textContent=w(a.departureIso);let V=document.createElement("span");V.className="clock-time",V.textContent=new Date(a.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),j.appendChild(J),j.appendChild(V),P.appendChild(j),q.appendChild(P);let z=document.createElement("span");z.className="track",f()?z.textContent=`Stop ${N(o,a)}`:z.textContent=a.track?`Track ${a.track}`:"Track \u2014",q.appendChild(z),y.appendChild(K),y.appendChild(q),n.departuresEl.appendChild(y)}requestAnimationFrame(D)}function v(){n.nowClockEl&&(n.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(s,{formatMinutes:w,minutesUntil:B,departureRowClass:M,isHelsinkiBound:h,sanitizeStopSelections:k,getVisibleDepartures:F,updateModeButtons:_,updateModeLabels:p,renderResultsLimitControl:T,updateHelsinkiFilterButton:g,setStopControlsVisibility:L,getStopMeta:b,getStopCodes:u,buildStopDisplay:I,buildModeStopDisplay:N,updateDataScope:x,renderFilterButtons:G,renderStopControls:H,updateNextSummary:Y,buildStatusFromResponse:i,getLoadErrorStatus:c,getGeolocationErrorStatus:U,alignDepartureColumns:D,render:$,updateClock:v})})();(()=>{let C=window.HMApp,{api:s,dom:n,state:t,constants:A}=C,{MODE_TRAM:O,MODE_METRO:R,MODE_BUS:l}=A;function d(p){return p===l||p===O||p===R}function f(p){return new Promise(T=>setTimeout(T,p))}async function m(p,T={},g=A.FETCH_TIMEOUT_MS){let L=new AbortController,b=setTimeout(()=>L.abort(),g);try{return await fetch(p,{...T,signal:L.signal})}finally{clearTimeout(b)}}async function w(p,T={}){let g;try{g=await m(p,T)}catch{return await f(350),m(p,T)}return g.status>=500?(await f(350),m(p,T)):g}function B(p){let T=new Map,g=new Map;for(let b of p||[]){let u=String(b?.line||"").trim();u&&T.set(u,(T.get(u)||0)+1);let I=String(b?.destination||"").trim();I&&g.set(I,(g.get(I)||0)+1)}let L=b=>[...b.entries()].sort((u,I)=>I[1]-u[1]||u[0].localeCompare(I[0])).map(([u,I])=>({value:u,count:I}));return{lines:L(T),destinations:L(g)}}function M(p){let T=Array.isArray(p?.stops)?p.stops.filter(u=>u&&u.id&&u.name).map(u=>({id:u.id,name:u.name,code:String(u.code||"").trim()||null,stopCodes:s.uniqueNonEmptyStrings([...Array.isArray(u.stopCodes)?u.stopCodes:[],u.code]),distanceMeters:Number(u.distanceMeters)||0})):[];t.busStops=T;let g=String(p?.selectedStopId||"").trim()||null,L=u=>T.some(I=>I.id===u);g&&L(g)?t.busStopId=g:(!t.busStopId||!L(t.busStopId))&&(t.busStopId=T[0]?.id||null);let b=Array.isArray(p?.station?.departures)?p.station.departures:[];t.busFilterOptions=B(b),s.sanitizeStopSelections()}async function h(p,T){let g=++t.latestLoadToken,L=t.mode,b=t.busStopId;s.setLoading(!0),s.setStatus("Loading departures...");try{let u=new URLSearchParams({lat:String(p),lon:String(T),mode:L.toUpperCase(),results:String(s.getActiveResultsLimit(L))});d(L)&&b&&u.set("stopId",b);let I=await w(`/api/v1/departures?${u.toString()}`);if(!(I.headers.get("content-type")||"").includes("application/json"))throw I.ok?new Error("Unexpected server response."):new Error("Request failed");let x=await I.json();if(!I.ok)throw new Error(x.error||"Request failed");if(g!==t.latestLoadToken)return;d(L)&&(M(x),s.persistUiState()),t.latestResponse=x,s.render(x),s.setPermissionRequired(!1),s.setLastUpdated(new Date),s.setStatus(s.buildStatusFromResponse(x))}catch(u){if(g!==t.latestLoadToken)return;t.latestResponse=null,console.error("load departures error:",u),s.reportClientError("load",u,{mode:L}),s.setStatus(s.getLoadErrorStatus(u)),n.resultEl.classList.add("hidden"),s.updateNextSummary(null)}finally{g===t.latestLoadToken&&s.setLoading(!1)}}function k(){return navigator.geolocation?t.isLoading?!1:(s.setStatus("Getting your location..."),s.setLoading(!0),navigator.geolocation.getCurrentPosition(p=>{t.currentCoords={lat:p.coords.latitude,lon:p.coords.longitude},s.setPermissionRequired(!1),s.setLoading(!1),h(t.currentCoords.lat,t.currentCoords.lon)},p=>{if(s.setLoading(!1),p.code===1){s.setPermissionRequired(!0),s.setStatus(s.getGeolocationErrorStatus(p)),t.latestResponse=null,n.resultEl.classList.add("hidden"),s.updateNextSummary(null);return}s.setPermissionRequired(!1),s.setStatus(s.getGeolocationErrorStatus(p)),t.latestResponse=null,n.resultEl.classList.add("hidden"),s.updateNextSummary(null)},{enableHighAccuracy:!1,timeout:1e4,maximumAge:0}),!0):(s.setStatus("Geolocation not supported in this browser."),s.setPermissionRequired(!0),!1)}function F(){if(t.currentCoords){h(t.currentCoords.lat,t.currentCoords.lon);return}k()}function _(){s.updateModeButtons(),s.updateModeLabels(),s.renderResultsLimitControl(),s.updateHelsinkiFilterButton(),s.renderStopControls(),s.updateDataScope(t.latestResponse)}Object.assign(s,{delay:f,fetchWithTimeout:m,fetchWithRetryOnce:w,updateStopModeStateFromResponse:M,buildFilterOptionsFromDepartures:B,load:h,requestLocationAndLoad:k,refreshDeparturesOnly:F,applyModeUiState:_})})();(()=>{let C=window.HMApp,{api:s,dom:n,state:t,constants:A}=C,{MODE_RAIL:O,MODE_TRAM:R,MODE_METRO:l,MODE_BUS:d}=A;function f(){if(t.currentCoords){s.load(t.currentCoords.lat,t.currentCoords.lon);return}s.requestLocationAndLoad()}n.locateBtn?.addEventListener("click",()=>{s.requestLocationAndLoad()}),n.modeRailBtn?.addEventListener("click",()=>{t.mode!==O&&(t.mode=O,s.applyModeUiState(),s.persistUiState(),f())}),n.modeTramBtn?.addEventListener("click",()=>{t.mode!==R&&(t.mode=R,t.helsinkiOnly=!1,s.applyModeUiState(),s.persistUiState(),f())}),n.modeMetroBtn?.addEventListener("click",()=>{t.mode!==l&&(t.mode=l,t.helsinkiOnly=!1,s.applyModeUiState(),s.persistUiState(),f())}),n.modeBusBtn?.addEventListener("click",()=>{t.mode!==d&&(t.mode=d,t.helsinkiOnly=!1,s.applyModeUiState(),s.persistUiState(),f())}),n.resultsLimitSelectEl?.addEventListener("change",()=>{let m=s.parseResultLimit(n.resultsLimitSelectEl.value);if(m==null){s.renderResultsLimitControl();return}s.getActiveResultsLimit()!==m&&(t.resultsLimitByMode[t.mode]=m,s.persistUiState(),f())}),n.busStopSelectEl?.addEventListener("change",()=>{if(t.suppressBusStopChange||t.mode!==d&&t.mode!==R&&t.mode!==l)return;let m=String(n.busStopSelectEl.value||"").trim();!m||m===t.busStopId||(t.busStopId=m,s.persistUiState(),t.currentCoords&&s.load(t.currentCoords.lat,t.currentCoords.lon))}),n.helsinkiOnlyBtn?.addEventListener("click",()=>{t.mode===O&&(t.helsinkiOnly=!t.helsinkiOnly,s.persistUiState(),s.updateHelsinkiFilterButton(),t.latestResponse&&(s.render(t.latestResponse),s.setStatus(s.buildStatusFromResponse(t.latestResponse))))}),s.hydrateInitialState(),s.persistUiState(),s.applyModeUiState(),s.updateClock(),setInterval(s.updateClock,1e3),s.requestLocationAndLoad(),setInterval(s.refreshDeparturesOnly,3e4),window.addEventListener("resize",()=>{requestAnimationFrame(s.alignDepartureColumns)}),window.addEventListener("error",m=>{s.reportClientError("error",m.error||m.message||"Unknown error",{source:m.filename||"",line:m.lineno||null,column:m.colno||null})}),window.addEventListener("unhandledrejection",m=>{s.reportClientError("unhandledrejection",m.reason||"Unhandled promise rejection")}),(()=>{let m=document.getElementById("themeToggle");if(!m)return;let w=document.documentElement,B=window.matchMedia("(prefers-color-scheme: dark)"),M=()=>{let _=s.getStorageItem("theme");return _==="dark"||_==="light"?_:null},h=_=>{w.setAttribute("data-theme",_==="light"?"light":"dark")},k=()=>{let _=M();if(_){h(_);return}h(B.matches?"dark":"light")},F=_=>{M()||h(_.matches?"dark":"light")};k(),typeof B.addEventListener=="function"?B.addEventListener("change",F):typeof B.addListener=="function"&&B.addListener(F),m.addEventListener("click",()=>{let _=w.getAttribute("data-theme")==="dark"?"light":"dark";h(_),s.setStorageItem("theme",_)})})()})();})();
