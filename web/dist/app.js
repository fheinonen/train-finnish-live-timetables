(()=>{(()=>{let x=window.HMApp||(window.HMApp={}),n=x.api||={};x.dom={locateBtn:document.getElementById("locateBtn"),voiceLocateBtn:document.getElementById("voiceLocateBtn"),voiceLocateBtnLabel:document.getElementById("voiceLocateBtnLabel"),skeletonEl:document.getElementById("skeleton"),segmentControlEl:document.querySelector(".segment-control"),modeRailBtn:document.getElementById("modeRailBtn"),modeTramBtn:document.getElementById("modeTramBtn"),modeMetroBtn:document.getElementById("modeMetroBtn"),modeBusBtn:document.getElementById("modeBusBtn"),helsinkiOnlyBtn:document.getElementById("helsinkiOnlyBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busStopSelectLabelEl:document.getElementById("busStopSelectLabel"),busStopSelectListEl:document.getElementById("busStopSelectList"),busStopSelectWrapEl:document.getElementById("busStopSelectWrap"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),stopFiltersToggleBtnEl:document.getElementById("stopFiltersToggleBtn"),stopFiltersPanelEl:document.getElementById("stopFiltersPanel"),stopFilterSummaryEl:document.getElementById("stopFilterSummary"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),resultsLimitSelectLabelEl:document.getElementById("resultsLimitSelectLabel"),resultsLimitSelectListEl:document.getElementById("resultsLimitSelectList"),resultsLimitSelectWrapEl:document.getElementById("resultsLimitSelectWrap"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),resolvedLocationEl:document.getElementById("resolvedLocation"),voiceLocationChoicesEl:document.getElementById("voiceLocationChoices"),voiceLocationChoicesTitleEl:document.getElementById("voiceLocationChoicesTitle"),voiceLocationChoicesOptionsEl:document.getElementById("voiceLocationChoicesOptions"),voiceLocationChoicesCancelEl:document.getElementById("voiceLocationChoicesCancel"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),locationPromptCardEl:document.getElementById("locationPromptCard"),locationPromptAllowEl:document.getElementById("locationPromptAllow"),permissionCardEl:document.getElementById("permissionCard"),permissionRetryBtnEl:document.getElementById("permissionRetryBtn"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},x.constants={MODE_RAIL:"rail",MODE_TRAM:"tram",MODE_METRO:"metro",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_HELSINKI_ONLY_KEY:"prefs:helsinkiOnly",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_TRAM_KEY:"prefs:resultsLimitTram",STORAGE_RESULTS_LIMIT_METRO_KEY:"prefs:resultsLimitMetro",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_TRAM:8,DEFAULT_RESULTS_LIMIT_METRO:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],VOICE_RECOGNITION_TIMEOUT_MS:8e3,VOICE_SILENCE_STOP_MS:1200,VOICE_QUERY_MIN_LENGTH:3,FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5,METRIC_REPORT_LIMIT:10,METRIC_SAMPLE_RATE:1};let{MODE_RAIL:t,MODE_TRAM:e,MODE_METRO:A,MODE_BUS:N}=x.constants;x.state={locationGranted:!1,isLoading:!1,isVoiceListening:!1,currentCoords:null,latestResponse:null,mode:t,helsinkiOnly:!1,busStopId:null,busLineFilters:[],busDestinationFilters:[],stopFiltersPanelOpen:!1,deferInitialStopContext:!1,deferredBusStopId:null,deferredBusLineFilters:[],deferredBusDestinationFilters:[],resultsLimitByMode:{[t]:x.constants.DEFAULT_RESULTS_LIMIT_RAIL,[e]:x.constants.DEFAULT_RESULTS_LIMIT_TRAM,[A]:x.constants.DEFAULT_RESULTS_LIMIT_METRO,[N]:x.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},resolvedLocationHint:null,suppressBusStopChange:!1,hasCompletedInitialStopModeLoad:!1,errorReportCount:0,metricReportCount:0,isMetricSessionSampled:Math.random()<x.constants.METRIC_SAMPLE_RATE,sessionStartedAtMs:Date.now(),hasReportedFirstSuccessfulRenderMetric:!1,hasReportedFirstManualInteractionMetric:!1,hasReportedFirstManualStopContextMetric:!1,hasReportedInitialNearestStopResolvedMetric:!1,latestLoadToken:0};let{dom:_,state:a,constants:y}=x;function w(){let o=a.isLoading||a.isVoiceListening,c=a.isLoading;_.locateBtn&&(_.locateBtn.disabled=o),_.voiceLocateBtn&&(_.voiceLocateBtn.disabled=c,_.voiceLocateBtn.classList.toggle("is-listening",a.isVoiceListening),_.voiceLocateBtn.setAttribute("aria-pressed",String(a.isVoiceListening))),_.voiceLocateBtnLabel&&(_.voiceLocateBtnLabel.textContent=a.isVoiceListening?"Listening...":"Describe Location")}function U(o){a.isLoading=o,w(),_.skeletonEl&&_.skeletonEl.classList.toggle("hidden",!o)}function D(o){a.isVoiceListening=!!o,w()}function q(o){_.statusEl&&(_.statusEl.textContent=o)}function p(o){let c=Number(o);return Number.isFinite(c)?c.toFixed(5):null}function h(o){let c=o&&typeof o=="object";if(a.resolvedLocationHint=c?{query:B(o.query,120).trim(),label:B(o.label,180).trim(),lat:Number(o.lat),lon:Number(o.lon)}:null,!_.resolvedLocationEl)return;if(!a.resolvedLocationHint){_.resolvedLocationEl.classList.add("hidden"),_.resolvedLocationEl.textContent="";return}let T=a.resolvedLocationHint.label||"Unknown place",v=a.resolvedLocationHint.query,i=p(a.resolvedLocationHint.lat),s=p(a.resolvedLocationHint.lon),l=v?` (from "${v}")`:"",m=i&&s?` - ${i}, ${s}`:"";_.resolvedLocationEl.textContent=`Resolved location: ${T}${l}${m}`,_.resolvedLocationEl.classList.remove("hidden")}function O(){_.locationPromptCardEl&&_.locationPromptCardEl.classList.remove("hidden"),_.permissionCardEl&&_.permissionCardEl.classList.add("hidden")}function I(){_.locationPromptCardEl&&_.locationPromptCardEl.classList.add("hidden")}function k(o){I(),_.permissionCardEl&&_.permissionCardEl.classList.toggle("hidden",!o)}function F(o){!_.lastUpdatedEl||!(o instanceof Date)||(_.lastUpdatedEl.textContent=`Last updated: ${o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function M(o){try{return window.localStorage.getItem(o)}catch{return null}}function R(o,c){try{window.localStorage.setItem(o,c)}catch{}}function B(o,c){let T=String(o||"");return T.length<=c?T:T.slice(0,c)}function X(o){if(o instanceof Error)return o;try{let c=typeof o=="string"?o:JSON.stringify(o);return new Error(c||"Unknown error")}catch{return new Error(String(o||"Unknown error"))}}function Z(o){let c=JSON.stringify(o);if(navigator.sendBeacon){let T=new Blob([c],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",T);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:c,keepalive:!0}).catch(()=>{})}function Y(o,c,T=null){if(a.errorReportCount>=y.ERROR_REPORT_LIMIT)return;a.errorReportCount+=1;let v=X(c),i={type:B(o,40),message:B(v.message,400),stack:B(v.stack||"",1200),url:B(window.location.href,500),userAgent:B(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:T&&typeof T=="object"?T:null};Z(i)}function V(){return Math.max(0,Date.now()-a.sessionStartedAtMs)}function G(o,c=null){if(!a.isMetricSessionSampled||a.metricReportCount>=y.METRIC_REPORT_LIMIT)return!1;a.metricReportCount+=1;let T={type:"metric",message:B(o,400),stack:"",url:B(window.location.href,500),userAgent:B(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:{metricName:B(o,80),sessionElapsedMs:V(),mode:a.mode,...c&&typeof c=="object"?c:{}}};return Z(T),!0}function ee(o,c){if(a.hasReportedFirstSuccessfulRenderMetric)return;a.hasReportedFirstSuccessfulRenderMetric=!0;let T=Array.isArray(o?.station?.departures)?o.station.departures:[];G("first_successful_render",{requestMode:String(c||"").trim(),hasStation:!!o?.station,departureCount:T.length})}function te(o,c=null){a.hasReportedFirstManualInteractionMetric||(a.hasReportedFirstManualInteractionMetric=!0,G("first_manual_interaction",{interactionType:B(o,80),...c&&typeof c=="object"?c:{}}))}function K(o,c=null){a.hasReportedFirstManualStopContextMetric||(a.hasReportedFirstManualStopContextMetric=!0,G("first_manual_stop_context_change",{changeType:B(o,80),lineFilterCount:a.busLineFilters.length,destinationFilterCount:a.busDestinationFilters.length,...c&&typeof c=="object"?c:{}}))}function j(o,c){if(a.hasReportedInitialNearestStopResolvedMetric)return;let T=String(o?.selectedStopId||"").trim();if(!T)return;a.hasReportedInitialNearestStopResolvedMetric=!0;let i=(Array.isArray(o?.stops)?o.stops:[]).find(l=>l?.id===T)||null,s=Array.isArray(o?.station?.departures)?o.station.departures:[];G("initial_nearest_stop_resolved",{requestMode:String(c||"").trim(),selectedStopId:T,distanceMeters:Number(i?.distanceMeters)||null,departureCount:s.length})}function z(o){if(!o)return null;let c=String(o).trim().toLowerCase();return c===t||c===e||c===A||c===N?c:null}function P(o){if(o==null)return null;let c=String(o).trim().toLowerCase();return["1","true","yes","on"].includes(c)?!0:["0","false","no","off"].includes(c)?!1:null}function H(o){return Array.isArray(o)?[...new Set(o.map(c=>String(c||"").trim()).filter(Boolean))]:[]}function $(o){if(o==null||o==="")return null;let c=Number(o);return!Number.isInteger(c)||!y.RESULT_LIMIT_OPTIONS.includes(c)?null:c}function W(o=a.mode){return o===N?y.DEFAULT_RESULTS_LIMIT_BUS:o===A?y.DEFAULT_RESULTS_LIMIT_METRO:o===e?y.DEFAULT_RESULTS_LIMIT_TRAM:y.DEFAULT_RESULTS_LIMIT_RAIL}function r(o=a.mode){let c=$(a.resultsLimitByMode?.[o]);return c??W(o)}function u(o){let c=M(o);if(!c)return[];try{let T=JSON.parse(c);return H(T)}catch{return[]}}function d(){let o=new URLSearchParams(window.location.search);return{mode:z(o.get("mode")),helsinkiOnly:P(o.get("helsinkiOnly")),stopProvided:o.has("stop"),busStopId:o.get("stop")?o.get("stop").trim():null,linesProvided:o.has("line"),busLines:H(o.getAll("line")),destinationsProvided:o.has("dest"),busDestinations:H(o.getAll("dest")),resultsProvided:o.has("results"),resultsLimit:$(o.get("results"))}}function g(){let o=d(),c=z(M(y.STORAGE_MODE_KEY)),T=P(M(y.STORAGE_HELSINKI_ONLY_KEY));a.mode=o.mode||c||t,a.helsinkiOnly=o.helsinkiOnly??T??!1,a.mode!==t&&(a.helsinkiOnly=!1);let v=String(M(y.STORAGE_BUS_STOP_KEY)||"").trim()||null,i=o.stopProvided?o.busStopId:v,s=u(y.STORAGE_BUS_LINES_KEY),l=u(y.STORAGE_BUS_DESTINATIONS_KEY),m=o.linesProvided?o.busLines:s,b=o.destinationsProvided?o.busDestinations:l,L=!!i||m.length>0||b.length>0;a.deferInitialStopContext=L,L?(a.deferredBusStopId=i,a.deferredBusLineFilters=[...m],a.deferredBusDestinationFilters=[...b],a.busStopId=null,a.busLineFilters=[],a.busDestinationFilters=[]):(a.deferredBusStopId=null,a.deferredBusLineFilters=[],a.deferredBusDestinationFilters=[],a.busStopId=i,a.busLineFilters=m,a.busDestinationFilters=b);let C=$(M(y.STORAGE_RESULTS_LIMIT_RAIL_KEY)),J=$(M(y.STORAGE_RESULTS_LIMIT_TRAM_KEY)),Q=$(M(y.STORAGE_RESULTS_LIMIT_METRO_KEY)),ne=$(M(y.STORAGE_RESULTS_LIMIT_BUS_KEY));a.resultsLimitByMode[t]=C??y.DEFAULT_RESULTS_LIMIT_RAIL,a.resultsLimitByMode[e]=J??y.DEFAULT_RESULTS_LIMIT_TRAM,a.resultsLimitByMode[A]=Q??y.DEFAULT_RESULTS_LIMIT_METRO,a.resultsLimitByMode[N]=ne??y.DEFAULT_RESULTS_LIMIT_BUS,o.resultsProvided&&o.resultsLimit!=null&&(a.resultsLimitByMode[a.mode]=o.resultsLimit)}function f(){R(y.STORAGE_MODE_KEY,a.mode),R(y.STORAGE_HELSINKI_ONLY_KEY,a.helsinkiOnly?"1":"0"),R(y.STORAGE_BUS_STOP_KEY,a.busStopId||""),R(y.STORAGE_BUS_LINES_KEY,JSON.stringify(a.busLineFilters)),R(y.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(a.busDestinationFilters)),R(y.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(r(t))),R(y.STORAGE_RESULTS_LIMIT_TRAM_KEY,String(r(e))),R(y.STORAGE_RESULTS_LIMIT_METRO_KEY,String(r(A))),R(y.STORAGE_RESULTS_LIMIT_BUS_KEY,String(r(N)))}function S(){let o=new URLSearchParams(window.location.search);a.mode===t?o.delete("mode"):o.set("mode",a.mode),a.mode===t&&a.helsinkiOnly?o.set("helsinkiOnly","1"):o.delete("helsinkiOnly");let c=r(),T=W();if(c===T?o.delete("results"):o.set("results",String(c)),o.delete("stop"),o.delete("line"),o.delete("dest"),a.mode===N||a.mode===e||a.mode===A){a.busStopId&&o.set("stop",a.busStopId);for(let s of a.busLineFilters)o.append("line",s);for(let s of a.busDestinationFilters)o.append("dest",s)}let v=o.toString(),i=`${window.location.pathname}${v?`?${v}`:""}${window.location.hash}`;window.history.replaceState(null,"",i)}function E(){f(),S()}w(),Object.assign(n,{updateLocationActionButtons:w,setLoading:U,setVoiceListening:D,setStatus:q,setResolvedLocationHint:h,showLocationPrompt:O,hideLocationPrompt:I,setPermissionRequired:k,setLastUpdated:F,getStorageItem:M,setStorageItem:R,safeString:B,toError:X,sendClientReport:Z,reportClientError:Y,reportClientMetric:G,getSessionElapsedMs:V,trackFirstSuccessfulRender:ee,trackFirstManualInteraction:te,trackFirstManualStopContextChange:K,trackInitialNearestStopResolved:j,normalizeMode:z,parseBoolean:P,uniqueNonEmptyStrings:H,parseResultLimit:$,getDefaultResultsLimit:W,getActiveResultsLimit:r,parseStoredArray:u,readStateFromUrl:d,hydrateInitialState:g,syncStateToStorage:f,syncStateToUrl:S,persistUiState:E})})();(()=>{let x=window.HMApp,{api:n,dom:t,state:e,constants:A}=x,{MODE_RAIL:N,MODE_TRAM:_,MODE_METRO:a,MODE_BUS:y}=A;function w(i=e.mode){return i===y||i===_||i===a}function U(i=e.mode){return i===_?{singular:"tram",plural:"trams",title:"Tram"}:i===a?{singular:"metro",plural:"metros",title:"Metro"}:{singular:"bus",plural:"buses",title:"Bus"}}function D(i){let s=q(i);return s<=0?"Now":`${s}m`}function q(i){let s=new Date(i);return Math.floor((s.getTime()-Date.now())/6e4)}function p(i){let s=q(i);return s<=0||s<3?"departure-now":s<=10?"departure-soon":"departure-later"}function h(i){let s=i?.destination||"";return/\bhelsinki\b/i.test(s)}function O(){let i=new Set((e.busFilterOptions.lines||[]).map(l=>l.value)),s=new Set((e.busFilterOptions.destinations||[]).map(l=>l.value));e.busLineFilters=e.busLineFilters.filter(l=>i.has(l)),e.busDestinationFilters=e.busDestinationFilters.filter(l=>s.has(l))}function I(i){if(!Array.isArray(i))return[];if(e.mode===N)return e.helsinkiOnly?i.filter(h):i;if(!w())return i;let s=new Set(e.busLineFilters),l=new Set(e.busDestinationFilters);return i.filter(m=>{if(s.size===0)return!0;let b=String(m?.line||"").trim();return s.has(b)}).filter(m=>{if(l.size===0)return!0;let b=String(m?.destination||"").trim();return l.has(b)})}function k(){let i=[{el:t.modeRailBtn,mode:N,index:0},{el:t.modeTramBtn,mode:_,index:1},{el:t.modeMetroBtn,mode:a,index:2},{el:t.modeBusBtn,mode:y,index:3}];for(let{el:s,mode:l,index:m}of i){if(!s)continue;let b=e.mode===l;if(s.setAttribute("aria-checked",String(b)),s.classList.toggle("is-active",b),b){let L=s.closest(".segment-control");L&&L.style.setProperty("--active-index",m)}}}function F(){let i=w()?U().title:"Rail",s=w()?`Next ${U().title}`:"Next Train";t.modeEyebrowEl&&(t.modeEyebrowEl.textContent=`Helsinki Moves \u2022 ${i}`),t.nextLabelEl&&(t.nextLabelEl.textContent=s)}function M(i){if(!t.resultsLimitSelectEl||!t.resultsLimitSelectListEl)return;let s=t.resultsLimitSelectEl.getAttribute("aria-expanded")==="true",l=typeof i=="boolean"?i:!s;t.resultsLimitSelectEl.setAttribute("aria-expanded",String(l)),t.resultsLimitSelectListEl.classList.toggle("hidden",!l)}function R(i){let s=n.parseResultLimit(i);s==null||(M(!1),n.getActiveResultsLimit()===s)||(n.trackFirstManualInteraction("results_limit_change",{nextLimit:s,currentMode:e.mode}),e.resultsLimitByMode[e.mode]=s,n.persistUiState(),t.resultsLimitSelectLabelEl&&(t.resultsLimitSelectLabelEl.textContent=String(s)),e.currentCoords?n.load(e.currentCoords.lat,e.currentCoords.lon):n.requestLocationAndLoad())}function B(){if(!t.resultsLimitSelectListEl)return;let i=Array.isArray(A.RESULT_LIMIT_OPTIONS)?A.RESULT_LIMIT_OPTIONS:[],s=n.getActiveResultsLimit();t.resultsLimitSelectListEl.innerHTML="";for(let l of i){let m=document.createElement("li");m.setAttribute("role","option"),m.dataset.value=String(l),m.textContent=String(l),l===s&&m.setAttribute("aria-selected","true"),m.addEventListener("click",()=>R(String(l))),t.resultsLimitSelectListEl.appendChild(m)}t.resultsLimitSelectLabelEl&&(t.resultsLimitSelectLabelEl.textContent=String(s))}function X(){if(t.helsinkiOnlyBtn){if(e.mode!==N){t.helsinkiOnlyBtn.setAttribute("aria-pressed","false"),t.helsinkiOnlyBtn.classList.remove("is-active"),t.helsinkiOnlyBtn.disabled=!0,t.helsinkiOnlyBtn.textContent="Helsinki Only (Rail)";return}t.helsinkiOnlyBtn.disabled=!1,t.helsinkiOnlyBtn.setAttribute("aria-pressed",String(e.helsinkiOnly)),t.helsinkiOnlyBtn.classList.toggle("is-active",e.helsinkiOnly),t.helsinkiOnlyBtn.textContent=e.helsinkiOnly?"Helsinki Only: On":"Helsinki Only: Off"}}function Z(){return Math.max(0,e.busLineFilters.length)+Math.max(0,e.busDestinationFilters.length)}function Y(i=e.busLineFilters.length,s=e.busDestinationFilters.length){let l=Math.max(0,Number(i)||0)+Math.max(0,Number(s)||0);return l===0?"No filters":l===1?"1 filter":`${l} filters`}function V(){t.stopFilterSummaryEl&&(t.stopFilterSummaryEl.textContent=Y()),!(!t.stopFiltersToggleBtnEl||!t.stopFiltersPanelEl)&&(t.stopFiltersToggleBtnEl.setAttribute("aria-expanded",String(!!e.stopFiltersPanelOpen)),t.stopFiltersPanelEl.classList.toggle("hidden",!e.stopFiltersPanelOpen))}function G(i){e.stopFiltersPanelOpen=!!i,V()}function ee(i){let s=typeof i=="boolean"?i:!e.stopFiltersPanelOpen;G(s)}function te(i){t.busControlsEl&&(t.busControlsEl.classList.toggle("hidden",!i),i||(e.stopFiltersPanelOpen=!1),V())}function K(i){return e.busStops.find(s=>s.id===i)||null}function j(i){let s=n.uniqueNonEmptyStrings([...Array.isArray(i?.stopCodes)?i.stopCodes:[],i?.code]);return s.length===0&&i?.id&&s.push(String(i.id)),s}function z(i,s=null){let l=K(e.busStopId),m=String(s?.stopName||i?.stopName||l?.name||"").trim(),L=n.uniqueNonEmptyStrings([s?.stopCode,...Array.isArray(i?.stopCodes)?i.stopCodes:[],i?.stopCode,...j(l)])[0]||"";return m&&L?`${m} ${L}`:m||L||"\u2014"}function P(i,s=null){if(w())return z(i,s);let l=String(s?.stopName||i?.stopName||"").trim(),m=String(s?.stopCode||i?.stopCode||"").trim();return l&&m?`${l} ${m}`:l||m||"\u2014"}function H(i){if(!t.dataScopeEl)return;if(!w()){t.dataScopeEl.classList.add("hidden"),t.dataScopeEl.textContent="";return}let s=String(i?.station?.stopName||K(e.busStopId)?.name||"").trim(),m=n.uniqueNonEmptyStrings([...Array.isArray(i?.station?.stopCodes)?i.station.stopCodes:[],i?.station?.stopCode,...j(K(e.busStopId))]).join(", "),b=e.busLineFilters.length===0?"all lines":`${e.busLineFilters.length} line${e.busLineFilters.length===1?"":"s"} selected`,L=e.busDestinationFilters.length===0?"all destinations":`${e.busDestinationFilters.length} destination${e.busDestinationFilters.length===1?"":"s"} selected`,C=`${n.getActiveResultsLimit()} results`;s?t.dataScopeEl.textContent=`Selected stop ${s} (${m||"\u2014"}) - ${b}, ${L}, ${C}`:t.dataScopeEl.textContent=`Selecting stop... (${b}, ${L}, ${C})`,t.dataScopeEl.classList.remove("hidden")}function $(i,s,l,m){if(!i)return;if(i.innerHTML="",!Array.isArray(s)||s.length===0){let L=document.createElement("span");L.className="chip-empty",L.textContent="No options",i.appendChild(L);return}let b=new Set(l);for(let L of s){let C=document.createElement("button");C.type="button",C.className="chip-toggle",b.has(L.value)?(C.classList.add("is-active"),C.setAttribute("aria-pressed","true")):C.setAttribute("aria-pressed","false"),C.textContent=`${L.value} (${L.count})`,C.addEventListener("click",()=>m(L.value)),i.appendChild(C)}}function W(i){if(!t.busStopSelectEl||!t.busStopSelectListEl)return;let s=t.busStopSelectEl.getAttribute("aria-expanded")==="true",l=typeof i=="boolean"?i:!s;t.busStopSelectEl.setAttribute("aria-expanded",String(l)),t.busStopSelectListEl.classList.toggle("hidden",!l)}function r(i){if(!e.suppressBusStopChange){if(!i||i===e.busStopId){W(!1);return}if(n.trackFirstManualInteraction("stop_select",{currentMode:e.mode}),n.trackFirstManualStopContextChange("stop_select",{selectedStopId:i}),e.busStopId=i,n.persistUiState(),W(!1),t.busStopSelectLabelEl){let s=e.busStops.find(l=>l.id===i);t.busStopSelectLabelEl.textContent=s?`${s.name} (${s.distanceMeters}m)`:i}e.currentCoords&&n.load(e.currentCoords.lat,e.currentCoords.lon)}}function u(){let i=w();if(te(i),!!i){if(V(),t.busStopSelectListEl){if(e.suppressBusStopChange=!0,t.busStopSelectListEl.innerHTML="",e.busStops.length===0)t.busStopSelectLabelEl&&(t.busStopSelectLabelEl.textContent=`No nearby ${U().singular} stops`),t.busStopSelectEl&&(t.busStopSelectEl.disabled=!0);else{t.busStopSelectEl&&(t.busStopSelectEl.disabled=!1);let s=e.busStopId;(!s||!e.busStops.some(l=>l.id===s))&&(s=e.busStops[0].id);for(let l of e.busStops){let m=document.createElement("li");m.setAttribute("role","option"),m.dataset.value=l.id,m.textContent=`${l.name} (${l.distanceMeters}m)`,l.id===s&&m.setAttribute("aria-selected","true"),m.addEventListener("click",()=>r(l.id)),t.busStopSelectListEl.appendChild(m)}if(t.busStopSelectLabelEl){let l=e.busStops.find(m=>m.id===s);t.busStopSelectLabelEl.textContent=l?`${l.name} (${l.distanceMeters}m)`:"Select stop"}}e.suppressBusStopChange=!1}$(t.busLineFiltersEl,e.busFilterOptions.lines,e.busLineFilters,s=>{e.busLineFilters.includes(s)?e.busLineFilters=e.busLineFilters.filter(l=>l!==s):e.busLineFilters=[...e.busLineFilters,s],n.trackFirstManualInteraction("line_filter_toggle",{currentMode:e.mode}),n.trackFirstManualStopContextChange("line_filter_toggle"),n.persistUiState(),V(),e.latestResponse&&(n.render(e.latestResponse),n.setStatus(n.buildStatusFromResponse(e.latestResponse)))}),$(t.busDestinationFiltersEl,e.busFilterOptions.destinations,e.busDestinationFilters,s=>{e.busDestinationFilters.includes(s)?e.busDestinationFilters=e.busDestinationFilters.filter(l=>l!==s):e.busDestinationFilters=[...e.busDestinationFilters,s],n.trackFirstManualInteraction("destination_filter_toggle",{currentMode:e.mode}),n.trackFirstManualStopContextChange("destination_filter_toggle"),n.persistUiState(),V(),e.latestResponse&&(n.render(e.latestResponse),n.setStatus(n.buildStatusFromResponse(e.latestResponse)))})}}function d(i,s=null){if(!t.nextSummaryEl||!t.nextMinsEl||!t.nextLineEl||!t.nextTrackEl||!t.nextDestinationEl)return;if(!i){t.nextSummaryEl.classList.add("hidden"),t.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later");return}let l=q(i.departureIso);t.nextMinsEl.textContent=D(i.departureIso),t.nextLineEl.textContent=i.line||"\u2014",t.nextLineEl.classList.toggle("next-letter-now",l<3),t.nextTrackEl.textContent=w()?`Stop ${P(s,i)}`:i.track?`Track ${i.track}`:"Track \u2014",t.nextDestinationEl.textContent=i.destination||"\u2014",t.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),l<3?t.nextSummaryEl.classList.add("next-summary-now"):l<=10?t.nextSummaryEl.classList.add("next-summary-soon"):t.nextSummaryEl.classList.add("next-summary-later"),t.nextSummaryEl.classList.remove("hidden")}function g(i){if(!i||!i.station)return w()?i?.message||`No nearby ${U().singular} stops found.`:i?.message||"No nearby train stations found.";let l=I(i.station.departures)[0];if(!l)return w()?e.busLineFilters.length>0||e.busDestinationFilters.length>0?`No upcoming ${U().plural} match selected filters.`:"No upcoming departures from this stop.":e.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.";let m=l.destination?` \u2022 ${l.destination}`:"",b=e.mode===N?l.track?` \u2022 Track ${l.track}`:"":i.station.stopName||i.station.stopCode?` \u2022 ${P(i.station,l)}`:"",L=w()?U().singular:"train";return`Next ${l.line||L} in ${D(l.departureIso)}${m}${b}`}function f(i){if(!(i instanceof Error))return"Could not refresh departures. Please try again.";if(i.name==="AbortError")return"Request timed out. Please try again.";let s=(i.message||"").trim();return s==="Temporary server error. Please try again."?s:s==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":s==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function S(i){return i?.code===1?"Location permission denied.":i?.code===2?"Location unavailable. Please try again.":i?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function E(i){let s=String(i?.code||"").trim();return s==="voice_unsupported"?"Voice location is not supported in this browser.":s==="voice_permission_denied"?"Microphone permission denied.":s==="voice_no_microphone"?"No microphone was found for voice location.":s==="voice_no_speech"?"No speech detected. Please try again.":s==="voice_recognition_timeout"?"Voice listening timed out. Please try again.":s==="voice_language_not_supported"?"Voice language was not supported on this device.":s==="voice_query_too_short"?"Please describe your location with a few words.":s==="voice_location_not_found"?"Could not match that place. Try a nearby landmark or street.":s==="voice_location_selection_cancelled"?"Location selection was cancelled.":s==="voice_location_selection_invalid"?"Please choose one of the suggested locations.":s==="voice_recognition_network"?"Voice recognition failed due to a network error. On iPhone, try enabling Siri & Dictation.":"Could not use voice location. Please try again."}function o(){t.skeletonEl&&t.skeletonEl.classList.remove("hidden")}function c(){t.skeletonEl&&t.skeletonEl.classList.add("hidden")}function T(i){if(c(),u(),H(i),!i||!i.station){t.resultEl.classList.add("hidden"),d(null);return}let s=i.station;t.resultEl.classList.remove("hidden"),t.stationTitleEl.textContent=s.stopName,t.stationMetaEl.textContent=`${s.distanceMeters}m away`,t.departuresEl.innerHTML="";let l=I(s.departures);if(l.length===0){d(null);let b=document.createElement("li");b.className="empty-row",w()?b.textContent=e.busLineFilters.length>0||e.busDestinationFilters.length>0?`No upcoming ${U().plural} match selected filters.`:"No upcoming departures from this stop.":b.textContent=e.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.",t.departuresEl.appendChild(b);return}d(l[0],s);let m=l.slice(1);if(m.length===0){let b=document.createElement("li");b.className="empty-row",b.textContent=w()?`No additional upcoming ${U().plural} right now.`:"No additional upcoming commuter trains right now.",t.departuresEl.appendChild(b);return}for(let b=0;b<m.length;b++){let L=m[b],C=document.createElement("li");C.className=`departure-row ${p(L.departureIso)}`,C.style.setProperty("--i",b);let J=document.createElement("div");J.className="letter-badge",J.textContent=L.line||"?";let Q=document.createElement("div");Q.className="train";let ne=document.createElement("div");ne.className="destination",ne.textContent=L.destination||"\u2014",Q.appendChild(ne);let oe=document.createElement("span");oe.className="track",w()?oe.textContent=`Stop ${P(s,L)}`:oe.textContent=L.track?`Track ${L.track}`:"Track \u2014",Q.appendChild(oe);let ie=document.createElement("div");ie.className="time";let se=document.createElement("span");se.className="remaining",se.textContent=D(L.departureIso);let re=document.createElement("span");re.className="clock-time",re.textContent=new Date(L.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),ie.appendChild(se),ie.appendChild(re),C.appendChild(J),C.appendChild(Q),C.appendChild(ie),t.departuresEl.appendChild(C)}}function v(){t.nowClockEl&&(t.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(n,{formatMinutes:D,minutesUntil:q,departureRowClass:p,isHelsinkiBound:h,sanitizeStopSelections:O,getVisibleDepartures:I,updateModeButtons:k,updateModeLabels:F,toggleResultsLimitDropdown:M,selectResultsLimit:R,renderResultsLimitControl:B,updateHelsinkiFilterButton:X,countActiveStopFilters:Z,buildStopFilterSummary:Y,syncStopFiltersPanelUi:V,setStopFiltersPanelOpen:G,toggleStopFiltersPanel:ee,setStopControlsVisibility:te,getStopMeta:K,getStopCodes:j,buildStopDisplay:z,buildModeStopDisplay:P,updateDataScope:H,renderFilterButtons:$,toggleStopDropdown:W,selectStop:r,renderStopControls:u,updateNextSummary:d,buildStatusFromResponse:g,getLoadErrorStatus:f,getGeolocationErrorStatus:S,getVoiceLocationErrorStatus:E,showSkeleton:o,hideSkeleton:c,render:T,updateClock:v})})();(()=>{let x=window.HMApp,{api:n,dom:t,state:e,constants:A}=x,{MODE_TRAM:N,MODE_METRO:_,MODE_BUS:a}=A;function y(r){return r===a||r===N||r===_}function w(r){return new Promise(u=>setTimeout(u,r))}async function U(r,u={},d=A.FETCH_TIMEOUT_MS){let g=new AbortController,f=setTimeout(()=>g.abort(),d);try{return await fetch(r,{...u,signal:g.signal})}finally{clearTimeout(f)}}async function D(r,u={}){let d;try{d=await U(r,u)}catch{return await w(350),U(r,u)}return d.status>=500?(await w(350),U(r,u)):d}function q(r){let u=new Map,d=new Map;for(let f of r||[]){let S=String(f?.line||"").trim();S&&u.set(S,(u.get(S)||0)+1);let E=String(f?.destination||"").trim();E&&d.set(E,(d.get(E)||0)+1)}let g=f=>[...f.entries()].sort((S,E)=>E[1]-S[1]||S[0].localeCompare(E[0])).map(([S,E])=>({value:S,count:E}));return{lines:g(u),destinations:g(d)}}function p(r){let u=Array.isArray(r?.stops)?r.stops.filter(S=>S&&S.id&&S.name).map(S=>({id:S.id,name:S.name,code:String(S.code||"").trim()||null,stopCodes:n.uniqueNonEmptyStrings([...Array.isArray(S.stopCodes)?S.stopCodes:[],S.code]),distanceMeters:Number(S.distanceMeters)||0})):[];e.busStops=u;let d=String(r?.selectedStopId||"").trim()||null,g=S=>u.some(E=>E.id===S);d&&g(d)?e.busStopId=d:(!e.busStopId||!g(e.busStopId))&&(e.busStopId=u[0]?.id||null),e.deferInitialStopContext&&(e.deferInitialStopContext=!1,e.deferredBusStopId=null,e.deferredBusLineFilters=[],e.deferredBusDestinationFilters=[],e.busLineFilters=[],e.busDestinationFilters=[]),e.hasCompletedInitialStopModeLoad=!0;let f=Array.isArray(r?.station?.departures)?r.station.departures:[];e.busFilterOptions=q(f),n.sanitizeStopSelections()}function h(r,u){let d=new Error(u);return d.code=r,d}function O(r){return String(r?.code||"").trim().toLowerCase()}function I(){return n.uniqueNonEmptyStrings(["fi-FI","en-US",...Array.isArray(navigator.languages)?navigator.languages:[],navigator.language])}function k(){return typeof window.SpeechRecognition=="function"?window.SpeechRecognition:typeof window.webkitSpeechRecognition=="function"?window.webkitSpeechRecognition:null}function F(){return!!k()}function M(r){return r==="not-allowed"||r==="service-not-allowed"?h("voice_permission_denied","Microphone permission denied."):r==="audio-capture"?h("voice_no_microphone","No microphone available."):r==="language-not-supported"?h("voice_language_not_supported","Speech language is not supported."):r==="network"?h("voice_recognition_network","Voice recognition network error."):r==="no-speech"?h("voice_no_speech","No speech detected."):h("voice_not_understood","Voice recognition failed.")}function R(r){let u=k();return u?new Promise((d,g)=>{let f=new u,S=String(r||navigator.language||"fi-FI").trim();f.lang=S||"fi-FI",f.continuous=!1,f.interimResults=!0,f.maxAlternatives=1;let E=!1,o="",c=null,T=!1,v=()=>{clearTimeout(c),c=null},i=()=>{if(!(T||E)){T=!0;try{f.stop()}catch{}}},s=()=>{v(),c=setTimeout(i,A.VOICE_SILENCE_STOP_MS)},l=()=>{clearTimeout(b),v(),f.onresult=null,f.onerror=null,f.onend=null,f.onspeechend=null,f.onsoundend=null,f.onaudioend=null,f.onnomatch=null},m=(L,C)=>{E||(E=!0,l(),L(C))},b=setTimeout(()=>{try{f.abort()}catch{}m(g,h("voice_recognition_timeout","Voice recognition timed out."))},A.VOICE_RECOGNITION_TIMEOUT_MS);f.onresult=L=>{for(let C=L?.resultIndex||0;C<(L?.results?.length||0);C+=1){let J=L.results[C],Q=String(J?.[0]?.transcript||"").trim();if(Q&&(o=Q,s(),J?.isFinal)){i();return}}},f.onerror=L=>{let C=String(L?.error||"").trim().toLowerCase();m(g,M(C))},f.onend=()=>{if(E)return;let L=String(o||"").trim();if(!L){m(g,h("voice_no_speech","No speech detected."));return}m(d,L)},f.onspeechend=()=>{i()},f.onsoundend=()=>{s()},f.onaudioend=()=>{s()},f.onnomatch=()=>{m(g,h("voice_not_understood","Could not understand speech."))};try{f.start()}catch(L){let C=String(L?.name||"").trim().toLowerCase();if(C==="notallowederror"||C==="securityerror"){m(g,h("voice_permission_denied","Microphone permission denied."));return}m(g,h("voice_not_understood","Unable to start voice recognition."))}}):Promise.reject(h("voice_unsupported","Voice recognition not supported."))}function B(r){return r==="voice_no_speech"||r==="voice_not_understood"||r==="voice_recognition_timeout"||r==="voice_language_not_supported"}async function X(){let r=I(),u=null;for(let d of r)try{return await R(d)}catch(g){if(u=g,!B(O(g)))break}throw u||h("voice_not_understood","Voice recognition failed.")}function Z(r){return Array.isArray(r)?r.map(u=>{let d=Number(u?.lat),g=Number(u?.lon);return!Number.isFinite(d)||!Number.isFinite(g)?null:{lat:d,lon:g,label:String(u?.label||"").trim()}}).filter(Boolean):[]}function Y(){t.voiceLocationChoicesEl&&t.voiceLocationChoicesEl.classList.add("hidden"),t.voiceLocationChoicesTitleEl&&(t.voiceLocationChoicesTitleEl.textContent=""),t.voiceLocationChoicesOptionsEl&&(t.voiceLocationChoicesOptionsEl.innerHTML=""),t.voiceLocationChoicesCancelEl&&(t.voiceLocationChoicesCancelEl.onclick=null)}function V(r,u){if(typeof window.prompt!="function")throw h("voice_location_selection_cancelled","Location selection was cancelled.");let d=u.map((S,E)=>`${E+1}. ${S.label||`${S.lat}, ${S.lon}`}`).join(`
`),g=window.prompt(`Multiple matches found for "${n.safeString(r,80)}". Select number:
${d}`,"1");if(g==null)throw h("voice_location_selection_cancelled","Location selection was cancelled.");let f=Number.parseInt(String(g).trim(),10);if(!Number.isInteger(f)||f<1||f>u.length)throw h("voice_location_selection_invalid","Invalid location selection.");return u[f-1]}async function G(r,u){if(!Array.isArray(u)||u.length===0)throw h("voice_location_not_found","No matching location found.");return!t.voiceLocationChoicesEl||!t.voiceLocationChoicesTitleEl||!t.voiceLocationChoicesOptionsEl||!t.voiceLocationChoicesCancelEl?V(r,u):new Promise((d,g)=>{let f=!1,S=(E,o)=>{f||(f=!0,Y(),E(o))};t.voiceLocationChoicesTitleEl.textContent=`Multiple matches for "${n.safeString(r,80)}". Choose one:`,n.setStatus("Multiple matches found. Choose one below."),t.voiceLocationChoicesOptionsEl.innerHTML="";for(let E of u){let o=document.createElement("button");o.type="button",o.className="voice-location-choice-option",o.textContent=E.label||`${E.lat.toFixed(5)}, ${E.lon.toFixed(5)}`,o.addEventListener("click",()=>S(d,E),{once:!0}),t.voiceLocationChoicesOptionsEl.appendChild(o)}t.voiceLocationChoicesCancelEl.onclick=()=>S(g,h("voice_location_selection_cancelled","Location selection was cancelled.")),t.voiceLocationChoicesEl.classList.remove("hidden")})}async function ee(r){let u=String(r||"").trim();if(u.length<A.VOICE_QUERY_MIN_LENGTH)throw h("voice_query_too_short","Voice query too short.");let d=new URLSearchParams({text:u});e.currentCoords&&(d.set("lat",String(e.currentCoords.lat)),d.set("lon",String(e.currentCoords.lon)));let g=Array.isArray(navigator.languages)&&navigator.languages[0]||navigator.language||"";g&&d.set("lang",String(g));let f;try{f=await D(`/api/v1/geocode?${d.toString()}`)}catch{throw h("voice_geocode_failed","Location lookup failed.")}if(!(f.headers.get("content-type")||"").includes("application/json"))throw h("voice_geocode_failed","Unexpected location lookup response.");let E=await f.json();if(!f.ok)throw h("voice_geocode_failed",String(E?.error||"Location lookup failed.").trim());let o=Z(E?.choices);if(E?.ambiguous&&o.length>1){let v=await G(u,o);return{lat:v.lat,lon:v.lon,label:v.label,query:u}}let c=Number(E?.location?.lat),T=Number(E?.location?.lon);if(!Number.isFinite(c)||!Number.isFinite(T))throw h("voice_location_not_found","No matching location found.");return{lat:c,lon:T,label:String(E?.location?.label||"").trim(),query:u}}function te(r){return r==="voice_unsupported"||r==="voice_no_speech"||r==="voice_recognition_timeout"||r==="voice_recognition_network"||r==="voice_not_understood"}function K(r){if(!te(r)||typeof window.prompt!="function")return null;let u=r==="voice_unsupported"?"Voice input is limited in this browser. Type your location instead:":"Could not capture your voice on this device. Type your location:",d=window.prompt(`${u}
Example: Kamppi Helsinki`,"");return String(d||"").trim()||null}async function j(r){let u=String(r||"").trim();Y(),n.setStatus(`Looking up "${n.safeString(u,80)}"...`);let d=await ee(u);return n.setResolvedLocationHint({query:u,label:d.label,lat:d.lat,lon:d.lon}),e.currentCoords={lat:d.lat,lon:d.lon},n.setPermissionRequired(!1),await P(d.lat,d.lon),!0}async function z(){if(e.isLoading||e.isVoiceListening)return!1;Y(),n.setVoiceListening(!0),n.setStatus("Listening... speak now, then pause.");try{if(!F()){let u=h("voice_unsupported","Voice recognition not supported."),d=K(O(u));return d?j(d):(n.setStatus(n.getVoiceLocationErrorStatus(u)),!1)}let r=await X();return j(r)}catch(r){let u=O(r),d=K(u);if(d)try{return await j(d)}catch(g){return console.error("voice fallback location error:",g),n.reportClientError("voice-location-fallback",g,{mode:e.mode,sourceCode:u||"unknown"}),n.setStatus(n.getVoiceLocationErrorStatus(g)),!1}return(!u||u==="unknown")&&console.error("voice location error:",r),n.reportClientError("voice-location",r,{mode:e.mode,code:u||"unknown"}),n.setStatus(n.getVoiceLocationErrorStatus(r)),!1}finally{n.setVoiceListening(!1)}}async function P(r,u){let d=++e.latestLoadToken,g=e.mode,f=e.busStopId,S=y(g)&&!e.hasCompletedInitialStopModeLoad;n.setLoading(!0),n.setStatus("Loading departures...");try{let E=new URLSearchParams({lat:String(r),lon:String(u),mode:g.toUpperCase(),results:String(n.getActiveResultsLimit(g))}),o=y(g)&&(e.deferInitialStopContext||!e.hasCompletedInitialStopModeLoad);y(g)&&f&&!o&&E.set("stopId",f);let c=await D(`/api/v1/departures?${E.toString()}`);if(!(c.headers.get("content-type")||"").includes("application/json"))throw c.ok?new Error("Unexpected server response."):new Error("Request failed");let v=await c.json();if(!c.ok)throw new Error(v.error||"Request failed");if(d!==e.latestLoadToken)return;y(g)&&(p(v),n.persistUiState(),S&&n.trackInitialNearestStopResolved(v,g)),e.latestResponse=v,n.render(v),n.setPermissionRequired(!1),n.setLastUpdated(new Date),n.setStatus(n.buildStatusFromResponse(v)),n.trackFirstSuccessfulRender(v,g)}catch(E){if(d!==e.latestLoadToken)return;e.latestResponse=null,console.error("load departures error:",E),n.reportClientError("load",E,{mode:g}),n.setStatus(n.getLoadErrorStatus(E)),t.resultEl.classList.add("hidden"),n.updateNextSummary(null)}finally{d===e.latestLoadToken&&n.setLoading(!1)}}function H(){if(Y(),n.setResolvedLocationHint(null),!navigator.geolocation)return n.setStatus("Geolocation not supported in this browser."),n.setPermissionRequired(!0),!1;if(e.isLoading||e.isVoiceListening)return!1;n.setStatus("Getting your location..."),n.setLoading(!0);let r=S=>({enableHighAccuracy:S,timeout:S?15e3:1e4,maximumAge:0}),u=(S,E)=>E?!1:S?.code===2||S?.code===3,d=S=>{e.currentCoords={lat:S.coords.latitude,lon:S.coords.longitude},e.locationGranted=!0,n.setStorageItem("location:granted","1"),n.setPermissionRequired(!1),n.setLoading(!1),P(e.currentCoords.lat,e.currentCoords.lon)},g=S=>{S.code===1?n.setPermissionRequired(!0):n.setPermissionRequired(!1),n.setStatus(n.getGeolocationErrorStatus(S)),e.latestResponse=null,t.resultEl.classList.add("hidden"),n.updateNextSummary(null),n.setLoading(!1)},f=S=>{navigator.geolocation.getCurrentPosition(d,E=>{if(u(E,S)){f(!0);return}g(E)},r(S))};return f(!1),!0}function $(){if(!e.isVoiceListening){if(e.currentCoords){P(e.currentCoords.lat,e.currentCoords.lon);return}H()}}function W(r={}){let u=!!r.modeOnly;n.updateModeButtons(),n.updateModeLabels(),!u&&(n.renderResultsLimitControl(),n.updateHelsinkiFilterButton(),n.renderStopControls(),n.updateDataScope(e.latestResponse))}Object.assign(n,{delay:w,fetchWithTimeout:U,fetchWithRetryOnce:D,updateStopModeStateFromResponse:p,buildFilterOptionsFromDepartures:q,load:P,requestLocationAndLoad:H,requestVoiceLocationAndLoad:z,supportsVoiceLocation:F,captureVoiceQuery:R,captureVoiceQueryWithRetry:X,getVoiceRecognitionLanguages:I,shouldRetryVoiceRecognition:B,resolveVoiceLocationQuery:ee,refreshDeparturesOnly:$,applyModeUiState:W})})();(()=>{let x=window.HMApp,{api:n,dom:t,state:e,constants:A}=x,{MODE_RAIL:N,MODE_TRAM:_,MODE_METRO:a,MODE_BUS:y}=A;function w(){if(e.currentCoords){n.load(e.currentCoords.lat,e.currentCoords.lon);return}n.requestLocationAndLoad()}function U(p){if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(p);return}setTimeout(p,0)}function D(p){e.mode!==p&&(n.trackFirstManualInteraction("mode_change",{toMode:p}),e.mode=p,p!==N&&(e.helsinkiOnly=!1),n.applyModeUiState({modeOnly:!0}),U(()=>{n.applyModeUiState(),n.persistUiState(),w()}))}t.locateBtn?.addEventListener("click",()=>{n.trackFirstManualInteraction("refresh_location_click"),n.requestLocationAndLoad()}),t.voiceLocateBtn?.addEventListener("click",()=>{n.trackFirstManualInteraction("voice_location_click"),n.requestVoiceLocationAndLoad()}),t.modeRailBtn?.addEventListener("click",()=>{D(N)}),t.modeTramBtn?.addEventListener("click",()=>{D(_)}),t.modeMetroBtn?.addEventListener("click",()=>{D(a)}),t.modeBusBtn?.addEventListener("click",()=>{D(y)}),t.resultsLimitSelectEl?.addEventListener("click",p=>{p.stopPropagation(),n.toggleResultsLimitDropdown()}),document.addEventListener("click",p=>{t.resultsLimitSelectWrapEl&&(t.resultsLimitSelectWrapEl.contains(p.target)||n.toggleResultsLimitDropdown(!1))}),t.resultsLimitSelectEl?.addEventListener("keydown",p=>{let h=t.resultsLimitSelectListEl;if(!h)return;let O=t.resultsLimitSelectEl.getAttribute("aria-expanded")==="true";if(p.key==="Escape"){n.toggleResultsLimitDropdown(!1),t.resultsLimitSelectEl.focus(),p.preventDefault();return}if(p.key==="Enter"||p.key===" "){if(!O){n.toggleResultsLimitDropdown(!0),p.preventDefault();return}let I=h.querySelector(".is-focused");I?.dataset?.value&&n.selectResultsLimit(I.dataset.value),p.preventDefault();return}if(p.key==="ArrowDown"||p.key==="ArrowUp"){if(p.preventDefault(),!O){n.toggleResultsLimitDropdown(!0);return}let I=[...h.querySelectorAll("li[role='option']")];if(I.length===0)return;let k=I.findIndex(M=>M.classList.contains("is-focused")),F;p.key==="ArrowDown"?F=k<I.length-1?k+1:0:F=k>0?k-1:I.length-1;for(let M of I)M.classList.remove("is-focused");I[F].classList.add("is-focused"),I[F].scrollIntoView({block:"nearest"})}}),t.busStopSelectEl?.addEventListener("click",p=>{p.stopPropagation(),n.toggleStopDropdown()}),document.addEventListener("click",p=>{t.busStopSelectWrapEl&&(t.busStopSelectWrapEl.contains(p.target)||n.toggleStopDropdown(!1))}),t.busStopSelectEl?.addEventListener("keydown",p=>{let h=t.busStopSelectListEl;if(!h)return;let O=t.busStopSelectEl.getAttribute("aria-expanded")==="true";if(p.key==="Escape"){n.toggleStopDropdown(!1),t.busStopSelectEl.focus(),p.preventDefault();return}if(p.key==="Enter"||p.key===" "){if(!O){n.toggleStopDropdown(!0),p.preventDefault();return}let I=h.querySelector(".is-focused");I?.dataset?.value&&n.selectStop(I.dataset.value),p.preventDefault();return}if(p.key==="ArrowDown"||p.key==="ArrowUp"){if(p.preventDefault(),!O){n.toggleStopDropdown(!0);return}let I=[...h.querySelectorAll("li[role='option']")];if(I.length===0)return;let k=I.findIndex(M=>M.classList.contains("is-focused")),F;p.key==="ArrowDown"?F=k<I.length-1?k+1:0:F=k>0?k-1:I.length-1;for(let M of I)M.classList.remove("is-focused");I[F].classList.add("is-focused"),I[F].scrollIntoView({block:"nearest"})}}),t.stopFiltersToggleBtnEl?.addEventListener("click",()=>{n.trackFirstManualInteraction("stop_filters_panel_toggle",{currentMode:e.mode}),n.toggleStopFiltersPanel()}),t.helsinkiOnlyBtn?.addEventListener("click",()=>{e.mode===N&&(n.trackFirstManualInteraction("helsinki_only_toggle"),e.helsinkiOnly=!e.helsinkiOnly,n.persistUiState(),n.updateHelsinkiFilterButton(),e.latestResponse&&(n.render(e.latestResponse),n.setStatus(n.buildStatusFromResponse(e.latestResponse))))}),t.locationPromptAllowEl?.addEventListener("click",()=>{n.hideLocationPrompt(),n.requestLocationAndLoad()}),t.permissionRetryBtnEl?.addEventListener("click",()=>{n.trackFirstManualInteraction("permission_retry_click"),n.requestLocationAndLoad()}),n.hydrateInitialState(),n.applyModeUiState(),n.updateClock(),setInterval(n.updateClock,1e3),n.getStorageItem("location:granted")==="1"?n.requestLocationAndLoad():(n.showLocationPrompt(),n.setStatus("Tap Allow Location to get started.")),setInterval(n.refreshDeparturesOnly,3e4),window.addEventListener("error",p=>{n.reportClientError("error",p.error||p.message||"Unknown error",{source:p.filename||"",line:p.lineno||null,column:p.colno||null})}),window.addEventListener("unhandledrejection",p=>{n.reportClientError("unhandledrejection",p.reason||"Unhandled promise rejection")}),(()=>{let p=document.getElementById("themeToggle");if(!p)return;let h=document.documentElement,O=window.matchMedia("(prefers-color-scheme: dark)"),I=()=>{let R=n.getStorageItem("theme");return R==="dark"||R==="light"?R:null},k=R=>{h.setAttribute("data-theme",R==="light"?"light":"dark")},F=()=>{let R=I();if(R){k(R);return}k(O.matches?"dark":"light")},M=R=>{I()||k(R.matches?"dark":"light")};F(),typeof O.addEventListener=="function"?O.addEventListener("change",M):typeof O.addListener=="function"&&O.addListener(M),p.addEventListener("click",()=>{let R=h.getAttribute("data-theme")==="dark"?"light":"dark";k(R),n.setStorageItem("theme",R)})})()})();})();
