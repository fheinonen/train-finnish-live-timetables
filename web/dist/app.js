(()=>{(()=>{let P=window.HMApp||(window.HMApp={}),r=P.api||={};P.dom={locateBtn:document.getElementById("locateBtn"),voiceLocateBtn:document.getElementById("voiceLocateBtn"),voiceLocateBtnLabel:document.getElementById("voiceLocateBtnLabel"),skeletonEl:document.getElementById("skeleton"),segmentControlEl:document.querySelector(".segment-control"),modeRailBtn:document.getElementById("modeRailBtn"),modeTramBtn:document.getElementById("modeTramBtn"),modeMetroBtn:document.getElementById("modeMetroBtn"),modeBusBtn:document.getElementById("modeBusBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busStopSelectLabelEl:document.getElementById("busStopSelectLabel"),busStopSelectListEl:document.getElementById("busStopSelectList"),busStopSelectWrapEl:document.getElementById("busStopSelectWrap"),busStopFiltersEl:document.getElementById("busStopFilters"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),stopFiltersToggleBtnEl:document.getElementById("stopFiltersToggleBtn"),stopFiltersPanelEl:document.getElementById("stopFiltersPanel"),stopFilterSummaryEl:document.getElementById("stopFilterSummary"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),resultsLimitSelectLabelEl:document.getElementById("resultsLimitSelectLabel"),resultsLimitSelectListEl:document.getElementById("resultsLimitSelectList"),resultsLimitSelectWrapEl:document.getElementById("resultsLimitSelectWrap"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),resolvedLocationEl:document.getElementById("resolvedLocation"),voiceLocationChoicesEl:document.getElementById("voiceLocationChoices"),voiceLocationChoicesTitleEl:document.getElementById("voiceLocationChoicesTitle"),voiceLocationChoicesOptionsEl:document.getElementById("voiceLocationChoicesOptions"),voiceLocationChoicesCancelEl:document.getElementById("voiceLocationChoicesCancel"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),locationPromptCardEl:document.getElementById("locationPromptCard"),locationPromptAllowEl:document.getElementById("locationPromptAllow"),permissionCardEl:document.getElementById("permissionCard"),permissionRetryBtnEl:document.getElementById("permissionRetryBtn"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},P.constants={MODE_RAIL:"rail",MODE_TRAM:"tram",MODE_METRO:"metro",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_TRAM_KEY:"prefs:resultsLimitTram",STORAGE_RESULTS_LIMIT_METRO_KEY:"prefs:resultsLimitMetro",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_TRAM:8,DEFAULT_RESULTS_LIMIT_METRO:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],VOICE_RECOGNITION_TIMEOUT_MS:8e3,VOICE_SILENCE_STOP_MS:1200,VOICE_QUERY_MIN_LENGTH:3,FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5,METRIC_REPORT_LIMIT:10,METRIC_SAMPLE_RATE:1};let{MODE_RAIL:n,MODE_TRAM:e,MODE_METRO:N,MODE_BUS:K}=P.constants;P.state={locationGranted:!1,isLoading:!1,isVoiceListening:!1,currentCoords:null,latestResponse:null,mode:n,busStopId:null,busStopMemberFilterId:null,busLineFilters:[],busDestinationFilters:[],stopFilterPinned:!1,stopFiltersPanelOpen:!1,stopFiltersPanelLockUntilMs:0,deferInitialStopContext:!1,deferredBusStopId:null,deferredBusLineFilters:[],deferredBusDestinationFilters:[],resultsLimitByMode:{[n]:P.constants.DEFAULT_RESULTS_LIMIT_RAIL,[e]:P.constants.DEFAULT_RESULTS_LIMIT_TRAM,[N]:P.constants.DEFAULT_RESULTS_LIMIT_METRO,[K]:P.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},resolvedLocationHint:null,suppressBusStopChange:!1,hasCompletedInitialStopModeLoad:!1,errorReportCount:0,metricReportCount:0,isMetricSessionSampled:Math.random()<P.constants.METRIC_SAMPLE_RATE,sessionStartedAtMs:Date.now(),hasReportedFirstSuccessfulRenderMetric:!1,hasReportedFirstManualInteractionMetric:!1,hasReportedFirstManualStopContextMetric:!1,hasReportedInitialNearestStopResolvedMetric:!1,latestLoadToken:0};let{dom:C,state:u,constants:M}=P;function H(){let o=u.isLoading||u.isVoiceListening,c=u.isLoading;C.locateBtn&&(C.locateBtn.disabled=o),C.voiceLocateBtn&&(C.voiceLocateBtn.disabled=c,C.voiceLocateBtn.classList.toggle("is-listening",u.isVoiceListening),C.voiceLocateBtn.setAttribute("aria-pressed",String(u.isVoiceListening))),C.voiceLocateBtnLabel&&(C.voiceLocateBtnLabel.textContent=u.isVoiceListening?"Listening...":"Voice Search")}function at(o){u.isLoading=o,H(),C.skeletonEl&&C.skeletonEl.classList.toggle("hidden",!o)}function rt(o){u.isVoiceListening=!!o,H()}function Q(o){if(!C.statusEl)return;let c=String(o||"").trim();C.statusEl.textContent=c,C.statusEl.classList?.toggle?.("hidden",c.length===0)}function J(o){let c=Number(o);return Number.isFinite(c)?c.toFixed(5):null}function f(o){let c=o&&typeof o=="object";if(u.resolvedLocationHint=c?{query:v(o.query,120).trim(),label:v(o.label,180).trim(),lat:Number(o.lat),lon:Number(o.lon)}:null,!C.resolvedLocationEl)return;if(!u.resolvedLocationHint){C.resolvedLocationEl.classList.add("hidden"),C.resolvedLocationEl.textContent="";return}let y=u.resolvedLocationHint.label||"Unknown place",I=u.resolvedLocationHint.query,A=J(u.resolvedLocationHint.lat),V=J(u.resolvedLocationHint.lon),G=I?` (from "${I}")`:"",ct=A&&V?` - ${A}, ${V}`:"";C.resolvedLocationEl.textContent=`Resolved location: ${y}${G}${ct}`,C.resolvedLocationEl.classList.remove("hidden")}function p(){C.locationPromptCardEl&&C.locationPromptCardEl.classList.remove("hidden"),C.permissionCardEl&&C.permissionCardEl.classList.add("hidden")}function O(){C.locationPromptCardEl&&C.locationPromptCardEl.classList.add("hidden")}function T(o){O(),C.permissionCardEl&&C.permissionCardEl.classList.toggle("hidden",!o)}function F(o){!C.lastUpdatedEl||!(o instanceof Date)||(C.lastUpdatedEl.textContent=`Last updated: ${o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function R(o){try{return window.localStorage.getItem(o)}catch{return null}}function w(o,c){try{window.localStorage.setItem(o,c)}catch{}}function v(o,c){let y=String(o||"");return y.length<=c?y:y.slice(0,c)}function Z(o){if(o instanceof Error)return o;try{let c=typeof o=="string"?o:JSON.stringify(o);return new Error(c||"Unknown error")}catch{return new Error(String(o||"Unknown error"))}}function tt(o){let c=JSON.stringify(o);if(navigator.sendBeacon){let y=new Blob([c],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",y);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:c,keepalive:!0}).catch(()=>{})}function x(o,c,y=null){if(u.errorReportCount>=M.ERROR_REPORT_LIMIT)return;u.errorReportCount+=1;let I=Z(c),A={type:v(o,40),message:v(I.message,400),stack:v(I.stack||"",1200),url:v(window.location.href,500),userAgent:v(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:y&&typeof y=="object"?y:null};tt(A)}function k(){return Math.max(0,Date.now()-u.sessionStartedAtMs)}function et(o,c=null){if(!u.isMetricSessionSampled||u.metricReportCount>=M.METRIC_REPORT_LIMIT)return!1;u.metricReportCount+=1;let y={type:"metric",message:v(o,400),stack:"",url:v(window.location.href,500),userAgent:v(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:{metricName:v(o,80),sessionElapsedMs:k(),mode:u.mode,...c&&typeof c=="object"?c:{}}};return tt(y),!0}function U(o,c){if(u.hasReportedFirstSuccessfulRenderMetric)return;u.hasReportedFirstSuccessfulRenderMetric=!0;let y=Array.isArray(o?.station?.departures)?o.station.departures:[];et("first_successful_render",{requestMode:String(c||"").trim(),hasStation:!!o?.station,departureCount:y.length})}function nt(o,c=null){u.hasReportedFirstManualInteractionMetric||(u.hasReportedFirstManualInteractionMetric=!0,et("first_manual_interaction",{interactionType:v(o,80),...c&&typeof c=="object"?c:{}}))}function S(o,c=null){u.hasReportedFirstManualStopContextMetric||(u.hasReportedFirstManualStopContextMetric=!0,et("first_manual_stop_context_change",{changeType:v(o,80),lineFilterCount:u.busLineFilters.length,destinationFilterCount:u.busDestinationFilters.length,...c&&typeof c=="object"?c:{}}))}function st(o,c){if(u.hasReportedInitialNearestStopResolvedMetric)return;let y=String(o?.selectedStopId||"").trim();if(!y)return;u.hasReportedInitialNearestStopResolvedMetric=!0;let A=(Array.isArray(o?.stops)?o.stops:[]).find(G=>G?.id===y)||null,V=Array.isArray(o?.station?.departures)?o.station.departures:[];et("initial_nearest_stop_resolved",{requestMode:String(c||"").trim(),selectedStopId:y,distanceMeters:Number(A?.distanceMeters)||null,departureCount:V.length})}function j(o){if(!o)return null;let c=String(o).trim().toLowerCase();return c===n||c===e||c===N||c===K?c:null}function dt(o){if(o==null)return null;let c=String(o).trim().toLowerCase();return["1","true","yes","on"].includes(c)?!0:["0","false","no","off"].includes(c)?!1:null}function W(o){return Array.isArray(o)?[...new Set(o.map(c=>String(c||"").trim()).filter(Boolean))]:[]}function Y(o){if(o==null||o==="")return null;let c=Number(o);return!Number.isInteger(c)||!M.RESULT_LIMIT_OPTIONS.includes(c)?null:c}function D(o=u.mode){return o===K?M.DEFAULT_RESULTS_LIMIT_BUS:o===N?M.DEFAULT_RESULTS_LIMIT_METRO:o===e?M.DEFAULT_RESULTS_LIMIT_TRAM:M.DEFAULT_RESULTS_LIMIT_RAIL}function h(o=u.mode){let c=Y(u.resultsLimitByMode?.[o]);return c??D(o)}function l(o){let c=R(o);if(!c)return[];try{let y=JSON.parse(c);return W(y)}catch{return[]}}function d(){let o=new URLSearchParams(window.location.search);return{mode:j(o.get("mode")),stopProvided:o.has("stop"),busStopId:o.get("stop")?o.get("stop").trim():null,linesProvided:o.has("line"),busLines:W(o.getAll("line")),destinationsProvided:o.has("dest"),busDestinations:W(o.getAll("dest")),resultsProvided:o.has("results"),resultsLimit:Y(o.get("results"))}}function m(){let o=d(),c=j(R(M.STORAGE_MODE_KEY));u.mode=o.mode||c||n;let y=String(R(M.STORAGE_BUS_STOP_KEY)||"").trim()||null,I=o.stopProvided?o.busStopId:y,A=l(M.STORAGE_BUS_LINES_KEY),V=l(M.STORAGE_BUS_DESTINATIONS_KEY),G=o.linesProvided?o.busLines:A,ct=o.destinationsProvided?o.busDestinations:V,X=!!I||G.length>0||ct.length>0;u.deferInitialStopContext=X,X?(u.deferredBusStopId=I,u.deferredBusLineFilters=[...G],u.deferredBusDestinationFilters=[...ct],u.busStopId=null,u.busLineFilters=[],u.busDestinationFilters=[]):(u.deferredBusStopId=null,u.deferredBusLineFilters=[],u.deferredBusDestinationFilters=[],u.busStopId=I,u.busLineFilters=G,u.busDestinationFilters=ct);let St=Y(R(M.STORAGE_RESULTS_LIMIT_RAIL_KEY)),q=Y(R(M.STORAGE_RESULTS_LIMIT_TRAM_KEY)),$=Y(R(M.STORAGE_RESULTS_LIMIT_METRO_KEY)),mt=Y(R(M.STORAGE_RESULTS_LIMIT_BUS_KEY));u.resultsLimitByMode[n]=St??M.DEFAULT_RESULTS_LIMIT_RAIL,u.resultsLimitByMode[e]=q??M.DEFAULT_RESULTS_LIMIT_TRAM,u.resultsLimitByMode[N]=$??M.DEFAULT_RESULTS_LIMIT_METRO,u.resultsLimitByMode[K]=mt??M.DEFAULT_RESULTS_LIMIT_BUS,o.resultsProvided&&o.resultsLimit!=null&&(u.resultsLimitByMode[u.mode]=o.resultsLimit)}function L(){w(M.STORAGE_MODE_KEY,u.mode),w(M.STORAGE_BUS_STOP_KEY,u.busStopId||""),w(M.STORAGE_BUS_LINES_KEY,JSON.stringify(u.busLineFilters)),w(M.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(u.busDestinationFilters)),w(M.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(h(n))),w(M.STORAGE_RESULTS_LIMIT_TRAM_KEY,String(h(e))),w(M.STORAGE_RESULTS_LIMIT_METRO_KEY,String(h(N))),w(M.STORAGE_RESULTS_LIMIT_BUS_KEY,String(h(K)))}function E(){let o=new URLSearchParams(window.location.search);u.mode===n?o.delete("mode"):o.set("mode",u.mode);let c=h(),y=D();if(c===y?o.delete("results"):o.set("results",String(c)),o.delete("stop"),o.delete("line"),o.delete("dest"),u.mode===K||u.mode===e||u.mode===N||u.mode===n){u.busStopId&&o.set("stop",u.busStopId);for(let V of u.busLineFilters)o.append("line",V);for(let V of u.busDestinationFilters)o.append("dest",V)}let I=o.toString(),A=`${window.location.pathname}${I?`?${I}`:""}${window.location.hash}`;window.history.replaceState(null,"",A)}function _(){L(),E()}H(),Object.assign(r,{updateLocationActionButtons:H,setLoading:at,setVoiceListening:rt,setStatus:Q,setResolvedLocationHint:f,showLocationPrompt:p,hideLocationPrompt:O,setPermissionRequired:T,setLastUpdated:F,getStorageItem:R,setStorageItem:w,safeString:v,toError:Z,sendClientReport:tt,reportClientError:x,reportClientMetric:et,getSessionElapsedMs:k,trackFirstSuccessfulRender:U,trackFirstManualInteraction:nt,trackFirstManualStopContextChange:S,trackInitialNearestStopResolved:st,normalizeMode:j,parseBoolean:dt,uniqueNonEmptyStrings:W,parseResultLimit:Y,getDefaultResultsLimit:D,getActiveResultsLimit:h,parseStoredArray:l,readStateFromUrl:d,hydrateInitialState:m,syncStateToStorage:L,syncStateToUrl:E,persistUiState:_})})();(()=>{let P=window.HMApp,{api:r,dom:n,state:e,constants:N}=P,{MODE_RAIL:K,MODE_TRAM:C,MODE_METRO:u,MODE_BUS:M}=N,H=1500,at=H+200,rt=14,Q=1300,J=null,f=null;function p(t=e.mode){return t===M||t===C||t===u||t===K}function O(t=e.mode){return t===K?{singular:"train",plural:"trains",title:"Rail"}:t===C?{singular:"tram",plural:"trams",title:"Tram"}:t===u?{singular:"metro",plural:"metros",title:"Metro"}:{singular:"bus",plural:"buses",title:"Bus"}}function T(t){let i=F(t);return i<=0?"Now":`${i}m`}function F(t){let i=new Date(t);return Math.floor((i.getTime()-Date.now())/6e4)}function R(t){let i=F(t);return i<=0||i<3?"departure-now":i<=10?"departure-soon":"departure-later"}function w(){let t=new Set((e.busFilterOptions.lines||[]).map(s=>s.value)),i=new Set((e.busFilterOptions.destinations||[]).map(s=>s.value));e.busLineFilters=e.busLineFilters.filter(s=>t.has(s)),e.busDestinationFilters=e.busDestinationFilters.filter(s=>i.has(s))}function v(t){if(!Array.isArray(t))return[];if(!p())return t;let i=new Set(e.busLineFilters),s=new Set(e.busDestinationFilters),a=String(e.busStopMemberFilterId||"").trim();return t.filter(g=>{if(i.size===0)return!0;let b=String(g?.line||"").trim();return i.has(b)}).filter(g=>{if(s.size===0)return!0;let b=String(g?.destination||"").trim();return s.has(b)}).filter(g=>a?String(g?.stopId||"").trim()===a:!0)}function Z(){let t=[{el:n.modeRailBtn,mode:K,index:0},{el:n.modeTramBtn,mode:C,index:1},{el:n.modeMetroBtn,mode:u,index:2},{el:n.modeBusBtn,mode:M,index:3}];for(let{el:i,mode:s,index:a}of t){if(!i)continue;let g=e.mode===s;if(i.setAttribute("aria-checked",String(g)),i.classList.toggle("is-active",g),g){let b=i.closest(".segment-control");b&&b.style.setProperty("--active-index",a)}}}function tt(){n.modeEyebrowEl&&(n.modeEyebrowEl.textContent="Helsinki Moves"),n.nextLabelEl&&(n.nextLabelEl.textContent="")}function x(t){if(!n.resultsLimitSelectEl||!n.resultsLimitSelectListEl)return;let i=n.resultsLimitSelectEl.getAttribute("aria-expanded")==="true",s=typeof t=="boolean"?t:!i;n.resultsLimitSelectEl.setAttribute("aria-expanded",String(s)),n.resultsLimitSelectListEl.classList.toggle("hidden",!s)}function k(t){let i=r.parseResultLimit(t);i==null||(x(!1),r.getActiveResultsLimit()===i)||(r.trackFirstManualInteraction("results_limit_change",{nextLimit:i,currentMode:e.mode}),e.resultsLimitByMode[e.mode]=i,r.persistUiState(),n.resultsLimitSelectLabelEl&&(n.resultsLimitSelectLabelEl.textContent=String(i)),e.currentCoords?r.load(e.currentCoords.lat,e.currentCoords.lon):r.requestLocationAndLoad())}function et(){if(!n.resultsLimitSelectListEl)return;let t=Array.isArray(N.RESULT_LIMIT_OPTIONS)?N.RESULT_LIMIT_OPTIONS:[],i=r.getActiveResultsLimit();n.resultsLimitSelectListEl.innerHTML="";for(let s of t){let a=document.createElement("li");a.setAttribute("role","option"),a.dataset.value=String(s),a.textContent=String(s),s===i&&a.setAttribute("aria-selected","true"),a.addEventListener("click",()=>k(String(s))),n.resultsLimitSelectListEl.appendChild(a)}n.resultsLimitSelectLabelEl&&(n.resultsLimitSelectLabelEl.textContent=String(i))}function U(){let t=S()?1:0;return Math.max(0,e.busLineFilters.length)+Math.max(0,e.busDestinationFilters.length)+t}function nt(t=e.busLineFilters.length,i=e.busDestinationFilters.length,s=S()){let a=Math.max(0,Number(t)||0)+Math.max(0,Number(i)||0)+(s?1:0);return a===0?"No filters":a===1?"1 filter":`${a} filters`}function S(){return p()?!!(e.stopFilterPinned||String(e.busStopMemberFilterId||"").trim()):!1}function st(){n.stopFilterSummaryEl?.classList?.remove?.("is-attention"),n.stopFiltersToggleBtnEl?.classList?.remove?.("is-attention")}function j(){f&&(clearTimeout(f),f=null)}function dt(){if(typeof window?.matchMedia=="function")try{if(window.matchMedia("(max-width: 679px)").matches)return!0}catch{}let t=Number(window?.innerWidth);return Number.isFinite(t)?t<=679:!1}function W(){if(dt())return!1;let t=Array.isArray(e.busFilterOptions?.lines)?e.busFilterOptions.lines.length:0,i=Array.isArray(e.busFilterOptions?.destinations)?e.busFilterOptions.destinations.length:0;return t+i<=rt}function Y(){if(!p())return;!e.stopFiltersPanelOpen&&W()?(e.stopFiltersPanelLockUntilMs=Date.now()+H,l(!0),j(),f=setTimeout(()=>{e.stopFiltersPanelLockUntilMs=0,l(!1),f=null},at)):e.stopFiltersPanelLockUntilMs=0,st(),n.stopFilterSummaryEl?.classList?.add?.("is-attention"),n.stopFiltersToggleBtnEl?.classList?.add?.("is-attention"),J&&(clearTimeout(J),J=null),J=setTimeout(()=>{st(),J=null},Q)}function D(){return Number(e.stopFiltersPanelLockUntilMs||0)>Date.now()}function h(){n.stopFilterSummaryEl&&(n.stopFilterSummaryEl.textContent=nt()),n.busStopSelectEl&&n.busStopSelectEl.classList.toggle("is-active-filter",S()),!(!n.stopFiltersToggleBtnEl||!n.stopFiltersPanelEl)&&(n.stopFiltersToggleBtnEl.setAttribute("aria-expanded",String(!!e.stopFiltersPanelOpen)),n.stopFiltersPanelEl.classList.toggle("hidden",!e.stopFiltersPanelOpen))}function l(t){e.stopFiltersPanelOpen=!!t,h()}function d(t){if(j(),(t===!1||t==null&&e.stopFiltersPanelOpen)&&D())return;let i=typeof t=="boolean"?t:!e.stopFiltersPanelOpen;l(i)}function m(t){n.busControlsEl&&(n.busControlsEl.classList.toggle("hidden",!t),n.busStopSelectWrapEl?.classList?.toggle?.("hidden",!t),n.stationTitleEl?.classList?.toggle?.("hidden",t),t||(j(),e.stopFiltersPanelOpen=!1,e.stopFiltersPanelLockUntilMs=0,st(),n.busStopSelectEl?.classList?.remove?.("is-active-filter"),yt(!1)),h())}function L(){e.latestResponse&&(r.render(e.latestResponse),r.setStatus(""))}function E({interactionType:t,changeType:i,showAttention:s=!1,requireLoad:a=!1,extraContext:g=null}){if(r.trackFirstManualInteraction(t,{currentMode:e.mode,...g&&typeof g=="object"?g:{}}),r.trackFirstManualStopContextChange(i,g),r.persistUiState(),h(),s&&Y(),a){e.currentCoords?r.load(e.currentCoords.lat,e.currentCoords.lon):r.requestLocationAndLoad();return}L()}function _(t,i){let s=String(i||"").trim();return s?t.includes(s)?t.filter(a=>a!==s):[...t,s]:t}function o(t,{interactionType:i="line_filter_toggle",changeType:s="line_filter_toggle",showAttention:a=!1}={}){if(!p())return!1;let g=_(e.busLineFilters,t);return g.length===e.busLineFilters.length?!1:(e.busLineFilters=g,E({interactionType:i,changeType:s,showAttention:a}),!0)}function c(t,{interactionType:i="destination_filter_toggle",changeType:s="destination_filter_toggle",showAttention:a=!1}={}){if(!p())return!1;let g=_(e.busDestinationFilters,t);return g.length===e.busDestinationFilters.length?!1:(e.busDestinationFilters=g,E({interactionType:i,changeType:s,showAttention:a}),!0)}function y(t){return e.busStops.find(i=>i.id===t)||null}function I(t){let i=r.uniqueNonEmptyStrings([...Array.isArray(t?.stopCodes)?t.stopCodes:[],t?.code]);return i.length===0&&t?.id&&i.push(String(t.id)),i}function A(t){return r.uniqueNonEmptyStrings([...Array.isArray(t?.memberStopIds)?t.memberStopIds:[],t?.id])}function V(t,i=null){let s=y(e.busStopId),a=String(i?.stopName||t?.stopName||s?.name||"").trim(),b=r.uniqueNonEmptyStrings([i?.stopCode,...Array.isArray(t?.stopCodes)?t.stopCodes:[],t?.stopCode,...I(s)])[0]||"";return a&&b?`${a} ${b}`:a||b||"\u2014"}function G(t,i=null){if(p())return V(t,i);let s=String(i?.stopName||t?.stopName||"").trim(),a=String(i?.stopCode||t?.stopCode||"").trim();return s&&a?`${s} ${a}`:s||a||"\u2014"}function ct(){if(n.dataScopeEl){if(typeof n.dataScopeEl.replaceChildren=="function"){n.dataScopeEl.replaceChildren();return}Array.isArray(n.dataScopeEl.children)&&(n.dataScopeEl.children.length=0),n.dataScopeEl.innerHTML=""}}function X(t,i="default"){let s=document.createElement("span");return s.className="data-scope-chip",i&&s.classList.add(`data-scope-chip--${i}`),s.textContent=t,s}function St(t){let i=String(e.busStopMemberFilterId||"").trim();if(i){let b=(Array.isArray(t?.station?.departures)?t.station.departures:[]).find(z=>String(z?.stopId||"").trim()===i),B=String(b?.stopCode||"").trim();return B||i}if(!e.stopFilterPinned)return"";let s=y(e.busStopId),a=String(I(s)[0]||"").trim();return a||String(s?.name||e.busStopId||"").trim()}function q(t){if(!n.dataScopeEl)return;if(ct(),n.dataScopeEl.textContent="",!p()){n.dataScopeEl.classList.add("hidden");return}let i=[],s=St(t);s&&i.push(X(s,"stop"));for(let a of e.busLineFilters)i.push(X(a,"line"));for(let a of e.busDestinationFilters)i.push(X(a,"destination"));if(i.length===0){n.dataScopeEl.classList.add("hidden");return}for(let a of i)n.dataScopeEl.appendChild(a);n.dataScopeEl.classList.remove("hidden")}function $(t,i,s,a){if(!t)return;if(t.innerHTML="",!Array.isArray(i)||i.length===0){let b=document.createElement("span");b.className="chip-empty",b.textContent="No options",t.appendChild(b);return}let g=new Set(s);for(let b of i){let B=document.createElement("button");B.type="button",B.className="chip-toggle",g.has(b.value)?(B.classList.add("is-active"),B.setAttribute("aria-pressed","true")):B.setAttribute("aria-pressed","false"),B.textContent=`${b.value} (${b.count})`,B.addEventListener("click",()=>a(b.value)),t.appendChild(B)}}function mt(){let t=Array.isArray(e.latestResponse?.station?.departures)?e.latestResponse.station.departures:[],i=new Map;for(let s of t){let a=String(s?.stopId||"").trim();if(!a)continue;let g=i.get(a);g?(g.count+=1,g.stopCode||(g.stopCode=String(s?.stopCode||"").trim()),g.stopName||(g.stopName=String(s?.stopName||"").trim())):i.set(a,{id:a,count:1,stopCode:String(s?.stopCode||"").trim(),stopName:String(s?.stopName||"").trim()})}return[...i.values()].sort((s,a)=>a.count-s.count||s.id.localeCompare(a.id)).map(s=>{let a=gt({stopId:s.id,stopCode:s.stopCode||"",stopName:s.stopName||""},e.latestResponse?.station||null);return{...s,selectableStopId:a.selectableStopId}})}function bt(){if(!n.busStopFiltersEl)return;n.busStopFiltersEl.innerHTML="";let t=mt();if(t.length===0){let s=document.createElement("span");s.className="chip-empty",s.textContent="No stops",n.busStopFiltersEl.appendChild(s);return}let i=String(e.busStopMemberFilterId||"").trim();for(let s of t){let a=document.createElement("button");a.type="button",a.className="chip-toggle",a.dataset.value=s.id,!!(i&&s.id===i)?(a.classList.add("is-active"),a.setAttribute("aria-pressed","true")):a.setAttribute("aria-pressed","false");let b=s.stopCode||s.id;a.textContent=b,a.addEventListener("click",()=>vt(s.selectableStopId,s.id)),n.busStopFiltersEl.appendChild(a)}}function yt(t){if(!n.busStopSelectEl||!n.busStopSelectListEl)return;let i=n.busStopSelectEl.getAttribute("aria-expanded")==="true",s=typeof t=="boolean"?t:!i;n.busStopSelectEl.setAttribute("aria-expanded",String(s)),n.busStopSelectListEl.classList.toggle("hidden",!s)}function Tt(t){if(!e.suppressBusStopChange){if(!t||t===e.busStopId){yt(!1);return}if(e.busStopId=t,e.stopFilterPinned=!0,e.busStopMemberFilterId=null,yt(!1),n.busStopSelectLabelEl){let i=e.busStops.find(s=>s.id===t);n.busStopSelectLabelEl.textContent=i?i.name:t}E({interactionType:"stop_select",changeType:"stop_select",requireLoad:!0,extraContext:{selectedStopId:t}})}}function Ct(){return e.busStops[0]?.id||null}function _t(t,i=null){let s=String(t||"").trim();if(!s||!e.stopFilterPinned||String(e.busStopId||"").trim()!==s)return!1;let g=String(e.busStopMemberFilterId||"").trim(),b=String(i||"").trim();return b?g===b:!g}function vt(t,i=null){if(!p())return!1;let s=String(t||"").trim()||null,a=String(i||"").trim()||null,g=String(e.busStopId||"").trim()||null,b=String(e.busStopMemberFilterId||"").trim()||null,B=Ct(),z=s||g||B;if(!z)return!1;let pt=!!e.stopFilterPinned,ft=_t(z,a),it=g,ut=pt,lt=b;ft?(ut=!1,lt=null,it=B||z):(it=z,ut=!0,lt=a);let Et=it!==g;if(it===g&&ut===pt&&lt===b)return!1;if(e.busStopId=it,e.stopFilterPinned=ut,e.busStopMemberFilterId=lt,n.busStopSelectLabelEl){let Lt=y(e.busStopId);n.busStopSelectLabelEl.textContent=Lt?Lt.name:"Nearest stop"}return E({interactionType:"result_card_stop_toggle",changeType:"result_card_stop_toggle",showAttention:!0,requireLoad:Et,extraContext:{selectedStopId:e.busStopId||"",selectedMemberStopId:e.busStopMemberFilterId||""}}),!0}function gt(t,i=null){let s=String(t?.stopId||"").trim();if(s){let g=e.busStops.find(b=>A(b).includes(s));if(g?.id)return{selectableStopId:g.id,memberStopId:s}}let a=r.uniqueNonEmptyStrings([t?.stopCode,...Array.isArray(i?.stopCodes)?i.stopCodes:[],i?.stopCode]);for(let g of a){let b=e.busStops.find(B=>I(B).includes(g));if(b?.id)return{selectableStopId:b.id,memberStopId:s||null}}return{selectableStopId:e.busStopId||Ct(),memberStopId:s||null}}function kt(t,i=null){return gt(t,i).selectableStopId}function ot(t){t&&(t.classList?.remove?.("result-filter-trigger","is-active"),t.removeAttribute?.("role"),t.removeAttribute?.("tabindex"),t.removeAttribute?.("aria-pressed"),t.removeAttribute?.("aria-label"),t.onclick=null,t.onkeydown=null)}function It(t,{active:i=!1,onActivate:s,ariaLabel:a}){if(!t||typeof s!="function"){ot(t);return}t.classList?.add?.("result-filter-trigger"),t.classList?.toggle?.("is-active",!!i),t.setAttribute?.("role","button"),t.setAttribute?.("tabindex","0"),t.setAttribute?.("aria-pressed",String(!!i)),t.setAttribute?.("aria-label",String(a||"Toggle filter"));let g=()=>s();t.onclick=()=>g(),t.onkeydown=b=>{let B=b?.key;B!=="Enter"&&B!==" "&&B!=="Spacebar"||(b?.preventDefault?.(),g())}}function Mt(t,i){let s=String(i||"").trim();if(!p()||!s){ot(t);return}It(t,{active:e.busLineFilters.includes(s),onActivate:()=>wt(s),ariaLabel:`Toggle line filter ${s}`})}function Rt(t,i){let s=String(i||"").trim();if(!p()||!s){ot(t);return}It(t,{active:e.busDestinationFilters.includes(s),onActivate:()=>At(s),ariaLabel:`Toggle destination filter ${s}`})}function Ft(t,i,s){if(!p()){ot(t);return}It(t,{active:_t(i,s),onActivate:()=>vt(i,s),ariaLabel:"Toggle stop filter"})}function wt(t){return o(t,{interactionType:"result_card_line_toggle",changeType:"result_card_line_toggle",showAttention:!0})}function At(t){return c(t,{interactionType:"result_card_destination_toggle",changeType:"result_card_destination_toggle",showAttention:!0})}function Ot(){let t=p();if(m(t),!!t){if(h(),n.busStopSelectListEl){if(e.suppressBusStopChange=!0,n.busStopSelectListEl.innerHTML="",e.busStops.length===0)n.busStopSelectLabelEl&&(n.busStopSelectLabelEl.textContent=`No nearby ${O().singular} stops`),n.busStopSelectEl&&(n.busStopSelectEl.disabled=!0);else{n.busStopSelectEl&&(n.busStopSelectEl.disabled=!1);let i=e.busStopId;(!i||!e.busStops.some(s=>s.id===i))&&(i=e.busStops[0].id);for(let s of e.busStops){let a=document.createElement("li");a.setAttribute("role","option"),a.dataset.value=s.id,a.textContent=`${s.name} (${s.distanceMeters}m)`,s.id===i&&a.setAttribute("aria-selected","true"),a.addEventListener("click",()=>Tt(s.id)),n.busStopSelectListEl.appendChild(a)}if(n.busStopSelectLabelEl){let s=e.busStops.find(a=>a.id===i);n.busStopSelectLabelEl.textContent=s?s.name:"Select stop"}}e.suppressBusStopChange=!1}bt(),$(n.busLineFiltersEl,e.busFilterOptions.lines,e.busLineFilters,i=>o(i)),$(n.busDestinationFiltersEl,e.busFilterOptions.destinations,e.busDestinationFilters,i=>c(i))}}function ht(t,i=null){if(!n.nextSummaryEl||!n.nextMinsEl||!n.nextLineEl||!n.nextTrackEl||!n.nextDestinationEl)return;if(!t){n.nextSummaryEl.classList.add("hidden"),n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),ot(n.nextLineEl),ot(n.nextDestinationEl),ot(n.nextTrackEl);return}let s=F(t.departureIso);if(n.nextMinsEl.textContent=T(t.departureIso),n.nextLineEl.textContent=t.line||"\u2014",n.nextLineEl.classList.toggle("next-letter-now",s<3),n.nextTrackEl.textContent=p()?G(i,t):t.track?`Track ${t.track}`:"Track \u2014",n.nextDestinationEl.textContent=t.destination||"\u2014",p()){let a=gt(t,i);Mt(n.nextLineEl,t.line),Rt(n.nextDestinationEl,t.destination),Ft(n.nextTrackEl,a.selectableStopId,a.memberStopId)}else ot(n.nextLineEl),ot(n.nextDestinationEl),ot(n.nextTrackEl);n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),s<3?n.nextSummaryEl.classList.add("next-summary-now"):s<=10?n.nextSummaryEl.classList.add("next-summary-soon"):n.nextSummaryEl.classList.add("next-summary-later"),n.nextSummaryEl.classList.remove("hidden")}function xt(t){if(!t||!t.station)return p()?t?.message||`No nearby ${O().singular} stops found.`:t?.message||"No nearby train stations found.";let s=v(t.station.departures)[0];if(!s)return p()?e.busLineFilters.length>0||e.busDestinationFilters.length>0||S()?`No upcoming ${O().plural} match selected filters.`:"No upcoming departures from this stop.":"No upcoming commuter trains right now.";let a=O().singular;return`${a.charAt(0).toUpperCase()+a.slice(1)} in ${T(s.departureIso)}`}function Nt(t){if(!(t instanceof Error))return"Could not refresh departures. Please try again.";if(t.name==="AbortError")return"Request timed out. Please try again.";let i=(t.message||"").trim();return i==="Temporary server error. Please try again."?i:i==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":i==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function Ut(t){return t?.code===1?"Location permission denied.":t?.code===2?"Location unavailable. Please try again.":t?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function Pt(t){let i=String(t?.code||"").trim();return i==="voice_unsupported"?"Voice location is not supported in this browser.":i==="voice_permission_denied"?"Microphone permission denied.":i==="voice_no_microphone"?"No microphone was found for voice location.":i==="voice_no_speech"?"No speech detected. Please try again.":i==="voice_recognition_timeout"?"Voice listening timed out. Please try again.":i==="voice_language_not_supported"?"Voice language was not supported on this device.":i==="voice_query_too_short"?"Please describe your location with a few words.":i==="voice_location_not_found"?"Could not match that place. Try a nearby landmark or street.":i==="voice_location_selection_cancelled"?"Location selection was cancelled.":i==="voice_location_selection_invalid"?"Please choose one of the suggested locations.":i==="voice_recognition_network"?"Voice recognition failed due to a network error. On iPhone, try enabling Siri & Dictation.":"Could not use voice location. Please try again."}function Dt(){n.skeletonEl&&n.skeletonEl.classList.remove("hidden")}function Bt(){n.skeletonEl&&n.skeletonEl.classList.add("hidden")}function Vt(t){return String(t||"").trim()==="200"}function qt(t){if(Bt(),Ot(),q(t),!t||!t.station){n.resultEl.classList.add("hidden"),ht(null);return}let i=t.station;n.resultEl.classList.remove("hidden"),n.stationTitleEl.textContent=i.stopName,n.stationMetaEl.textContent=`${i.distanceMeters}m away`,n.departuresEl.innerHTML="";let s=v(i.departures);if(s.length===0){ht(null);let g=document.createElement("li");g.className="empty-row",p()?g.textContent=e.busLineFilters.length>0||e.busDestinationFilters.length>0||S()?`No upcoming ${O().plural} match selected filters.`:"No upcoming departures from this stop.":g.textContent="No upcoming commuter trains right now.",n.departuresEl.appendChild(g);return}ht(null);let a=s;for(let g=0;g<a.length;g++){let b=a[g],B=document.createElement("li");B.className=`departure-row ${R(b.departureIso)}`,B.style.setProperty("--i",g);let z=document.createElement("div");z.className="letter-badge route-badge",z.textContent=b.line||"?",Vt(b.line)&&z.classList.add("route-badge-cool"),p()&&Mt(z,b.line);let pt=document.createElement("div");pt.className="train departure-main";let ft=document.createElement("div");ft.className="destination",ft.textContent=b.destination||"\u2014",p()&&Rt(ft,b.destination),pt.appendChild(ft);let it=document.createElement("span");if(it.className="track",p()){it.textContent=G(i,b);let Lt=gt(b,i);Ft(it,Lt.selectableStopId,Lt.memberStopId)}else it.textContent=b.track?`Track ${b.track}`:"Track \u2014";pt.appendChild(it);let ut=document.createElement("div");ut.className="time departure-timing";let lt=document.createElement("span");lt.className="remaining",lt.textContent=T(b.departureIso),lt.classList.toggle("time-now",lt.textContent==="Now");let Et=document.createElement("span");Et.className="clock-time",Et.textContent=new Date(b.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),ut.appendChild(lt),ut.appendChild(Et),B.appendChild(z),B.appendChild(pt),B.appendChild(ut),n.departuresEl.appendChild(B)}}function $t(){n.nowClockEl&&(n.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(r,{formatMinutes:T,minutesUntil:F,departureRowClass:R,sanitizeStopSelections:w,getVisibleDepartures:v,updateModeButtons:Z,updateModeLabels:tt,toggleResultsLimitDropdown:x,selectResultsLimit:k,renderResultsLimitControl:et,countActiveStopFilters:U,buildStopFilterSummary:nt,syncStopFiltersPanelUi:h,setStopFiltersPanelOpen:l,toggleStopFiltersPanel:d,setStopControlsVisibility:m,getStopMeta:y,getStopCodes:I,buildStopDisplay:V,buildModeStopDisplay:G,updateDataScope:q,renderFilterButtons:$,toggleStopDropdown:yt,selectStop:Tt,toggleLineFilter:o,toggleDestinationFilter:c,toggleLineFilterFromResultCard:wt,toggleDestinationFilterFromResultCard:At,toggleStopFromResultCard:vt,isStopTargetActive:_t,resolveStopTargetFromDeparture:gt,resolveStopIdFromDeparture:kt,setResultFilterTrigger:It,clearResultFilterTrigger:ot,triggerStopFilterAttention:Y,renderStopControls:Ot,updateNextSummary:ht,buildStatusFromResponse:xt,getLoadErrorStatus:Nt,getGeolocationErrorStatus:Ut,getVoiceLocationErrorStatus:Pt,showSkeleton:Dt,hideSkeleton:Bt,render:qt,updateClock:$t})})();(()=>{let P=window.HMApp,{api:r,dom:n,state:e,constants:N}=P,{MODE_RAIL:K,MODE_TRAM:C,MODE_METRO:u,MODE_BUS:M}=N;function H(l){return l===M||l===C||l===u||l===K}function at(l){return new Promise(d=>setTimeout(d,l))}async function rt(l,d={},m=N.FETCH_TIMEOUT_MS){let L=new AbortController,E=setTimeout(()=>L.abort(),m);try{return await fetch(l,{...d,signal:L.signal})}finally{clearTimeout(E)}}async function Q(l,d={}){let m;try{m=await rt(l,d)}catch{return await at(350),rt(l,d)}return m.status>=500?(await at(350),rt(l,d)):m}function J(l){let d=new Map,m=new Map;for(let E of l||[]){let _=String(E?.line||"").trim();_&&d.set(_,(d.get(_)||0)+1);let o=String(E?.destination||"").trim();o&&m.set(o,(m.get(o)||0)+1)}let L=E=>[...E.entries()].sort((_,o)=>o[1]-_[1]||_[0].localeCompare(o[0])).map(([_,o])=>({value:_,count:o}));return{lines:L(d),destinations:L(m)}}function f(l){let d=Array.isArray(l?.stops)?l.stops.filter(I=>I&&I.id&&I.name).map(I=>({id:I.id,name:I.name,code:String(I.code||"").trim()||null,memberStopIds:r.uniqueNonEmptyStrings([...Array.isArray(I.memberStopIds)?I.memberStopIds:[],I.id]),stopCodes:r.uniqueNonEmptyStrings([...Array.isArray(I.stopCodes)?I.stopCodes:[],I.code]),distanceMeters:Number(I.distanceMeters)||0})):[];e.busStops=d;let m=String(l?.selectedStopId||"").trim()||null,L=I=>d.some(A=>A.id===I),E=String(e.busStopId||"").trim()||null,_=!!(E&&!L(E)&&!(m&&L(m)));m&&L(m)?e.busStopId=m:(!e.busStopId||!L(e.busStopId))&&(e.busStopId=d[0]?.id||null);let o=d[0]?.id||null;e.busStopId?o&&e.busStopId!==o?e.stopFilterPinned=!0:_&&(e.stopFilterPinned=!1):e.stopFilterPinned=!1,e.deferInitialStopContext&&(e.deferInitialStopContext=!1,e.deferredBusStopId=null,e.deferredBusLineFilters=[],e.deferredBusDestinationFilters=[],e.busLineFilters=[],e.busDestinationFilters=[],e.stopFilterPinned=!1,e.busStopMemberFilterId=null),e.hasCompletedInitialStopModeLoad=!0;let c=Array.isArray(l?.station?.departures)?l.station.departures:[],y=new Set(c.map(I=>String(I?.stopId||"").trim()).filter(Boolean));e.stopFilterPinned?e.busStopMemberFilterId&&!y.has(String(e.busStopMemberFilterId).trim())&&(e.busStopMemberFilterId=null):e.busStopMemberFilterId=null,e.busFilterOptions=J(c),r.sanitizeStopSelections()}function p(l,d){let m=new Error(d);return m.code=l,m}function O(l){return String(l?.code||"").trim().toLowerCase()}function T(){return r.uniqueNonEmptyStrings(["fi-FI","en-US",...Array.isArray(navigator.languages)?navigator.languages:[],navigator.language])}function F(){return typeof window.SpeechRecognition=="function"?window.SpeechRecognition:typeof window.webkitSpeechRecognition=="function"?window.webkitSpeechRecognition:null}function R(){return!!F()}function w(l){return l==="not-allowed"||l==="service-not-allowed"?p("voice_permission_denied","Microphone permission denied."):l==="audio-capture"?p("voice_no_microphone","No microphone available."):l==="language-not-supported"?p("voice_language_not_supported","Speech language is not supported."):l==="network"?p("voice_recognition_network","Voice recognition network error."):l==="no-speech"?p("voice_no_speech","No speech detected."):p("voice_not_understood","Voice recognition failed.")}function v(l){let d=F();return d?new Promise((m,L)=>{let E=new d,_=String(l||navigator.language||"fi-FI").trim();E.lang=_||"fi-FI",E.continuous=!1,E.interimResults=!0,E.maxAlternatives=1;let o=!1,c="",y=null,I=!1,A=()=>{clearTimeout(y),y=null},V=()=>{if(!(I||o)){I=!0;try{E.stop()}catch{}}},G=()=>{A(),y=setTimeout(V,N.VOICE_SILENCE_STOP_MS)},ct=()=>{clearTimeout(St),A(),E.onresult=null,E.onerror=null,E.onend=null,E.onspeechend=null,E.onsoundend=null,E.onaudioend=null,E.onnomatch=null},X=(q,$)=>{o||(o=!0,ct(),q($))},St=setTimeout(()=>{try{E.abort()}catch{}X(L,p("voice_recognition_timeout","Voice recognition timed out."))},N.VOICE_RECOGNITION_TIMEOUT_MS);E.onresult=q=>{for(let $=q?.resultIndex||0;$<(q?.results?.length||0);$+=1){let mt=q.results[$],bt=String(mt?.[0]?.transcript||"").trim();if(bt&&(c=bt,G(),mt?.isFinal)){V();return}}},E.onerror=q=>{let $=String(q?.error||"").trim().toLowerCase();X(L,w($))},E.onend=()=>{if(o)return;let q=String(c||"").trim();if(!q){X(L,p("voice_no_speech","No speech detected."));return}X(m,q)},E.onspeechend=()=>{V()},E.onsoundend=()=>{G()},E.onaudioend=()=>{G()},E.onnomatch=()=>{X(L,p("voice_not_understood","Could not understand speech."))};try{E.start()}catch(q){let $=String(q?.name||"").trim().toLowerCase();if($==="notallowederror"||$==="securityerror"){X(L,p("voice_permission_denied","Microphone permission denied."));return}X(L,p("voice_not_understood","Unable to start voice recognition."))}}):Promise.reject(p("voice_unsupported","Voice recognition not supported."))}function Z(l){return l==="voice_no_speech"||l==="voice_not_understood"||l==="voice_recognition_timeout"||l==="voice_language_not_supported"}async function tt(){let l=T(),d=null;for(let m of l)try{return await v(m)}catch(L){if(d=L,!Z(O(L)))break}throw d||p("voice_not_understood","Voice recognition failed.")}function x(l){return Array.isArray(l)?l.map(d=>{let m=Number(d?.lat),L=Number(d?.lon);return!Number.isFinite(m)||!Number.isFinite(L)?null:{lat:m,lon:L,label:String(d?.label||"").trim()}}).filter(Boolean):[]}function k(){n.voiceLocationChoicesEl&&n.voiceLocationChoicesEl.classList.add("hidden"),n.voiceLocationChoicesTitleEl&&(n.voiceLocationChoicesTitleEl.textContent=""),n.voiceLocationChoicesOptionsEl&&(n.voiceLocationChoicesOptionsEl.innerHTML=""),n.voiceLocationChoicesCancelEl&&(n.voiceLocationChoicesCancelEl.onclick=null)}function et(l,d){if(typeof window.prompt!="function")throw p("voice_location_selection_cancelled","Location selection was cancelled.");let m=d.map((_,o)=>`${o+1}. ${_.label||`${_.lat}, ${_.lon}`}`).join(`
`),L=window.prompt(`Multiple matches found for "${r.safeString(l,80)}". Select number:
${m}`,"1");if(L==null)throw p("voice_location_selection_cancelled","Location selection was cancelled.");let E=Number.parseInt(String(L).trim(),10);if(!Number.isInteger(E)||E<1||E>d.length)throw p("voice_location_selection_invalid","Invalid location selection.");return d[E-1]}async function U(l,d){if(!Array.isArray(d)||d.length===0)throw p("voice_location_not_found","No matching location found.");return!n.voiceLocationChoicesEl||!n.voiceLocationChoicesTitleEl||!n.voiceLocationChoicesOptionsEl||!n.voiceLocationChoicesCancelEl?et(l,d):new Promise((m,L)=>{let E=!1,_=(o,c)=>{E||(E=!0,k(),o(c))};n.voiceLocationChoicesTitleEl.textContent=`Multiple matches for "${r.safeString(l,80)}". Choose one:`,r.setStatus("Multiple matches found. Choose one below."),n.voiceLocationChoicesOptionsEl.innerHTML="";for(let o of d){let c=document.createElement("button");c.type="button",c.className="voice-location-choice-option",c.textContent=o.label||`${o.lat.toFixed(5)}, ${o.lon.toFixed(5)}`,c.addEventListener("click",()=>_(m,o),{once:!0}),n.voiceLocationChoicesOptionsEl.appendChild(c)}n.voiceLocationChoicesCancelEl.onclick=()=>_(L,p("voice_location_selection_cancelled","Location selection was cancelled.")),n.voiceLocationChoicesEl.classList.remove("hidden")})}async function nt(l){let d=String(l||"").trim();if(d.length<N.VOICE_QUERY_MIN_LENGTH)throw p("voice_query_too_short","Voice query too short.");let m=new URLSearchParams({text:d});e.currentCoords&&(m.set("lat",String(e.currentCoords.lat)),m.set("lon",String(e.currentCoords.lon)));let L=Array.isArray(navigator.languages)&&navigator.languages[0]||navigator.language||"";L&&m.set("lang",String(L));let E;try{E=await Q(`/api/v1/geocode?${m.toString()}`)}catch{throw p("voice_geocode_failed","Location lookup failed.")}if(!(E.headers.get("content-type")||"").includes("application/json"))throw p("voice_geocode_failed","Unexpected location lookup response.");let o=await E.json();if(!E.ok)throw p("voice_geocode_failed",String(o?.error||"Location lookup failed.").trim());let c=x(o?.choices);if(o?.ambiguous&&c.length>1){let A=await U(d,c);return{lat:A.lat,lon:A.lon,label:A.label,query:d}}let y=Number(o?.location?.lat),I=Number(o?.location?.lon);if(!Number.isFinite(y)||!Number.isFinite(I))throw p("voice_location_not_found","No matching location found.");return{lat:y,lon:I,label:String(o?.location?.label||"").trim(),query:d}}function S(l){return l==="voice_unsupported"||l==="voice_no_speech"||l==="voice_recognition_timeout"||l==="voice_recognition_network"||l==="voice_not_understood"}function st(l){if(!S(l)||typeof window.prompt!="function")return null;let d=l==="voice_unsupported"?"Voice input is limited in this browser. Type your location instead:":"Could not capture your voice on this device. Type your location:",m=window.prompt(`${d}
Example: Kamppi Helsinki`,"");return String(m||"").trim()||null}async function j(l){let d=String(l||"").trim();k(),r.setStatus(`Looking up "${r.safeString(d,80)}"...`);let m=await nt(d);return r.setResolvedLocationHint({query:d,label:m.label,lat:m.lat,lon:m.lon}),e.currentCoords={lat:m.lat,lon:m.lon},r.setPermissionRequired(!1),await W(m.lat,m.lon),!0}async function dt(){if(e.isLoading||e.isVoiceListening)return!1;k(),r.setVoiceListening(!0),r.setStatus("Listening... speak now, then pause.");try{if(!R()){let d=p("voice_unsupported","Voice recognition not supported."),m=st(O(d));return m?j(m):(r.setStatus(r.getVoiceLocationErrorStatus(d)),!1)}let l=await tt();return j(l)}catch(l){let d=O(l),m=st(d);if(m)try{return await j(m)}catch(L){return console.error("voice fallback location error:",L),r.reportClientError("voice-location-fallback",L,{mode:e.mode,sourceCode:d||"unknown"}),r.setStatus(r.getVoiceLocationErrorStatus(L)),!1}return(!d||d==="unknown")&&console.error("voice location error:",l),r.reportClientError("voice-location",l,{mode:e.mode,code:d||"unknown"}),r.setStatus(r.getVoiceLocationErrorStatus(l)),!1}finally{r.setVoiceListening(!1)}}async function W(l,d){let m=++e.latestLoadToken,L=e.mode,E=e.busStopId,_=H(L)&&!e.hasCompletedInitialStopModeLoad;r.setLoading(!0),r.setStatus("Loading departures...");try{let o=new URLSearchParams({lat:String(l),lon:String(d),mode:L.toUpperCase(),results:String(r.getActiveResultsLimit(L))}),c=H(L)&&(e.deferInitialStopContext||!e.hasCompletedInitialStopModeLoad);H(L)&&E&&!c&&o.set("stopId",E);let y=await Q(`/api/v1/departures?${o.toString()}`);if(!(y.headers.get("content-type")||"").includes("application/json"))throw y.ok?new Error("Unexpected server response."):new Error("Request failed");let A=await y.json();if(!y.ok)throw new Error(A.error||"Request failed");if(m!==e.latestLoadToken)return;H(L)&&(f(A),r.persistUiState(),_&&r.trackInitialNearestStopResolved(A,L)),e.latestResponse=A,r.render(A),r.setPermissionRequired(!1),r.setLastUpdated(new Date),r.setStatus(""),r.trackFirstSuccessfulRender(A,L)}catch(o){if(m!==e.latestLoadToken)return;e.latestResponse=null,console.error("load departures error:",o),r.reportClientError("load",o,{mode:L}),r.setStatus(r.getLoadErrorStatus(o)),n.resultEl.classList.add("hidden"),r.updateNextSummary(null)}finally{m===e.latestLoadToken&&r.setLoading(!1)}}function Y(){if(k(),r.setResolvedLocationHint(null),!navigator.geolocation)return r.setStatus("Geolocation not supported in this browser."),r.setPermissionRequired(!0),!1;if(e.isLoading||e.isVoiceListening)return!1;r.setStatus("Getting your location..."),r.setLoading(!0);let l=_=>({enableHighAccuracy:_,timeout:_?15e3:1e4,maximumAge:0}),d=(_,o)=>o?!1:_?.code===2||_?.code===3,m=_=>{e.currentCoords={lat:_.coords.latitude,lon:_.coords.longitude},e.locationGranted=!0,r.setStorageItem("location:granted","1"),r.setPermissionRequired(!1),r.setLoading(!1),W(e.currentCoords.lat,e.currentCoords.lon)},L=_=>{_.code===1?r.setPermissionRequired(!0):r.setPermissionRequired(!1),r.setStatus(r.getGeolocationErrorStatus(_)),e.latestResponse=null,n.resultEl.classList.add("hidden"),r.updateNextSummary(null),r.setLoading(!1)},E=_=>{navigator.geolocation.getCurrentPosition(m,o=>{if(d(o,_)){E(!0);return}L(o)},l(_))};return E(!1),!0}function D(){if(!e.isVoiceListening){if(e.currentCoords){W(e.currentCoords.lat,e.currentCoords.lon);return}Y()}}function h(l={}){let d=!!l.modeOnly;r.updateModeButtons(),r.updateModeLabels(),!d&&(r.renderResultsLimitControl(),r.renderStopControls(),r.updateDataScope(e.latestResponse))}Object.assign(r,{delay:at,fetchWithTimeout:rt,fetchWithRetryOnce:Q,updateStopModeStateFromResponse:f,buildFilterOptionsFromDepartures:J,load:W,requestLocationAndLoad:Y,requestVoiceLocationAndLoad:dt,supportsVoiceLocation:R,captureVoiceQuery:v,captureVoiceQueryWithRetry:tt,getVoiceRecognitionLanguages:T,shouldRetryVoiceRecognition:Z,resolveVoiceLocationQuery:nt,refreshDeparturesOnly:D,applyModeUiState:h})})();(()=>{let P=window.HMApp,{api:r,dom:n,state:e,constants:N}=P,{MODE_RAIL:K,MODE_TRAM:C,MODE_METRO:u,MODE_BUS:M}=N,H=window.location.search;function at(){if(e.currentCoords){r.load(e.currentCoords.lat,e.currentCoords.lon);return}r.requestLocationAndLoad()}function rt(f){if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(f);return}setTimeout(f,0)}function Q(f){e.mode!==f&&(r.trackFirstManualInteraction("mode_change",{toMode:f}),e.mode=f,r.applyModeUiState({modeOnly:!0}),rt(()=>{r.applyModeUiState(),r.persistUiState(),at()}))}n.locateBtn?.addEventListener("click",()=>{r.trackFirstManualInteraction("refresh_location_click"),r.requestLocationAndLoad()}),n.voiceLocateBtn?.addEventListener("click",()=>{r.trackFirstManualInteraction("voice_location_click"),r.requestVoiceLocationAndLoad()}),n.modeRailBtn?.addEventListener("click",()=>{Q(K)}),n.modeTramBtn?.addEventListener("click",()=>{Q(C)}),n.modeMetroBtn?.addEventListener("click",()=>{Q(u)}),n.modeBusBtn?.addEventListener("click",()=>{Q(M)}),n.resultsLimitSelectEl?.addEventListener("click",f=>{f.stopPropagation(),r.toggleResultsLimitDropdown()}),document.addEventListener("click",f=>{n.resultsLimitSelectWrapEl&&(n.resultsLimitSelectWrapEl.contains(f.target)||r.toggleResultsLimitDropdown(!1))}),n.resultsLimitSelectEl?.addEventListener("keydown",f=>{let p=n.resultsLimitSelectListEl;if(!p)return;let O=n.resultsLimitSelectEl.getAttribute("aria-expanded")==="true";if(f.key==="Escape"){r.toggleResultsLimitDropdown(!1),n.resultsLimitSelectEl.focus(),f.preventDefault();return}if(f.key==="Enter"||f.key===" "){if(!O){r.toggleResultsLimitDropdown(!0),f.preventDefault();return}let T=p.querySelector(".is-focused");T?.dataset?.value&&r.selectResultsLimit(T.dataset.value),f.preventDefault();return}if(f.key==="ArrowDown"||f.key==="ArrowUp"){if(f.preventDefault(),!O){r.toggleResultsLimitDropdown(!0);return}let T=[...p.querySelectorAll("li[role='option']")];if(T.length===0)return;let F=T.findIndex(w=>w.classList.contains("is-focused")),R;f.key==="ArrowDown"?R=F<T.length-1?F+1:0:R=F>0?F-1:T.length-1;for(let w of T)w.classList.remove("is-focused");T[R].classList.add("is-focused"),T[R].scrollIntoView({block:"nearest"})}}),n.busStopSelectEl?.addEventListener("click",f=>{f.stopPropagation(),r.toggleStopDropdown()}),document.addEventListener("click",f=>{n.busStopSelectWrapEl&&(n.busStopSelectWrapEl.contains(f.target)||r.toggleStopDropdown(!1))}),n.busStopSelectEl?.addEventListener("keydown",f=>{let p=n.busStopSelectListEl;if(!p)return;let O=n.busStopSelectEl.getAttribute("aria-expanded")==="true";if(f.key==="Escape"){r.toggleStopDropdown(!1),n.busStopSelectEl.focus(),f.preventDefault();return}if(f.key==="Enter"||f.key===" "){if(!O){r.toggleStopDropdown(!0),f.preventDefault();return}let T=p.querySelector(".is-focused");T?.dataset?.value&&r.selectStop(T.dataset.value),f.preventDefault();return}if(f.key==="ArrowDown"||f.key==="ArrowUp"){if(f.preventDefault(),!O){r.toggleStopDropdown(!0);return}let T=[...p.querySelectorAll("li[role='option']")];if(T.length===0)return;let F=T.findIndex(w=>w.classList.contains("is-focused")),R;f.key==="ArrowDown"?R=F<T.length-1?F+1:0:R=F>0?F-1:T.length-1;for(let w of T)w.classList.remove("is-focused");T[R].classList.add("is-focused"),T[R].scrollIntoView({block:"nearest"})}}),n.stopFiltersToggleBtnEl?.addEventListener("click",()=>{r.trackFirstManualInteraction("stop_filters_panel_toggle",{currentMode:e.mode}),r.toggleStopFiltersPanel()}),n.locationPromptAllowEl?.addEventListener("click",()=>{r.hideLocationPrompt(),r.requestLocationAndLoad()}),n.permissionRetryBtnEl?.addEventListener("click",()=>{r.trackFirstManualInteraction("permission_retry_click"),r.requestLocationAndLoad()}),r.hydrateInitialState(),r.applyModeUiState(),r.updateClock(),setInterval(r.updateClock,1e3),r.getStorageItem("location:granted")==="1"?r.requestLocationAndLoad():(r.showLocationPrompt(),r.setStatus("Tap Allow Location to get started.")),setInterval(r.refreshDeparturesOnly,3e4),window.addEventListener("error",f=>{r.reportClientError("error",f.error||f.message||"Unknown error",{source:f.filename||"",line:f.lineno||null,column:f.colno||null})}),window.addEventListener("unhandledrejection",f=>{r.reportClientError("unhandledrejection",f.reason||"Unhandled promise rejection")}),(()=>{let f=document.getElementById("themeToggle");if(!f)return;let p=document.documentElement,O=window.matchMedia("(prefers-color-scheme: dark)"),T=()=>{let v=r.getStorageItem("theme");return v==="dark"||v==="light"?v:null},F=v=>{p.setAttribute("data-theme",v==="light"?"light":"dark")},R=()=>{let v=T();if(v){F(v);return}F(O.matches?"dark":"light")},w=v=>{T()||F(v.matches?"dark":"light")};R(),typeof O.addEventListener=="function"?O.addEventListener("change",w):typeof O.addListener=="function"&&O.addListener(w),f.addEventListener("click",()=>{let v=p.getAttribute("data-theme")==="dark"?"light":"dark";F(v),r.setStorageItem("theme",v)})})(),(()=>{let f=document.getElementById("mockOverlayLayer"),p=document.getElementById("mockOverlayImage"),O=document.getElementById("mockOverlayControls"),T=document.getElementById("mockOverlayUrlInput"),F=document.getElementById("mockOverlayOpacityInput"),R=document.getElementById("mockOverlayOffsetXInput"),w=document.getElementById("mockOverlayOffsetYInput"),v=document.getElementById("mockOverlayScaleInput"),Z=document.getElementById("mockOverlayToggleBtn"),tt=document.getElementById("mockOverlayResetBtn");if(!f||!p||!O||!T||!F||!R||!w||!v||!Z||!tt)return;let x={url:"dev:overlay:url",opacity:"dev:overlay:opacity",offsetX:"dev:overlay:offsetX",offsetY:"dev:overlay:offsetY",scale:"dev:overlay:scale",visible:"dev:overlay:visible",panelVisible:"dev:overlay:panelVisible"},k=new URLSearchParams(H),et=k.get("overlay")==="1",U=(h,{min:l,max:d,fallback:m})=>{let L=Number(h);return Number.isFinite(L)?Math.min(d,Math.max(l,L)):m},nt=(h,l=!1)=>h==="1"||h==="true"?!0:h==="0"||h==="false"?!1:l,S={url:"",opacity:45,offsetX:0,offsetY:0,scale:100,visible:!1,panelVisible:!1},st=()=>{T.value=S.url,F.value=String(S.opacity),R.value=String(S.offsetX),w.value=String(S.offsetY),v.value=String(S.scale)},j=()=>{r.setStorageItem(x.url,S.url),r.setStorageItem(x.opacity,String(S.opacity)),r.setStorageItem(x.offsetX,String(S.offsetX)),r.setStorageItem(x.offsetY,String(S.offsetY)),r.setStorageItem(x.scale,String(S.scale)),r.setStorageItem(x.visible,S.visible?"1":"0"),r.setStorageItem(x.panelVisible,S.panelVisible?"1":"0")},dt=()=>{let h=S.url.length>0,l=h&&S.visible;O.classList.toggle("hidden",!S.panelVisible),f.classList.toggle("hidden",!l),f.setAttribute("aria-hidden",String(!l)),Z.textContent=l?"Overlay: On":"Overlay: Off",Z.setAttribute("aria-pressed",String(l)),h?p.getAttribute("src")!==S.url&&p.setAttribute("src",S.url):p.removeAttribute("src"),p.style.opacity=String(S.opacity/100),p.style.transform=`translate(${S.offsetX}px, ${S.offsetY}px) scale(${S.scale/100})`,st()},W=h=>{let l=h instanceof Element?h:null;return l?l.tagName==="INPUT"||l.tagName==="TEXTAREA"||l.tagName==="SELECT"?!0:!!l.closest("[contenteditable='true']"):!1},Y=()=>{S.url=String(r.getStorageItem(x.url)||"").trim(),S.opacity=U(r.getStorageItem(x.opacity),{min:0,max:100,fallback:45}),S.offsetX=U(r.getStorageItem(x.offsetX),{min:-2e3,max:2e3,fallback:0}),S.offsetY=U(r.getStorageItem(x.offsetY),{min:-2e3,max:2e3,fallback:0}),S.scale=U(r.getStorageItem(x.scale),{min:50,max:200,fallback:100}),S.visible=nt(r.getStorageItem(x.visible),!1),S.panelVisible=nt(r.getStorageItem(x.panelVisible),!1);let h=String(k.get("overlayUrl")||"").trim();h&&(S.url=h),k.has("overlayOpacity")&&(S.opacity=U(k.get("overlayOpacity"),{min:0,max:100,fallback:S.opacity})),k.has("overlayOffsetX")&&(S.offsetX=U(k.get("overlayOffsetX"),{min:-2e3,max:2e3,fallback:S.offsetX})),k.has("overlayOffsetY")&&(S.offsetY=U(k.get("overlayOffsetY"),{min:-2e3,max:2e3,fallback:S.offsetY})),k.has("overlayScale")&&(S.scale=U(k.get("overlayScale"),{min:50,max:200,fallback:S.scale})),k.has("overlayVisible")&&(S.visible=nt(k.get("overlayVisible"),S.visible)),et&&(S.panelVisible=!0,k.has("overlayVisible")||(S.visible=!0))},D=h=>{Object.assign(S,h),j(),dt()};Y(),dt(),T.addEventListener("input",()=>{let h=String(T.value||"").trim();D({url:h,visible:h.length>0?!0:S.visible})}),F.addEventListener("input",()=>{D({opacity:U(F.value,{min:0,max:100,fallback:S.opacity})})}),R.addEventListener("input",()=>{D({offsetX:U(R.value,{min:-2e3,max:2e3,fallback:S.offsetX})})}),w.addEventListener("input",()=>{D({offsetY:U(w.value,{min:-2e3,max:2e3,fallback:S.offsetY})})}),v.addEventListener("input",()=>{D({scale:U(v.value,{min:50,max:200,fallback:S.scale})})}),Z.addEventListener("click",()=>{D({visible:!S.visible})}),tt.addEventListener("click",()=>{D({opacity:45,offsetX:0,offsetY:0,scale:100})}),document.addEventListener("keydown",h=>{if(!W(h.target)&&h.key.toLowerCase()==="o"&&!(h.metaKey||h.ctrlKey||h.altKey)){if(h.preventDefault(),h.shiftKey){D({panelVisible:!S.panelVisible});return}D({visible:!S.visible})}})})()})();})();
