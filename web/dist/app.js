(()=>{(()=>{let x=window.HMApp||(window.HMApp={}),n=x.api||={};x.dom={locateBtn:document.getElementById("locateBtn"),voiceLocateBtn:document.getElementById("voiceLocateBtn"),voiceLocateBtnLabel:document.getElementById("voiceLocateBtnLabel"),skeletonEl:document.getElementById("skeleton"),segmentControlEl:document.querySelector(".segment-control"),modeRailBtn:document.getElementById("modeRailBtn"),modeTramBtn:document.getElementById("modeTramBtn"),modeMetroBtn:document.getElementById("modeMetroBtn"),modeBusBtn:document.getElementById("modeBusBtn"),helsinkiOnlyBtn:document.getElementById("helsinkiOnlyBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busStopSelectLabelEl:document.getElementById("busStopSelectLabel"),busStopSelectListEl:document.getElementById("busStopSelectList"),busStopSelectWrapEl:document.getElementById("busStopSelectWrap"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),stopFiltersToggleBtnEl:document.getElementById("stopFiltersToggleBtn"),stopFiltersPanelEl:document.getElementById("stopFiltersPanel"),stopFilterSummaryEl:document.getElementById("stopFilterSummary"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),resultsLimitSelectLabelEl:document.getElementById("resultsLimitSelectLabel"),resultsLimitSelectListEl:document.getElementById("resultsLimitSelectList"),resultsLimitSelectWrapEl:document.getElementById("resultsLimitSelectWrap"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),resolvedLocationEl:document.getElementById("resolvedLocation"),voiceLocationChoicesEl:document.getElementById("voiceLocationChoices"),voiceLocationChoicesTitleEl:document.getElementById("voiceLocationChoicesTitle"),voiceLocationChoicesOptionsEl:document.getElementById("voiceLocationChoicesOptions"),voiceLocationChoicesCancelEl:document.getElementById("voiceLocationChoicesCancel"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),locationPromptCardEl:document.getElementById("locationPromptCard"),locationPromptAllowEl:document.getElementById("locationPromptAllow"),permissionCardEl:document.getElementById("permissionCard"),permissionRetryBtnEl:document.getElementById("permissionRetryBtn"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},x.constants={MODE_RAIL:"rail",MODE_TRAM:"tram",MODE_METRO:"metro",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_HELSINKI_ONLY_KEY:"prefs:helsinkiOnly",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_TRAM_KEY:"prefs:resultsLimitTram",STORAGE_RESULTS_LIMIT_METRO_KEY:"prefs:resultsLimitMetro",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_TRAM:8,DEFAULT_RESULTS_LIMIT_METRO:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],VOICE_RECOGNITION_TIMEOUT_MS:8e3,VOICE_SILENCE_STOP_MS:1200,VOICE_QUERY_MIN_LENGTH:3,FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5,METRIC_REPORT_LIMIT:10,METRIC_SAMPLE_RATE:1};let{MODE_RAIL:t,MODE_TRAM:e,MODE_METRO:A,MODE_BUS:F}=x.constants;x.state={locationGranted:!1,isLoading:!1,isVoiceListening:!1,currentCoords:null,latestResponse:null,mode:t,helsinkiOnly:!1,busStopId:null,busLineFilters:[],busDestinationFilters:[],stopFiltersPanelOpen:!1,deferInitialStopContext:!1,deferredBusStopId:null,deferredBusLineFilters:[],deferredBusDestinationFilters:[],resultsLimitByMode:{[t]:x.constants.DEFAULT_RESULTS_LIMIT_RAIL,[e]:x.constants.DEFAULT_RESULTS_LIMIT_TRAM,[A]:x.constants.DEFAULT_RESULTS_LIMIT_METRO,[F]:x.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},resolvedLocationHint:null,suppressBusStopChange:!1,hasCompletedInitialStopModeLoad:!1,errorReportCount:0,metricReportCount:0,isMetricSessionSampled:Math.random()<x.constants.METRIC_SAMPLE_RATE,sessionStartedAtMs:Date.now(),hasReportedFirstSuccessfulRenderMetric:!1,hasReportedFirstManualInteractionMetric:!1,hasReportedFirstManualStopContextMetric:!1,hasReportedInitialNearestStopResolvedMetric:!1,latestLoadToken:0};let{dom:_,state:r,constants:y}=x;function R(){let o=r.isLoading||r.isVoiceListening,c=r.isLoading;_.locateBtn&&(_.locateBtn.disabled=o),_.voiceLocateBtn&&(_.voiceLocateBtn.disabled=c,_.voiceLocateBtn.classList.toggle("is-listening",r.isVoiceListening),_.voiceLocateBtn.setAttribute("aria-pressed",String(r.isVoiceListening))),_.voiceLocateBtnLabel&&(_.voiceLocateBtnLabel.textContent=r.isVoiceListening?"Listening...":"Describe Location")}function N(o){r.isLoading=o,R(),_.skeletonEl&&_.skeletonEl.classList.toggle("hidden",!o)}function g(o){r.isVoiceListening=!!o,R()}function w(o){_.statusEl&&(_.statusEl.textContent=o)}function k(o){let c=Number(o);return Number.isFinite(c)?c.toFixed(5):null}function m(o){let c=o&&typeof o=="object";if(r.resolvedLocationHint=c?{query:B(o.query,120).trim(),label:B(o.label,180).trim(),lat:Number(o.lat),lon:Number(o.lon)}:null,!_.resolvedLocationEl)return;if(!r.resolvedLocationHint){_.resolvedLocationEl.classList.add("hidden"),_.resolvedLocationEl.textContent="";return}let I=r.resolvedLocationHint.label||"Unknown place",M=r.resolvedLocationHint.query,i=k(r.resolvedLocationHint.lat),s=k(r.resolvedLocationHint.lon),l=M?` (from "${M}")`:"",p=i&&s?` - ${i}, ${s}`:"";_.resolvedLocationEl.textContent=`Resolved location: ${I}${l}${p}`,_.resolvedLocationEl.classList.remove("hidden")}function C(){_.locationPromptCardEl&&_.locationPromptCardEl.classList.remove("hidden"),_.permissionCardEl&&_.permissionCardEl.classList.add("hidden")}function v(){_.locationPromptCardEl&&_.locationPromptCardEl.classList.add("hidden")}function U(o){v(),_.permissionCardEl&&_.permissionCardEl.classList.toggle("hidden",!o)}function O(o){!_.lastUpdatedEl||!(o instanceof Date)||(_.lastUpdatedEl.textContent=`Last updated: ${o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function P(o){try{return window.localStorage.getItem(o)}catch{return null}}function D(o,c){try{window.localStorage.setItem(o,c)}catch{}}function B(o,c){let I=String(o||"");return I.length<=c?I:I.slice(0,c)}function X(o){if(o instanceof Error)return o;try{let c=typeof o=="string"?o:JSON.stringify(o);return new Error(c||"Unknown error")}catch{return new Error(String(o||"Unknown error"))}}function Z(o){let c=JSON.stringify(o);if(navigator.sendBeacon){let I=new Blob([c],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",I);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:c,keepalive:!0}).catch(()=>{})}function Y(o,c,I=null){if(r.errorReportCount>=y.ERROR_REPORT_LIMIT)return;r.errorReportCount+=1;let M=X(c),i={type:B(o,40),message:B(M.message,400),stack:B(M.stack||"",1200),url:B(window.location.href,500),userAgent:B(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:I&&typeof I=="object"?I:null};Z(i)}function q(){return Math.max(0,Date.now()-r.sessionStartedAtMs)}function G(o,c=null){if(!r.isMetricSessionSampled||r.metricReportCount>=y.METRIC_REPORT_LIMIT)return!1;r.metricReportCount+=1;let I={type:"metric",message:B(o,400),stack:"",url:B(window.location.href,500),userAgent:B(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:{metricName:B(o,80),sessionElapsedMs:q(),mode:r.mode,...c&&typeof c=="object"?c:{}}};return Z(I),!0}function ee(o,c){if(r.hasReportedFirstSuccessfulRenderMetric)return;r.hasReportedFirstSuccessfulRenderMetric=!0;let I=Array.isArray(o?.station?.departures)?o.station.departures:[];G("first_successful_render",{requestMode:String(c||"").trim(),hasStation:!!o?.station,departureCount:I.length})}function te(o,c=null){r.hasReportedFirstManualInteractionMetric||(r.hasReportedFirstManualInteractionMetric=!0,G("first_manual_interaction",{interactionType:B(o,80),...c&&typeof c=="object"?c:{}}))}function K(o,c=null){r.hasReportedFirstManualStopContextMetric||(r.hasReportedFirstManualStopContextMetric=!0,G("first_manual_stop_context_change",{changeType:B(o,80),lineFilterCount:r.busLineFilters.length,destinationFilterCount:r.busDestinationFilters.length,...c&&typeof c=="object"?c:{}}))}function j(o,c){if(r.hasReportedInitialNearestStopResolvedMetric)return;let I=String(o?.selectedStopId||"").trim();if(!I)return;r.hasReportedInitialNearestStopResolvedMetric=!0;let i=(Array.isArray(o?.stops)?o.stops:[]).find(l=>l?.id===I)||null,s=Array.isArray(o?.station?.departures)?o.station.departures:[];G("initial_nearest_stop_resolved",{requestMode:String(c||"").trim(),selectedStopId:I,distanceMeters:Number(i?.distanceMeters)||null,departureCount:s.length})}function z(o){if(!o)return null;let c=String(o).trim().toLowerCase();return c===t||c===e||c===A||c===F?c:null}function $(o){if(o==null)return null;let c=String(o).trim().toLowerCase();return["1","true","yes","on"].includes(c)?!0:["0","false","no","off"].includes(c)?!1:null}function H(o){return Array.isArray(o)?[...new Set(o.map(c=>String(c||"").trim()).filter(Boolean))]:[]}function V(o){if(o==null||o==="")return null;let c=Number(o);return!Number.isInteger(c)||!y.RESULT_LIMIT_OPTIONS.includes(c)?null:c}function W(o=r.mode){return o===F?y.DEFAULT_RESULTS_LIMIT_BUS:o===A?y.DEFAULT_RESULTS_LIMIT_METRO:o===e?y.DEFAULT_RESULTS_LIMIT_TRAM:y.DEFAULT_RESULTS_LIMIT_RAIL}function a(o=r.mode){let c=V(r.resultsLimitByMode?.[o]);return c??W(o)}function u(o){let c=P(o);if(!c)return[];try{let I=JSON.parse(c);return H(I)}catch{return[]}}function d(){let o=new URLSearchParams(window.location.search);return{mode:z(o.get("mode")),helsinkiOnly:$(o.get("helsinkiOnly")),stopProvided:o.has("stop"),busStopId:o.get("stop")?o.get("stop").trim():null,linesProvided:o.has("line"),busLines:H(o.getAll("line")),destinationsProvided:o.has("dest"),busDestinations:H(o.getAll("dest")),resultsProvided:o.has("results"),resultsLimit:V(o.get("results"))}}function E(){let o=d(),c=z(P(y.STORAGE_MODE_KEY)),I=$(P(y.STORAGE_HELSINKI_ONLY_KEY));r.mode=o.mode||c||t,r.helsinkiOnly=o.helsinkiOnly??I??!1,r.mode!==t&&(r.helsinkiOnly=!1);let M=String(P(y.STORAGE_BUS_STOP_KEY)||"").trim()||null,i=o.stopProvided?o.busStopId:M,s=u(y.STORAGE_BUS_LINES_KEY),l=u(y.STORAGE_BUS_DESTINATIONS_KEY),p=o.linesProvided?o.busLines:s,b=o.destinationsProvided?o.busDestinations:l,h=!!i||p.length>0||b.length>0;r.deferInitialStopContext=h,h?(r.deferredBusStopId=i,r.deferredBusLineFilters=[...p],r.deferredBusDestinationFilters=[...b],r.busStopId=null,r.busLineFilters=[],r.busDestinationFilters=[]):(r.deferredBusStopId=null,r.deferredBusLineFilters=[],r.deferredBusDestinationFilters=[],r.busStopId=i,r.busLineFilters=p,r.busDestinationFilters=b);let T=V(P(y.STORAGE_RESULTS_LIMIT_RAIL_KEY)),J=V(P(y.STORAGE_RESULTS_LIMIT_TRAM_KEY)),Q=V(P(y.STORAGE_RESULTS_LIMIT_METRO_KEY)),ne=V(P(y.STORAGE_RESULTS_LIMIT_BUS_KEY));r.resultsLimitByMode[t]=T??y.DEFAULT_RESULTS_LIMIT_RAIL,r.resultsLimitByMode[e]=J??y.DEFAULT_RESULTS_LIMIT_TRAM,r.resultsLimitByMode[A]=Q??y.DEFAULT_RESULTS_LIMIT_METRO,r.resultsLimitByMode[F]=ne??y.DEFAULT_RESULTS_LIMIT_BUS,o.resultsProvided&&o.resultsLimit!=null&&(r.resultsLimitByMode[r.mode]=o.resultsLimit)}function f(){D(y.STORAGE_MODE_KEY,r.mode),D(y.STORAGE_HELSINKI_ONLY_KEY,r.helsinkiOnly?"1":"0"),D(y.STORAGE_BUS_STOP_KEY,r.busStopId||""),D(y.STORAGE_BUS_LINES_KEY,JSON.stringify(r.busLineFilters)),D(y.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(r.busDestinationFilters)),D(y.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(a(t))),D(y.STORAGE_RESULTS_LIMIT_TRAM_KEY,String(a(e))),D(y.STORAGE_RESULTS_LIMIT_METRO_KEY,String(a(A))),D(y.STORAGE_RESULTS_LIMIT_BUS_KEY,String(a(F)))}function S(){let o=new URLSearchParams(window.location.search);r.mode===t?o.delete("mode"):o.set("mode",r.mode),r.mode===t&&r.helsinkiOnly?o.set("helsinkiOnly","1"):o.delete("helsinkiOnly");let c=a(),I=W();if(c===I?o.delete("results"):o.set("results",String(c)),o.delete("stop"),o.delete("line"),o.delete("dest"),r.mode===F||r.mode===e||r.mode===A){r.busStopId&&o.set("stop",r.busStopId);for(let s of r.busLineFilters)o.append("line",s);for(let s of r.busDestinationFilters)o.append("dest",s)}let M=o.toString(),i=`${window.location.pathname}${M?`?${M}`:""}${window.location.hash}`;window.history.replaceState(null,"",i)}function L(){f(),S()}R(),Object.assign(n,{updateLocationActionButtons:R,setLoading:N,setVoiceListening:g,setStatus:w,setResolvedLocationHint:m,showLocationPrompt:C,hideLocationPrompt:v,setPermissionRequired:U,setLastUpdated:O,getStorageItem:P,setStorageItem:D,safeString:B,toError:X,sendClientReport:Z,reportClientError:Y,reportClientMetric:G,getSessionElapsedMs:q,trackFirstSuccessfulRender:ee,trackFirstManualInteraction:te,trackFirstManualStopContextChange:K,trackInitialNearestStopResolved:j,normalizeMode:z,parseBoolean:$,uniqueNonEmptyStrings:H,parseResultLimit:V,getDefaultResultsLimit:W,getActiveResultsLimit:a,parseStoredArray:u,readStateFromUrl:d,hydrateInitialState:E,syncStateToStorage:f,syncStateToUrl:S,persistUiState:L})})();(()=>{let x=window.HMApp,{api:n,dom:t,state:e,constants:A}=x,{MODE_RAIL:F,MODE_TRAM:_,MODE_METRO:r,MODE_BUS:y}=A;function R(i=e.mode){return i===y||i===_||i===r}function N(i=e.mode){return i===_?{singular:"tram",plural:"trams",title:"Tram"}:i===r?{singular:"metro",plural:"metros",title:"Metro"}:{singular:"bus",plural:"buses",title:"Bus"}}function g(i){let s=w(i);return s<=0?"Now":`${s}m`}function w(i){let s=new Date(i);return Math.floor((s.getTime()-Date.now())/6e4)}function k(i){let s=w(i);return s<=0||s<3?"departure-now":s<=10?"departure-soon":"departure-later"}function m(i){let s=i?.destination||"";return/\bhelsinki\b/i.test(s)}function C(){let i=new Set((e.busFilterOptions.lines||[]).map(l=>l.value)),s=new Set((e.busFilterOptions.destinations||[]).map(l=>l.value));e.busLineFilters=e.busLineFilters.filter(l=>i.has(l)),e.busDestinationFilters=e.busDestinationFilters.filter(l=>s.has(l))}function v(i){if(!Array.isArray(i))return[];if(e.mode===F)return e.helsinkiOnly?i.filter(m):i;if(!R())return i;let s=new Set(e.busLineFilters),l=new Set(e.busDestinationFilters);return i.filter(p=>{if(s.size===0)return!0;let b=String(p?.line||"").trim();return s.has(b)}).filter(p=>{if(l.size===0)return!0;let b=String(p?.destination||"").trim();return l.has(b)})}function U(){let i=[{el:t.modeRailBtn,mode:F,index:0},{el:t.modeTramBtn,mode:_,index:1},{el:t.modeMetroBtn,mode:r,index:2},{el:t.modeBusBtn,mode:y,index:3}];for(let{el:s,mode:l,index:p}of i){if(!s)continue;let b=e.mode===l;if(s.setAttribute("aria-checked",String(b)),s.classList.toggle("is-active",b),b){let h=s.closest(".segment-control");h&&h.style.setProperty("--active-index",p)}}}function O(){let i=R()?N().title:"Rail",s=R()?`Next ${N().title}`:"Next Train";t.modeEyebrowEl&&(t.modeEyebrowEl.textContent=`Helsinki Moves \u2022 ${i}`),t.nextLabelEl&&(t.nextLabelEl.textContent=s)}function P(i){if(!t.resultsLimitSelectEl||!t.resultsLimitSelectListEl)return;let s=t.resultsLimitSelectEl.getAttribute("aria-expanded")==="true",l=typeof i=="boolean"?i:!s;t.resultsLimitSelectEl.setAttribute("aria-expanded",String(l)),t.resultsLimitSelectListEl.classList.toggle("hidden",!l)}function D(i){let s=n.parseResultLimit(i);s==null||(P(!1),n.getActiveResultsLimit()===s)||(n.trackFirstManualInteraction("results_limit_change",{nextLimit:s,currentMode:e.mode}),e.resultsLimitByMode[e.mode]=s,n.persistUiState(),t.resultsLimitSelectLabelEl&&(t.resultsLimitSelectLabelEl.textContent=String(s)),e.currentCoords?n.load(e.currentCoords.lat,e.currentCoords.lon):n.requestLocationAndLoad())}function B(){if(!t.resultsLimitSelectListEl)return;let i=Array.isArray(A.RESULT_LIMIT_OPTIONS)?A.RESULT_LIMIT_OPTIONS:[],s=n.getActiveResultsLimit();t.resultsLimitSelectListEl.innerHTML="";for(let l of i){let p=document.createElement("li");p.setAttribute("role","option"),p.dataset.value=String(l),p.textContent=String(l),l===s&&p.setAttribute("aria-selected","true"),p.addEventListener("click",()=>D(String(l))),t.resultsLimitSelectListEl.appendChild(p)}t.resultsLimitSelectLabelEl&&(t.resultsLimitSelectLabelEl.textContent=String(s))}function X(){if(t.helsinkiOnlyBtn){if(e.mode!==F){t.helsinkiOnlyBtn.setAttribute("aria-pressed","false"),t.helsinkiOnlyBtn.classList.remove("is-active"),t.helsinkiOnlyBtn.disabled=!0,t.helsinkiOnlyBtn.textContent="Helsinki Only (Rail)";return}t.helsinkiOnlyBtn.disabled=!1,t.helsinkiOnlyBtn.setAttribute("aria-pressed",String(e.helsinkiOnly)),t.helsinkiOnlyBtn.classList.toggle("is-active",e.helsinkiOnly),t.helsinkiOnlyBtn.textContent=e.helsinkiOnly?"Helsinki Only: On":"Helsinki Only: Off"}}function Z(){return Math.max(0,e.busLineFilters.length)+Math.max(0,e.busDestinationFilters.length)}function Y(i=e.busLineFilters.length,s=e.busDestinationFilters.length){let l=Math.max(0,Number(i)||0)+Math.max(0,Number(s)||0);return l===0?"No filters":l===1?"1 filter":`${l} filters`}function q(){t.stopFilterSummaryEl&&(t.stopFilterSummaryEl.textContent=Y()),!(!t.stopFiltersToggleBtnEl||!t.stopFiltersPanelEl)&&(t.stopFiltersToggleBtnEl.setAttribute("aria-expanded",String(!!e.stopFiltersPanelOpen)),t.stopFiltersPanelEl.classList.toggle("hidden",!e.stopFiltersPanelOpen))}function G(i){e.stopFiltersPanelOpen=!!i,q()}function ee(i){let s=typeof i=="boolean"?i:!e.stopFiltersPanelOpen;G(s)}function te(i){t.busControlsEl&&(t.busControlsEl.classList.toggle("hidden",!i),i||(e.stopFiltersPanelOpen=!1),q())}function K(i){return e.busStops.find(s=>s.id===i)||null}function j(i){let s=n.uniqueNonEmptyStrings([...Array.isArray(i?.stopCodes)?i.stopCodes:[],i?.code]);return s.length===0&&i?.id&&s.push(String(i.id)),s}function z(i,s=null){let l=K(e.busStopId),p=String(s?.stopName||i?.stopName||l?.name||"").trim(),h=n.uniqueNonEmptyStrings([s?.stopCode,...Array.isArray(i?.stopCodes)?i.stopCodes:[],i?.stopCode,...j(l)])[0]||"";return p&&h?`${p} ${h}`:p||h||"\u2014"}function $(i,s=null){if(R())return z(i,s);let l=String(s?.stopName||i?.stopName||"").trim(),p=String(s?.stopCode||i?.stopCode||"").trim();return l&&p?`${l} ${p}`:l||p||"\u2014"}function H(i){if(!t.dataScopeEl)return;if(!R()){t.dataScopeEl.classList.add("hidden"),t.dataScopeEl.textContent="";return}let s=String(i?.station?.stopName||K(e.busStopId)?.name||"").trim(),p=n.uniqueNonEmptyStrings([...Array.isArray(i?.station?.stopCodes)?i.station.stopCodes:[],i?.station?.stopCode,...j(K(e.busStopId))]).join(", "),b=e.busLineFilters.length===0?"all lines":`${e.busLineFilters.length} line${e.busLineFilters.length===1?"":"s"} selected`,h=e.busDestinationFilters.length===0?"all destinations":`${e.busDestinationFilters.length} destination${e.busDestinationFilters.length===1?"":"s"} selected`,T=`${n.getActiveResultsLimit()} results`;s?t.dataScopeEl.textContent=`Selected stop ${s} (${p||"\u2014"}) - ${b}, ${h}, ${T}`:t.dataScopeEl.textContent=`Selecting stop... (${b}, ${h}, ${T})`,t.dataScopeEl.classList.remove("hidden")}function V(i,s,l,p){if(!i)return;if(i.innerHTML="",!Array.isArray(s)||s.length===0){let h=document.createElement("span");h.className="chip-empty",h.textContent="No options",i.appendChild(h);return}let b=new Set(l);for(let h of s){let T=document.createElement("button");T.type="button",T.className="chip-toggle",b.has(h.value)?(T.classList.add("is-active"),T.setAttribute("aria-pressed","true")):T.setAttribute("aria-pressed","false"),T.textContent=`${h.value} (${h.count})`,T.addEventListener("click",()=>p(h.value)),i.appendChild(T)}}function W(i){if(!t.busStopSelectEl||!t.busStopSelectListEl)return;let s=t.busStopSelectEl.getAttribute("aria-expanded")==="true",l=typeof i=="boolean"?i:!s;t.busStopSelectEl.setAttribute("aria-expanded",String(l)),t.busStopSelectListEl.classList.toggle("hidden",!l)}function a(i){if(!e.suppressBusStopChange){if(!i||i===e.busStopId){W(!1);return}if(n.trackFirstManualInteraction("stop_select",{currentMode:e.mode}),n.trackFirstManualStopContextChange("stop_select",{selectedStopId:i}),e.busStopId=i,n.persistUiState(),W(!1),t.busStopSelectLabelEl){let s=e.busStops.find(l=>l.id===i);t.busStopSelectLabelEl.textContent=s?`${s.name} (${s.distanceMeters}m)`:i}e.currentCoords&&n.load(e.currentCoords.lat,e.currentCoords.lon)}}function u(){let i=R();if(te(i),!!i){if(q(),t.busStopSelectListEl){if(e.suppressBusStopChange=!0,t.busStopSelectListEl.innerHTML="",e.busStops.length===0)t.busStopSelectLabelEl&&(t.busStopSelectLabelEl.textContent=`No nearby ${N().singular} stops`),t.busStopSelectEl&&(t.busStopSelectEl.disabled=!0);else{t.busStopSelectEl&&(t.busStopSelectEl.disabled=!1);let s=e.busStopId;(!s||!e.busStops.some(l=>l.id===s))&&(s=e.busStops[0].id);for(let l of e.busStops){let p=document.createElement("li");p.setAttribute("role","option"),p.dataset.value=l.id,p.textContent=`${l.name} (${l.distanceMeters}m)`,l.id===s&&p.setAttribute("aria-selected","true"),p.addEventListener("click",()=>a(l.id)),t.busStopSelectListEl.appendChild(p)}if(t.busStopSelectLabelEl){let l=e.busStops.find(p=>p.id===s);t.busStopSelectLabelEl.textContent=l?`${l.name} (${l.distanceMeters}m)`:"Select stop"}}e.suppressBusStopChange=!1}V(t.busLineFiltersEl,e.busFilterOptions.lines,e.busLineFilters,s=>{e.busLineFilters.includes(s)?e.busLineFilters=e.busLineFilters.filter(l=>l!==s):e.busLineFilters=[...e.busLineFilters,s],n.trackFirstManualInteraction("line_filter_toggle",{currentMode:e.mode}),n.trackFirstManualStopContextChange("line_filter_toggle"),n.persistUiState(),q(),e.latestResponse&&(n.render(e.latestResponse),n.setStatus(n.buildStatusFromResponse(e.latestResponse)))}),V(t.busDestinationFiltersEl,e.busFilterOptions.destinations,e.busDestinationFilters,s=>{e.busDestinationFilters.includes(s)?e.busDestinationFilters=e.busDestinationFilters.filter(l=>l!==s):e.busDestinationFilters=[...e.busDestinationFilters,s],n.trackFirstManualInteraction("destination_filter_toggle",{currentMode:e.mode}),n.trackFirstManualStopContextChange("destination_filter_toggle"),n.persistUiState(),q(),e.latestResponse&&(n.render(e.latestResponse),n.setStatus(n.buildStatusFromResponse(e.latestResponse)))})}}function d(i,s=null){if(!t.nextSummaryEl||!t.nextMinsEl||!t.nextLineEl||!t.nextTrackEl||!t.nextDestinationEl)return;if(!i){t.nextSummaryEl.classList.add("hidden"),t.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later");return}let l=w(i.departureIso);t.nextMinsEl.textContent=g(i.departureIso),t.nextLineEl.textContent=i.line||"\u2014",t.nextLineEl.classList.toggle("next-letter-now",l<3),t.nextTrackEl.textContent=R()?`Stop ${$(s,i)}`:i.track?`Track ${i.track}`:"Track \u2014",t.nextDestinationEl.textContent=i.destination||"\u2014",t.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),l<3?t.nextSummaryEl.classList.add("next-summary-now"):l<=10?t.nextSummaryEl.classList.add("next-summary-soon"):t.nextSummaryEl.classList.add("next-summary-later"),t.nextSummaryEl.classList.remove("hidden")}function E(i){if(!i||!i.station)return R()?i?.message||`No nearby ${N().singular} stops found.`:i?.message||"No nearby train stations found.";let l=v(i.station.departures)[0];if(!l)return R()?e.busLineFilters.length>0||e.busDestinationFilters.length>0?`No upcoming ${N().plural} match selected filters.`:"No upcoming departures from this stop.":e.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.";let p=l.destination?` \u2022 ${l.destination}`:"",b=e.mode===F?l.track?` \u2022 Track ${l.track}`:"":i.station.stopName||i.station.stopCode?` \u2022 ${$(i.station,l)}`:"",h=R()?N().singular:"train";return`Next ${l.line||h} in ${g(l.departureIso)}${p}${b}`}function f(i){if(!(i instanceof Error))return"Could not refresh departures. Please try again.";if(i.name==="AbortError")return"Request timed out. Please try again.";let s=(i.message||"").trim();return s==="Temporary server error. Please try again."?s:s==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":s==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function S(i){return i?.code===1?"Location permission denied.":i?.code===2?"Location unavailable. Please try again.":i?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function L(i){let s=String(i?.code||"").trim();return s==="voice_unsupported"?"Voice location is not supported in this browser.":s==="voice_permission_denied"?"Microphone permission denied.":s==="voice_no_microphone"?"No microphone was found for voice location.":s==="voice_no_speech"?"No speech detected. Please try again.":s==="voice_recognition_timeout"?"Voice listening timed out. Please try again.":s==="voice_language_not_supported"?"Voice language was not supported on this device.":s==="voice_query_too_short"?"Please describe your location with a few words.":s==="voice_location_not_found"?"Could not match that place. Try a nearby landmark or street.":s==="voice_location_selection_cancelled"?"Location selection was cancelled.":s==="voice_location_selection_invalid"?"Please choose one of the suggested locations.":s==="voice_recognition_network"?"Voice recognition failed due to a network error. On iPhone, try enabling Siri & Dictation.":"Could not use voice location. Please try again."}function o(){t.skeletonEl&&t.skeletonEl.classList.remove("hidden")}function c(){t.skeletonEl&&t.skeletonEl.classList.add("hidden")}function I(i){if(c(),u(),H(i),!i||!i.station){t.resultEl.classList.add("hidden"),d(null);return}let s=i.station;t.resultEl.classList.remove("hidden"),t.stationTitleEl.textContent=s.stopName,t.stationMetaEl.textContent=`${s.distanceMeters}m away`,t.departuresEl.innerHTML="";let l=v(s.departures);if(l.length===0){d(null);let b=document.createElement("li");b.className="empty-row",R()?b.textContent=e.busLineFilters.length>0||e.busDestinationFilters.length>0?`No upcoming ${N().plural} match selected filters.`:"No upcoming departures from this stop.":b.textContent=e.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.",t.departuresEl.appendChild(b);return}d(l[0],s);let p=l.slice(1);if(p.length===0){let b=document.createElement("li");b.className="empty-row",b.textContent=R()?`No additional upcoming ${N().plural} right now.`:"No additional upcoming commuter trains right now.",t.departuresEl.appendChild(b);return}for(let b=0;b<p.length;b++){let h=p[b],T=document.createElement("li");T.className=`departure-row ${k(h.departureIso)}`,T.style.setProperty("--i",b);let J=document.createElement("div");J.className="letter-badge",J.textContent=h.line||"?";let Q=document.createElement("div");Q.className="train";let ne=document.createElement("div");ne.className="destination",ne.textContent=h.destination||"\u2014",Q.appendChild(ne);let oe=document.createElement("span");oe.className="track",R()?oe.textContent=`Stop ${$(s,h)}`:oe.textContent=h.track?`Track ${h.track}`:"Track \u2014",Q.appendChild(oe);let ie=document.createElement("div");ie.className="time";let se=document.createElement("span");se.className="remaining",se.textContent=g(h.departureIso);let re=document.createElement("span");re.className="clock-time",re.textContent=new Date(h.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),ie.appendChild(se),ie.appendChild(re),T.appendChild(J),T.appendChild(Q),T.appendChild(ie),t.departuresEl.appendChild(T)}}function M(){t.nowClockEl&&(t.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(n,{formatMinutes:g,minutesUntil:w,departureRowClass:k,isHelsinkiBound:m,sanitizeStopSelections:C,getVisibleDepartures:v,updateModeButtons:U,updateModeLabels:O,toggleResultsLimitDropdown:P,selectResultsLimit:D,renderResultsLimitControl:B,updateHelsinkiFilterButton:X,countActiveStopFilters:Z,buildStopFilterSummary:Y,syncStopFiltersPanelUi:q,setStopFiltersPanelOpen:G,toggleStopFiltersPanel:ee,setStopControlsVisibility:te,getStopMeta:K,getStopCodes:j,buildStopDisplay:z,buildModeStopDisplay:$,updateDataScope:H,renderFilterButtons:V,toggleStopDropdown:W,selectStop:a,renderStopControls:u,updateNextSummary:d,buildStatusFromResponse:E,getLoadErrorStatus:f,getGeolocationErrorStatus:S,getVoiceLocationErrorStatus:L,showSkeleton:o,hideSkeleton:c,render:I,updateClock:M})})();(()=>{let x=window.HMApp,{api:n,dom:t,state:e,constants:A}=x,{MODE_TRAM:F,MODE_METRO:_,MODE_BUS:r}=A;function y(a){return a===r||a===F||a===_}function R(a){return new Promise(u=>setTimeout(u,a))}async function N(a,u={},d=A.FETCH_TIMEOUT_MS){let E=new AbortController,f=setTimeout(()=>E.abort(),d);try{return await fetch(a,{...u,signal:E.signal})}finally{clearTimeout(f)}}async function g(a,u={}){let d;try{d=await N(a,u)}catch{return await R(350),N(a,u)}return d.status>=500?(await R(350),N(a,u)):d}function w(a){let u=new Map,d=new Map;for(let f of a||[]){let S=String(f?.line||"").trim();S&&u.set(S,(u.get(S)||0)+1);let L=String(f?.destination||"").trim();L&&d.set(L,(d.get(L)||0)+1)}let E=f=>[...f.entries()].sort((S,L)=>L[1]-S[1]||S[0].localeCompare(L[0])).map(([S,L])=>({value:S,count:L}));return{lines:E(u),destinations:E(d)}}function k(a){let u=Array.isArray(a?.stops)?a.stops.filter(S=>S&&S.id&&S.name).map(S=>({id:S.id,name:S.name,code:String(S.code||"").trim()||null,stopCodes:n.uniqueNonEmptyStrings([...Array.isArray(S.stopCodes)?S.stopCodes:[],S.code]),distanceMeters:Number(S.distanceMeters)||0})):[];e.busStops=u;let d=String(a?.selectedStopId||"").trim()||null,E=S=>u.some(L=>L.id===S);d&&E(d)?e.busStopId=d:(!e.busStopId||!E(e.busStopId))&&(e.busStopId=u[0]?.id||null),e.deferInitialStopContext&&(e.deferInitialStopContext=!1,e.deferredBusStopId=null,e.deferredBusLineFilters=[],e.deferredBusDestinationFilters=[],e.busLineFilters=[],e.busDestinationFilters=[]),e.hasCompletedInitialStopModeLoad=!0;let f=Array.isArray(a?.station?.departures)?a.station.departures:[];e.busFilterOptions=w(f),n.sanitizeStopSelections()}function m(a,u){let d=new Error(u);return d.code=a,d}function C(a){return String(a?.code||"").trim().toLowerCase()}function v(){return n.uniqueNonEmptyStrings(["fi-FI","en-US",...Array.isArray(navigator.languages)?navigator.languages:[],navigator.language])}function U(){return typeof window.SpeechRecognition=="function"?window.SpeechRecognition:typeof window.webkitSpeechRecognition=="function"?window.webkitSpeechRecognition:null}function O(){return!!U()}function P(a){return a==="not-allowed"||a==="service-not-allowed"?m("voice_permission_denied","Microphone permission denied."):a==="audio-capture"?m("voice_no_microphone","No microphone available."):a==="language-not-supported"?m("voice_language_not_supported","Speech language is not supported."):a==="network"?m("voice_recognition_network","Voice recognition network error."):a==="no-speech"?m("voice_no_speech","No speech detected."):m("voice_not_understood","Voice recognition failed.")}function D(a){let u=U();return u?new Promise((d,E)=>{let f=new u,S=String(a||navigator.language||"fi-FI").trim();f.lang=S||"fi-FI",f.continuous=!1,f.interimResults=!0,f.maxAlternatives=1;let L=!1,o="",c=null,I=!1,M=()=>{clearTimeout(c),c=null},i=()=>{if(!(I||L)){I=!0;try{f.stop()}catch{}}},s=()=>{M(),c=setTimeout(i,A.VOICE_SILENCE_STOP_MS)},l=()=>{clearTimeout(b),M(),f.onresult=null,f.onerror=null,f.onend=null,f.onspeechend=null,f.onsoundend=null,f.onaudioend=null,f.onnomatch=null},p=(h,T)=>{L||(L=!0,l(),h(T))},b=setTimeout(()=>{try{f.abort()}catch{}p(E,m("voice_recognition_timeout","Voice recognition timed out."))},A.VOICE_RECOGNITION_TIMEOUT_MS);f.onresult=h=>{for(let T=h?.resultIndex||0;T<(h?.results?.length||0);T+=1){let J=h.results[T],Q=String(J?.[0]?.transcript||"").trim();if(Q&&(o=Q,s(),J?.isFinal)){i();return}}},f.onerror=h=>{let T=String(h?.error||"").trim().toLowerCase();p(E,P(T))},f.onend=()=>{if(L)return;let h=String(o||"").trim();if(!h){p(E,m("voice_no_speech","No speech detected."));return}p(d,h)},f.onspeechend=()=>{i()},f.onsoundend=()=>{s()},f.onaudioend=()=>{s()},f.onnomatch=()=>{p(E,m("voice_not_understood","Could not understand speech."))};try{f.start()}catch(h){let T=String(h?.name||"").trim().toLowerCase();if(T==="notallowederror"||T==="securityerror"){p(E,m("voice_permission_denied","Microphone permission denied."));return}p(E,m("voice_not_understood","Unable to start voice recognition."))}}):Promise.reject(m("voice_unsupported","Voice recognition not supported."))}function B(a){return a==="voice_no_speech"||a==="voice_not_understood"||a==="voice_recognition_timeout"||a==="voice_language_not_supported"}async function X(){let a=v(),u=null;for(let d of a)try{return await D(d)}catch(E){if(u=E,!B(C(E)))break}throw u||m("voice_not_understood","Voice recognition failed.")}function Z(a){return Array.isArray(a)?a.map(u=>{let d=Number(u?.lat),E=Number(u?.lon);return!Number.isFinite(d)||!Number.isFinite(E)?null:{lat:d,lon:E,label:String(u?.label||"").trim()}}).filter(Boolean):[]}function Y(){t.voiceLocationChoicesEl&&t.voiceLocationChoicesEl.classList.add("hidden"),t.voiceLocationChoicesTitleEl&&(t.voiceLocationChoicesTitleEl.textContent=""),t.voiceLocationChoicesOptionsEl&&(t.voiceLocationChoicesOptionsEl.innerHTML=""),t.voiceLocationChoicesCancelEl&&(t.voiceLocationChoicesCancelEl.onclick=null)}function q(a,u){if(typeof window.prompt!="function")throw m("voice_location_selection_cancelled","Location selection was cancelled.");let d=u.map((S,L)=>`${L+1}. ${S.label||`${S.lat}, ${S.lon}`}`).join(`
`),E=window.prompt(`Multiple matches found for "${n.safeString(a,80)}". Select number:
${d}`,"1");if(E==null)throw m("voice_location_selection_cancelled","Location selection was cancelled.");let f=Number.parseInt(String(E).trim(),10);if(!Number.isInteger(f)||f<1||f>u.length)throw m("voice_location_selection_invalid","Invalid location selection.");return u[f-1]}async function G(a,u){if(!Array.isArray(u)||u.length===0)throw m("voice_location_not_found","No matching location found.");return!t.voiceLocationChoicesEl||!t.voiceLocationChoicesTitleEl||!t.voiceLocationChoicesOptionsEl||!t.voiceLocationChoicesCancelEl?q(a,u):new Promise((d,E)=>{let f=!1,S=(L,o)=>{f||(f=!0,Y(),L(o))};t.voiceLocationChoicesTitleEl.textContent=`Multiple matches for "${n.safeString(a,80)}". Choose one:`,n.setStatus("Multiple matches found. Choose one below."),t.voiceLocationChoicesOptionsEl.innerHTML="";for(let L of u){let o=document.createElement("button");o.type="button",o.className="voice-location-choice-option",o.textContent=L.label||`${L.lat.toFixed(5)}, ${L.lon.toFixed(5)}`,o.addEventListener("click",()=>S(d,L),{once:!0}),t.voiceLocationChoicesOptionsEl.appendChild(o)}t.voiceLocationChoicesCancelEl.onclick=()=>S(E,m("voice_location_selection_cancelled","Location selection was cancelled.")),t.voiceLocationChoicesEl.classList.remove("hidden")})}async function ee(a){let u=String(a||"").trim();if(u.length<A.VOICE_QUERY_MIN_LENGTH)throw m("voice_query_too_short","Voice query too short.");let d=new URLSearchParams({text:u});e.currentCoords&&(d.set("lat",String(e.currentCoords.lat)),d.set("lon",String(e.currentCoords.lon)));let E=Array.isArray(navigator.languages)&&navigator.languages[0]||navigator.language||"";E&&d.set("lang",String(E));let f;try{f=await g(`/api/v1/geocode?${d.toString()}`)}catch{throw m("voice_geocode_failed","Location lookup failed.")}if(!(f.headers.get("content-type")||"").includes("application/json"))throw m("voice_geocode_failed","Unexpected location lookup response.");let L=await f.json();if(!f.ok)throw m("voice_geocode_failed",String(L?.error||"Location lookup failed.").trim());let o=Z(L?.choices);if(L?.ambiguous&&o.length>1){let M=await G(u,o);return{lat:M.lat,lon:M.lon,label:M.label,query:u}}let c=Number(L?.location?.lat),I=Number(L?.location?.lon);if(!Number.isFinite(c)||!Number.isFinite(I))throw m("voice_location_not_found","No matching location found.");return{lat:c,lon:I,label:String(L?.location?.label||"").trim(),query:u}}function te(a){return a==="voice_unsupported"||a==="voice_no_speech"||a==="voice_recognition_timeout"||a==="voice_recognition_network"||a==="voice_not_understood"}function K(a){if(!te(a)||typeof window.prompt!="function")return null;let u=a==="voice_unsupported"?"Voice input is limited in this browser. Type your location instead:":"Could not capture your voice on this device. Type your location:",d=window.prompt(`${u}
Example: Kamppi Helsinki`,"");return String(d||"").trim()||null}async function j(a){let u=String(a||"").trim();Y(),n.setStatus(`Looking up "${n.safeString(u,80)}"...`);let d=await ee(u);return n.setResolvedLocationHint({query:u,label:d.label,lat:d.lat,lon:d.lon}),e.currentCoords={lat:d.lat,lon:d.lon},n.setPermissionRequired(!1),await $(d.lat,d.lon),!0}async function z(){if(e.isLoading||e.isVoiceListening)return!1;Y(),n.setVoiceListening(!0),n.setStatus("Listening... speak now, then pause.");try{if(!O()){let u=m("voice_unsupported","Voice recognition not supported."),d=K(C(u));return d?j(d):(n.setStatus(n.getVoiceLocationErrorStatus(u)),!1)}let a=await X();return j(a)}catch(a){let u=C(a),d=K(u);if(d)try{return await j(d)}catch(E){return console.error("voice fallback location error:",E),n.reportClientError("voice-location-fallback",E,{mode:e.mode,sourceCode:u||"unknown"}),n.setStatus(n.getVoiceLocationErrorStatus(E)),!1}return(!u||u==="unknown")&&console.error("voice location error:",a),n.reportClientError("voice-location",a,{mode:e.mode,code:u||"unknown"}),n.setStatus(n.getVoiceLocationErrorStatus(a)),!1}finally{n.setVoiceListening(!1)}}async function $(a,u){let d=++e.latestLoadToken,E=e.mode,f=e.busStopId,S=y(E)&&!e.hasCompletedInitialStopModeLoad;n.setLoading(!0),n.setStatus("Loading departures...");try{let L=new URLSearchParams({lat:String(a),lon:String(u),mode:E.toUpperCase(),results:String(n.getActiveResultsLimit(E))}),o=y(E)&&(e.deferInitialStopContext||!e.hasCompletedInitialStopModeLoad);y(E)&&f&&!o&&L.set("stopId",f);let c=await g(`/api/v1/departures?${L.toString()}`);if(!(c.headers.get("content-type")||"").includes("application/json"))throw c.ok?new Error("Unexpected server response."):new Error("Request failed");let M=await c.json();if(!c.ok)throw new Error(M.error||"Request failed");if(d!==e.latestLoadToken)return;y(E)&&(k(M),n.persistUiState(),S&&n.trackInitialNearestStopResolved(M,E)),e.latestResponse=M,n.render(M),n.setPermissionRequired(!1),n.setLastUpdated(new Date),n.setStatus(n.buildStatusFromResponse(M)),n.trackFirstSuccessfulRender(M,E)}catch(L){if(d!==e.latestLoadToken)return;e.latestResponse=null,console.error("load departures error:",L),n.reportClientError("load",L,{mode:E}),n.setStatus(n.getLoadErrorStatus(L)),t.resultEl.classList.add("hidden"),n.updateNextSummary(null)}finally{d===e.latestLoadToken&&n.setLoading(!1)}}function H(){if(Y(),n.setResolvedLocationHint(null),!navigator.geolocation)return n.setStatus("Geolocation not supported in this browser."),n.setPermissionRequired(!0),!1;if(e.isLoading||e.isVoiceListening)return!1;n.setStatus("Getting your location..."),n.setLoading(!0);let a=S=>({enableHighAccuracy:S,timeout:S?15e3:1e4,maximumAge:0}),u=(S,L)=>L?!1:S?.code===2||S?.code===3,d=S=>{e.currentCoords={lat:S.coords.latitude,lon:S.coords.longitude},e.locationGranted=!0,n.setStorageItem("location:granted","1"),n.setPermissionRequired(!1),n.setLoading(!1),$(e.currentCoords.lat,e.currentCoords.lon)},E=S=>{S.code===1?n.setPermissionRequired(!0):n.setPermissionRequired(!1),n.setStatus(n.getGeolocationErrorStatus(S)),e.latestResponse=null,t.resultEl.classList.add("hidden"),n.updateNextSummary(null),n.setLoading(!1)},f=S=>{navigator.geolocation.getCurrentPosition(d,L=>{if(u(L,S)){f(!0);return}E(L)},a(S))};return f(!1),!0}function V(){if(!e.isVoiceListening){if(e.currentCoords){$(e.currentCoords.lat,e.currentCoords.lon);return}H()}}function W(){n.updateModeButtons(),n.updateModeLabels(),n.renderResultsLimitControl(),n.updateHelsinkiFilterButton(),n.renderStopControls(),n.updateDataScope(e.latestResponse)}Object.assign(n,{delay:R,fetchWithTimeout:N,fetchWithRetryOnce:g,updateStopModeStateFromResponse:k,buildFilterOptionsFromDepartures:w,load:$,requestLocationAndLoad:H,requestVoiceLocationAndLoad:z,supportsVoiceLocation:O,captureVoiceQuery:D,captureVoiceQueryWithRetry:X,getVoiceRecognitionLanguages:v,shouldRetryVoiceRecognition:B,resolveVoiceLocationQuery:ee,refreshDeparturesOnly:V,applyModeUiState:W})})();(()=>{let x=window.HMApp,{api:n,dom:t,state:e,constants:A}=x,{MODE_RAIL:F,MODE_TRAM:_,MODE_METRO:r,MODE_BUS:y}=A;function R(){if(e.currentCoords){n.load(e.currentCoords.lat,e.currentCoords.lon);return}n.requestLocationAndLoad()}t.locateBtn?.addEventListener("click",()=>{n.trackFirstManualInteraction("refresh_location_click"),n.requestLocationAndLoad()}),t.voiceLocateBtn?.addEventListener("click",()=>{n.trackFirstManualInteraction("voice_location_click"),n.requestVoiceLocationAndLoad()}),t.modeRailBtn?.addEventListener("click",()=>{e.mode!==F&&(n.trackFirstManualInteraction("mode_change",{toMode:F}),e.mode=F,n.applyModeUiState(),n.persistUiState(),R())}),t.modeTramBtn?.addEventListener("click",()=>{e.mode!==_&&(n.trackFirstManualInteraction("mode_change",{toMode:_}),e.mode=_,e.helsinkiOnly=!1,n.applyModeUiState(),n.persistUiState(),R())}),t.modeMetroBtn?.addEventListener("click",()=>{e.mode!==r&&(n.trackFirstManualInteraction("mode_change",{toMode:r}),e.mode=r,e.helsinkiOnly=!1,n.applyModeUiState(),n.persistUiState(),R())}),t.modeBusBtn?.addEventListener("click",()=>{e.mode!==y&&(n.trackFirstManualInteraction("mode_change",{toMode:y}),e.mode=y,e.helsinkiOnly=!1,n.applyModeUiState(),n.persistUiState(),R())}),t.resultsLimitSelectEl?.addEventListener("click",g=>{g.stopPropagation(),n.toggleResultsLimitDropdown()}),document.addEventListener("click",g=>{t.resultsLimitSelectWrapEl&&(t.resultsLimitSelectWrapEl.contains(g.target)||n.toggleResultsLimitDropdown(!1))}),t.resultsLimitSelectEl?.addEventListener("keydown",g=>{let w=t.resultsLimitSelectListEl;if(!w)return;let k=t.resultsLimitSelectEl.getAttribute("aria-expanded")==="true";if(g.key==="Escape"){n.toggleResultsLimitDropdown(!1),t.resultsLimitSelectEl.focus(),g.preventDefault();return}if(g.key==="Enter"||g.key===" "){if(!k){n.toggleResultsLimitDropdown(!0),g.preventDefault();return}let m=w.querySelector(".is-focused");m?.dataset?.value&&n.selectResultsLimit(m.dataset.value),g.preventDefault();return}if(g.key==="ArrowDown"||g.key==="ArrowUp"){if(g.preventDefault(),!k){n.toggleResultsLimitDropdown(!0);return}let m=[...w.querySelectorAll("li[role='option']")];if(m.length===0)return;let C=m.findIndex(U=>U.classList.contains("is-focused")),v;g.key==="ArrowDown"?v=C<m.length-1?C+1:0:v=C>0?C-1:m.length-1;for(let U of m)U.classList.remove("is-focused");m[v].classList.add("is-focused"),m[v].scrollIntoView({block:"nearest"})}}),t.busStopSelectEl?.addEventListener("click",g=>{g.stopPropagation(),n.toggleStopDropdown()}),document.addEventListener("click",g=>{t.busStopSelectWrapEl&&(t.busStopSelectWrapEl.contains(g.target)||n.toggleStopDropdown(!1))}),t.busStopSelectEl?.addEventListener("keydown",g=>{let w=t.busStopSelectListEl;if(!w)return;let k=t.busStopSelectEl.getAttribute("aria-expanded")==="true";if(g.key==="Escape"){n.toggleStopDropdown(!1),t.busStopSelectEl.focus(),g.preventDefault();return}if(g.key==="Enter"||g.key===" "){if(!k){n.toggleStopDropdown(!0),g.preventDefault();return}let m=w.querySelector(".is-focused");m?.dataset?.value&&n.selectStop(m.dataset.value),g.preventDefault();return}if(g.key==="ArrowDown"||g.key==="ArrowUp"){if(g.preventDefault(),!k){n.toggleStopDropdown(!0);return}let m=[...w.querySelectorAll("li[role='option']")];if(m.length===0)return;let C=m.findIndex(U=>U.classList.contains("is-focused")),v;g.key==="ArrowDown"?v=C<m.length-1?C+1:0:v=C>0?C-1:m.length-1;for(let U of m)U.classList.remove("is-focused");m[v].classList.add("is-focused"),m[v].scrollIntoView({block:"nearest"})}}),t.stopFiltersToggleBtnEl?.addEventListener("click",()=>{n.trackFirstManualInteraction("stop_filters_panel_toggle",{currentMode:e.mode}),n.toggleStopFiltersPanel()}),t.helsinkiOnlyBtn?.addEventListener("click",()=>{e.mode===F&&(n.trackFirstManualInteraction("helsinki_only_toggle"),e.helsinkiOnly=!e.helsinkiOnly,n.persistUiState(),n.updateHelsinkiFilterButton(),e.latestResponse&&(n.render(e.latestResponse),n.setStatus(n.buildStatusFromResponse(e.latestResponse))))}),t.locationPromptAllowEl?.addEventListener("click",()=>{n.hideLocationPrompt(),n.requestLocationAndLoad()}),t.permissionRetryBtnEl?.addEventListener("click",()=>{n.trackFirstManualInteraction("permission_retry_click"),n.requestLocationAndLoad()}),n.hydrateInitialState(),n.applyModeUiState(),n.updateClock(),setInterval(n.updateClock,1e3),n.getStorageItem("location:granted")==="1"?n.requestLocationAndLoad():(n.showLocationPrompt(),n.setStatus("Tap Allow Location to get started.")),setInterval(n.refreshDeparturesOnly,3e4),window.addEventListener("error",g=>{n.reportClientError("error",g.error||g.message||"Unknown error",{source:g.filename||"",line:g.lineno||null,column:g.colno||null})}),window.addEventListener("unhandledrejection",g=>{n.reportClientError("unhandledrejection",g.reason||"Unhandled promise rejection")}),(()=>{let g=document.getElementById("themeToggle");if(!g)return;let w=document.documentElement,k=window.matchMedia("(prefers-color-scheme: dark)"),m=()=>{let O=n.getStorageItem("theme");return O==="dark"||O==="light"?O:null},C=O=>{w.setAttribute("data-theme",O==="light"?"light":"dark")},v=()=>{let O=m();if(O){C(O);return}C(k.matches?"dark":"light")},U=O=>{m()||C(O.matches?"dark":"light")};v(),typeof k.addEventListener=="function"?k.addEventListener("change",U):typeof k.addListener=="function"&&k.addListener(U),g.addEventListener("click",()=>{let O=w.getAttribute("data-theme")==="dark"?"light":"dark";C(O),n.setStorageItem("theme",O)})})()})();})();
