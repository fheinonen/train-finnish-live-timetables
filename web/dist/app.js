(()=>{(()=>{let x=window.HMApp||(window.HMApp={}),n=x.api||={};x.dom={locateBtn:document.getElementById("locateBtn"),voiceLocateBtn:document.getElementById("voiceLocateBtn"),voiceLocateBtnLabel:document.getElementById("voiceLocateBtnLabel"),skeletonEl:document.getElementById("skeleton"),segmentControlEl:document.querySelector(".segment-control"),modeRailBtn:document.getElementById("modeRailBtn"),modeTramBtn:document.getElementById("modeTramBtn"),modeMetroBtn:document.getElementById("modeMetroBtn"),modeBusBtn:document.getElementById("modeBusBtn"),helsinkiOnlyBtn:document.getElementById("helsinkiOnlyBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busStopSelectLabelEl:document.getElementById("busStopSelectLabel"),busStopSelectListEl:document.getElementById("busStopSelectList"),busStopSelectWrapEl:document.getElementById("busStopSelectWrap"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),stopFiltersToggleBtnEl:document.getElementById("stopFiltersToggleBtn"),stopFiltersPanelEl:document.getElementById("stopFiltersPanel"),stopFilterSummaryEl:document.getElementById("stopFilterSummary"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),resultsLimitSelectLabelEl:document.getElementById("resultsLimitSelectLabel"),resultsLimitSelectListEl:document.getElementById("resultsLimitSelectList"),resultsLimitSelectWrapEl:document.getElementById("resultsLimitSelectWrap"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),resolvedLocationEl:document.getElementById("resolvedLocation"),voiceLocationChoicesEl:document.getElementById("voiceLocationChoices"),voiceLocationChoicesTitleEl:document.getElementById("voiceLocationChoicesTitle"),voiceLocationChoicesOptionsEl:document.getElementById("voiceLocationChoicesOptions"),voiceLocationChoicesCancelEl:document.getElementById("voiceLocationChoicesCancel"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),locationPromptCardEl:document.getElementById("locationPromptCard"),locationPromptAllowEl:document.getElementById("locationPromptAllow"),permissionCardEl:document.getElementById("permissionCard"),permissionRetryBtnEl:document.getElementById("permissionRetryBtn"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},x.constants={MODE_RAIL:"rail",MODE_TRAM:"tram",MODE_METRO:"metro",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_HELSINKI_ONLY_KEY:"prefs:helsinkiOnly",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_TRAM_KEY:"prefs:resultsLimitTram",STORAGE_RESULTS_LIMIT_METRO_KEY:"prefs:resultsLimitMetro",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_TRAM:8,DEFAULT_RESULTS_LIMIT_METRO:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],VOICE_RECOGNITION_TIMEOUT_MS:8e3,VOICE_SILENCE_STOP_MS:1200,VOICE_QUERY_MIN_LENGTH:3,FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5,METRIC_REPORT_LIMIT:10,METRIC_SAMPLE_RATE:1};let{MODE_RAIL:t,MODE_TRAM:e,MODE_METRO:A,MODE_BUS:F}=x.constants;x.state={locationGranted:!1,isLoading:!1,isVoiceListening:!1,currentCoords:null,latestResponse:null,mode:t,helsinkiOnly:!1,busStopId:null,busLineFilters:[],busDestinationFilters:[],stopFiltersPanelOpen:!1,deferInitialStopContext:!1,deferredBusStopId:null,deferredBusLineFilters:[],deferredBusDestinationFilters:[],resultsLimitByMode:{[t]:x.constants.DEFAULT_RESULTS_LIMIT_RAIL,[e]:x.constants.DEFAULT_RESULTS_LIMIT_TRAM,[A]:x.constants.DEFAULT_RESULTS_LIMIT_METRO,[F]:x.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},resolvedLocationHint:null,suppressBusStopChange:!1,hasCompletedInitialStopModeLoad:!1,errorReportCount:0,metricReportCount:0,isMetricSessionSampled:Math.random()<x.constants.METRIC_SAMPLE_RATE,sessionStartedAtMs:Date.now(),hasReportedFirstSuccessfulRenderMetric:!1,hasReportedFirstManualInteractionMetric:!1,hasReportedFirstManualStopContextMetric:!1,hasReportedInitialNearestStopResolvedMetric:!1,latestLoadToken:0};let{dom:_,state:l,constants:h}=x;function R(){let o=l.isLoading||l.isVoiceListening,c=l.isLoading;_.locateBtn&&(_.locateBtn.disabled=o),_.voiceLocateBtn&&(_.voiceLocateBtn.disabled=c,_.voiceLocateBtn.classList.toggle("is-listening",l.isVoiceListening),_.voiceLocateBtn.setAttribute("aria-pressed",String(l.isVoiceListening))),_.voiceLocateBtnLabel&&(_.voiceLocateBtnLabel.textContent=l.isVoiceListening?"Listening...":"Describe Location")}function U(o){l.isLoading=o,R(),_.skeletonEl&&_.skeletonEl.classList.toggle("hidden",!o)}function f(o){l.isVoiceListening=!!o,R()}function w(o){_.statusEl&&(_.statusEl.textContent=o)}function k(o){let c=Number(o);return Number.isFinite(c)?c.toFixed(5):null}function m(o){let c=o&&typeof o=="object";if(l.resolvedLocationHint=c?{query:B(o.query,120).trim(),label:B(o.label,180).trim(),lat:Number(o.lat),lon:Number(o.lon)}:null,!_.resolvedLocationEl)return;if(!l.resolvedLocationHint){_.resolvedLocationEl.classList.add("hidden"),_.resolvedLocationEl.textContent="";return}let I=l.resolvedLocationHint.label||"Unknown place",M=l.resolvedLocationHint.query,i=k(l.resolvedLocationHint.lat),s=k(l.resolvedLocationHint.lon),a=M?` (from "${M}")`:"",p=i&&s?` - ${i}, ${s}`:"";_.resolvedLocationEl.textContent=`Resolved location: ${I}${a}${p}`,_.resolvedLocationEl.classList.remove("hidden")}function C(){_.locationPromptCardEl&&_.locationPromptCardEl.classList.remove("hidden"),_.permissionCardEl&&_.permissionCardEl.classList.add("hidden")}function v(){_.locationPromptCardEl&&_.locationPromptCardEl.classList.add("hidden")}function N(o){v(),_.permissionCardEl&&_.permissionCardEl.classList.toggle("hidden",!o)}function O(o){!_.lastUpdatedEl||!(o instanceof Date)||(_.lastUpdatedEl.textContent=`Last updated: ${o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function P(o){try{return window.localStorage.getItem(o)}catch{return null}}function D(o,c){try{window.localStorage.setItem(o,c)}catch{}}function B(o,c){let I=String(o||"");return I.length<=c?I:I.slice(0,c)}function X(o){if(o instanceof Error)return o;try{let c=typeof o=="string"?o:JSON.stringify(o);return new Error(c||"Unknown error")}catch{return new Error(String(o||"Unknown error"))}}function Z(o){let c=JSON.stringify(o);if(navigator.sendBeacon){let I=new Blob([c],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",I);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:c,keepalive:!0}).catch(()=>{})}function Y(o,c,I=null){if(l.errorReportCount>=h.ERROR_REPORT_LIMIT)return;l.errorReportCount+=1;let M=X(c),i={type:B(o,40),message:B(M.message,400),stack:B(M.stack||"",1200),url:B(window.location.href,500),userAgent:B(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:I&&typeof I=="object"?I:null};Z(i)}function q(){return Math.max(0,Date.now()-l.sessionStartedAtMs)}function H(o,c=null){if(!l.isMetricSessionSampled||l.metricReportCount>=h.METRIC_REPORT_LIMIT)return!1;l.metricReportCount+=1;let I={type:"metric",message:B(o,400),stack:"",url:B(window.location.href,500),userAgent:B(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:{metricName:B(o,80),sessionElapsedMs:q(),mode:l.mode,...c&&typeof c=="object"?c:{}}};return Z(I),!0}function ee(o,c){if(l.hasReportedFirstSuccessfulRenderMetric)return;l.hasReportedFirstSuccessfulRenderMetric=!0;let I=Array.isArray(o?.station?.departures)?o.station.departures:[];H("first_successful_render",{requestMode:String(c||"").trim(),hasStation:!!o?.station,departureCount:I.length})}function te(o,c=null){l.hasReportedFirstManualInteractionMetric||(l.hasReportedFirstManualInteractionMetric=!0,H("first_manual_interaction",{interactionType:B(o,80),...c&&typeof c=="object"?c:{}}))}function K(o,c=null){l.hasReportedFirstManualStopContextMetric||(l.hasReportedFirstManualStopContextMetric=!0,H("first_manual_stop_context_change",{changeType:B(o,80),lineFilterCount:l.busLineFilters.length,destinationFilterCount:l.busDestinationFilters.length,...c&&typeof c=="object"?c:{}}))}function j(o,c){if(l.hasReportedInitialNearestStopResolvedMetric)return;let I=String(o?.selectedStopId||"").trim();if(!I)return;l.hasReportedInitialNearestStopResolvedMetric=!0;let i=(Array.isArray(o?.stops)?o.stops:[]).find(a=>a?.id===I)||null,s=Array.isArray(o?.station?.departures)?o.station.departures:[];H("initial_nearest_stop_resolved",{requestMode:String(c||"").trim(),selectedStopId:I,distanceMeters:Number(i?.distanceMeters)||null,departureCount:s.length})}function z(o){if(!o)return null;let c=String(o).trim().toLowerCase();return c===t||c===e||c===A||c===F?c:null}function $(o){if(o==null)return null;let c=String(o).trim().toLowerCase();return["1","true","yes","on"].includes(c)?!0:["0","false","no","off"].includes(c)?!1:null}function G(o){return Array.isArray(o)?[...new Set(o.map(c=>String(c||"").trim()).filter(Boolean))]:[]}function V(o){if(o==null||o==="")return null;let c=Number(o);return!Number.isInteger(c)||!h.RESULT_LIMIT_OPTIONS.includes(c)?null:c}function W(o=l.mode){return o===F?h.DEFAULT_RESULTS_LIMIT_BUS:o===A?h.DEFAULT_RESULTS_LIMIT_METRO:o===e?h.DEFAULT_RESULTS_LIMIT_TRAM:h.DEFAULT_RESULTS_LIMIT_RAIL}function r(o=l.mode){let c=V(l.resultsLimitByMode?.[o]);return c??W(o)}function u(o){let c=P(o);if(!c)return[];try{let I=JSON.parse(c);return G(I)}catch{return[]}}function d(){let o=new URLSearchParams(window.location.search);return{mode:z(o.get("mode")),helsinkiOnly:$(o.get("helsinkiOnly")),stopProvided:o.has("stop"),busStopId:o.get("stop")?o.get("stop").trim():null,linesProvided:o.has("line"),busLines:G(o.getAll("line")),destinationsProvided:o.has("dest"),busDestinations:G(o.getAll("dest")),resultsProvided:o.has("results"),resultsLimit:V(o.get("results"))}}function g(){let o=d(),c=z(P(h.STORAGE_MODE_KEY)),I=$(P(h.STORAGE_HELSINKI_ONLY_KEY));l.mode=o.mode||c||t,l.helsinkiOnly=o.helsinkiOnly??I??!1,l.mode!==t&&(l.helsinkiOnly=!1);let M=String(P(h.STORAGE_BUS_STOP_KEY)||"").trim()||null,i=o.stopProvided?o.busStopId:M,s=u(h.STORAGE_BUS_LINES_KEY),a=u(h.STORAGE_BUS_DESTINATIONS_KEY),p=o.linesProvided?o.busLines:s,b=o.destinationsProvided?o.busDestinations:a,E=!!i||p.length>0||b.length>0;l.deferInitialStopContext=E,E?(l.deferredBusStopId=i,l.deferredBusLineFilters=[...p],l.deferredBusDestinationFilters=[...b],l.busStopId=null,l.busLineFilters=[],l.busDestinationFilters=[]):(l.deferredBusStopId=null,l.deferredBusLineFilters=[],l.deferredBusDestinationFilters=[],l.busStopId=i,l.busLineFilters=p,l.busDestinationFilters=b);let T=V(P(h.STORAGE_RESULTS_LIMIT_RAIL_KEY)),J=V(P(h.STORAGE_RESULTS_LIMIT_TRAM_KEY)),Q=V(P(h.STORAGE_RESULTS_LIMIT_METRO_KEY)),ne=V(P(h.STORAGE_RESULTS_LIMIT_BUS_KEY));l.resultsLimitByMode[t]=T??h.DEFAULT_RESULTS_LIMIT_RAIL,l.resultsLimitByMode[e]=J??h.DEFAULT_RESULTS_LIMIT_TRAM,l.resultsLimitByMode[A]=Q??h.DEFAULT_RESULTS_LIMIT_METRO,l.resultsLimitByMode[F]=ne??h.DEFAULT_RESULTS_LIMIT_BUS,o.resultsProvided&&o.resultsLimit!=null&&(l.resultsLimitByMode[l.mode]=o.resultsLimit)}function S(){D(h.STORAGE_MODE_KEY,l.mode),D(h.STORAGE_HELSINKI_ONLY_KEY,l.helsinkiOnly?"1":"0"),D(h.STORAGE_BUS_STOP_KEY,l.busStopId||""),D(h.STORAGE_BUS_LINES_KEY,JSON.stringify(l.busLineFilters)),D(h.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(l.busDestinationFilters)),D(h.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(r(t))),D(h.STORAGE_RESULTS_LIMIT_TRAM_KEY,String(r(e))),D(h.STORAGE_RESULTS_LIMIT_METRO_KEY,String(r(A))),D(h.STORAGE_RESULTS_LIMIT_BUS_KEY,String(r(F)))}function y(){let o=new URLSearchParams(window.location.search);l.mode===t?o.delete("mode"):o.set("mode",l.mode),l.mode===t&&l.helsinkiOnly?o.set("helsinkiOnly","1"):o.delete("helsinkiOnly");let c=r(),I=W();if(c===I?o.delete("results"):o.set("results",String(c)),o.delete("stop"),o.delete("line"),o.delete("dest"),l.mode===F||l.mode===e||l.mode===A){l.busStopId&&o.set("stop",l.busStopId);for(let s of l.busLineFilters)o.append("line",s);for(let s of l.busDestinationFilters)o.append("dest",s)}let M=o.toString(),i=`${window.location.pathname}${M?`?${M}`:""}${window.location.hash}`;window.history.replaceState(null,"",i)}function L(){S(),y()}R(),Object.assign(n,{updateLocationActionButtons:R,setLoading:U,setVoiceListening:f,setStatus:w,setResolvedLocationHint:m,showLocationPrompt:C,hideLocationPrompt:v,setPermissionRequired:N,setLastUpdated:O,getStorageItem:P,setStorageItem:D,safeString:B,toError:X,sendClientReport:Z,reportClientError:Y,reportClientMetric:H,getSessionElapsedMs:q,trackFirstSuccessfulRender:ee,trackFirstManualInteraction:te,trackFirstManualStopContextChange:K,trackInitialNearestStopResolved:j,normalizeMode:z,parseBoolean:$,uniqueNonEmptyStrings:G,parseResultLimit:V,getDefaultResultsLimit:W,getActiveResultsLimit:r,parseStoredArray:u,readStateFromUrl:d,hydrateInitialState:g,syncStateToStorage:S,syncStateToUrl:y,persistUiState:L})})();(()=>{let x=window.HMApp,{api:n,dom:t,state:e,constants:A}=x,{MODE_RAIL:F,MODE_TRAM:_,MODE_METRO:l,MODE_BUS:h}=A;function R(i=e.mode){return i===h||i===_||i===l}function U(i=e.mode){return i===_?{singular:"tram",plural:"trams",title:"Tram"}:i===l?{singular:"metro",plural:"metros",title:"Metro"}:{singular:"bus",plural:"buses",title:"Bus"}}function f(i){let s=w(i);return s<=0?"Now":`${s}m`}function w(i){let s=new Date(i);return Math.floor((s.getTime()-Date.now())/6e4)}function k(i){let s=w(i);return s<=0||s<3?"departure-now":s<=10?"departure-soon":"departure-later"}function m(i){let s=i?.destination||"";return/\bhelsinki\b/i.test(s)}function C(){let i=new Set((e.busFilterOptions.lines||[]).map(a=>a.value)),s=new Set((e.busFilterOptions.destinations||[]).map(a=>a.value));e.busLineFilters=e.busLineFilters.filter(a=>i.has(a)),e.busDestinationFilters=e.busDestinationFilters.filter(a=>s.has(a))}function v(i){if(!Array.isArray(i))return[];if(e.mode===F)return e.helsinkiOnly?i.filter(m):i;if(!R())return i;let s=new Set(e.busLineFilters),a=new Set(e.busDestinationFilters);return i.filter(p=>{if(s.size===0)return!0;let b=String(p?.line||"").trim();return s.has(b)}).filter(p=>{if(a.size===0)return!0;let b=String(p?.destination||"").trim();return a.has(b)})}function N(){let i=[{el:t.modeRailBtn,mode:F,index:0},{el:t.modeTramBtn,mode:_,index:1},{el:t.modeMetroBtn,mode:l,index:2},{el:t.modeBusBtn,mode:h,index:3}];for(let{el:s,mode:a,index:p}of i){if(!s)continue;let b=e.mode===a;if(s.setAttribute("aria-checked",String(b)),s.classList.toggle("is-active",b),b){let E=s.closest(".segment-control");E&&E.style.setProperty("--active-index",p)}}}function O(){let i=R()?U().title:"Rail",s=R()?`Next ${U().title}`:"Next Train";t.modeEyebrowEl&&(t.modeEyebrowEl.textContent=`Helsinki Moves \u2022 ${i}`),t.nextLabelEl&&(t.nextLabelEl.textContent=s)}function P(i){if(!t.resultsLimitSelectEl||!t.resultsLimitSelectListEl)return;let s=t.resultsLimitSelectEl.getAttribute("aria-expanded")==="true",a=typeof i=="boolean"?i:!s;t.resultsLimitSelectEl.setAttribute("aria-expanded",String(a)),t.resultsLimitSelectListEl.classList.toggle("hidden",!a)}function D(i){let s=n.parseResultLimit(i);s==null||(P(!1),n.getActiveResultsLimit()===s)||(n.trackFirstManualInteraction("results_limit_change",{nextLimit:s,currentMode:e.mode}),e.resultsLimitByMode[e.mode]=s,n.persistUiState(),t.resultsLimitSelectLabelEl&&(t.resultsLimitSelectLabelEl.textContent=String(s)),e.currentCoords?n.load(e.currentCoords.lat,e.currentCoords.lon):n.requestLocationAndLoad())}function B(){if(!t.resultsLimitSelectListEl)return;let i=Array.isArray(A.RESULT_LIMIT_OPTIONS)?A.RESULT_LIMIT_OPTIONS:[],s=n.getActiveResultsLimit();t.resultsLimitSelectListEl.innerHTML="";for(let a of i){let p=document.createElement("li");p.setAttribute("role","option"),p.dataset.value=String(a),p.textContent=String(a),a===s&&p.setAttribute("aria-selected","true"),p.addEventListener("click",()=>D(String(a))),t.resultsLimitSelectListEl.appendChild(p)}t.resultsLimitSelectLabelEl&&(t.resultsLimitSelectLabelEl.textContent=String(s))}function X(){if(t.helsinkiOnlyBtn){if(e.mode!==F){t.helsinkiOnlyBtn.setAttribute("aria-pressed","false"),t.helsinkiOnlyBtn.classList.remove("is-active"),t.helsinkiOnlyBtn.disabled=!0,t.helsinkiOnlyBtn.textContent="Helsinki Only (Rail)";return}t.helsinkiOnlyBtn.disabled=!1,t.helsinkiOnlyBtn.setAttribute("aria-pressed",String(e.helsinkiOnly)),t.helsinkiOnlyBtn.classList.toggle("is-active",e.helsinkiOnly),t.helsinkiOnlyBtn.textContent=e.helsinkiOnly?"Helsinki Only: On":"Helsinki Only: Off"}}function Z(){return Math.max(0,e.busLineFilters.length)+Math.max(0,e.busDestinationFilters.length)}function Y(i=e.busLineFilters.length,s=e.busDestinationFilters.length){let a=Math.max(0,Number(i)||0)+Math.max(0,Number(s)||0);return a===0?"No filters":a===1?"1 filter":`${a} filters`}function q(){t.stopFilterSummaryEl&&(t.stopFilterSummaryEl.textContent=Y()),!(!t.stopFiltersToggleBtnEl||!t.stopFiltersPanelEl)&&(t.stopFiltersToggleBtnEl.setAttribute("aria-expanded",String(!!e.stopFiltersPanelOpen)),t.stopFiltersPanelEl.classList.toggle("hidden",!e.stopFiltersPanelOpen))}function H(i){e.stopFiltersPanelOpen=!!i,q()}function ee(i){let s=typeof i=="boolean"?i:!e.stopFiltersPanelOpen;H(s)}function te(i){t.busControlsEl&&(t.busControlsEl.classList.toggle("hidden",!i),i||(e.stopFiltersPanelOpen=!1),q())}function K(i){return e.busStops.find(s=>s.id===i)||null}function j(i){let s=n.uniqueNonEmptyStrings([...Array.isArray(i?.stopCodes)?i.stopCodes:[],i?.code]);return s.length===0&&i?.id&&s.push(String(i.id)),s}function z(i,s=null){let a=K(e.busStopId),p=String(s?.stopName||i?.stopName||a?.name||"").trim(),E=n.uniqueNonEmptyStrings([s?.stopCode,...Array.isArray(i?.stopCodes)?i.stopCodes:[],i?.stopCode,...j(a)])[0]||"";return p&&E?`${p} ${E}`:p||E||"\u2014"}function $(i,s=null){if(R())return z(i,s);let a=String(s?.stopName||i?.stopName||"").trim(),p=String(s?.stopCode||i?.stopCode||"").trim();return a&&p?`${a} ${p}`:a||p||"\u2014"}function G(i){if(!t.dataScopeEl)return;if(!R()){t.dataScopeEl.classList.add("hidden"),t.dataScopeEl.textContent="";return}let s=String(i?.station?.stopName||K(e.busStopId)?.name||"").trim(),p=n.uniqueNonEmptyStrings([...Array.isArray(i?.station?.stopCodes)?i.station.stopCodes:[],i?.station?.stopCode,...j(K(e.busStopId))]).join(", "),b=e.busLineFilters.length===0?"all lines":`${e.busLineFilters.length} line${e.busLineFilters.length===1?"":"s"} selected`,E=e.busDestinationFilters.length===0?"all destinations":`${e.busDestinationFilters.length} destination${e.busDestinationFilters.length===1?"":"s"} selected`,T=`${n.getActiveResultsLimit()} results`;s?t.dataScopeEl.textContent=`Selected stop ${s} (${p||"\u2014"}) - ${b}, ${E}, ${T}`:t.dataScopeEl.textContent=`Selecting stop... (${b}, ${E}, ${T})`,t.dataScopeEl.classList.remove("hidden")}function V(i,s,a,p){if(!i)return;if(i.innerHTML="",!Array.isArray(s)||s.length===0){let E=document.createElement("span");E.className="chip-empty",E.textContent="No options",i.appendChild(E);return}let b=new Set(a);for(let E of s){let T=document.createElement("button");T.type="button",T.className="chip-toggle",b.has(E.value)?(T.classList.add("is-active"),T.setAttribute("aria-pressed","true")):T.setAttribute("aria-pressed","false"),T.textContent=`${E.value} (${E.count})`,T.addEventListener("click",()=>p(E.value)),i.appendChild(T)}}function W(i){if(!t.busStopSelectEl||!t.busStopSelectListEl)return;let s=t.busStopSelectEl.getAttribute("aria-expanded")==="true",a=typeof i=="boolean"?i:!s;t.busStopSelectEl.setAttribute("aria-expanded",String(a)),t.busStopSelectListEl.classList.toggle("hidden",!a)}function r(i){if(!e.suppressBusStopChange){if(!i||i===e.busStopId){W(!1);return}if(n.trackFirstManualInteraction("stop_select",{currentMode:e.mode}),n.trackFirstManualStopContextChange("stop_select",{selectedStopId:i}),e.busStopId=i,n.persistUiState(),W(!1),t.busStopSelectLabelEl){let s=e.busStops.find(a=>a.id===i);t.busStopSelectLabelEl.textContent=s?`${s.name} (${s.distanceMeters}m)`:i}e.currentCoords&&n.load(e.currentCoords.lat,e.currentCoords.lon)}}function u(){let i=R();if(te(i),!!i){if(q(),t.busStopSelectListEl){if(e.suppressBusStopChange=!0,t.busStopSelectListEl.innerHTML="",e.busStops.length===0)t.busStopSelectLabelEl&&(t.busStopSelectLabelEl.textContent=`No nearby ${U().singular} stops`),t.busStopSelectEl&&(t.busStopSelectEl.disabled=!0);else{t.busStopSelectEl&&(t.busStopSelectEl.disabled=!1);let s=e.busStopId;(!s||!e.busStops.some(a=>a.id===s))&&(s=e.busStops[0].id);for(let a of e.busStops){let p=document.createElement("li");p.setAttribute("role","option"),p.dataset.value=a.id,p.textContent=`${a.name} (${a.distanceMeters}m)`,a.id===s&&p.setAttribute("aria-selected","true"),p.addEventListener("click",()=>r(a.id)),t.busStopSelectListEl.appendChild(p)}if(t.busStopSelectLabelEl){let a=e.busStops.find(p=>p.id===s);t.busStopSelectLabelEl.textContent=a?`${a.name} (${a.distanceMeters}m)`:"Select stop"}}e.suppressBusStopChange=!1}V(t.busLineFiltersEl,e.busFilterOptions.lines,e.busLineFilters,s=>{e.busLineFilters.includes(s)?e.busLineFilters=e.busLineFilters.filter(a=>a!==s):e.busLineFilters=[...e.busLineFilters,s],n.trackFirstManualInteraction("line_filter_toggle",{currentMode:e.mode}),n.trackFirstManualStopContextChange("line_filter_toggle"),n.persistUiState(),q(),e.latestResponse&&(n.render(e.latestResponse),n.setStatus(n.buildStatusFromResponse(e.latestResponse)))}),V(t.busDestinationFiltersEl,e.busFilterOptions.destinations,e.busDestinationFilters,s=>{e.busDestinationFilters.includes(s)?e.busDestinationFilters=e.busDestinationFilters.filter(a=>a!==s):e.busDestinationFilters=[...e.busDestinationFilters,s],n.trackFirstManualInteraction("destination_filter_toggle",{currentMode:e.mode}),n.trackFirstManualStopContextChange("destination_filter_toggle"),n.persistUiState(),q(),e.latestResponse&&(n.render(e.latestResponse),n.setStatus(n.buildStatusFromResponse(e.latestResponse)))})}}function d(i,s=null){if(!t.nextSummaryEl||!t.nextMinsEl||!t.nextLineEl||!t.nextTrackEl||!t.nextDestinationEl)return;if(!i){t.nextSummaryEl.classList.add("hidden"),t.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later");return}let a=w(i.departureIso);t.nextMinsEl.textContent=f(i.departureIso),t.nextLineEl.textContent=i.line||"\u2014",t.nextLineEl.classList.toggle("next-letter-now",a<3),t.nextTrackEl.textContent=R()?`Stop ${$(s,i)}`:i.track?`Track ${i.track}`:"Track \u2014",t.nextDestinationEl.textContent=i.destination||"\u2014",t.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),a<3?t.nextSummaryEl.classList.add("next-summary-now"):a<=10?t.nextSummaryEl.classList.add("next-summary-soon"):t.nextSummaryEl.classList.add("next-summary-later"),t.nextSummaryEl.classList.remove("hidden")}function g(i){if(!i||!i.station)return R()?i?.message||`No nearby ${U().singular} stops found.`:i?.message||"No nearby train stations found.";let a=v(i.station.departures)[0];if(!a)return R()?e.busLineFilters.length>0||e.busDestinationFilters.length>0?`No upcoming ${U().plural} match selected filters.`:"No upcoming departures from this stop.":e.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.";let p=a.destination?` \u2022 ${a.destination}`:"",b=e.mode===F?a.track?` \u2022 Track ${a.track}`:"":i.station.stopName||i.station.stopCode?` \u2022 ${$(i.station,a)}`:"",E=R()?U().singular:"train";return`Next ${a.line||E} in ${f(a.departureIso)}${p}${b}`}function S(i){if(!(i instanceof Error))return"Could not refresh departures. Please try again.";if(i.name==="AbortError")return"Request timed out. Please try again.";let s=(i.message||"").trim();return s==="Temporary server error. Please try again."?s:s==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":s==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function y(i){return i?.code===1?"Location permission denied.":i?.code===2?"Location unavailable. Please try again.":i?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function L(i){let s=String(i?.code||"").trim();return s==="voice_unsupported"?"Voice location is not supported in this browser.":s==="voice_permission_denied"?"Microphone permission denied.":s==="voice_no_microphone"?"No microphone was found for voice location.":s==="voice_no_speech"?"No speech detected. Please try again.":s==="voice_recognition_timeout"?"Voice listening timed out. Please try again.":s==="voice_language_not_supported"?"Voice language was not supported on this device.":s==="voice_query_too_short"?"Please describe your location with a few words.":s==="voice_location_not_found"?"Could not match that place. Try a nearby landmark or street.":s==="voice_location_selection_cancelled"?"Location selection was cancelled.":s==="voice_location_selection_invalid"?"Please choose one of the suggested locations.":s==="voice_recognition_network"?"Voice recognition failed due to a network error. On iPhone, try enabling Siri & Dictation.":"Could not use voice location. Please try again."}function o(){t.skeletonEl&&t.skeletonEl.classList.remove("hidden")}function c(){t.skeletonEl&&t.skeletonEl.classList.add("hidden")}function I(i){if(c(),u(),G(i),!i||!i.station){t.resultEl.classList.add("hidden"),d(null);return}let s=i.station;t.resultEl.classList.remove("hidden"),t.stationTitleEl.textContent=s.stopName,t.stationMetaEl.textContent=`${s.distanceMeters}m away`,t.departuresEl.innerHTML="";let a=v(s.departures);if(a.length===0){d(null);let b=document.createElement("li");b.className="empty-row",R()?b.textContent=e.busLineFilters.length>0||e.busDestinationFilters.length>0?`No upcoming ${U().plural} match selected filters.`:"No upcoming departures from this stop.":b.textContent=e.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.",t.departuresEl.appendChild(b);return}d(a[0],s);let p=a.slice(1);if(p.length===0){let b=document.createElement("li");b.className="empty-row",b.textContent=R()?`No additional upcoming ${U().plural} right now.`:"No additional upcoming commuter trains right now.",t.departuresEl.appendChild(b);return}for(let b=0;b<p.length;b++){let E=p[b],T=document.createElement("li");T.className=`departure-row ${k(E.departureIso)}`,T.style.setProperty("--i",b);let J=document.createElement("div");J.className="letter-badge",J.textContent=E.line||"?";let Q=document.createElement("div");Q.className="train";let ne=document.createElement("div");ne.className="destination",ne.textContent=E.destination||"\u2014",Q.appendChild(ne);let oe=document.createElement("span");oe.className="track",R()?oe.textContent=`Stop ${$(s,E)}`:oe.textContent=E.track?`Track ${E.track}`:"Track \u2014",Q.appendChild(oe);let ie=document.createElement("div");ie.className="time";let se=document.createElement("span");se.className="remaining",se.textContent=f(E.departureIso);let re=document.createElement("span");re.className="clock-time",re.textContent=new Date(E.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),ie.appendChild(se),ie.appendChild(re),T.appendChild(J),T.appendChild(Q),T.appendChild(ie),t.departuresEl.appendChild(T)}}function M(){t.nowClockEl&&(t.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(n,{formatMinutes:f,minutesUntil:w,departureRowClass:k,isHelsinkiBound:m,sanitizeStopSelections:C,getVisibleDepartures:v,updateModeButtons:N,updateModeLabels:O,toggleResultsLimitDropdown:P,selectResultsLimit:D,renderResultsLimitControl:B,updateHelsinkiFilterButton:X,countActiveStopFilters:Z,buildStopFilterSummary:Y,syncStopFiltersPanelUi:q,setStopFiltersPanelOpen:H,toggleStopFiltersPanel:ee,setStopControlsVisibility:te,getStopMeta:K,getStopCodes:j,buildStopDisplay:z,buildModeStopDisplay:$,updateDataScope:G,renderFilterButtons:V,toggleStopDropdown:W,selectStop:r,renderStopControls:u,updateNextSummary:d,buildStatusFromResponse:g,getLoadErrorStatus:S,getGeolocationErrorStatus:y,getVoiceLocationErrorStatus:L,showSkeleton:o,hideSkeleton:c,render:I,updateClock:M})})();(()=>{let x=window.HMApp,{api:n,dom:t,state:e,constants:A}=x,{MODE_TRAM:F,MODE_METRO:_,MODE_BUS:l}=A;function h(r){return r===l||r===F||r===_}function R(r){return new Promise(u=>setTimeout(u,r))}async function U(r,u={},d=A.FETCH_TIMEOUT_MS){let g=new AbortController,S=setTimeout(()=>g.abort(),d);try{return await fetch(r,{...u,signal:g.signal})}finally{clearTimeout(S)}}async function f(r,u={}){let d;try{d=await U(r,u)}catch{return await R(350),U(r,u)}return d.status>=500?(await R(350),U(r,u)):d}function w(r){let u=new Map,d=new Map;for(let S of r||[]){let y=String(S?.line||"").trim();y&&u.set(y,(u.get(y)||0)+1);let L=String(S?.destination||"").trim();L&&d.set(L,(d.get(L)||0)+1)}let g=S=>[...S.entries()].sort((y,L)=>L[1]-y[1]||y[0].localeCompare(L[0])).map(([y,L])=>({value:y,count:L}));return{lines:g(u),destinations:g(d)}}function k(r){let u=Array.isArray(r?.stops)?r.stops.filter(y=>y&&y.id&&y.name).map(y=>({id:y.id,name:y.name,code:String(y.code||"").trim()||null,stopCodes:n.uniqueNonEmptyStrings([...Array.isArray(y.stopCodes)?y.stopCodes:[],y.code]),distanceMeters:Number(y.distanceMeters)||0})):[];e.busStops=u;let d=String(r?.selectedStopId||"").trim()||null,g=y=>u.some(L=>L.id===y);d&&g(d)?e.busStopId=d:(!e.busStopId||!g(e.busStopId))&&(e.busStopId=u[0]?.id||null),e.deferInitialStopContext&&(e.deferInitialStopContext=!1,e.deferredBusStopId=null,e.deferredBusLineFilters=[],e.deferredBusDestinationFilters=[],e.busLineFilters=[],e.busDestinationFilters=[]),e.hasCompletedInitialStopModeLoad=!0;let S=Array.isArray(r?.station?.departures)?r.station.departures:[];e.busFilterOptions=w(S),n.sanitizeStopSelections()}function m(r,u){let d=new Error(u);return d.code=r,d}function C(r){return String(r?.code||"").trim().toLowerCase()}function v(){return n.uniqueNonEmptyStrings(["fi-FI","en-US",...Array.isArray(navigator.languages)?navigator.languages:[],navigator.language])}function N(){return typeof window.SpeechRecognition=="function"?window.SpeechRecognition:typeof window.webkitSpeechRecognition=="function"?window.webkitSpeechRecognition:null}function O(){return!!N()}function P(r){return r==="not-allowed"||r==="service-not-allowed"?m("voice_permission_denied","Microphone permission denied."):r==="audio-capture"?m("voice_no_microphone","No microphone available."):r==="language-not-supported"?m("voice_language_not_supported","Speech language is not supported."):r==="network"?m("voice_recognition_network","Voice recognition network error."):r==="no-speech"?m("voice_no_speech","No speech detected."):m("voice_not_understood","Voice recognition failed.")}function D(r){let u=N();return u?new Promise((d,g)=>{let S=new u,y=String(r||navigator.language||"fi-FI").trim();S.lang=y||"fi-FI",S.continuous=!1,S.interimResults=!0,S.maxAlternatives=1;let L=!1,o="",c=null,I=!1,M=()=>{clearTimeout(c),c=null},i=()=>{if(!(I||L)){I=!0;try{S.stop()}catch{}}},s=()=>{M(),c=setTimeout(i,A.VOICE_SILENCE_STOP_MS)},a=()=>{clearTimeout(b),M(),S.onresult=null,S.onerror=null,S.onend=null,S.onspeechend=null,S.onsoundend=null,S.onaudioend=null,S.onnomatch=null},p=(E,T)=>{L||(L=!0,a(),E(T))},b=setTimeout(()=>{try{S.abort()}catch{}p(g,m("voice_recognition_timeout","Voice recognition timed out."))},A.VOICE_RECOGNITION_TIMEOUT_MS);S.onresult=E=>{for(let T=E?.resultIndex||0;T<(E?.results?.length||0);T+=1){let J=E.results[T],Q=String(J?.[0]?.transcript||"").trim();if(Q&&(o=Q,s(),J?.isFinal)){i();return}}},S.onerror=E=>{let T=String(E?.error||"").trim().toLowerCase();p(g,P(T))},S.onend=()=>{if(L)return;let E=String(o||"").trim();if(!E){p(g,m("voice_no_speech","No speech detected."));return}p(d,E)},S.onspeechend=()=>{i()},S.onsoundend=()=>{s()},S.onaudioend=()=>{s()},S.onnomatch=()=>{p(g,m("voice_not_understood","Could not understand speech."))};try{S.start()}catch(E){let T=String(E?.name||"").trim().toLowerCase();if(T==="notallowederror"||T==="securityerror"){p(g,m("voice_permission_denied","Microphone permission denied."));return}p(g,m("voice_not_understood","Unable to start voice recognition."))}}):Promise.reject(m("voice_unsupported","Voice recognition not supported."))}function B(r){return r==="voice_no_speech"||r==="voice_not_understood"||r==="voice_recognition_timeout"||r==="voice_language_not_supported"}async function X(){let r=v(),u=null;for(let d of r)try{return await D(d)}catch(g){if(u=g,!B(C(g)))break}throw u||m("voice_not_understood","Voice recognition failed.")}function Z(r){return Array.isArray(r)?r.map(u=>{let d=Number(u?.lat),g=Number(u?.lon);return!Number.isFinite(d)||!Number.isFinite(g)?null:{lat:d,lon:g,label:String(u?.label||"").trim()}}).filter(Boolean):[]}function Y(){t.voiceLocationChoicesEl&&t.voiceLocationChoicesEl.classList.add("hidden"),t.voiceLocationChoicesTitleEl&&(t.voiceLocationChoicesTitleEl.textContent=""),t.voiceLocationChoicesOptionsEl&&(t.voiceLocationChoicesOptionsEl.innerHTML=""),t.voiceLocationChoicesCancelEl&&(t.voiceLocationChoicesCancelEl.onclick=null)}function q(r,u){if(typeof window.prompt!="function")throw m("voice_location_selection_cancelled","Location selection was cancelled.");let d=u.map((y,L)=>`${L+1}. ${y.label||`${y.lat}, ${y.lon}`}`).join(`
`),g=window.prompt(`Multiple matches found for "${n.safeString(r,80)}". Select number:
${d}`,"1");if(g==null)throw m("voice_location_selection_cancelled","Location selection was cancelled.");let S=Number.parseInt(String(g).trim(),10);if(!Number.isInteger(S)||S<1||S>u.length)throw m("voice_location_selection_invalid","Invalid location selection.");return u[S-1]}async function H(r,u){if(!Array.isArray(u)||u.length===0)throw m("voice_location_not_found","No matching location found.");return!t.voiceLocationChoicesEl||!t.voiceLocationChoicesTitleEl||!t.voiceLocationChoicesOptionsEl||!t.voiceLocationChoicesCancelEl?q(r,u):new Promise((d,g)=>{let S=!1,y=(L,o)=>{S||(S=!0,Y(),L(o))};t.voiceLocationChoicesTitleEl.textContent=`Multiple matches for "${n.safeString(r,80)}". Choose one:`,n.setStatus("Multiple matches found. Choose one below."),t.voiceLocationChoicesOptionsEl.innerHTML="";for(let L of u){let o=document.createElement("button");o.type="button",o.className="voice-location-choice-option",o.textContent=L.label||`${L.lat.toFixed(5)}, ${L.lon.toFixed(5)}`,o.addEventListener("click",()=>y(d,L),{once:!0}),t.voiceLocationChoicesOptionsEl.appendChild(o)}t.voiceLocationChoicesCancelEl.onclick=()=>y(g,m("voice_location_selection_cancelled","Location selection was cancelled.")),t.voiceLocationChoicesEl.classList.remove("hidden")})}async function ee(r){let u=String(r||"").trim();if(u.length<A.VOICE_QUERY_MIN_LENGTH)throw m("voice_query_too_short","Voice query too short.");let d=new URLSearchParams({text:u});e.currentCoords&&(d.set("lat",String(e.currentCoords.lat)),d.set("lon",String(e.currentCoords.lon)));let g=Array.isArray(navigator.languages)&&navigator.languages[0]||navigator.language||"";g&&d.set("lang",String(g));let S;try{S=await f(`/api/v1/geocode?${d.toString()}`)}catch{throw m("voice_geocode_failed","Location lookup failed.")}if(!(S.headers.get("content-type")||"").includes("application/json"))throw m("voice_geocode_failed","Unexpected location lookup response.");let L=await S.json();if(!S.ok)throw m("voice_geocode_failed",String(L?.error||"Location lookup failed.").trim());let o=Z(L?.choices);if(L?.ambiguous&&o.length>1){let M=await H(u,o);return{lat:M.lat,lon:M.lon,label:M.label,query:u}}let c=Number(L?.location?.lat),I=Number(L?.location?.lon);if(!Number.isFinite(c)||!Number.isFinite(I))throw m("voice_location_not_found","No matching location found.");return{lat:c,lon:I,label:String(L?.location?.label||"").trim(),query:u}}function te(r){return r==="voice_unsupported"||r==="voice_no_speech"||r==="voice_recognition_timeout"||r==="voice_recognition_network"||r==="voice_not_understood"}function K(r){if(!te(r)||typeof window.prompt!="function")return null;let u=r==="voice_unsupported"?"Voice input is limited in this browser. Type your location instead:":"Could not capture your voice on this device. Type your location:",d=window.prompt(`${u}
Example: Kamppi Helsinki`,"");return String(d||"").trim()||null}async function j(r){let u=String(r||"").trim();Y(),n.setStatus(`Looking up "${n.safeString(u,80)}"...`);let d=await ee(u);return n.setResolvedLocationHint({query:u,label:d.label,lat:d.lat,lon:d.lon}),e.currentCoords={lat:d.lat,lon:d.lon},n.setPermissionRequired(!1),await $(d.lat,d.lon),!0}async function z(){if(e.isLoading||e.isVoiceListening)return!1;Y(),n.setVoiceListening(!0),n.setStatus("Listening... speak now, then pause.");try{if(!O()){let u=m("voice_unsupported","Voice recognition not supported."),d=K(C(u));return d?j(d):(n.setStatus(n.getVoiceLocationErrorStatus(u)),!1)}let r=await X();return j(r)}catch(r){let u=C(r),d=K(u);if(d)try{return await j(d)}catch(g){return console.error("voice fallback location error:",g),n.reportClientError("voice-location-fallback",g,{mode:e.mode,sourceCode:u||"unknown"}),n.setStatus(n.getVoiceLocationErrorStatus(g)),!1}return(!u||u==="unknown")&&console.error("voice location error:",r),n.reportClientError("voice-location",r,{mode:e.mode,code:u||"unknown"}),n.setStatus(n.getVoiceLocationErrorStatus(r)),!1}finally{n.setVoiceListening(!1)}}async function $(r,u){let d=++e.latestLoadToken,g=e.mode,S=e.busStopId,y=h(g)&&!e.hasCompletedInitialStopModeLoad;n.setLoading(!0),n.setStatus("Loading departures...");try{let L=new URLSearchParams({lat:String(r),lon:String(u),mode:g.toUpperCase(),results:String(n.getActiveResultsLimit(g))}),o=h(g)&&(e.deferInitialStopContext||!e.hasCompletedInitialStopModeLoad);h(g)&&S&&!o&&L.set("stopId",S);let c=await f(`/api/v1/departures?${L.toString()}`);if(!(c.headers.get("content-type")||"").includes("application/json"))throw c.ok?new Error("Unexpected server response."):new Error("Request failed");let M=await c.json();if(!c.ok)throw new Error(M.error||"Request failed");if(d!==e.latestLoadToken)return;h(g)&&(k(M),n.persistUiState(),y&&n.trackInitialNearestStopResolved(M,g)),e.latestResponse=M,n.render(M),n.setPermissionRequired(!1),n.setLastUpdated(new Date),n.setStatus(n.buildStatusFromResponse(M)),n.trackFirstSuccessfulRender(M,g)}catch(L){if(d!==e.latestLoadToken)return;e.latestResponse=null,console.error("load departures error:",L),n.reportClientError("load",L,{mode:g}),n.setStatus(n.getLoadErrorStatus(L)),t.resultEl.classList.add("hidden"),n.updateNextSummary(null)}finally{d===e.latestLoadToken&&n.setLoading(!1)}}function G(){return Y(),n.setResolvedLocationHint(null),navigator.geolocation?e.isLoading||e.isVoiceListening?!1:(n.setStatus("Getting your location..."),n.setLoading(!0),navigator.geolocation.getCurrentPosition(r=>{e.currentCoords={lat:r.coords.latitude,lon:r.coords.longitude},e.locationGranted=!0,n.setStorageItem("location:granted","1"),n.setPermissionRequired(!1),n.setLoading(!1),$(e.currentCoords.lat,e.currentCoords.lon)},r=>{if(n.setLoading(!1),r.code===1){n.setPermissionRequired(!0),n.setStatus(n.getGeolocationErrorStatus(r)),e.latestResponse=null,t.resultEl.classList.add("hidden"),n.updateNextSummary(null);return}n.setPermissionRequired(!1),n.setStatus(n.getGeolocationErrorStatus(r)),e.latestResponse=null,t.resultEl.classList.add("hidden"),n.updateNextSummary(null)},{enableHighAccuracy:!1,timeout:1e4,maximumAge:0}),!0):(n.setStatus("Geolocation not supported in this browser."),n.setPermissionRequired(!0),!1)}function V(){if(!e.isVoiceListening){if(e.currentCoords){$(e.currentCoords.lat,e.currentCoords.lon);return}G()}}function W(){n.updateModeButtons(),n.updateModeLabels(),n.renderResultsLimitControl(),n.updateHelsinkiFilterButton(),n.renderStopControls(),n.updateDataScope(e.latestResponse)}Object.assign(n,{delay:R,fetchWithTimeout:U,fetchWithRetryOnce:f,updateStopModeStateFromResponse:k,buildFilterOptionsFromDepartures:w,load:$,requestLocationAndLoad:G,requestVoiceLocationAndLoad:z,supportsVoiceLocation:O,captureVoiceQuery:D,captureVoiceQueryWithRetry:X,getVoiceRecognitionLanguages:v,shouldRetryVoiceRecognition:B,resolveVoiceLocationQuery:ee,refreshDeparturesOnly:V,applyModeUiState:W})})();(()=>{let x=window.HMApp,{api:n,dom:t,state:e,constants:A}=x,{MODE_RAIL:F,MODE_TRAM:_,MODE_METRO:l,MODE_BUS:h}=A;function R(){if(e.currentCoords){n.load(e.currentCoords.lat,e.currentCoords.lon);return}n.requestLocationAndLoad()}t.locateBtn?.addEventListener("click",()=>{n.trackFirstManualInteraction("refresh_location_click"),n.requestLocationAndLoad()}),t.voiceLocateBtn?.addEventListener("click",()=>{n.trackFirstManualInteraction("voice_location_click"),n.requestVoiceLocationAndLoad()}),t.modeRailBtn?.addEventListener("click",()=>{e.mode!==F&&(n.trackFirstManualInteraction("mode_change",{toMode:F}),e.mode=F,n.applyModeUiState(),n.persistUiState(),R())}),t.modeTramBtn?.addEventListener("click",()=>{e.mode!==_&&(n.trackFirstManualInteraction("mode_change",{toMode:_}),e.mode=_,e.helsinkiOnly=!1,n.applyModeUiState(),n.persistUiState(),R())}),t.modeMetroBtn?.addEventListener("click",()=>{e.mode!==l&&(n.trackFirstManualInteraction("mode_change",{toMode:l}),e.mode=l,e.helsinkiOnly=!1,n.applyModeUiState(),n.persistUiState(),R())}),t.modeBusBtn?.addEventListener("click",()=>{e.mode!==h&&(n.trackFirstManualInteraction("mode_change",{toMode:h}),e.mode=h,e.helsinkiOnly=!1,n.applyModeUiState(),n.persistUiState(),R())}),t.resultsLimitSelectEl?.addEventListener("click",f=>{f.stopPropagation(),n.toggleResultsLimitDropdown()}),document.addEventListener("click",f=>{t.resultsLimitSelectWrapEl&&(t.resultsLimitSelectWrapEl.contains(f.target)||n.toggleResultsLimitDropdown(!1))}),t.resultsLimitSelectEl?.addEventListener("keydown",f=>{let w=t.resultsLimitSelectListEl;if(!w)return;let k=t.resultsLimitSelectEl.getAttribute("aria-expanded")==="true";if(f.key==="Escape"){n.toggleResultsLimitDropdown(!1),t.resultsLimitSelectEl.focus(),f.preventDefault();return}if(f.key==="Enter"||f.key===" "){if(!k){n.toggleResultsLimitDropdown(!0),f.preventDefault();return}let m=w.querySelector(".is-focused");m?.dataset?.value&&n.selectResultsLimit(m.dataset.value),f.preventDefault();return}if(f.key==="ArrowDown"||f.key==="ArrowUp"){if(f.preventDefault(),!k){n.toggleResultsLimitDropdown(!0);return}let m=[...w.querySelectorAll("li[role='option']")];if(m.length===0)return;let C=m.findIndex(N=>N.classList.contains("is-focused")),v;f.key==="ArrowDown"?v=C<m.length-1?C+1:0:v=C>0?C-1:m.length-1;for(let N of m)N.classList.remove("is-focused");m[v].classList.add("is-focused"),m[v].scrollIntoView({block:"nearest"})}}),t.busStopSelectEl?.addEventListener("click",f=>{f.stopPropagation(),n.toggleStopDropdown()}),document.addEventListener("click",f=>{t.busStopSelectWrapEl&&(t.busStopSelectWrapEl.contains(f.target)||n.toggleStopDropdown(!1))}),t.busStopSelectEl?.addEventListener("keydown",f=>{let w=t.busStopSelectListEl;if(!w)return;let k=t.busStopSelectEl.getAttribute("aria-expanded")==="true";if(f.key==="Escape"){n.toggleStopDropdown(!1),t.busStopSelectEl.focus(),f.preventDefault();return}if(f.key==="Enter"||f.key===" "){if(!k){n.toggleStopDropdown(!0),f.preventDefault();return}let m=w.querySelector(".is-focused");m?.dataset?.value&&n.selectStop(m.dataset.value),f.preventDefault();return}if(f.key==="ArrowDown"||f.key==="ArrowUp"){if(f.preventDefault(),!k){n.toggleStopDropdown(!0);return}let m=[...w.querySelectorAll("li[role='option']")];if(m.length===0)return;let C=m.findIndex(N=>N.classList.contains("is-focused")),v;f.key==="ArrowDown"?v=C<m.length-1?C+1:0:v=C>0?C-1:m.length-1;for(let N of m)N.classList.remove("is-focused");m[v].classList.add("is-focused"),m[v].scrollIntoView({block:"nearest"})}}),t.stopFiltersToggleBtnEl?.addEventListener("click",()=>{n.trackFirstManualInteraction("stop_filters_panel_toggle",{currentMode:e.mode}),n.toggleStopFiltersPanel()}),t.helsinkiOnlyBtn?.addEventListener("click",()=>{e.mode===F&&(n.trackFirstManualInteraction("helsinki_only_toggle"),e.helsinkiOnly=!e.helsinkiOnly,n.persistUiState(),n.updateHelsinkiFilterButton(),e.latestResponse&&(n.render(e.latestResponse),n.setStatus(n.buildStatusFromResponse(e.latestResponse))))}),t.locationPromptAllowEl?.addEventListener("click",()=>{n.hideLocationPrompt(),n.requestLocationAndLoad()}),t.permissionRetryBtnEl?.addEventListener("click",()=>{n.trackFirstManualInteraction("permission_retry_click"),n.requestLocationAndLoad()}),n.hydrateInitialState(),n.applyModeUiState(),n.updateClock(),setInterval(n.updateClock,1e3),n.getStorageItem("location:granted")==="1"?n.requestLocationAndLoad():(n.showLocationPrompt(),n.setStatus("Tap Allow Location to get started.")),setInterval(n.refreshDeparturesOnly,3e4),window.addEventListener("error",f=>{n.reportClientError("error",f.error||f.message||"Unknown error",{source:f.filename||"",line:f.lineno||null,column:f.colno||null})}),window.addEventListener("unhandledrejection",f=>{n.reportClientError("unhandledrejection",f.reason||"Unhandled promise rejection")}),(()=>{let f=document.getElementById("themeToggle");if(!f)return;let w=document.documentElement,k=window.matchMedia("(prefers-color-scheme: dark)"),m=()=>{let O=n.getStorageItem("theme");return O==="dark"||O==="light"?O:null},C=O=>{w.setAttribute("data-theme",O==="light"?"light":"dark")},v=()=>{let O=m();if(O){C(O);return}C(k.matches?"dark":"light")},N=O=>{m()||C(O.matches?"dark":"light")};v(),typeof k.addEventListener=="function"?k.addEventListener("change",N):typeof k.addListener=="function"&&k.addListener(N),f.addEventListener("click",()=>{let O=w.getAttribute("data-theme")==="dark"?"light":"dark";C(O),n.setStorageItem("theme",O)})})()})();})();
