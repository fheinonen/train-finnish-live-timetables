(()=>{(()=>{let k=window.HMApp||(window.HMApp={}),s=k.api||={};k.dom={locateBtn:document.getElementById("locateBtn"),voiceLocateBtn:document.getElementById("voiceLocateBtn"),voiceLocateBtnLabel:document.getElementById("voiceLocateBtnLabel"),skeletonEl:document.getElementById("skeleton"),segmentControlEl:document.querySelector(".segment-control"),modeRailBtn:document.getElementById("modeRailBtn"),modeTramBtn:document.getElementById("modeTramBtn"),modeMetroBtn:document.getElementById("modeMetroBtn"),modeBusBtn:document.getElementById("modeBusBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busStopSelectLabelEl:document.getElementById("busStopSelectLabel"),busStopSelectListEl:document.getElementById("busStopSelectList"),busStopSelectWrapEl:document.getElementById("busStopSelectWrap"),busStopFiltersEl:document.getElementById("busStopFilters"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),stopFiltersToggleBtnEl:document.getElementById("stopFiltersToggleBtn"),stopFiltersPanelEl:document.getElementById("stopFiltersPanel"),stopFilterSummaryEl:document.getElementById("stopFilterSummary"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),resultsLimitSelectLabelEl:document.getElementById("resultsLimitSelectLabel"),resultsLimitSelectListEl:document.getElementById("resultsLimitSelectList"),resultsLimitSelectWrapEl:document.getElementById("resultsLimitSelectWrap"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),resolvedLocationEl:document.getElementById("resolvedLocation"),voiceLocationChoicesEl:document.getElementById("voiceLocationChoices"),voiceLocationChoicesTitleEl:document.getElementById("voiceLocationChoicesTitle"),voiceLocationChoicesOptionsEl:document.getElementById("voiceLocationChoicesOptions"),voiceLocationChoicesCancelEl:document.getElementById("voiceLocationChoicesCancel"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),locationPromptCardEl:document.getElementById("locationPromptCard"),locationPromptAllowEl:document.getElementById("locationPromptAllow"),permissionCardEl:document.getElementById("permissionCard"),permissionRetryBtnEl:document.getElementById("permissionRetryBtn"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},k.constants={MODE_RAIL:"rail",MODE_TRAM:"tram",MODE_METRO:"metro",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_TRAM_KEY:"prefs:resultsLimitTram",STORAGE_RESULTS_LIMIT_METRO_KEY:"prefs:resultsLimitMetro",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_TRAM:8,DEFAULT_RESULTS_LIMIT_METRO:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],VOICE_RECOGNITION_TIMEOUT_MS:8e3,VOICE_SILENCE_STOP_MS:1200,VOICE_QUERY_MIN_LENGTH:3,FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5,METRIC_REPORT_LIMIT:10,METRIC_SAMPLE_RATE:1};let{MODE_RAIL:n,MODE_TRAM:e,MODE_METRO:O,MODE_BUS:P}=k.constants;k.state={locationGranted:!1,isLoading:!1,isVoiceListening:!1,currentCoords:null,latestResponse:null,mode:n,busStopId:null,busStopMemberFilterId:null,busLineFilters:[],busDestinationFilters:[],stopFilterPinned:!1,stopFiltersPanelOpen:!1,stopFiltersPanelLockUntilMs:0,deferInitialStopContext:!1,deferredBusStopId:null,deferredBusLineFilters:[],deferredBusDestinationFilters:[],resultsLimitByMode:{[n]:k.constants.DEFAULT_RESULTS_LIMIT_RAIL,[e]:k.constants.DEFAULT_RESULTS_LIMIT_TRAM,[O]:k.constants.DEFAULT_RESULTS_LIMIT_METRO,[P]:k.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},resolvedLocationHint:null,suppressBusStopChange:!1,hasCompletedInitialStopModeLoad:!1,errorReportCount:0,metricReportCount:0,isMetricSessionSampled:Math.random()<k.constants.METRIC_SAMPLE_RATE,sessionStartedAtMs:Date.now(),hasReportedFirstSuccessfulRenderMetric:!1,hasReportedFirstManualInteractionMetric:!1,hasReportedFirstManualStopContextMetric:!1,hasReportedInitialNearestStopResolvedMetric:!1,latestLoadToken:0};let{dom:y,state:u,constants:T}=k;function q(){let o=u.isLoading||u.isVoiceListening,c=u.isLoading;y.locateBtn&&(y.locateBtn.disabled=o),y.voiceLocateBtn&&(y.voiceLocateBtn.disabled=c,y.voiceLocateBtn.classList.toggle("is-listening",u.isVoiceListening),y.voiceLocateBtn.setAttribute("aria-pressed",String(u.isVoiceListening))),y.voiceLocateBtnLabel&&(y.voiceLocateBtnLabel.textContent=u.isVoiceListening?"Listening...":"Describe Location")}function J(o){u.isLoading=o,q(),y.skeletonEl&&y.skeletonEl.classList.toggle("hidden",!o)}function G(o){u.isVoiceListening=!!o,q()}function nt(o){y.statusEl&&(y.statusEl.textContent=o)}function S(o){let c=Number(o);return Number.isFinite(c)?c.toFixed(5):null}function w(o){let c=o&&typeof o=="object";if(u.resolvedLocationHint=c?{query:B(o.query,120).trim(),label:B(o.label,180).trim(),lat:Number(o.lat),lon:Number(o.lon)}:null,!y.resolvedLocationEl)return;if(!u.resolvedLocationHint){y.resolvedLocationEl.classList.add("hidden"),y.resolvedLocationEl.textContent="";return}let b=u.resolvedLocationHint.label||"Unknown place",h=u.resolvedLocationHint.query,M=S(u.resolvedLocationHint.lat),x=S(u.resolvedLocationHint.lon),U=h?` (from "${h}")`:"",tt=M&&x?` - ${M}, ${x}`:"";y.resolvedLocationEl.textContent=`Resolved location: ${b}${U}${tt}`,y.resolvedLocationEl.classList.remove("hidden")}function f(){y.locationPromptCardEl&&y.locationPromptCardEl.classList.remove("hidden"),y.permissionCardEl&&y.permissionCardEl.classList.add("hidden")}function I(){y.locationPromptCardEl&&y.locationPromptCardEl.classList.add("hidden")}function F(o){I(),y.permissionCardEl&&y.permissionCardEl.classList.toggle("hidden",!o)}function A(o){!y.lastUpdatedEl||!(o instanceof Date)||(y.lastUpdatedEl.textContent=`Last updated: ${o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function R(o){try{return window.localStorage.getItem(o)}catch{return null}}function v(o,c){try{window.localStorage.setItem(o,c)}catch{}}function B(o,c){let b=String(o||"");return b.length<=c?b:b.slice(0,c)}function st(o){if(o instanceof Error)return o;try{let c=typeof o=="string"?o:JSON.stringify(o);return new Error(c||"Unknown error")}catch{return new Error(String(o||"Unknown error"))}}function ot(o){let c=JSON.stringify(o);if(navigator.sendBeacon){let b=new Blob([c],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",b);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:c,keepalive:!0}).catch(()=>{})}function ut(o,c,b=null){if(u.errorReportCount>=T.ERROR_REPORT_LIMIT)return;u.errorReportCount+=1;let h=st(c),M={type:B(o,40),message:B(h.message,400),stack:B(h.stack||"",1200),url:B(window.location.href,500),userAgent:B(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:b&&typeof b=="object"?b:null};ot(M)}function Q(){return Math.max(0,Date.now()-u.sessionStartedAtMs)}function X(o,c=null){if(!u.isMetricSessionSampled||u.metricReportCount>=T.METRIC_REPORT_LIMIT)return!1;u.metricReportCount+=1;let b={type:"metric",message:B(o,400),stack:"",url:B(window.location.href,500),userAgent:B(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:{metricName:B(o,80),sessionElapsedMs:Q(),mode:u.mode,...c&&typeof c=="object"?c:{}}};return ot(b),!0}function ft(o,c){if(u.hasReportedFirstSuccessfulRenderMetric)return;u.hasReportedFirstSuccessfulRenderMetric=!0;let b=Array.isArray(o?.station?.departures)?o.station.departures:[];X("first_successful_render",{requestMode:String(c||"").trim(),hasStation:!!o?.station,departureCount:b.length})}function lt(o,c=null){u.hasReportedFirstManualInteractionMetric||(u.hasReportedFirstManualInteractionMetric=!0,X("first_manual_interaction",{interactionType:B(o,80),...c&&typeof c=="object"?c:{}}))}function Z(o,c=null){u.hasReportedFirstManualStopContextMetric||(u.hasReportedFirstManualStopContextMetric=!0,X("first_manual_stop_context_change",{changeType:B(o,80),lineFilterCount:u.busLineFilters.length,destinationFilterCount:u.busDestinationFilters.length,...c&&typeof c=="object"?c:{}}))}function it(o,c){if(u.hasReportedInitialNearestStopResolvedMetric)return;let b=String(o?.selectedStopId||"").trim();if(!b)return;u.hasReportedInitialNearestStopResolvedMetric=!0;let M=(Array.isArray(o?.stops)?o.stops:[]).find(U=>U?.id===b)||null,x=Array.isArray(o?.station?.departures)?o.station.departures:[];X("initial_nearest_stop_resolved",{requestMode:String(c||"").trim(),selectedStopId:b,distanceMeters:Number(M?.distanceMeters)||null,departureCount:x.length})}function Y(o){if(!o)return null;let c=String(o).trim().toLowerCase();return c===n||c===e||c===O||c===P?c:null}function St(o){if(o==null)return null;let c=String(o).trim().toLowerCase();return["1","true","yes","on"].includes(c)?!0:["0","false","no","off"].includes(c)?!1:null}function j(o){return Array.isArray(o)?[...new Set(o.map(c=>String(c||"").trim()).filter(Boolean))]:[]}function H(o){if(o==null||o==="")return null;let c=Number(o);return!Number.isInteger(c)||!T.RESULT_LIMIT_OPTIONS.includes(c)?null:c}function at(o=u.mode){return o===P?T.DEFAULT_RESULTS_LIMIT_BUS:o===O?T.DEFAULT_RESULTS_LIMIT_METRO:o===e?T.DEFAULT_RESULTS_LIMIT_TRAM:T.DEFAULT_RESULTS_LIMIT_RAIL}function V(o=u.mode){let c=H(u.resultsLimitByMode?.[o]);return c??at(o)}function a(o){let c=R(o);if(!c)return[];try{let b=JSON.parse(c);return j(b)}catch{return[]}}function d(){let o=new URLSearchParams(window.location.search);return{mode:Y(o.get("mode")),stopProvided:o.has("stop"),busStopId:o.get("stop")?o.get("stop").trim():null,linesProvided:o.has("line"),busLines:j(o.getAll("line")),destinationsProvided:o.has("dest"),busDestinations:j(o.getAll("dest")),resultsProvided:o.has("results"),resultsLimit:H(o.get("results"))}}function m(){let o=d(),c=Y(R(T.STORAGE_MODE_KEY));u.mode=o.mode||c||n;let b=String(R(T.STORAGE_BUS_STOP_KEY)||"").trim()||null,h=o.stopProvided?o.busStopId:b,M=a(T.STORAGE_BUS_LINES_KEY),x=a(T.STORAGE_BUS_DESTINATIONS_KEY),U=o.linesProvided?o.busLines:M,tt=o.destinationsProvided?o.busDestinations:x,$=!!h||U.length>0||tt.length>0;u.deferInitialStopContext=$,$?(u.deferredBusStopId=h,u.deferredBusLineFilters=[...U],u.deferredBusDestinationFilters=[...tt],u.busStopId=null,u.busLineFilters=[],u.busDestinationFilters=[]):(u.deferredBusStopId=null,u.deferredBusLineFilters=[],u.deferredBusDestinationFilters=[],u.busStopId=h,u.busLineFilters=U,u.busDestinationFilters=tt);let gt=H(R(T.STORAGE_RESULTS_LIMIT_RAIL_KEY)),N=H(R(T.STORAGE_RESULTS_LIMIT_TRAM_KEY)),D=H(R(T.STORAGE_RESULTS_LIMIT_METRO_KEY)),dt=H(R(T.STORAGE_RESULTS_LIMIT_BUS_KEY));u.resultsLimitByMode[n]=gt??T.DEFAULT_RESULTS_LIMIT_RAIL,u.resultsLimitByMode[e]=N??T.DEFAULT_RESULTS_LIMIT_TRAM,u.resultsLimitByMode[O]=D??T.DEFAULT_RESULTS_LIMIT_METRO,u.resultsLimitByMode[P]=dt??T.DEFAULT_RESULTS_LIMIT_BUS,o.resultsProvided&&o.resultsLimit!=null&&(u.resultsLimitByMode[u.mode]=o.resultsLimit)}function L(){v(T.STORAGE_MODE_KEY,u.mode),v(T.STORAGE_BUS_STOP_KEY,u.busStopId||""),v(T.STORAGE_BUS_LINES_KEY,JSON.stringify(u.busLineFilters)),v(T.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(u.busDestinationFilters)),v(T.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(V(n))),v(T.STORAGE_RESULTS_LIMIT_TRAM_KEY,String(V(e))),v(T.STORAGE_RESULTS_LIMIT_METRO_KEY,String(V(O))),v(T.STORAGE_RESULTS_LIMIT_BUS_KEY,String(V(P)))}function g(){let o=new URLSearchParams(window.location.search);u.mode===n?o.delete("mode"):o.set("mode",u.mode);let c=V(),b=at();if(c===b?o.delete("results"):o.set("results",String(c)),o.delete("stop"),o.delete("line"),o.delete("dest"),u.mode===P||u.mode===e||u.mode===O||u.mode===n){u.busStopId&&o.set("stop",u.busStopId);for(let x of u.busLineFilters)o.append("line",x);for(let x of u.busDestinationFilters)o.append("dest",x)}let h=o.toString(),M=`${window.location.pathname}${h?`?${h}`:""}${window.location.hash}`;window.history.replaceState(null,"",M)}function _(){L(),g()}q(),Object.assign(s,{updateLocationActionButtons:q,setLoading:J,setVoiceListening:G,setStatus:nt,setResolvedLocationHint:w,showLocationPrompt:f,hideLocationPrompt:I,setPermissionRequired:F,setLastUpdated:A,getStorageItem:R,setStorageItem:v,safeString:B,toError:st,sendClientReport:ot,reportClientError:ut,reportClientMetric:X,getSessionElapsedMs:Q,trackFirstSuccessfulRender:ft,trackFirstManualInteraction:lt,trackFirstManualStopContextChange:Z,trackInitialNearestStopResolved:it,normalizeMode:Y,parseBoolean:St,uniqueNonEmptyStrings:j,parseResultLimit:H,getDefaultResultsLimit:at,getActiveResultsLimit:V,parseStoredArray:a,readStateFromUrl:d,hydrateInitialState:m,syncStateToStorage:L,syncStateToUrl:g,persistUiState:_})})();(()=>{let k=window.HMApp,{api:s,dom:n,state:e,constants:O}=k,{MODE_RAIL:P,MODE_TRAM:y,MODE_METRO:u,MODE_BUS:T}=O,q=1500,J=q+200,G=14,nt=1300,S=null,w=null;function f(t=e.mode){return t===T||t===y||t===u||t===P}function I(t=e.mode){return t===P?{singular:"train",plural:"trains",title:"Rail"}:t===y?{singular:"tram",plural:"trams",title:"Tram"}:t===u?{singular:"metro",plural:"metros",title:"Metro"}:{singular:"bus",plural:"buses",title:"Bus"}}function F(t){let i=A(t);return i<=0?"Now":`${i}m`}function A(t){let i=new Date(t);return Math.floor((i.getTime()-Date.now())/6e4)}function R(t){let i=A(t);return i<=0||i<3?"departure-now":i<=10?"departure-soon":"departure-later"}function v(){let t=new Set((e.busFilterOptions.lines||[]).map(r=>r.value)),i=new Set((e.busFilterOptions.destinations||[]).map(r=>r.value));e.busLineFilters=e.busLineFilters.filter(r=>t.has(r)),e.busDestinationFilters=e.busDestinationFilters.filter(r=>i.has(r))}function B(t){if(!Array.isArray(t))return[];if(!f())return t;let i=new Set(e.busLineFilters),r=new Set(e.busDestinationFilters),l=String(e.busStopMemberFilterId||"").trim();return t.filter(p=>{if(i.size===0)return!0;let E=String(p?.line||"").trim();return i.has(E)}).filter(p=>{if(r.size===0)return!0;let E=String(p?.destination||"").trim();return r.has(E)}).filter(p=>l?String(p?.stopId||"").trim()===l:!0)}function st(){let t=[{el:n.modeRailBtn,mode:P,index:0},{el:n.modeTramBtn,mode:y,index:1},{el:n.modeMetroBtn,mode:u,index:2},{el:n.modeBusBtn,mode:T,index:3}];for(let{el:i,mode:r,index:l}of t){if(!i)continue;let p=e.mode===r;if(i.setAttribute("aria-checked",String(p)),i.classList.toggle("is-active",p),p){let E=i.closest(".segment-control");E&&E.style.setProperty("--active-index",l)}}}function ot(){let t=f()?I().title:"Rail",i="";n.modeEyebrowEl&&(n.modeEyebrowEl.textContent=`Helsinki Moves \u2022 ${t}`),n.nextLabelEl&&(n.nextLabelEl.textContent=i)}function ut(t){if(!n.resultsLimitSelectEl||!n.resultsLimitSelectListEl)return;let i=n.resultsLimitSelectEl.getAttribute("aria-expanded")==="true",r=typeof t=="boolean"?t:!i;n.resultsLimitSelectEl.setAttribute("aria-expanded",String(r)),n.resultsLimitSelectListEl.classList.toggle("hidden",!r)}function Q(t){let i=s.parseResultLimit(t);i==null||(ut(!1),s.getActiveResultsLimit()===i)||(s.trackFirstManualInteraction("results_limit_change",{nextLimit:i,currentMode:e.mode}),e.resultsLimitByMode[e.mode]=i,s.persistUiState(),n.resultsLimitSelectLabelEl&&(n.resultsLimitSelectLabelEl.textContent=String(i)),e.currentCoords?s.load(e.currentCoords.lat,e.currentCoords.lon):s.requestLocationAndLoad())}function X(){if(!n.resultsLimitSelectListEl)return;let t=Array.isArray(O.RESULT_LIMIT_OPTIONS)?O.RESULT_LIMIT_OPTIONS:[],i=s.getActiveResultsLimit();n.resultsLimitSelectListEl.innerHTML="";for(let r of t){let l=document.createElement("li");l.setAttribute("role","option"),l.dataset.value=String(r),l.textContent=String(r),r===i&&l.setAttribute("aria-selected","true"),l.addEventListener("click",()=>Q(String(r))),n.resultsLimitSelectListEl.appendChild(l)}n.resultsLimitSelectLabelEl&&(n.resultsLimitSelectLabelEl.textContent=String(i))}function ft(){let t=Z()?1:0;return Math.max(0,e.busLineFilters.length)+Math.max(0,e.busDestinationFilters.length)+t}function lt(t=e.busLineFilters.length,i=e.busDestinationFilters.length,r=Z()){let l=Math.max(0,Number(t)||0)+Math.max(0,Number(i)||0)+(r?1:0);return l===0?"No filters":l===1?"1 filter":`${l} filters`}function Z(){return f()?!!(e.stopFilterPinned||String(e.busStopMemberFilterId||"").trim()):!1}function it(){n.stopFilterSummaryEl?.classList?.remove?.("is-attention"),n.stopFiltersToggleBtnEl?.classList?.remove?.("is-attention")}function Y(){w&&(clearTimeout(w),w=null)}function St(){if(typeof window?.matchMedia=="function")try{if(window.matchMedia("(max-width: 679px)").matches)return!0}catch{}let t=Number(window?.innerWidth);return Number.isFinite(t)?t<=679:!1}function j(){if(St())return!1;let t=Array.isArray(e.busFilterOptions?.lines)?e.busFilterOptions.lines.length:0,i=Array.isArray(e.busFilterOptions?.destinations)?e.busFilterOptions.destinations.length:0;return t+i<=G}function H(){if(!f())return;!e.stopFiltersPanelOpen&&j()?(e.stopFiltersPanelLockUntilMs=Date.now()+q,a(!0),Y(),w=setTimeout(()=>{e.stopFiltersPanelLockUntilMs=0,a(!1),w=null},J)):e.stopFiltersPanelLockUntilMs=0,it(),n.stopFilterSummaryEl?.classList?.add?.("is-attention"),n.stopFiltersToggleBtnEl?.classList?.add?.("is-attention"),S&&(clearTimeout(S),S=null),S=setTimeout(()=>{it(),S=null},nt)}function at(){return Number(e.stopFiltersPanelLockUntilMs||0)>Date.now()}function V(){n.stopFilterSummaryEl&&(n.stopFilterSummaryEl.textContent=lt()),n.busStopSelectEl&&n.busStopSelectEl.classList.toggle("is-active-filter",Z()),!(!n.stopFiltersToggleBtnEl||!n.stopFiltersPanelEl)&&(n.stopFiltersToggleBtnEl.setAttribute("aria-expanded",String(!!e.stopFiltersPanelOpen)),n.stopFiltersPanelEl.classList.toggle("hidden",!e.stopFiltersPanelOpen))}function a(t){e.stopFiltersPanelOpen=!!t,V()}function d(t){if(Y(),(t===!1||t==null&&e.stopFiltersPanelOpen)&&at())return;let i=typeof t=="boolean"?t:!e.stopFiltersPanelOpen;a(i)}function m(t){n.busControlsEl&&(n.busControlsEl.classList.toggle("hidden",!t),t||(Y(),e.stopFiltersPanelOpen=!1,e.stopFiltersPanelLockUntilMs=0,it(),n.busStopSelectEl?.classList?.remove?.("is-active-filter")),V())}function L(){e.latestResponse&&(s.render(e.latestResponse),s.setStatus(s.buildStatusFromResponse(e.latestResponse)))}function g({interactionType:t,changeType:i,showAttention:r=!1,requireLoad:l=!1,extraContext:p=null}){if(s.trackFirstManualInteraction(t,{currentMode:e.mode,...p&&typeof p=="object"?p:{}}),s.trackFirstManualStopContextChange(i,p),s.persistUiState(),V(),r&&H(),l){e.currentCoords?s.load(e.currentCoords.lat,e.currentCoords.lon):s.requestLocationAndLoad();return}L()}function _(t,i){let r=String(i||"").trim();return r?t.includes(r)?t.filter(l=>l!==r):[...t,r]:t}function o(t,{interactionType:i="line_filter_toggle",changeType:r="line_filter_toggle",showAttention:l=!1}={}){if(!f())return!1;let p=_(e.busLineFilters,t);return p.length===e.busLineFilters.length?!1:(e.busLineFilters=p,g({interactionType:i,changeType:r,showAttention:l}),!0)}function c(t,{interactionType:i="destination_filter_toggle",changeType:r="destination_filter_toggle",showAttention:l=!1}={}){if(!f())return!1;let p=_(e.busDestinationFilters,t);return p.length===e.busDestinationFilters.length?!1:(e.busDestinationFilters=p,g({interactionType:i,changeType:r,showAttention:l}),!0)}function b(t){return e.busStops.find(i=>i.id===t)||null}function h(t){let i=s.uniqueNonEmptyStrings([...Array.isArray(t?.stopCodes)?t.stopCodes:[],t?.code]);return i.length===0&&t?.id&&i.push(String(t.id)),i}function M(t){return s.uniqueNonEmptyStrings([...Array.isArray(t?.memberStopIds)?t.memberStopIds:[],t?.id])}function x(t,i=null){let r=b(e.busStopId),l=String(i?.stopName||t?.stopName||r?.name||"").trim(),E=s.uniqueNonEmptyStrings([i?.stopCode,...Array.isArray(t?.stopCodes)?t.stopCodes:[],t?.stopCode,...h(r)])[0]||"";return l&&E?`${l} ${E}`:l||E||"\u2014"}function U(t,i=null){if(f())return x(t,i);let r=String(i?.stopName||t?.stopName||"").trim(),l=String(i?.stopCode||t?.stopCode||"").trim();return r&&l?`${r} ${l}`:r||l||"\u2014"}function tt(){if(n.dataScopeEl){if(typeof n.dataScopeEl.replaceChildren=="function"){n.dataScopeEl.replaceChildren();return}Array.isArray(n.dataScopeEl.children)&&(n.dataScopeEl.children.length=0),n.dataScopeEl.innerHTML=""}}function $(t,i="default"){let r=document.createElement("span");return r.className="data-scope-chip",i&&r.classList.add(`data-scope-chip--${i}`),r.textContent=t,r}function gt(t){let i=String(e.busStopMemberFilterId||"").trim();if(i){let E=(Array.isArray(t?.station?.departures)?t.station.departures:[]).find(K=>String(K?.stopId||"").trim()===i),C=String(E?.stopCode||"").trim();return C||i}if(!e.stopFilterPinned)return"";let r=b(e.busStopId),l=String(h(r)[0]||"").trim();return l||String(r?.name||e.busStopId||"").trim()}function N(t){if(!n.dataScopeEl)return;if(tt(),n.dataScopeEl.textContent="",!f()){n.dataScopeEl.classList.add("hidden");return}let i=[],r=gt(t);r&&i.push($(r,"stop"));for(let l of e.busLineFilters)i.push($(l,"line"));for(let l of e.busDestinationFilters)i.push($(l,"destination"));if(i.length===0){n.dataScopeEl.classList.add("hidden");return}for(let l of i)n.dataScopeEl.appendChild(l);n.dataScopeEl.classList.remove("hidden")}function D(t,i,r,l){if(!t)return;if(t.innerHTML="",!Array.isArray(i)||i.length===0){let E=document.createElement("span");E.className="chip-empty",E.textContent="No options",t.appendChild(E);return}let p=new Set(r);for(let E of i){let C=document.createElement("button");C.type="button",C.className="chip-toggle",p.has(E.value)?(C.classList.add("is-active"),C.setAttribute("aria-pressed","true")):C.setAttribute("aria-pressed","false"),C.textContent=`${E.value} (${E.count})`,C.addEventListener("click",()=>l(E.value)),t.appendChild(C)}}function dt(){let t=Array.isArray(e.latestResponse?.station?.departures)?e.latestResponse.station.departures:[],i=new Map;for(let r of t){let l=String(r?.stopId||"").trim();if(!l)continue;let p=i.get(l);p?(p.count+=1,p.stopCode||(p.stopCode=String(r?.stopCode||"").trim()),p.stopName||(p.stopName=String(r?.stopName||"").trim())):i.set(l,{id:l,count:1,stopCode:String(r?.stopCode||"").trim(),stopName:String(r?.stopName||"").trim()})}return[...i.values()].sort((r,l)=>l.count-r.count||r.id.localeCompare(l.id)).map(r=>{let l=Lt({stopId:r.id,stopCode:r.stopCode||"",stopName:r.stopName||""},e.latestResponse?.station||null);return{...r,selectableStopId:l.selectableStopId}})}function bt(){if(!n.busStopFiltersEl)return;n.busStopFiltersEl.innerHTML="";let t=dt();if(t.length===0){let r=document.createElement("span");r.className="chip-empty",r.textContent="No stops",n.busStopFiltersEl.appendChild(r);return}let i=String(e.busStopMemberFilterId||"").trim();for(let r of t){let l=document.createElement("button");l.type="button",l.className="chip-toggle",l.dataset.value=r.id,!!(i&&r.id===i)?(l.classList.add("is-active"),l.setAttribute("aria-pressed","true")):l.setAttribute("aria-pressed","false");let E=r.stopCode||r.id;l.textContent=E,l.addEventListener("click",()=>Tt(r.selectableStopId,r.id)),n.busStopFiltersEl.appendChild(l)}}function It(t){if(!n.busStopSelectEl||!n.busStopSelectListEl)return;let i=n.busStopSelectEl.getAttribute("aria-expanded")==="true",r=typeof t=="boolean"?t:!i;n.busStopSelectEl.setAttribute("aria-expanded",String(r)),n.busStopSelectListEl.classList.toggle("hidden",!r)}function Mt(t){if(!e.suppressBusStopChange){if(!t||t===e.busStopId){It(!1);return}if(e.busStopId=t,e.stopFilterPinned=!0,e.busStopMemberFilterId=null,It(!1),n.busStopSelectLabelEl){let i=e.busStops.find(r=>r.id===t);n.busStopSelectLabelEl.textContent=i?`${i.name} (${i.distanceMeters}m)`:t}g({interactionType:"stop_select",changeType:"stop_select",requireLoad:!0,extraContext:{selectedStopId:t}})}}function vt(){return e.busStops[0]?.id||null}function yt(t,i=null){let r=String(t||"").trim();if(!r||!e.stopFilterPinned||String(e.busStopId||"").trim()!==r)return!1;let p=String(e.busStopMemberFilterId||"").trim(),E=String(i||"").trim();return E?p===E:!p}function Tt(t,i=null){if(!f())return!1;let r=String(t||"").trim()||null,l=String(i||"").trim()||null,p=String(e.busStopId||"").trim()||null,E=String(e.busStopMemberFilterId||"").trim()||null,C=vt(),K=r||p||C;if(!K)return!1;let ct=!!e.stopFilterPinned,pt=yt(K,l),z=p,et=ct,rt=E;pt?(et=!1,rt=null,z=C||K):(z=K,et=!0,rt=l);let Et=z!==p;if(z===p&&et===ct&&rt===E)return!1;if(e.busStopId=z,e.stopFilterPinned=et,e.busStopMemberFilterId=rt,n.busStopSelectLabelEl){let mt=b(e.busStopId);n.busStopSelectLabelEl.textContent=mt?`${mt.name} (${mt.distanceMeters}m)`:"Nearest stop"}return g({interactionType:"result_card_stop_toggle",changeType:"result_card_stop_toggle",showAttention:!0,requireLoad:Et,extraContext:{selectedStopId:e.busStopId||"",selectedMemberStopId:e.busStopMemberFilterId||""}}),!0}function Lt(t,i=null){let r=String(t?.stopId||"").trim();if(r){let p=e.busStops.find(E=>M(E).includes(r));if(p?.id)return{selectableStopId:p.id,memberStopId:r}}let l=s.uniqueNonEmptyStrings([t?.stopCode,...Array.isArray(i?.stopCodes)?i.stopCodes:[],i?.stopCode]);for(let p of l){let E=e.busStops.find(C=>h(C).includes(p));if(E?.id)return{selectableStopId:E.id,memberStopId:r||null}}return{selectableStopId:e.busStopId||vt(),memberStopId:r||null}}function kt(t,i=null){return Lt(t,i).selectableStopId}function W(t){t&&(t.classList?.remove?.("result-filter-trigger","is-active"),t.removeAttribute?.("role"),t.removeAttribute?.("tabindex"),t.removeAttribute?.("aria-pressed"),t.removeAttribute?.("aria-label"),t.onclick=null,t.onkeydown=null)}function ht(t,{active:i=!1,onActivate:r,ariaLabel:l}){if(!t||typeof r!="function"){W(t);return}t.classList?.add?.("result-filter-trigger"),t.classList?.toggle?.("is-active",!!i),t.setAttribute?.("role","button"),t.setAttribute?.("tabindex","0"),t.setAttribute?.("aria-pressed",String(!!i)),t.setAttribute?.("aria-label",String(l||"Toggle filter"));let p=()=>r();t.onclick=()=>p(),t.onkeydown=E=>{let C=E?.key;C!=="Enter"&&C!==" "&&C!=="Spacebar"||(E?.preventDefault?.(),p())}}function Ct(t,i){let r=String(i||"").trim();if(!f()||!r){W(t);return}ht(t,{active:e.busLineFilters.includes(r),onActivate:()=>wt(r),ariaLabel:`Toggle line filter ${r}`})}function Rt(t,i){let r=String(i||"").trim();if(!f()||!r){W(t);return}ht(t,{active:e.busDestinationFilters.includes(r),onActivate:()=>At(r),ariaLabel:`Toggle destination filter ${r}`})}function Ft(t,i,r){if(!f()){W(t);return}ht(t,{active:yt(i,r),onActivate:()=>Tt(i,r),ariaLabel:"Toggle stop filter"})}function wt(t){return o(t,{interactionType:"result_card_line_toggle",changeType:"result_card_line_toggle",showAttention:!0})}function At(t){return c(t,{interactionType:"result_card_destination_toggle",changeType:"result_card_destination_toggle",showAttention:!0})}function Bt(){let t=f();if(m(t),!!t){if(V(),n.busStopSelectListEl){if(e.suppressBusStopChange=!0,n.busStopSelectListEl.innerHTML="",e.busStops.length===0)n.busStopSelectLabelEl&&(n.busStopSelectLabelEl.textContent=`No nearby ${I().singular} stops`),n.busStopSelectEl&&(n.busStopSelectEl.disabled=!0);else{n.busStopSelectEl&&(n.busStopSelectEl.disabled=!1);let i=e.busStopId;(!i||!e.busStops.some(r=>r.id===i))&&(i=e.busStops[0].id);for(let r of e.busStops){let l=document.createElement("li");l.setAttribute("role","option"),l.dataset.value=r.id,l.textContent=`${r.name} (${r.distanceMeters}m)`,r.id===i&&l.setAttribute("aria-selected","true"),l.addEventListener("click",()=>Mt(r.id)),n.busStopSelectListEl.appendChild(l)}if(n.busStopSelectLabelEl){let r=e.busStops.find(l=>l.id===i);n.busStopSelectLabelEl.textContent=r?`${r.name} (${r.distanceMeters}m)`:"Select stop"}}e.suppressBusStopChange=!1}bt(),D(n.busLineFiltersEl,e.busFilterOptions.lines,e.busLineFilters,i=>o(i)),D(n.busDestinationFiltersEl,e.busFilterOptions.destinations,e.busDestinationFilters,i=>c(i))}}function _t(t,i=null){if(!n.nextSummaryEl||!n.nextMinsEl||!n.nextLineEl||!n.nextTrackEl||!n.nextDestinationEl)return;if(!t){n.nextSummaryEl.classList.add("hidden"),n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),W(n.nextLineEl),W(n.nextDestinationEl),W(n.nextTrackEl);return}let r=A(t.departureIso);if(n.nextMinsEl.textContent=F(t.departureIso),n.nextLineEl.textContent=t.line||"\u2014",n.nextLineEl.classList.toggle("next-letter-now",r<3),n.nextTrackEl.textContent=f()?U(i,t):t.track?`Track ${t.track}`:"Track \u2014",n.nextDestinationEl.textContent=t.destination||"\u2014",f()){let l=Lt(t,i);Ct(n.nextLineEl,t.line),Rt(n.nextDestinationEl,t.destination),Ft(n.nextTrackEl,l.selectableStopId,l.memberStopId)}else W(n.nextLineEl),W(n.nextDestinationEl),W(n.nextTrackEl);n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),r<3?n.nextSummaryEl.classList.add("next-summary-now"):r<=10?n.nextSummaryEl.classList.add("next-summary-soon"):n.nextSummaryEl.classList.add("next-summary-later"),n.nextSummaryEl.classList.remove("hidden")}function xt(t){if(!t||!t.station)return f()?t?.message||`No nearby ${I().singular} stops found.`:t?.message||"No nearby train stations found.";let r=B(t.station.departures)[0];if(!r)return f()?e.busLineFilters.length>0||e.busDestinationFilters.length>0||Z()?`No upcoming ${I().plural} match selected filters.`:"No upcoming departures from this stop.":"No upcoming commuter trains right now.";let l=I().singular;return`${l.charAt(0).toUpperCase()+l.slice(1)} in ${F(r.departureIso)}`}function Nt(t){if(!(t instanceof Error))return"Could not refresh departures. Please try again.";if(t.name==="AbortError")return"Request timed out. Please try again.";let i=(t.message||"").trim();return i==="Temporary server error. Please try again."?i:i==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":i==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function Dt(t){return t?.code===1?"Location permission denied.":t?.code===2?"Location unavailable. Please try again.":t?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function Ut(t){let i=String(t?.code||"").trim();return i==="voice_unsupported"?"Voice location is not supported in this browser.":i==="voice_permission_denied"?"Microphone permission denied.":i==="voice_no_microphone"?"No microphone was found for voice location.":i==="voice_no_speech"?"No speech detected. Please try again.":i==="voice_recognition_timeout"?"Voice listening timed out. Please try again.":i==="voice_language_not_supported"?"Voice language was not supported on this device.":i==="voice_query_too_short"?"Please describe your location with a few words.":i==="voice_location_not_found"?"Could not match that place. Try a nearby landmark or street.":i==="voice_location_selection_cancelled"?"Location selection was cancelled.":i==="voice_location_selection_invalid"?"Please choose one of the suggested locations.":i==="voice_recognition_network"?"Voice recognition failed due to a network error. On iPhone, try enabling Siri & Dictation.":"Could not use voice location. Please try again."}function Pt(){n.skeletonEl&&n.skeletonEl.classList.remove("hidden")}function Ot(){n.skeletonEl&&n.skeletonEl.classList.add("hidden")}function qt(t){if(Ot(),Bt(),N(t),!t||!t.station){n.resultEl.classList.add("hidden"),_t(null);return}let i=t.station;n.resultEl.classList.remove("hidden"),n.stationTitleEl.textContent=i.stopName,n.stationMetaEl.textContent=`${i.distanceMeters}m away`,n.departuresEl.innerHTML="";let r=B(i.departures);if(r.length===0){_t(null);let p=document.createElement("li");p.className="empty-row",f()?p.textContent=e.busLineFilters.length>0||e.busDestinationFilters.length>0||Z()?`No upcoming ${I().plural} match selected filters.`:"No upcoming departures from this stop.":p.textContent="No upcoming commuter trains right now.",n.departuresEl.appendChild(p);return}_t(r[0],i);let l=r.slice(1);if(l.length===0){let p=document.createElement("li");p.className="empty-row",p.textContent=`No additional upcoming ${I().plural} right now.`,n.departuresEl.appendChild(p);return}for(let p=0;p<l.length;p++){let E=l[p],C=document.createElement("li");C.className=`departure-row ${R(E.departureIso)}`,C.style.setProperty("--i",p);let K=document.createElement("div");K.className="letter-badge",K.textContent=E.line||"?",f()&&Ct(K,E.line);let ct=document.createElement("div");ct.className="train";let pt=document.createElement("div");pt.className="destination",pt.textContent=E.destination||"\u2014",f()&&Rt(pt,E.destination),ct.appendChild(pt);let z=document.createElement("span");if(z.className="track",f()){z.textContent=U(i,E);let mt=Lt(E,i);Ft(z,mt.selectableStopId,mt.memberStopId)}else z.textContent=E.track?`Track ${E.track}`:"Track \u2014";ct.appendChild(z);let et=document.createElement("div");et.className="time";let rt=document.createElement("span");rt.className="remaining",rt.textContent=F(E.departureIso);let Et=document.createElement("span");Et.className="clock-time",Et.textContent=new Date(E.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),et.appendChild(rt),et.appendChild(Et),C.appendChild(K),C.appendChild(ct),C.appendChild(et),n.departuresEl.appendChild(C)}}function Vt(){n.nowClockEl&&(n.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(s,{formatMinutes:F,minutesUntil:A,departureRowClass:R,sanitizeStopSelections:v,getVisibleDepartures:B,updateModeButtons:st,updateModeLabels:ot,toggleResultsLimitDropdown:ut,selectResultsLimit:Q,renderResultsLimitControl:X,countActiveStopFilters:ft,buildStopFilterSummary:lt,syncStopFiltersPanelUi:V,setStopFiltersPanelOpen:a,toggleStopFiltersPanel:d,setStopControlsVisibility:m,getStopMeta:b,getStopCodes:h,buildStopDisplay:x,buildModeStopDisplay:U,updateDataScope:N,renderFilterButtons:D,toggleStopDropdown:It,selectStop:Mt,toggleLineFilter:o,toggleDestinationFilter:c,toggleLineFilterFromResultCard:wt,toggleDestinationFilterFromResultCard:At,toggleStopFromResultCard:Tt,isStopTargetActive:yt,resolveStopTargetFromDeparture:Lt,resolveStopIdFromDeparture:kt,setResultFilterTrigger:ht,clearResultFilterTrigger:W,triggerStopFilterAttention:H,renderStopControls:Bt,updateNextSummary:_t,buildStatusFromResponse:xt,getLoadErrorStatus:Nt,getGeolocationErrorStatus:Dt,getVoiceLocationErrorStatus:Ut,showSkeleton:Pt,hideSkeleton:Ot,render:qt,updateClock:Vt})})();(()=>{let k=window.HMApp,{api:s,dom:n,state:e,constants:O}=k,{MODE_RAIL:P,MODE_TRAM:y,MODE_METRO:u,MODE_BUS:T}=O;function q(a){return a===T||a===y||a===u||a===P}function J(a){return new Promise(d=>setTimeout(d,a))}async function G(a,d={},m=O.FETCH_TIMEOUT_MS){let L=new AbortController,g=setTimeout(()=>L.abort(),m);try{return await fetch(a,{...d,signal:L.signal})}finally{clearTimeout(g)}}async function nt(a,d={}){let m;try{m=await G(a,d)}catch{return await J(350),G(a,d)}return m.status>=500?(await J(350),G(a,d)):m}function S(a){let d=new Map,m=new Map;for(let g of a||[]){let _=String(g?.line||"").trim();_&&d.set(_,(d.get(_)||0)+1);let o=String(g?.destination||"").trim();o&&m.set(o,(m.get(o)||0)+1)}let L=g=>[...g.entries()].sort((_,o)=>o[1]-_[1]||_[0].localeCompare(o[0])).map(([_,o])=>({value:_,count:o}));return{lines:L(d),destinations:L(m)}}function w(a){let d=Array.isArray(a?.stops)?a.stops.filter(h=>h&&h.id&&h.name).map(h=>({id:h.id,name:h.name,code:String(h.code||"").trim()||null,memberStopIds:s.uniqueNonEmptyStrings([...Array.isArray(h.memberStopIds)?h.memberStopIds:[],h.id]),stopCodes:s.uniqueNonEmptyStrings([...Array.isArray(h.stopCodes)?h.stopCodes:[],h.code]),distanceMeters:Number(h.distanceMeters)||0})):[];e.busStops=d;let m=String(a?.selectedStopId||"").trim()||null,L=h=>d.some(M=>M.id===h),g=String(e.busStopId||"").trim()||null,_=!!(g&&!L(g)&&!(m&&L(m)));m&&L(m)?e.busStopId=m:(!e.busStopId||!L(e.busStopId))&&(e.busStopId=d[0]?.id||null);let o=d[0]?.id||null;e.busStopId?o&&e.busStopId!==o?e.stopFilterPinned=!0:_&&(e.stopFilterPinned=!1):e.stopFilterPinned=!1,e.deferInitialStopContext&&(e.deferInitialStopContext=!1,e.deferredBusStopId=null,e.deferredBusLineFilters=[],e.deferredBusDestinationFilters=[],e.busLineFilters=[],e.busDestinationFilters=[],e.stopFilterPinned=!1,e.busStopMemberFilterId=null),e.hasCompletedInitialStopModeLoad=!0;let c=Array.isArray(a?.station?.departures)?a.station.departures:[],b=new Set(c.map(h=>String(h?.stopId||"").trim()).filter(Boolean));e.stopFilterPinned?e.busStopMemberFilterId&&!b.has(String(e.busStopMemberFilterId).trim())&&(e.busStopMemberFilterId=null):e.busStopMemberFilterId=null,e.busFilterOptions=S(c),s.sanitizeStopSelections()}function f(a,d){let m=new Error(d);return m.code=a,m}function I(a){return String(a?.code||"").trim().toLowerCase()}function F(){return s.uniqueNonEmptyStrings(["fi-FI","en-US",...Array.isArray(navigator.languages)?navigator.languages:[],navigator.language])}function A(){return typeof window.SpeechRecognition=="function"?window.SpeechRecognition:typeof window.webkitSpeechRecognition=="function"?window.webkitSpeechRecognition:null}function R(){return!!A()}function v(a){return a==="not-allowed"||a==="service-not-allowed"?f("voice_permission_denied","Microphone permission denied."):a==="audio-capture"?f("voice_no_microphone","No microphone available."):a==="language-not-supported"?f("voice_language_not_supported","Speech language is not supported."):a==="network"?f("voice_recognition_network","Voice recognition network error."):a==="no-speech"?f("voice_no_speech","No speech detected."):f("voice_not_understood","Voice recognition failed.")}function B(a){let d=A();return d?new Promise((m,L)=>{let g=new d,_=String(a||navigator.language||"fi-FI").trim();g.lang=_||"fi-FI",g.continuous=!1,g.interimResults=!0,g.maxAlternatives=1;let o=!1,c="",b=null,h=!1,M=()=>{clearTimeout(b),b=null},x=()=>{if(!(h||o)){h=!0;try{g.stop()}catch{}}},U=()=>{M(),b=setTimeout(x,O.VOICE_SILENCE_STOP_MS)},tt=()=>{clearTimeout(gt),M(),g.onresult=null,g.onerror=null,g.onend=null,g.onspeechend=null,g.onsoundend=null,g.onaudioend=null,g.onnomatch=null},$=(N,D)=>{o||(o=!0,tt(),N(D))},gt=setTimeout(()=>{try{g.abort()}catch{}$(L,f("voice_recognition_timeout","Voice recognition timed out."))},O.VOICE_RECOGNITION_TIMEOUT_MS);g.onresult=N=>{for(let D=N?.resultIndex||0;D<(N?.results?.length||0);D+=1){let dt=N.results[D],bt=String(dt?.[0]?.transcript||"").trim();if(bt&&(c=bt,U(),dt?.isFinal)){x();return}}},g.onerror=N=>{let D=String(N?.error||"").trim().toLowerCase();$(L,v(D))},g.onend=()=>{if(o)return;let N=String(c||"").trim();if(!N){$(L,f("voice_no_speech","No speech detected."));return}$(m,N)},g.onspeechend=()=>{x()},g.onsoundend=()=>{U()},g.onaudioend=()=>{U()},g.onnomatch=()=>{$(L,f("voice_not_understood","Could not understand speech."))};try{g.start()}catch(N){let D=String(N?.name||"").trim().toLowerCase();if(D==="notallowederror"||D==="securityerror"){$(L,f("voice_permission_denied","Microphone permission denied."));return}$(L,f("voice_not_understood","Unable to start voice recognition."))}}):Promise.reject(f("voice_unsupported","Voice recognition not supported."))}function st(a){return a==="voice_no_speech"||a==="voice_not_understood"||a==="voice_recognition_timeout"||a==="voice_language_not_supported"}async function ot(){let a=F(),d=null;for(let m of a)try{return await B(m)}catch(L){if(d=L,!st(I(L)))break}throw d||f("voice_not_understood","Voice recognition failed.")}function ut(a){return Array.isArray(a)?a.map(d=>{let m=Number(d?.lat),L=Number(d?.lon);return!Number.isFinite(m)||!Number.isFinite(L)?null:{lat:m,lon:L,label:String(d?.label||"").trim()}}).filter(Boolean):[]}function Q(){n.voiceLocationChoicesEl&&n.voiceLocationChoicesEl.classList.add("hidden"),n.voiceLocationChoicesTitleEl&&(n.voiceLocationChoicesTitleEl.textContent=""),n.voiceLocationChoicesOptionsEl&&(n.voiceLocationChoicesOptionsEl.innerHTML=""),n.voiceLocationChoicesCancelEl&&(n.voiceLocationChoicesCancelEl.onclick=null)}function X(a,d){if(typeof window.prompt!="function")throw f("voice_location_selection_cancelled","Location selection was cancelled.");let m=d.map((_,o)=>`${o+1}. ${_.label||`${_.lat}, ${_.lon}`}`).join(`
`),L=window.prompt(`Multiple matches found for "${s.safeString(a,80)}". Select number:
${m}`,"1");if(L==null)throw f("voice_location_selection_cancelled","Location selection was cancelled.");let g=Number.parseInt(String(L).trim(),10);if(!Number.isInteger(g)||g<1||g>d.length)throw f("voice_location_selection_invalid","Invalid location selection.");return d[g-1]}async function ft(a,d){if(!Array.isArray(d)||d.length===0)throw f("voice_location_not_found","No matching location found.");return!n.voiceLocationChoicesEl||!n.voiceLocationChoicesTitleEl||!n.voiceLocationChoicesOptionsEl||!n.voiceLocationChoicesCancelEl?X(a,d):new Promise((m,L)=>{let g=!1,_=(o,c)=>{g||(g=!0,Q(),o(c))};n.voiceLocationChoicesTitleEl.textContent=`Multiple matches for "${s.safeString(a,80)}". Choose one:`,s.setStatus("Multiple matches found. Choose one below."),n.voiceLocationChoicesOptionsEl.innerHTML="";for(let o of d){let c=document.createElement("button");c.type="button",c.className="voice-location-choice-option",c.textContent=o.label||`${o.lat.toFixed(5)}, ${o.lon.toFixed(5)}`,c.addEventListener("click",()=>_(m,o),{once:!0}),n.voiceLocationChoicesOptionsEl.appendChild(c)}n.voiceLocationChoicesCancelEl.onclick=()=>_(L,f("voice_location_selection_cancelled","Location selection was cancelled.")),n.voiceLocationChoicesEl.classList.remove("hidden")})}async function lt(a){let d=String(a||"").trim();if(d.length<O.VOICE_QUERY_MIN_LENGTH)throw f("voice_query_too_short","Voice query too short.");let m=new URLSearchParams({text:d});e.currentCoords&&(m.set("lat",String(e.currentCoords.lat)),m.set("lon",String(e.currentCoords.lon)));let L=Array.isArray(navigator.languages)&&navigator.languages[0]||navigator.language||"";L&&m.set("lang",String(L));let g;try{g=await nt(`/api/v1/geocode?${m.toString()}`)}catch{throw f("voice_geocode_failed","Location lookup failed.")}if(!(g.headers.get("content-type")||"").includes("application/json"))throw f("voice_geocode_failed","Unexpected location lookup response.");let o=await g.json();if(!g.ok)throw f("voice_geocode_failed",String(o?.error||"Location lookup failed.").trim());let c=ut(o?.choices);if(o?.ambiguous&&c.length>1){let M=await ft(d,c);return{lat:M.lat,lon:M.lon,label:M.label,query:d}}let b=Number(o?.location?.lat),h=Number(o?.location?.lon);if(!Number.isFinite(b)||!Number.isFinite(h))throw f("voice_location_not_found","No matching location found.");return{lat:b,lon:h,label:String(o?.location?.label||"").trim(),query:d}}function Z(a){return a==="voice_unsupported"||a==="voice_no_speech"||a==="voice_recognition_timeout"||a==="voice_recognition_network"||a==="voice_not_understood"}function it(a){if(!Z(a)||typeof window.prompt!="function")return null;let d=a==="voice_unsupported"?"Voice input is limited in this browser. Type your location instead:":"Could not capture your voice on this device. Type your location:",m=window.prompt(`${d}
Example: Kamppi Helsinki`,"");return String(m||"").trim()||null}async function Y(a){let d=String(a||"").trim();Q(),s.setStatus(`Looking up "${s.safeString(d,80)}"...`);let m=await lt(d);return s.setResolvedLocationHint({query:d,label:m.label,lat:m.lat,lon:m.lon}),e.currentCoords={lat:m.lat,lon:m.lon},s.setPermissionRequired(!1),await j(m.lat,m.lon),!0}async function St(){if(e.isLoading||e.isVoiceListening)return!1;Q(),s.setVoiceListening(!0),s.setStatus("Listening... speak now, then pause.");try{if(!R()){let d=f("voice_unsupported","Voice recognition not supported."),m=it(I(d));return m?Y(m):(s.setStatus(s.getVoiceLocationErrorStatus(d)),!1)}let a=await ot();return Y(a)}catch(a){let d=I(a),m=it(d);if(m)try{return await Y(m)}catch(L){return console.error("voice fallback location error:",L),s.reportClientError("voice-location-fallback",L,{mode:e.mode,sourceCode:d||"unknown"}),s.setStatus(s.getVoiceLocationErrorStatus(L)),!1}return(!d||d==="unknown")&&console.error("voice location error:",a),s.reportClientError("voice-location",a,{mode:e.mode,code:d||"unknown"}),s.setStatus(s.getVoiceLocationErrorStatus(a)),!1}finally{s.setVoiceListening(!1)}}async function j(a,d){let m=++e.latestLoadToken,L=e.mode,g=e.busStopId,_=q(L)&&!e.hasCompletedInitialStopModeLoad;s.setLoading(!0),s.setStatus("Loading departures...");try{let o=new URLSearchParams({lat:String(a),lon:String(d),mode:L.toUpperCase(),results:String(s.getActiveResultsLimit(L))}),c=q(L)&&(e.deferInitialStopContext||!e.hasCompletedInitialStopModeLoad);q(L)&&g&&!c&&o.set("stopId",g);let b=await nt(`/api/v1/departures?${o.toString()}`);if(!(b.headers.get("content-type")||"").includes("application/json"))throw b.ok?new Error("Unexpected server response."):new Error("Request failed");let M=await b.json();if(!b.ok)throw new Error(M.error||"Request failed");if(m!==e.latestLoadToken)return;q(L)&&(w(M),s.persistUiState(),_&&s.trackInitialNearestStopResolved(M,L)),e.latestResponse=M,s.render(M),s.setPermissionRequired(!1),s.setLastUpdated(new Date),s.setStatus(s.buildStatusFromResponse(M)),s.trackFirstSuccessfulRender(M,L)}catch(o){if(m!==e.latestLoadToken)return;e.latestResponse=null,console.error("load departures error:",o),s.reportClientError("load",o,{mode:L}),s.setStatus(s.getLoadErrorStatus(o)),n.resultEl.classList.add("hidden"),s.updateNextSummary(null)}finally{m===e.latestLoadToken&&s.setLoading(!1)}}function H(){if(Q(),s.setResolvedLocationHint(null),!navigator.geolocation)return s.setStatus("Geolocation not supported in this browser."),s.setPermissionRequired(!0),!1;if(e.isLoading||e.isVoiceListening)return!1;s.setStatus("Getting your location..."),s.setLoading(!0);let a=_=>({enableHighAccuracy:_,timeout:_?15e3:1e4,maximumAge:0}),d=(_,o)=>o?!1:_?.code===2||_?.code===3,m=_=>{e.currentCoords={lat:_.coords.latitude,lon:_.coords.longitude},e.locationGranted=!0,s.setStorageItem("location:granted","1"),s.setPermissionRequired(!1),s.setLoading(!1),j(e.currentCoords.lat,e.currentCoords.lon)},L=_=>{_.code===1?s.setPermissionRequired(!0):s.setPermissionRequired(!1),s.setStatus(s.getGeolocationErrorStatus(_)),e.latestResponse=null,n.resultEl.classList.add("hidden"),s.updateNextSummary(null),s.setLoading(!1)},g=_=>{navigator.geolocation.getCurrentPosition(m,o=>{if(d(o,_)){g(!0);return}L(o)},a(_))};return g(!1),!0}function at(){if(!e.isVoiceListening){if(e.currentCoords){j(e.currentCoords.lat,e.currentCoords.lon);return}H()}}function V(a={}){let d=!!a.modeOnly;s.updateModeButtons(),s.updateModeLabels(),!d&&(s.renderResultsLimitControl(),s.renderStopControls(),s.updateDataScope(e.latestResponse))}Object.assign(s,{delay:J,fetchWithTimeout:G,fetchWithRetryOnce:nt,updateStopModeStateFromResponse:w,buildFilterOptionsFromDepartures:S,load:j,requestLocationAndLoad:H,requestVoiceLocationAndLoad:St,supportsVoiceLocation:R,captureVoiceQuery:B,captureVoiceQueryWithRetry:ot,getVoiceRecognitionLanguages:F,shouldRetryVoiceRecognition:st,resolveVoiceLocationQuery:lt,refreshDeparturesOnly:at,applyModeUiState:V})})();(()=>{let k=window.HMApp,{api:s,dom:n,state:e,constants:O}=k,{MODE_RAIL:P,MODE_TRAM:y,MODE_METRO:u,MODE_BUS:T}=O;function q(){if(e.currentCoords){s.load(e.currentCoords.lat,e.currentCoords.lon);return}s.requestLocationAndLoad()}function J(S){if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(S);return}setTimeout(S,0)}function G(S){e.mode!==S&&(s.trackFirstManualInteraction("mode_change",{toMode:S}),e.mode=S,s.applyModeUiState({modeOnly:!0}),J(()=>{s.applyModeUiState(),s.persistUiState(),q()}))}n.locateBtn?.addEventListener("click",()=>{s.trackFirstManualInteraction("refresh_location_click"),s.requestLocationAndLoad()}),n.voiceLocateBtn?.addEventListener("click",()=>{s.trackFirstManualInteraction("voice_location_click"),s.requestVoiceLocationAndLoad()}),n.modeRailBtn?.addEventListener("click",()=>{G(P)}),n.modeTramBtn?.addEventListener("click",()=>{G(y)}),n.modeMetroBtn?.addEventListener("click",()=>{G(u)}),n.modeBusBtn?.addEventListener("click",()=>{G(T)}),n.resultsLimitSelectEl?.addEventListener("click",S=>{S.stopPropagation(),s.toggleResultsLimitDropdown()}),document.addEventListener("click",S=>{n.resultsLimitSelectWrapEl&&(n.resultsLimitSelectWrapEl.contains(S.target)||s.toggleResultsLimitDropdown(!1))}),n.resultsLimitSelectEl?.addEventListener("keydown",S=>{let w=n.resultsLimitSelectListEl;if(!w)return;let f=n.resultsLimitSelectEl.getAttribute("aria-expanded")==="true";if(S.key==="Escape"){s.toggleResultsLimitDropdown(!1),n.resultsLimitSelectEl.focus(),S.preventDefault();return}if(S.key==="Enter"||S.key===" "){if(!f){s.toggleResultsLimitDropdown(!0),S.preventDefault();return}let I=w.querySelector(".is-focused");I?.dataset?.value&&s.selectResultsLimit(I.dataset.value),S.preventDefault();return}if(S.key==="ArrowDown"||S.key==="ArrowUp"){if(S.preventDefault(),!f){s.toggleResultsLimitDropdown(!0);return}let I=[...w.querySelectorAll("li[role='option']")];if(I.length===0)return;let F=I.findIndex(R=>R.classList.contains("is-focused")),A;S.key==="ArrowDown"?A=F<I.length-1?F+1:0:A=F>0?F-1:I.length-1;for(let R of I)R.classList.remove("is-focused");I[A].classList.add("is-focused"),I[A].scrollIntoView({block:"nearest"})}}),n.busStopSelectEl?.addEventListener("click",S=>{S.stopPropagation(),s.toggleStopDropdown()}),document.addEventListener("click",S=>{n.busStopSelectWrapEl&&(n.busStopSelectWrapEl.contains(S.target)||s.toggleStopDropdown(!1))}),n.busStopSelectEl?.addEventListener("keydown",S=>{let w=n.busStopSelectListEl;if(!w)return;let f=n.busStopSelectEl.getAttribute("aria-expanded")==="true";if(S.key==="Escape"){s.toggleStopDropdown(!1),n.busStopSelectEl.focus(),S.preventDefault();return}if(S.key==="Enter"||S.key===" "){if(!f){s.toggleStopDropdown(!0),S.preventDefault();return}let I=w.querySelector(".is-focused");I?.dataset?.value&&s.selectStop(I.dataset.value),S.preventDefault();return}if(S.key==="ArrowDown"||S.key==="ArrowUp"){if(S.preventDefault(),!f){s.toggleStopDropdown(!0);return}let I=[...w.querySelectorAll("li[role='option']")];if(I.length===0)return;let F=I.findIndex(R=>R.classList.contains("is-focused")),A;S.key==="ArrowDown"?A=F<I.length-1?F+1:0:A=F>0?F-1:I.length-1;for(let R of I)R.classList.remove("is-focused");I[A].classList.add("is-focused"),I[A].scrollIntoView({block:"nearest"})}}),n.stopFiltersToggleBtnEl?.addEventListener("click",()=>{s.trackFirstManualInteraction("stop_filters_panel_toggle",{currentMode:e.mode}),s.toggleStopFiltersPanel()}),n.locationPromptAllowEl?.addEventListener("click",()=>{s.hideLocationPrompt(),s.requestLocationAndLoad()}),n.permissionRetryBtnEl?.addEventListener("click",()=>{s.trackFirstManualInteraction("permission_retry_click"),s.requestLocationAndLoad()}),s.hydrateInitialState(),s.applyModeUiState(),s.updateClock(),setInterval(s.updateClock,1e3),s.getStorageItem("location:granted")==="1"?s.requestLocationAndLoad():(s.showLocationPrompt(),s.setStatus("Tap Allow Location to get started.")),setInterval(s.refreshDeparturesOnly,3e4),window.addEventListener("error",S=>{s.reportClientError("error",S.error||S.message||"Unknown error",{source:S.filename||"",line:S.lineno||null,column:S.colno||null})}),window.addEventListener("unhandledrejection",S=>{s.reportClientError("unhandledrejection",S.reason||"Unhandled promise rejection")}),(()=>{let S=document.getElementById("themeToggle");if(!S)return;let w=document.documentElement,f=window.matchMedia("(prefers-color-scheme: dark)"),I=()=>{let v=s.getStorageItem("theme");return v==="dark"||v==="light"?v:null},F=v=>{w.setAttribute("data-theme",v==="light"?"light":"dark")},A=()=>{let v=I();if(v){F(v);return}F(f.matches?"dark":"light")},R=v=>{I()||F(v.matches?"dark":"light")};A(),typeof f.addEventListener=="function"?f.addEventListener("change",R):typeof f.addListener=="function"&&f.addListener(R),S.addEventListener("click",()=>{let v=w.getAttribute("data-theme")==="dark"?"light":"dark";F(v),s.setStorageItem("theme",v)})})()})();})();
