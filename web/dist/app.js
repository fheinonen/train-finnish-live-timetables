(()=>{(()=>{let v=window.HMApp||(window.HMApp={}),i=v.api||={};v.dom={locateBtn:document.getElementById("locateBtn"),voiceLocateBtn:document.getElementById("voiceLocateBtn"),voiceLocateBtnLabel:document.getElementById("voiceLocateBtnLabel"),skeletonEl:document.getElementById("skeleton"),segmentControlEl:document.querySelector(".segment-control"),modeRailBtn:document.getElementById("modeRailBtn"),modeTramBtn:document.getElementById("modeTramBtn"),modeMetroBtn:document.getElementById("modeMetroBtn"),modeBusBtn:document.getElementById("modeBusBtn"),helsinkiOnlyBtn:document.getElementById("helsinkiOnlyBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busStopSelectLabelEl:document.getElementById("busStopSelectLabel"),busStopSelectListEl:document.getElementById("busStopSelectList"),busStopSelectWrapEl:document.getElementById("busStopSelectWrap"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),resolvedLocationEl:document.getElementById("resolvedLocation"),voiceLocationChoicesEl:document.getElementById("voiceLocationChoices"),voiceLocationChoicesTitleEl:document.getElementById("voiceLocationChoicesTitle"),voiceLocationChoicesOptionsEl:document.getElementById("voiceLocationChoicesOptions"),voiceLocationChoicesCancelEl:document.getElementById("voiceLocationChoicesCancel"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),permissionCardEl:document.getElementById("permissionCard"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},v.constants={MODE_RAIL:"rail",MODE_TRAM:"tram",MODE_METRO:"metro",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_HELSINKI_ONLY_KEY:"prefs:helsinkiOnly",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_TRAM_KEY:"prefs:resultsLimitTram",STORAGE_RESULTS_LIMIT_METRO_KEY:"prefs:resultsLimitMetro",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_TRAM:8,DEFAULT_RESULTS_LIMIT_METRO:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],VOICE_RECOGNITION_TIMEOUT_MS:8e3,VOICE_SILENCE_STOP_MS:1200,VOICE_QUERY_MIN_LENGTH:3,FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5,METRIC_REPORT_LIMIT:10,METRIC_SAMPLE_RATE:1};let{MODE_RAIL:s,MODE_TRAM:o,MODE_METRO:b,MODE_BUS:I}=v.constants;v.state={isLoading:!1,isVoiceListening:!1,currentCoords:null,latestResponse:null,mode:s,helsinkiOnly:!1,busStopId:null,busLineFilters:[],busDestinationFilters:[],deferInitialStopContext:!1,deferredBusStopId:null,deferredBusLineFilters:[],deferredBusDestinationFilters:[],resultsLimitByMode:{[s]:v.constants.DEFAULT_RESULTS_LIMIT_RAIL,[o]:v.constants.DEFAULT_RESULTS_LIMIT_TRAM,[b]:v.constants.DEFAULT_RESULTS_LIMIT_METRO,[I]:v.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},resolvedLocationHint:null,suppressBusStopChange:!1,hasCompletedInitialStopModeLoad:!1,errorReportCount:0,metricReportCount:0,isMetricSessionSampled:Math.random()<v.constants.METRIC_SAMPLE_RATE,sessionStartedAtMs:Date.now(),hasReportedFirstSuccessfulRenderMetric:!1,hasReportedFirstManualInteractionMetric:!1,hasReportedFirstManualStopContextMetric:!1,hasReportedInitialNearestStopResolvedMetric:!1,latestLoadToken:0};let{dom:L,state:r,constants:g}=v;function h(){let e=r.isLoading||r.isVoiceListening,t=r.isLoading;L.locateBtn&&(L.locateBtn.disabled=e),L.voiceLocateBtn&&(L.voiceLocateBtn.disabled=t,L.voiceLocateBtn.classList.toggle("is-listening",r.isVoiceListening),L.voiceLocateBtn.setAttribute("aria-pressed",String(r.isVoiceListening))),L.voiceLocateBtnLabel&&(L.voiceLocateBtnLabel.textContent=r.isVoiceListening?"Listening...":"Describe Location")}function f(e){r.isLoading=e,h(),e&&L.skeletonEl&&L.skeletonEl.classList.remove("hidden")}function T(e){r.isVoiceListening=!!e,h()}function M(e){L.statusEl&&(L.statusEl.textContent=e)}function y(e){let t=Number(e);return Number.isFinite(t)?t.toFixed(5):null}function E(e){let t=e&&typeof e=="object";if(r.resolvedLocationHint=t?{query:R(e.query,120).trim(),label:R(e.label,180).trim(),lat:Number(e.lat),lon:Number(e.lon)}:null,!L.resolvedLocationEl)return;if(!r.resolvedLocationHint){L.resolvedLocationEl.classList.add("hidden"),L.resolvedLocationEl.textContent="";return}let a=r.resolvedLocationHint.label||"Unknown place",d=r.resolvedLocationHint.query,p=y(r.resolvedLocationHint.lat),S=y(r.resolvedLocationHint.lon),N=d?` (from "${d}")`:"",x=p&&S?` - ${p}, ${S}`:"";L.resolvedLocationEl.textContent=`Resolved location: ${a}${N}${x}`,L.resolvedLocationEl.classList.remove("hidden")}function B(e){L.permissionCardEl&&L.permissionCardEl.classList.toggle("hidden",!e)}function k(e){!L.lastUpdatedEl||!(e instanceof Date)||(L.lastUpdatedEl.textContent=`Last updated: ${e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function _(e){try{return window.localStorage.getItem(e)}catch{return null}}function O(e,t){try{window.localStorage.setItem(e,t)}catch{}}function R(e,t){let a=String(e||"");return a.length<=t?a:a.slice(0,t)}function z(e){if(e instanceof Error)return e;try{let t=typeof e=="string"?e:JSON.stringify(e);return new Error(t||"Unknown error")}catch{return new Error(String(e||"Unknown error"))}}function V(e){let t=JSON.stringify(e);if(navigator.sendBeacon){let a=new Blob([t],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",a);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:t,keepalive:!0}).catch(()=>{})}function q(e,t,a=null){if(r.errorReportCount>=g.ERROR_REPORT_LIMIT)return;r.errorReportCount+=1;let d=z(t),p={type:R(e,40),message:R(d.message,400),stack:R(d.stack||"",1200),url:R(window.location.href,500),userAgent:R(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:a&&typeof a=="object"?a:null};V(p)}function Y(){return Math.max(0,Date.now()-r.sessionStartedAtMs)}function U(e,t=null){if(!r.isMetricSessionSampled||r.metricReportCount>=g.METRIC_REPORT_LIMIT)return!1;r.metricReportCount+=1;let a={type:"metric",message:R(e,400),stack:"",url:R(window.location.href,500),userAgent:R(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:{metricName:R(e,80),sessionElapsedMs:Y(),mode:r.mode,...t&&typeof t=="object"?t:{}}};return V(a),!0}function K(e,t){if(r.hasReportedFirstSuccessfulRenderMetric)return;r.hasReportedFirstSuccessfulRenderMetric=!0;let a=Array.isArray(e?.station?.departures)?e.station.departures:[];U("first_successful_render",{requestMode:String(t||"").trim(),hasStation:!!e?.station,departureCount:a.length})}function Z(e,t=null){r.hasReportedFirstManualInteractionMetric||(r.hasReportedFirstManualInteractionMetric=!0,U("first_manual_interaction",{interactionType:R(e,80),...t&&typeof t=="object"?t:{}}))}function j(e,t=null){r.hasReportedFirstManualStopContextMetric||(r.hasReportedFirstManualStopContextMetric=!0,U("first_manual_stop_context_change",{changeType:R(e,80),lineFilterCount:r.busLineFilters.length,destinationFilterCount:r.busDestinationFilters.length,...t&&typeof t=="object"?t:{}}))}function J(e,t){if(r.hasReportedInitialNearestStopResolvedMetric)return;let a=String(e?.selectedStopId||"").trim();if(!a)return;r.hasReportedInitialNearestStopResolvedMetric=!0;let p=(Array.isArray(e?.stops)?e.stops:[]).find(N=>N?.id===a)||null,S=Array.isArray(e?.station?.departures)?e.station.departures:[];U("initial_nearest_stop_resolved",{requestMode:String(t||"").trim(),selectedStopId:a,distanceMeters:Number(p?.distanceMeters)||null,departureCount:S.length})}function H(e){if(!e)return null;let t=String(e).trim().toLowerCase();return t===s||t===o||t===b||t===I?t:null}function $(e){if(e==null)return null;let t=String(e).trim().toLowerCase();return["1","true","yes","on"].includes(t)?!0:["0","false","no","off"].includes(t)?!1:null}function D(e){return Array.isArray(e)?[...new Set(e.map(t=>String(t||"").trim()).filter(Boolean))]:[]}function F(e){if(e==null||e==="")return null;let t=Number(e);return!Number.isInteger(t)||!g.RESULT_LIMIT_OPTIONS.includes(t)?null:t}function Q(e=r.mode){return e===I?g.DEFAULT_RESULTS_LIMIT_BUS:e===b?g.DEFAULT_RESULTS_LIMIT_METRO:e===o?g.DEFAULT_RESULTS_LIMIT_TRAM:g.DEFAULT_RESULTS_LIMIT_RAIL}function P(e=r.mode){let t=F(r.resultsLimitByMode?.[e]);return t??Q(e)}function X(e){let t=_(e);if(!t)return[];try{let a=JSON.parse(t);return D(a)}catch{return[]}}function l(){let e=new URLSearchParams(window.location.search);return{mode:H(e.get("mode")),helsinkiOnly:$(e.get("helsinkiOnly")),stopProvided:e.has("stop"),busStopId:e.get("stop")?e.get("stop").trim():null,linesProvided:e.has("line"),busLines:D(e.getAll("line")),destinationsProvided:e.has("dest"),busDestinations:D(e.getAll("dest")),resultsProvided:e.has("results"),resultsLimit:F(e.get("results"))}}function c(){let e=l(),t=H(_(g.STORAGE_MODE_KEY)),a=$(_(g.STORAGE_HELSINKI_ONLY_KEY));r.mode=e.mode||t||s,r.helsinkiOnly=e.helsinkiOnly??a??!1,r.mode!==s&&(r.helsinkiOnly=!1);let d=String(_(g.STORAGE_BUS_STOP_KEY)||"").trim()||null,p=e.stopProvided?e.busStopId:d,S=X(g.STORAGE_BUS_LINES_KEY),N=X(g.STORAGE_BUS_DESTINATIONS_KEY),x=e.linesProvided?e.busLines:S,G=e.destinationsProvided?e.busDestinations:N,A=!!p||x.length>0||G.length>0;r.deferInitialStopContext=A,A?(r.deferredBusStopId=p,r.deferredBusLineFilters=[...x],r.deferredBusDestinationFilters=[...G],r.busStopId=null,r.busLineFilters=[],r.busDestinationFilters=[]):(r.deferredBusStopId=null,r.deferredBusLineFilters=[],r.deferredBusDestinationFilters=[],r.busStopId=p,r.busLineFilters=x,r.busDestinationFilters=G);let W=F(_(g.STORAGE_RESULTS_LIMIT_RAIL_KEY)),C=F(_(g.STORAGE_RESULTS_LIMIT_TRAM_KEY)),w=F(_(g.STORAGE_RESULTS_LIMIT_METRO_KEY)),ee=F(_(g.STORAGE_RESULTS_LIMIT_BUS_KEY));r.resultsLimitByMode[s]=W??g.DEFAULT_RESULTS_LIMIT_RAIL,r.resultsLimitByMode[o]=C??g.DEFAULT_RESULTS_LIMIT_TRAM,r.resultsLimitByMode[b]=w??g.DEFAULT_RESULTS_LIMIT_METRO,r.resultsLimitByMode[I]=ee??g.DEFAULT_RESULTS_LIMIT_BUS,e.resultsProvided&&e.resultsLimit!=null&&(r.resultsLimitByMode[r.mode]=e.resultsLimit)}function u(){O(g.STORAGE_MODE_KEY,r.mode),O(g.STORAGE_HELSINKI_ONLY_KEY,r.helsinkiOnly?"1":"0"),O(g.STORAGE_BUS_STOP_KEY,r.busStopId||""),O(g.STORAGE_BUS_LINES_KEY,JSON.stringify(r.busLineFilters)),O(g.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(r.busDestinationFilters)),O(g.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(P(s))),O(g.STORAGE_RESULTS_LIMIT_TRAM_KEY,String(P(o))),O(g.STORAGE_RESULTS_LIMIT_METRO_KEY,String(P(b))),O(g.STORAGE_RESULTS_LIMIT_BUS_KEY,String(P(I)))}function m(){let e=new URLSearchParams(window.location.search);r.mode===s?e.delete("mode"):e.set("mode",r.mode),r.mode===s&&r.helsinkiOnly?e.set("helsinkiOnly","1"):e.delete("helsinkiOnly");let t=P(),a=Q();if(t===a?e.delete("results"):e.set("results",String(t)),e.delete("stop"),e.delete("line"),e.delete("dest"),r.mode===I||r.mode===o||r.mode===b){r.busStopId&&e.set("stop",r.busStopId);for(let S of r.busLineFilters)e.append("line",S);for(let S of r.busDestinationFilters)e.append("dest",S)}let d=e.toString(),p=`${window.location.pathname}${d?`?${d}`:""}${window.location.hash}`;window.history.replaceState(null,"",p)}function n(){u(),m()}h(),Object.assign(i,{updateLocationActionButtons:h,setLoading:f,setVoiceListening:T,setStatus:M,setResolvedLocationHint:E,setPermissionRequired:B,setLastUpdated:k,getStorageItem:_,setStorageItem:O,safeString:R,toError:z,sendClientReport:V,reportClientError:q,reportClientMetric:U,getSessionElapsedMs:Y,trackFirstSuccessfulRender:K,trackFirstManualInteraction:Z,trackFirstManualStopContextChange:j,trackInitialNearestStopResolved:J,normalizeMode:H,parseBoolean:$,uniqueNonEmptyStrings:D,parseResultLimit:F,getDefaultResultsLimit:Q,getActiveResultsLimit:P,parseStoredArray:X,readStateFromUrl:l,hydrateInitialState:c,syncStateToStorage:u,syncStateToUrl:m,persistUiState:n})})();(()=>{let v=window.HMApp,{api:i,dom:s,state:o,constants:b}=v,{MODE_RAIL:I,MODE_TRAM:L,MODE_METRO:r,MODE_BUS:g}=b;function h(n=o.mode){return n===g||n===L||n===r}function f(n=o.mode){return n===L?{singular:"tram",plural:"trams",title:"Tram"}:n===r?{singular:"metro",plural:"metros",title:"Metro"}:{singular:"bus",plural:"buses",title:"Bus"}}function T(n){let e=M(n);return e<=0?"Now":`${e}m`}function M(n){let e=new Date(n);return Math.floor((e.getTime()-Date.now())/6e4)}function y(n){let e=M(n);return e<=0||e<5?"departure-now":e<=15?"departure-soon":"departure-later"}function E(n){let e=n?.destination||"";return/\bhelsinki\b/i.test(e)}function B(){let n=new Set((o.busFilterOptions.lines||[]).map(t=>t.value)),e=new Set((o.busFilterOptions.destinations||[]).map(t=>t.value));o.busLineFilters=o.busLineFilters.filter(t=>n.has(t)),o.busDestinationFilters=o.busDestinationFilters.filter(t=>e.has(t))}function k(n){if(!Array.isArray(n))return[];if(o.mode===I)return o.helsinkiOnly?n.filter(E):n;if(!h())return n;let e=new Set(o.busLineFilters),t=new Set(o.busDestinationFilters);return n.filter(a=>{if(e.size===0)return!0;let d=String(a?.line||"").trim();return e.has(d)}).filter(a=>{if(t.size===0)return!0;let d=String(a?.destination||"").trim();return t.has(d)})}function _(){let n=[{el:s.modeRailBtn,mode:I,index:0},{el:s.modeTramBtn,mode:L,index:1},{el:s.modeMetroBtn,mode:r,index:2},{el:s.modeBusBtn,mode:g,index:3}];for(let{el:e,mode:t,index:a}of n){if(!e)continue;let d=o.mode===t;if(e.setAttribute("aria-checked",String(d)),e.classList.toggle("is-active",d),d){let p=e.closest(".segment-control");p&&p.style.setProperty("--active-index",a)}}}function O(){let n=h()?f().title:"Rail",e=h()?`Next ${f().title}`:"Next Train";s.modeEyebrowEl&&(s.modeEyebrowEl.textContent=`Helsinki Moves \u2022 ${n}`),s.nextLabelEl&&(s.nextLabelEl.textContent=e)}function R(){if(!s.resultsLimitSelectEl)return;let n=Array.isArray(b.RESULT_LIMIT_OPTIONS)?b.RESULT_LIMIT_OPTIONS:[],e=i.getActiveResultsLimit();s.resultsLimitSelectEl.innerHTML="";for(let t of n){let a=document.createElement("option");a.value=String(t),a.textContent=`${t}`,s.resultsLimitSelectEl.appendChild(a)}s.resultsLimitSelectEl.value=String(e)}function z(){if(s.helsinkiOnlyBtn){if(o.mode!==I){s.helsinkiOnlyBtn.setAttribute("aria-pressed","false"),s.helsinkiOnlyBtn.classList.remove("is-active"),s.helsinkiOnlyBtn.disabled=!0,s.helsinkiOnlyBtn.textContent="Helsinki Only (Rail)";return}s.helsinkiOnlyBtn.disabled=!1,s.helsinkiOnlyBtn.setAttribute("aria-pressed",String(o.helsinkiOnly)),s.helsinkiOnlyBtn.classList.toggle("is-active",o.helsinkiOnly),s.helsinkiOnlyBtn.textContent=o.helsinkiOnly?"Helsinki Only: On":"Helsinki Only: Off"}}function V(n){s.busControlsEl&&s.busControlsEl.classList.toggle("hidden",!n)}function q(n){return o.busStops.find(e=>e.id===n)||null}function Y(n){let e=i.uniqueNonEmptyStrings([...Array.isArray(n?.stopCodes)?n.stopCodes:[],n?.code]);return e.length===0&&n?.id&&e.push(String(n.id)),e}function U(n,e=null){let t=q(o.busStopId),a=String(e?.stopName||n?.stopName||t?.name||"").trim(),p=i.uniqueNonEmptyStrings([e?.stopCode,...Array.isArray(n?.stopCodes)?n.stopCodes:[],n?.stopCode,...Y(t)])[0]||"";return a&&p?`${a} ${p}`:a||p||"\u2014"}function K(n,e=null){if(h())return U(n,e);let t=String(e?.stopName||n?.stopName||"").trim(),a=String(e?.stopCode||n?.stopCode||"").trim();return t&&a?`${t} ${a}`:t||a||"\u2014"}function Z(n){if(!s.dataScopeEl)return;if(!h()){s.dataScopeEl.classList.add("hidden"),s.dataScopeEl.textContent="";return}let e=String(n?.station?.stopName||q(o.busStopId)?.name||"").trim(),a=i.uniqueNonEmptyStrings([...Array.isArray(n?.station?.stopCodes)?n.station.stopCodes:[],n?.station?.stopCode,...Y(q(o.busStopId))]).join(", "),d=o.busLineFilters.length===0?"all lines":`${o.busLineFilters.length} line${o.busLineFilters.length===1?"":"s"} selected`,p=o.busDestinationFilters.length===0?"all destinations":`${o.busDestinationFilters.length} destination${o.busDestinationFilters.length===1?"":"s"} selected`,S=`${i.getActiveResultsLimit()} results`;e?s.dataScopeEl.textContent=`Selected stop ${e} (${a||"\u2014"}) - ${d}, ${p}, ${S}`:s.dataScopeEl.textContent=`Selecting stop... (${d}, ${p}, ${S})`,s.dataScopeEl.classList.remove("hidden")}function j(n,e,t,a){if(!n)return;if(n.innerHTML="",!Array.isArray(e)||e.length===0){let p=document.createElement("span");p.className="chip-empty",p.textContent="No options",n.appendChild(p);return}let d=new Set(t);for(let p of e){let S=document.createElement("button");S.type="button",S.className="chip-toggle",d.has(p.value)?(S.classList.add("is-active"),S.setAttribute("aria-pressed","true")):S.setAttribute("aria-pressed","false"),S.textContent=`${p.value} (${p.count})`,S.addEventListener("click",()=>a(p.value)),n.appendChild(S)}}function J(n){if(!s.busStopSelectEl||!s.busStopSelectListEl)return;let e=s.busStopSelectEl.getAttribute("aria-expanded")==="true",t=typeof n=="boolean"?n:!e;s.busStopSelectEl.setAttribute("aria-expanded",String(t)),s.busStopSelectListEl.classList.toggle("hidden",!t)}function H(n){if(!o.suppressBusStopChange){if(!n||n===o.busStopId){J(!1);return}if(i.trackFirstManualInteraction("stop_select",{currentMode:o.mode}),i.trackFirstManualStopContextChange("stop_select",{selectedStopId:n}),o.busStopId=n,i.persistUiState(),J(!1),s.busStopSelectLabelEl){let e=o.busStops.find(t=>t.id===n);s.busStopSelectLabelEl.textContent=e?`${e.name} (${e.distanceMeters}m)`:n}o.currentCoords&&i.load(o.currentCoords.lat,o.currentCoords.lon)}}function $(){let n=h();if(V(n),!!n){if(s.busStopSelectListEl){if(o.suppressBusStopChange=!0,s.busStopSelectListEl.innerHTML="",o.busStops.length===0)s.busStopSelectLabelEl&&(s.busStopSelectLabelEl.textContent=`No nearby ${f().singular} stops`),s.busStopSelectEl&&(s.busStopSelectEl.disabled=!0);else{s.busStopSelectEl&&(s.busStopSelectEl.disabled=!1);let e=o.busStopId;(!e||!o.busStops.some(t=>t.id===e))&&(e=o.busStops[0].id);for(let t of o.busStops){let a=document.createElement("li");a.setAttribute("role","option"),a.dataset.value=t.id,a.textContent=`${t.name} (${t.distanceMeters}m)`,t.id===e&&a.setAttribute("aria-selected","true"),a.addEventListener("click",()=>H(t.id)),s.busStopSelectListEl.appendChild(a)}if(s.busStopSelectLabelEl){let t=o.busStops.find(a=>a.id===e);s.busStopSelectLabelEl.textContent=t?`${t.name} (${t.distanceMeters}m)`:"Select stop"}}o.suppressBusStopChange=!1}j(s.busLineFiltersEl,o.busFilterOptions.lines,o.busLineFilters,e=>{o.busLineFilters.includes(e)?o.busLineFilters=o.busLineFilters.filter(t=>t!==e):o.busLineFilters=[...o.busLineFilters,e],i.trackFirstManualInteraction("line_filter_toggle",{currentMode:o.mode}),i.trackFirstManualStopContextChange("line_filter_toggle"),i.persistUiState(),o.latestResponse&&(i.render(o.latestResponse),i.setStatus(i.buildStatusFromResponse(o.latestResponse)))}),j(s.busDestinationFiltersEl,o.busFilterOptions.destinations,o.busDestinationFilters,e=>{o.busDestinationFilters.includes(e)?o.busDestinationFilters=o.busDestinationFilters.filter(t=>t!==e):o.busDestinationFilters=[...o.busDestinationFilters,e],i.trackFirstManualInteraction("destination_filter_toggle",{currentMode:o.mode}),i.trackFirstManualStopContextChange("destination_filter_toggle"),i.persistUiState(),o.latestResponse&&(i.render(o.latestResponse),i.setStatus(i.buildStatusFromResponse(o.latestResponse)))})}}function D(n,e=null){if(!s.nextSummaryEl||!s.nextMinsEl||!s.nextLineEl||!s.nextTrackEl||!s.nextDestinationEl)return;if(!n){s.nextSummaryEl.classList.add("hidden"),s.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later");return}let t=M(n.departureIso);s.nextMinsEl.textContent=T(n.departureIso),s.nextLineEl.textContent=n.line||"\u2014",s.nextLineEl.classList.toggle("next-letter-now",t<5),s.nextTrackEl.textContent=h()?`Stop ${K(e,n)}`:n.track?`Track ${n.track}`:"Track \u2014",s.nextDestinationEl.textContent=n.destination||"\u2014",s.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),t<5?s.nextSummaryEl.classList.add("next-summary-now"):t<=15?s.nextSummaryEl.classList.add("next-summary-soon"):s.nextSummaryEl.classList.add("next-summary-later"),s.nextSummaryEl.classList.remove("hidden")}function F(n){if(!n||!n.station)return h()?n?.message||`No nearby ${f().singular} stops found.`:n?.message||"No nearby train stations found.";let t=k(n.station.departures)[0];if(!t)return h()?o.busLineFilters.length>0||o.busDestinationFilters.length>0?`No upcoming ${f().plural} match selected filters.`:"No upcoming departures from this stop.":o.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.";let a=t.destination?` \u2022 ${t.destination}`:"",d=o.mode===I?t.track?` \u2022 Track ${t.track}`:"":n.station.stopName||n.station.stopCode?` \u2022 ${K(n.station,t)}`:"",p=h()?f().singular:"train";return`Next ${t.line||p} in ${T(t.departureIso)}${a}${d}`}function Q(n){if(!(n instanceof Error))return"Could not refresh departures. Please try again.";if(n.name==="AbortError")return"Request timed out. Please try again.";let e=(n.message||"").trim();return e==="Temporary server error. Please try again."?e:e==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":e==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function P(n){return n?.code===1?"Location permission denied.":n?.code===2?"Location unavailable. Please try again.":n?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function X(n){let e=String(n?.code||"").trim();return e==="voice_unsupported"?"Voice location is not supported in this browser.":e==="voice_permission_denied"?"Microphone permission denied.":e==="voice_no_microphone"?"No microphone was found for voice location.":e==="voice_no_speech"?"No speech detected. Please try again.":e==="voice_recognition_timeout"?"Voice listening timed out. Please try again.":e==="voice_language_not_supported"?"Voice language was not supported on this device.":e==="voice_query_too_short"?"Please describe your location with a few words.":e==="voice_location_not_found"?"Could not match that place. Try a nearby landmark or street.":e==="voice_location_selection_cancelled"?"Location selection was cancelled.":e==="voice_location_selection_invalid"?"Please choose one of the suggested locations.":e==="voice_recognition_network"?"Voice recognition failed due to a network error. On iPhone, try enabling Siri & Dictation.":"Could not use voice location. Please try again."}function l(){s.skeletonEl&&s.skeletonEl.classList.remove("hidden")}function c(){s.skeletonEl&&s.skeletonEl.classList.add("hidden")}function u(n){if(c(),$(),Z(n),!n||!n.station){s.resultEl.classList.add("hidden"),D(null);return}let e=n.station;s.resultEl.classList.remove("hidden"),s.stationTitleEl.textContent=e.stopName,s.stationMetaEl.textContent=`${e.distanceMeters}m away`,s.departuresEl.innerHTML="";let t=k(e.departures);if(t.length===0){D(null);let d=document.createElement("li");d.className="empty-row",h()?d.textContent=o.busLineFilters.length>0||o.busDestinationFilters.length>0?`No upcoming ${f().plural} match selected filters.`:"No upcoming departures from this stop.":d.textContent=o.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.",s.departuresEl.appendChild(d);return}D(t[0],e);let a=t.slice(1);if(a.length===0){let d=document.createElement("li");d.className="empty-row",d.textContent=h()?`No additional upcoming ${f().plural} right now.`:"No additional upcoming commuter trains right now.",s.departuresEl.appendChild(d);return}for(let d=0;d<a.length;d++){let p=a[d],S=document.createElement("li");S.className=`departure-row ${y(p.departureIso)}`,S.style.setProperty("--i",d);let N=document.createElement("div");N.className="letter-badge",N.textContent=p.line||"?";let x=document.createElement("div");x.className="train";let G=document.createElement("div");G.className="destination",G.textContent=p.destination||"\u2014",x.appendChild(G);let A=document.createElement("span");A.className="track",h()?A.textContent=`Stop ${K(e,p)}`:A.textContent=p.track?`Track ${p.track}`:"Track \u2014",x.appendChild(A);let W=document.createElement("div");W.className="time";let C=document.createElement("span");C.className="remaining",C.textContent=T(p.departureIso);let w=document.createElement("span");w.className="clock-time",w.textContent=new Date(p.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),W.appendChild(C),W.appendChild(w),S.appendChild(N),S.appendChild(x),S.appendChild(W),s.departuresEl.appendChild(S)}}function m(){s.nowClockEl&&(s.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(i,{formatMinutes:T,minutesUntil:M,departureRowClass:y,isHelsinkiBound:E,sanitizeStopSelections:B,getVisibleDepartures:k,updateModeButtons:_,updateModeLabels:O,renderResultsLimitControl:R,updateHelsinkiFilterButton:z,setStopControlsVisibility:V,getStopMeta:q,getStopCodes:Y,buildStopDisplay:U,buildModeStopDisplay:K,updateDataScope:Z,renderFilterButtons:j,toggleStopDropdown:J,selectStop:H,renderStopControls:$,updateNextSummary:D,buildStatusFromResponse:F,getLoadErrorStatus:Q,getGeolocationErrorStatus:P,getVoiceLocationErrorStatus:X,showSkeleton:l,hideSkeleton:c,render:u,updateClock:m})})();(()=>{let v=window.HMApp,{api:i,dom:s,state:o,constants:b}=v,{MODE_TRAM:I,MODE_METRO:L,MODE_BUS:r}=b;function g(l){return l===r||l===I||l===L}function h(l){return new Promise(c=>setTimeout(c,l))}async function f(l,c={},u=b.FETCH_TIMEOUT_MS){let m=new AbortController,n=setTimeout(()=>m.abort(),u);try{return await fetch(l,{...c,signal:m.signal})}finally{clearTimeout(n)}}async function T(l,c={}){let u;try{u=await f(l,c)}catch{return await h(350),f(l,c)}return u.status>=500?(await h(350),f(l,c)):u}function M(l){let c=new Map,u=new Map;for(let n of l||[]){let e=String(n?.line||"").trim();e&&c.set(e,(c.get(e)||0)+1);let t=String(n?.destination||"").trim();t&&u.set(t,(u.get(t)||0)+1)}let m=n=>[...n.entries()].sort((e,t)=>t[1]-e[1]||e[0].localeCompare(t[0])).map(([e,t])=>({value:e,count:t}));return{lines:m(c),destinations:m(u)}}function y(l){let c=Array.isArray(l?.stops)?l.stops.filter(e=>e&&e.id&&e.name).map(e=>({id:e.id,name:e.name,code:String(e.code||"").trim()||null,stopCodes:i.uniqueNonEmptyStrings([...Array.isArray(e.stopCodes)?e.stopCodes:[],e.code]),distanceMeters:Number(e.distanceMeters)||0})):[];o.busStops=c;let u=String(l?.selectedStopId||"").trim()||null,m=e=>c.some(t=>t.id===e);u&&m(u)?o.busStopId=u:(!o.busStopId||!m(o.busStopId))&&(o.busStopId=c[0]?.id||null),o.deferInitialStopContext&&(o.deferInitialStopContext=!1,o.deferredBusStopId=null,o.deferredBusLineFilters=[],o.deferredBusDestinationFilters=[],o.busLineFilters=[],o.busDestinationFilters=[]),o.hasCompletedInitialStopModeLoad=!0;let n=Array.isArray(l?.station?.departures)?l.station.departures:[];o.busFilterOptions=M(n),i.sanitizeStopSelections()}function E(l,c){let u=new Error(c);return u.code=l,u}function B(l){return String(l?.code||"").trim().toLowerCase()}function k(){return i.uniqueNonEmptyStrings(["fi-FI","en-US",...Array.isArray(navigator.languages)?navigator.languages:[],navigator.language])}function _(){return typeof window.SpeechRecognition=="function"?window.SpeechRecognition:typeof window.webkitSpeechRecognition=="function"?window.webkitSpeechRecognition:null}function O(){return!!_()}function R(l){return l==="not-allowed"||l==="service-not-allowed"?E("voice_permission_denied","Microphone permission denied."):l==="audio-capture"?E("voice_no_microphone","No microphone available."):l==="language-not-supported"?E("voice_language_not_supported","Speech language is not supported."):l==="network"?E("voice_recognition_network","Voice recognition network error."):l==="no-speech"?E("voice_no_speech","No speech detected."):E("voice_not_understood","Voice recognition failed.")}function z(l){let c=_();return c?new Promise((u,m)=>{let n=new c,e=String(l||navigator.language||"fi-FI").trim();n.lang=e||"fi-FI",n.continuous=!1,n.interimResults=!0,n.maxAlternatives=1;let t=!1,a="",d=null,p=!1,S=()=>{clearTimeout(d),d=null},N=()=>{if(!(p||t)){p=!0;try{n.stop()}catch{}}},x=()=>{S(),d=setTimeout(N,b.VOICE_SILENCE_STOP_MS)},G=()=>{clearTimeout(W),S(),n.onresult=null,n.onerror=null,n.onend=null,n.onspeechend=null,n.onsoundend=null,n.onaudioend=null,n.onnomatch=null},A=(C,w)=>{t||(t=!0,G(),C(w))},W=setTimeout(()=>{try{n.abort()}catch{}A(m,E("voice_recognition_timeout","Voice recognition timed out."))},b.VOICE_RECOGNITION_TIMEOUT_MS);n.onresult=C=>{for(let w=C?.resultIndex||0;w<(C?.results?.length||0);w+=1){let ee=C.results[w],te=String(ee?.[0]?.transcript||"").trim();if(te&&(a=te,x(),ee?.isFinal)){N();return}}},n.onerror=C=>{let w=String(C?.error||"").trim().toLowerCase();A(m,R(w))},n.onend=()=>{if(t)return;let C=String(a||"").trim();if(!C){A(m,E("voice_no_speech","No speech detected."));return}A(u,C)},n.onspeechend=()=>{N()},n.onsoundend=()=>{x()},n.onaudioend=()=>{x()},n.onnomatch=()=>{A(m,E("voice_not_understood","Could not understand speech."))};try{n.start()}catch(C){let w=String(C?.name||"").trim().toLowerCase();if(w==="notallowederror"||w==="securityerror"){A(m,E("voice_permission_denied","Microphone permission denied."));return}A(m,E("voice_not_understood","Unable to start voice recognition."))}}):Promise.reject(E("voice_unsupported","Voice recognition not supported."))}function V(l){return l==="voice_no_speech"||l==="voice_not_understood"||l==="voice_recognition_timeout"||l==="voice_language_not_supported"}async function q(){let l=k(),c=null;for(let u of l)try{return await z(u)}catch(m){if(c=m,!V(B(m)))break}throw c||E("voice_not_understood","Voice recognition failed.")}function Y(l){return Array.isArray(l)?l.map(c=>{let u=Number(c?.lat),m=Number(c?.lon);return!Number.isFinite(u)||!Number.isFinite(m)?null:{lat:u,lon:m,label:String(c?.label||"").trim()}}).filter(Boolean):[]}function U(){s.voiceLocationChoicesEl&&s.voiceLocationChoicesEl.classList.add("hidden"),s.voiceLocationChoicesTitleEl&&(s.voiceLocationChoicesTitleEl.textContent=""),s.voiceLocationChoicesOptionsEl&&(s.voiceLocationChoicesOptionsEl.innerHTML=""),s.voiceLocationChoicesCancelEl&&(s.voiceLocationChoicesCancelEl.onclick=null)}function K(l,c){if(typeof window.prompt!="function")throw E("voice_location_selection_cancelled","Location selection was cancelled.");let u=c.map((e,t)=>`${t+1}. ${e.label||`${e.lat}, ${e.lon}`}`).join(`
`),m=window.prompt(`Multiple matches found for "${i.safeString(l,80)}". Select number:
${u}`,"1");if(m==null)throw E("voice_location_selection_cancelled","Location selection was cancelled.");let n=Number.parseInt(String(m).trim(),10);if(!Number.isInteger(n)||n<1||n>c.length)throw E("voice_location_selection_invalid","Invalid location selection.");return c[n-1]}async function Z(l,c){if(!Array.isArray(c)||c.length===0)throw E("voice_location_not_found","No matching location found.");return!s.voiceLocationChoicesEl||!s.voiceLocationChoicesTitleEl||!s.voiceLocationChoicesOptionsEl||!s.voiceLocationChoicesCancelEl?K(l,c):new Promise((u,m)=>{let n=!1,e=(t,a)=>{n||(n=!0,U(),t(a))};s.voiceLocationChoicesTitleEl.textContent=`Multiple matches for "${i.safeString(l,80)}". Choose one:`,i.setStatus("Multiple matches found. Choose one below."),s.voiceLocationChoicesOptionsEl.innerHTML="";for(let t of c){let a=document.createElement("button");a.type="button",a.className="voice-location-choice-option",a.textContent=t.label||`${t.lat.toFixed(5)}, ${t.lon.toFixed(5)}`,a.addEventListener("click",()=>e(u,t),{once:!0}),s.voiceLocationChoicesOptionsEl.appendChild(a)}s.voiceLocationChoicesCancelEl.onclick=()=>e(m,E("voice_location_selection_cancelled","Location selection was cancelled.")),s.voiceLocationChoicesEl.classList.remove("hidden")})}async function j(l){let c=String(l||"").trim();if(c.length<b.VOICE_QUERY_MIN_LENGTH)throw E("voice_query_too_short","Voice query too short.");let u=new URLSearchParams({text:c});o.currentCoords&&(u.set("lat",String(o.currentCoords.lat)),u.set("lon",String(o.currentCoords.lon)));let m=Array.isArray(navigator.languages)&&navigator.languages[0]||navigator.language||"";m&&u.set("lang",String(m));let n;try{n=await T(`/api/v1/geocode?${u.toString()}`)}catch{throw E("voice_geocode_failed","Location lookup failed.")}if(!(n.headers.get("content-type")||"").includes("application/json"))throw E("voice_geocode_failed","Unexpected location lookup response.");let t=await n.json();if(!n.ok)throw E("voice_geocode_failed",String(t?.error||"Location lookup failed.").trim());let a=Y(t?.choices);if(t?.ambiguous&&a.length>1){let S=await Z(c,a);return{lat:S.lat,lon:S.lon,label:S.label,query:c}}let d=Number(t?.location?.lat),p=Number(t?.location?.lon);if(!Number.isFinite(d)||!Number.isFinite(p))throw E("voice_location_not_found","No matching location found.");return{lat:d,lon:p,label:String(t?.location?.label||"").trim(),query:c}}function J(l){return l==="voice_unsupported"||l==="voice_no_speech"||l==="voice_recognition_timeout"||l==="voice_recognition_network"||l==="voice_not_understood"}function H(l){if(!J(l)||typeof window.prompt!="function")return null;let c=l==="voice_unsupported"?"Voice input is limited in this browser. Type your location instead:":"Could not capture your voice on this device. Type your location:",u=window.prompt(`${c}
Example: Kamppi Helsinki`,"");return String(u||"").trim()||null}async function $(l){let c=String(l||"").trim();U(),i.setStatus(`Looking up "${i.safeString(c,80)}"...`);let u=await j(c);return i.setResolvedLocationHint({query:c,label:u.label,lat:u.lat,lon:u.lon}),o.currentCoords={lat:u.lat,lon:u.lon},i.setPermissionRequired(!1),await F(u.lat,u.lon),!0}async function D(){if(o.isLoading||o.isVoiceListening)return!1;U(),i.setVoiceListening(!0),i.setStatus("Listening... speak now, then pause.");try{if(!O()){let c=E("voice_unsupported","Voice recognition not supported."),u=H(B(c));return u?$(u):(i.setStatus(i.getVoiceLocationErrorStatus(c)),!1)}let l=await q();return $(l)}catch(l){let c=B(l),u=H(c);if(u)try{return await $(u)}catch(m){return console.error("voice fallback location error:",m),i.reportClientError("voice-location-fallback",m,{mode:o.mode,sourceCode:c||"unknown"}),i.setStatus(i.getVoiceLocationErrorStatus(m)),!1}return(!c||c==="unknown")&&console.error("voice location error:",l),i.reportClientError("voice-location",l,{mode:o.mode,code:c||"unknown"}),i.setStatus(i.getVoiceLocationErrorStatus(l)),!1}finally{i.setVoiceListening(!1)}}async function F(l,c){let u=++o.latestLoadToken,m=o.mode,n=o.busStopId,e=g(m)&&!o.hasCompletedInitialStopModeLoad;i.setLoading(!0),i.setStatus("Loading departures...");try{let t=new URLSearchParams({lat:String(l),lon:String(c),mode:m.toUpperCase(),results:String(i.getActiveResultsLimit(m))}),a=g(m)&&(o.deferInitialStopContext||!o.hasCompletedInitialStopModeLoad);g(m)&&n&&!a&&t.set("stopId",n);let d=await T(`/api/v1/departures?${t.toString()}`);if(!(d.headers.get("content-type")||"").includes("application/json"))throw d.ok?new Error("Unexpected server response."):new Error("Request failed");let S=await d.json();if(!d.ok)throw new Error(S.error||"Request failed");if(u!==o.latestLoadToken)return;g(m)&&(y(S),i.persistUiState(),e&&i.trackInitialNearestStopResolved(S,m)),o.latestResponse=S,i.render(S),i.setPermissionRequired(!1),i.setLastUpdated(new Date),i.setStatus(i.buildStatusFromResponse(S)),i.trackFirstSuccessfulRender(S,m)}catch(t){if(u!==o.latestLoadToken)return;o.latestResponse=null,console.error("load departures error:",t),i.reportClientError("load",t,{mode:m}),i.setStatus(i.getLoadErrorStatus(t)),s.resultEl.classList.add("hidden"),i.updateNextSummary(null)}finally{u===o.latestLoadToken&&i.setLoading(!1)}}function Q(){return U(),i.setResolvedLocationHint(null),navigator.geolocation?o.isLoading||o.isVoiceListening?!1:(i.setStatus("Getting your location..."),i.setLoading(!0),navigator.geolocation.getCurrentPosition(l=>{o.currentCoords={lat:l.coords.latitude,lon:l.coords.longitude},i.setPermissionRequired(!1),i.setLoading(!1),F(o.currentCoords.lat,o.currentCoords.lon)},l=>{if(i.setLoading(!1),l.code===1){i.setPermissionRequired(!0),i.setStatus(i.getGeolocationErrorStatus(l)),o.latestResponse=null,s.resultEl.classList.add("hidden"),i.updateNextSummary(null);return}i.setPermissionRequired(!1),i.setStatus(i.getGeolocationErrorStatus(l)),o.latestResponse=null,s.resultEl.classList.add("hidden"),i.updateNextSummary(null)},{enableHighAccuracy:!1,timeout:1e4,maximumAge:0}),!0):(i.setStatus("Geolocation not supported in this browser."),i.setPermissionRequired(!0),!1)}function P(){if(!o.isVoiceListening){if(o.currentCoords){F(o.currentCoords.lat,o.currentCoords.lon);return}Q()}}function X(){i.updateModeButtons(),i.updateModeLabels(),i.renderResultsLimitControl(),i.updateHelsinkiFilterButton(),i.renderStopControls(),i.updateDataScope(o.latestResponse)}Object.assign(i,{delay:h,fetchWithTimeout:f,fetchWithRetryOnce:T,updateStopModeStateFromResponse:y,buildFilterOptionsFromDepartures:M,load:F,requestLocationAndLoad:Q,requestVoiceLocationAndLoad:D,supportsVoiceLocation:O,captureVoiceQuery:z,captureVoiceQueryWithRetry:q,getVoiceRecognitionLanguages:k,shouldRetryVoiceRecognition:V,resolveVoiceLocationQuery:j,refreshDeparturesOnly:P,applyModeUiState:X})})();(()=>{let v=window.HMApp,{api:i,dom:s,state:o,constants:b}=v,{MODE_RAIL:I,MODE_TRAM:L,MODE_METRO:r,MODE_BUS:g}=b;function h(){if(o.currentCoords){i.load(o.currentCoords.lat,o.currentCoords.lon);return}i.requestLocationAndLoad()}s.locateBtn?.addEventListener("click",()=>{i.trackFirstManualInteraction("refresh_location_click"),i.requestLocationAndLoad()}),s.voiceLocateBtn?.addEventListener("click",()=>{i.trackFirstManualInteraction("voice_location_click"),i.requestVoiceLocationAndLoad()}),s.modeRailBtn?.addEventListener("click",()=>{o.mode!==I&&(i.trackFirstManualInteraction("mode_change",{toMode:I}),o.mode=I,i.applyModeUiState(),i.persistUiState(),h())}),s.modeTramBtn?.addEventListener("click",()=>{o.mode!==L&&(i.trackFirstManualInteraction("mode_change",{toMode:L}),o.mode=L,o.helsinkiOnly=!1,i.applyModeUiState(),i.persistUiState(),h())}),s.modeMetroBtn?.addEventListener("click",()=>{o.mode!==r&&(i.trackFirstManualInteraction("mode_change",{toMode:r}),o.mode=r,o.helsinkiOnly=!1,i.applyModeUiState(),i.persistUiState(),h())}),s.modeBusBtn?.addEventListener("click",()=>{o.mode!==g&&(i.trackFirstManualInteraction("mode_change",{toMode:g}),o.mode=g,o.helsinkiOnly=!1,i.applyModeUiState(),i.persistUiState(),h())}),s.resultsLimitSelectEl?.addEventListener("change",()=>{let f=i.parseResultLimit(s.resultsLimitSelectEl.value);if(f==null){i.renderResultsLimitControl();return}i.getActiveResultsLimit()!==f&&(i.trackFirstManualInteraction("results_limit_change",{nextLimit:f,currentMode:o.mode}),o.resultsLimitByMode[o.mode]=f,i.persistUiState(),h())}),s.busStopSelectEl?.addEventListener("click",f=>{f.stopPropagation(),i.toggleStopDropdown()}),document.addEventListener("click",f=>{s.busStopSelectWrapEl&&(s.busStopSelectWrapEl.contains(f.target)||i.toggleStopDropdown(!1))}),s.busStopSelectEl?.addEventListener("keydown",f=>{let T=s.busStopSelectListEl;if(!T)return;let M=s.busStopSelectEl.getAttribute("aria-expanded")==="true";if(f.key==="Escape"){i.toggleStopDropdown(!1),s.busStopSelectEl.focus(),f.preventDefault();return}if(f.key==="Enter"||f.key===" "){if(!M){i.toggleStopDropdown(!0),f.preventDefault();return}let y=T.querySelector(".is-focused");y?.dataset?.value&&i.selectStop(y.dataset.value),f.preventDefault();return}if(f.key==="ArrowDown"||f.key==="ArrowUp"){if(f.preventDefault(),!M){i.toggleStopDropdown(!0);return}let y=[...T.querySelectorAll("li[role='option']")];if(y.length===0)return;let E=y.findIndex(k=>k.classList.contains("is-focused")),B;f.key==="ArrowDown"?B=E<y.length-1?E+1:0:B=E>0?E-1:y.length-1;for(let k of y)k.classList.remove("is-focused");y[B].classList.add("is-focused"),y[B].scrollIntoView({block:"nearest"})}}),s.helsinkiOnlyBtn?.addEventListener("click",()=>{o.mode===I&&(i.trackFirstManualInteraction("helsinki_only_toggle"),o.helsinkiOnly=!o.helsinkiOnly,i.persistUiState(),i.updateHelsinkiFilterButton(),o.latestResponse&&(i.render(o.latestResponse),i.setStatus(i.buildStatusFromResponse(o.latestResponse))))}),i.hydrateInitialState(),i.applyModeUiState(),i.updateClock(),setInterval(i.updateClock,1e3),i.requestLocationAndLoad(),setInterval(i.refreshDeparturesOnly,3e4),window.addEventListener("error",f=>{i.reportClientError("error",f.error||f.message||"Unknown error",{source:f.filename||"",line:f.lineno||null,column:f.colno||null})}),window.addEventListener("unhandledrejection",f=>{i.reportClientError("unhandledrejection",f.reason||"Unhandled promise rejection")}),(()=>{let f=document.getElementById("themeToggle");if(!f)return;let T=document.documentElement,M=window.matchMedia("(prefers-color-scheme: dark)"),y=()=>{let _=i.getStorageItem("theme");return _==="dark"||_==="light"?_:null},E=_=>{T.setAttribute("data-theme",_==="light"?"light":"dark")},B=()=>{let _=y();if(_){E(_);return}E(M.matches?"dark":"light")},k=_=>{y()||E(_.matches?"dark":"light")};B(),typeof M.addEventListener=="function"?M.addEventListener("change",k):typeof M.addListener=="function"&&M.addListener(k),f.addEventListener("click",()=>{let _=T.getAttribute("data-theme")==="dark"?"light":"dark";E(_),i.setStorageItem("theme",_)})})()})();})();
